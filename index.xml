<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/">
  <channel>
    <title>Lucius | Braindump</title>
    <link>https://sheerwill.live/</link>
    <description>Recent content on Lucius | Braindump</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>en-us</language>
    <lastBuildDate>Wed, 21 Sep 2022 14:11:23 +0800</lastBuildDate><atom:link href="https://sheerwill.live/index.xml" rel="self" type="application/rss+xml" />
    <item>
      <title>Vanilla Emacs with Purcell</title>
      <link>https://sheerwill.live/posts/main/20220723211325-vanilla_emacs_with_purcell/</link>
      <pubDate>Wed, 21 Sep 2022 14:11:23 +0800</pubDate>
      
      <guid>https://sheerwill.live/posts/main/20220723211325-vanilla_emacs_with_purcell/</guid>
      <description>Introduction Emacs outshines all other editing software in approximately the same way that the noonday sun does the stars. It is not just bigger and brighter; it simply makes everything else vanish. – Neal Stephenson, In the Beginning was the Command Line (1998) Install Emacs-plus With Homebrew brew tap d12frosted/emacs-plus brew install emacs-plus --with-native-comp --with-modern-vscode-icon ln -s /usr/local/opt/emacs-plus@29/Emacs.app /Applications Workflow Figure 1: workflow 如上图所示，融</description>
      <content:encoded><![CDATA[<h2 id="introduction">Introduction</h2>
<blockquote>
<p>Emacs outshines all other editing software in approximately the same way that the noonday sun does the stars. It is not just bigger and brighter; it simply makes everything else vanish.</p>
<p>– Neal Stephenson, In the Beginning was the Command Line (1998)</p>
</blockquote>
<h2 id="install-emacs-plus-with-homebrew">Install Emacs-plus With Homebrew</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">brew tap d12frosted/emacs-plus
</span></span><span class="line"><span class="cl">brew install emacs-plus --with-native-comp --with-modern-vscode-icon
</span></span><span class="line"><span class="cl">ln -s /usr/local/opt/emacs-plus@29/Emacs.app /Applications
</span></span></code></pre></div><h2 id="workflow">Workflow</h2>
<figure>
    <img loading="lazy" src="/ox-hugo/workflow.png"
         alt="Figure 1: workflow"/> <figcaption>
            <p><span class="figure-number">Figure 1: </span>workflow</p>
        </figcaption>
</figure>

<p>如上图所示，融合了笔记和 GTD 管理。</p>
<h3 id="gtd">GTD</h3>
<h4 id="capture">Capture</h4>
<p>To-Dos 分为的来源分为六种：</p>
<ul>
<li>Habit Track: 即对于重复事件的循环，有利于习惯的养成。<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup></li>
<li>Cyclic Tasks: 需要循环的任务。
<ul>
<li>生日提醒</li>
<li>周报</li>
<li>每日回顾</li>
<li>稍后读</li>
<li>etc.</li>
</ul>
</li>
<li>Inbox: 用来收集各种 To-Dos，设置的快捷键为 <code>C-c c</code>​。每日回顾的时候分发到各自的分类，并行进行 Scheduled。
<ul>
<li>personal: 个人事宜</li>
<li>someday: 存放一些不知道什么时候会做的 To-Dos，有时间回顾的时候再次分类。</li>
<li>technical: 存放个人需要偿还的技术债</li>
<li>work: 工作相关</li>
</ul>
</li>
<li>books: 阅读的书籍，通过 ebib 的 <code>ebib-add-reading-list-item</code> 添加。</li>
<li>Dynamic: 只要是 org 文件中的有 To-Dos，就会在保存文件时，自动给文件添加 <code>:dynamic:</code> 标签，纳入到 Agenda 文件中。</li>
<li>note: 对一些地方的备注或者 To-Dos，后者和 Dynamic To-Dos 场景重复。</li>
</ul>
<h4 id="clarify">Clarify</h4>
<p>对 Inbox 当中的 To-Dos 进行分发，并用关键字标记 To-Dos 的属性，比如 <code>PROJECT</code>, <code>DELEGRTED</code> 等。对于 <code>PROJECT</code> 这类还要继续分解。</p>
<h4 id="organize">Organize</h4>
<p>对明天需要做的或知道明确日期的 To-Dos 进行 Scheduled，对于 <code>DONE</code> 或 <code>CANCELLED</code> 的 To-Dos 会自动复制到今日的 Daily log 当中，这样呈现的结果，其实和 Logseq 中在 Journals 里面管理 To-Dos 是一致的。</p>
<p>不过实现的过程，或者说内在逻辑是不一样的。在 Logseq 的 Journals 中管理 To-Dos 即便是通过查询汇聚展示 To-Dos 也没有 agenda 中这么灵活，另外前几天定下的需要后面完成的 To-Dos 有两种管理方式：1. 将 To-Dos 链接到需要做的某天，自动展示。这样的操作确实方便，但使得各种关联杂乱。2. 将 To-Dos 移动到对应需要做的某天。</p>
<p>上面说的呈现结果一致，就是指的第二种，回顾起来也非常清晰。在 org-roam 配合 agenda 使用中，To-Dos 有了单独的收集仓库，整理分发。也可以通过自定义的函数在 agenda 和 org-roam 之间联动，比如对于 <code>DONE</code> 或 <code>CANCELLED</code> 的 To-Dos 会自动复制到今日的 Daily log 当中，比如 org-roam 中的 To-Dos 也会呈现在 agenda view 中，完成后也会自动复制到 Daily log 中。</p>
<p>整体上来讲，内在逻辑 agenda 和 org-roam 配合起来更加清晰，灵活。</p>
<h4 id="reflect">Reflect</h4>
<p>回顾所有的 To-Dos，选取明天或者近期需要完成。对已完成或取消的 To-Dos 归档，是按照结构<sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup>归档到同级别 <code>*.org</code> 文件的 <code>archive</code> 文件夹下的同名文件中。</p>
<p>同时，要回顾一下 Notes 当中的对某处的笔记或设定的 To-Dos。</p>
<h4 id="engage">Engage</h4>
<p>按照重要，简单等因素顺序执行需要做的 To-Dos</p>
<h3 id="note-taking">Note taking</h3>
<p>输入源分为工作、书籍和文章（来自于 RSS、Newsletter、Twitter 等平台）。</p>
<h4 id="book">Book</h4>
<p>PDF 以及 Epub 格式的书籍或者论文通过 Ebib 管理 Bibtex，Ebib 的 <code>ebib-reading-list-file</code> 设置为 Agenda 中的 <code>books.org</code>​，这样就可以很方便在 Agenda View 中看到自己当前在阅读的书籍/论文，并查看进度。</p>
<p>书籍/论文对应的笔记则是在 <code>references</code> 文件夹下，可以方便笔记中进行引用。</p>
<h4 id="daily-log">Daily log</h4>
<p>每个 Daily log 文件头部都有 <code>#+ARCHIVE: journal.org::</code> 来控制归档的位置，每天回顾完当天的 log 就归档到 <code>journal.org</code> 文件中，如果后续这个文件太大，还可以按照年份来继续归档。</p>
<p>而且在 <code>journal.org</code> 中通过 <code>C-c \</code> 可以查看所有的 tags，选择对应的 tag 就可以过滤出想要的内容，其他内容全部收缩。</p>
<h4 id="articles-work">Articles/Work</h4>
<p>文章的阅读笔记是放在 Daily log 当中的，在 What I read? 的标题下，打上对应的 tags。后期回顾的时候，或者积累一定数量的同类型、同话题文章，可能会 refile 到 org-roam 内进行总结，形成知识点。</p>
<p>工作中的事情都是记在 Daily log 中，每条 log 有明确的时间。</p>
<p>对于问题的解决，有详细的原因和解决方案，后续遇到同样的问题可以参考之前的思路；对于与他人沟通的内容，有详细的操作记录、数据记录以及邮件聊天等记录链接或截图，有背锅风险时可以轻松应对。</p>
<p>同样的，工作中某个类型的知识点的笔记积累多了，会在 org-roam 中进行总结，形成知识点。</p>
<h4 id="export">Export</h4>
<p>输出是 org 的强项，Hugo 方便与人在线分享，PDF/Markdown 离线分享。</p>
<h4 id="org-roam-ui">org-roam-ui</h4>
<p>方便的查看笔记之间的关系，进行系统性回顾。</p>
<h2 id="personal-settings">Personal Settings</h2>
<p>目前在 <a href="https://github.com/purcell/emacs.d">purcell</a> 中就增加或修改了这些文件。</p>
<pre tabindex="0"><code class="language-nil" data-lang="nil">.
├── lisp
    ├── ligature.el
    ├── init-org.el
    ├── init-sis.el
    ├── init-font.el
    ├── init-ebib.el
    ├── init-meow.el
    ├── beancount.el
    ├── init-elpa.el
    ├── init-local.el
    ├── init-corfu.el
    ├── init-themes.el
    ├── init-elfeed.el
    ├── init-telega.el
    ├── init-org-modern.el
    ├── init-quick-menus.el
    ├── init-tree-sitter.el
    └── init-org-enhance.el
</code></pre><h3 id="ligature-dot-el">ligature.el</h3>
<p><a href="https://github.com/mickeynp/ligature.el">GitHub - mickeynp/ligature.el: Display typographical ligatures in Emacs</a>，这里是将其中的 <code>ligature.el</code> 下载到 <code>.emacs.d/lisp/</code> 目录下，加上下列代码。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-elisp" data-lang="elisp"><span class="line"><span class="cl"><span class="c1">;; Enable the www ligature in every possible major mode</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">ligature-set-ligatures</span> <span class="ss">&#39;t</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;www&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;; Enable ligatures in programming modes</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">ligature-set-ligatures</span> <span class="ss">&#39;prog-mode</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;www&#34;</span> <span class="s">&#34;**&#34;</span> <span class="s">&#34;***&#34;</span> <span class="s">&#34;**/&#34;</span> <span class="s">&#34;*&gt;&#34;</span> <span class="s">&#34;*/&#34;</span> <span class="s">&#34;\\\\&#34;</span> <span class="s">&#34;\\\\\\&#34;</span> <span class="s">&#34;{-&#34;</span> <span class="s">&#34;::&#34;</span>
</span></span><span class="line"><span class="cl">                                     <span class="s">&#34;:::&#34;</span> <span class="s">&#34;:=&#34;</span> <span class="s">&#34;!!&#34;</span> <span class="s">&#34;!=&#34;</span> <span class="s">&#34;!==&#34;</span> <span class="s">&#34;-}&#34;</span> <span class="s">&#34;----&#34;</span> <span class="s">&#34;--&gt;&#34;</span> <span class="s">&#34;-&gt;&#34;</span> <span class="s">&#34;-&gt;&gt;&#34;</span>
</span></span><span class="line"><span class="cl">                                     <span class="s">&#34;-&lt;&#34;</span> <span class="s">&#34;-&lt;&lt;&#34;</span> <span class="s">&#34;-~&#34;</span> <span class="s">&#34;#{&#34;</span> <span class="s">&#34;#[&#34;</span> <span class="s">&#34;##&#34;</span> <span class="s">&#34;###&#34;</span> <span class="s">&#34;####&#34;</span> <span class="s">&#34;#(&#34;</span> <span class="s">&#34;#?&#34;</span> <span class="s">&#34;#_&#34;</span>
</span></span><span class="line"><span class="cl">                                     <span class="s">&#34;#_(&#34;</span> <span class="s">&#34;.-&#34;</span> <span class="s">&#34;.=&#34;</span> <span class="s">&#34;..&#34;</span> <span class="s">&#34;..&lt;&#34;</span> <span class="s">&#34;...&#34;</span> <span class="s">&#34;?=&#34;</span> <span class="s">&#34;??&#34;</span> <span class="s">&#34;;;&#34;</span> <span class="s">&#34;/*&#34;</span> <span class="s">&#34;/**&#34;</span>
</span></span><span class="line"><span class="cl">                                     <span class="s">&#34;/=&#34;</span> <span class="s">&#34;/==&#34;</span> <span class="s">&#34;/&gt;&#34;</span> <span class="s">&#34;//&#34;</span> <span class="s">&#34;///&#34;</span> <span class="s">&#34;&amp;&amp;&#34;</span> <span class="s">&#34;||&#34;</span> <span class="s">&#34;||=&#34;</span> <span class="s">&#34;|=&#34;</span> <span class="s">&#34;|&gt;&#34;</span> <span class="s">&#34;^=&#34;</span> <span class="s">&#34;$&gt;&#34;</span>
</span></span><span class="line"><span class="cl">                                     <span class="s">&#34;++&#34;</span> <span class="s">&#34;+++&#34;</span> <span class="s">&#34;+&gt;&#34;</span> <span class="s">&#34;=:=&#34;</span> <span class="s">&#34;==&#34;</span> <span class="s">&#34;===&#34;</span> <span class="s">&#34;==&gt;&#34;</span> <span class="s">&#34;=&gt;&#34;</span> <span class="s">&#34;=&gt;&gt;&#34;</span> <span class="s">&#34;&lt;=&#34;</span>
</span></span><span class="line"><span class="cl">                                     <span class="s">&#34;=&lt;&lt;&#34;</span> <span class="s">&#34;=/=&#34;</span> <span class="s">&#34;&gt;-&#34;</span> <span class="s">&#34;&gt;=&#34;</span> <span class="s">&#34;&gt;=&gt;&#34;</span> <span class="s">&#34;&gt;&gt;&#34;</span> <span class="s">&#34;&gt;&gt;-&#34;</span> <span class="s">&#34;&gt;&gt;=&#34;</span> <span class="s">&#34;&gt;&gt;&gt;&#34;</span> <span class="s">&#34;&lt;*&#34;</span>
</span></span><span class="line"><span class="cl">                                     <span class="s">&#34;&lt;*&gt;&#34;</span> <span class="s">&#34;&lt;|&#34;</span> <span class="s">&#34;&lt;|&gt;&#34;</span> <span class="s">&#34;&lt;$&#34;</span> <span class="s">&#34;&lt;$&gt;&#34;</span> <span class="s">&#34;&lt;!--&#34;</span> <span class="s">&#34;&lt;-&#34;</span> <span class="s">&#34;&lt;--&#34;</span> <span class="s">&#34;&lt;-&gt;&#34;</span> <span class="s">&#34;&lt;+&#34;</span>
</span></span><span class="line"><span class="cl">                                     <span class="s">&#34;&lt;+&gt;&#34;</span> <span class="s">&#34;&lt;=&#34;</span> <span class="s">&#34;&lt;==&#34;</span> <span class="s">&#34;&lt;=&gt;&#34;</span> <span class="s">&#34;&lt;=&lt;&#34;</span> <span class="s">&#34;&lt;&gt;&#34;</span> <span class="s">&#34;&lt;&lt;&#34;</span> <span class="s">&#34;&lt;&lt;-&#34;</span> <span class="s">&#34;&lt;&lt;=&#34;</span> <span class="s">&#34;&lt;&lt;&lt;&#34;</span>
</span></span><span class="line"><span class="cl">                                     <span class="s">&#34;&lt;~&#34;</span> <span class="s">&#34;&lt;~~&#34;</span> <span class="s">&#34;&lt;/&#34;</span> <span class="s">&#34;&lt;/&gt;&#34;</span> <span class="s">&#34;~@&#34;</span> <span class="s">&#34;~-&#34;</span> <span class="s">&#34;~&gt;&#34;</span> <span class="s">&#34;~~&#34;</span> <span class="s">&#34;~~&gt;&#34;</span> <span class="s">&#34;%%&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">global-ligature-mode</span> <span class="ss">&#39;t</span><span class="p">)</span>
</span></span></code></pre></div><h3 id="init-org-dot-el">init-org.el</h3>
<p>org-roam 和 Emacs 自带的 agenda 可以很方便的将笔记和 GTD 结合起来。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-elisp" data-lang="elisp"><span class="line"><span class="cl"><span class="c1">;;; init-org.el --- Org-mode config -*- lexical-binding: t -*-</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;; Commentary:</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;; Among settings for many aspects of `org-mode&#39;, this code includes</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; an opinionated setup for the Getting Things Done (GTD) system based</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; around the Org Agenda.  I have an &#34;inbox.org&#34; file with a header</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; including</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;;     #+CATEGORY: Inbox</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;     #+FILETAGS: INBOX</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;; and then set this file as `org-default-notes-file&#39;.  Captured org</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; items will then go into this file with the file-level tag, and can</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; be refiled to other locations as necessary.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;; Those other locations are generally other org files, which should</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; be added to `org-agenda-files-list&#39; (along with &#34;inbox.org&#34; org).</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; With that done, there&#39;s then an agenda view, accessible via the</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; `org-agenda&#39; command, which gives a convenient overview.</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; `org-todo-keywords&#39; is customised here to provide corresponding</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; TODO states, which should make sense to GTD adherents.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;;; Code:</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; 都是方便插入超链接的</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">when</span> <span class="vg">*is-a-mac*</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">maybe-require-package</span> <span class="ss">&#39;grab-mac-link</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">maybe-require-package</span> <span class="ss">&#39;org-cliplink</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; 图片宽度</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">org-image-actual-width</span> <span class="no">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nf">define-key</span> <span class="nv">global-map</span> <span class="p">(</span><span class="nv">kbd</span> <span class="s">&#34;C-c l&#34;</span><span class="p">)</span> <span class="ss">&#39;org-store-link</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nf">define-key</span> <span class="nv">global-map</span> <span class="p">(</span><span class="nv">kbd</span> <span class="s">&#34;C-c a&#34;</span><span class="p">)</span> <span class="ss">&#39;org-agenda</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defvar</span> <span class="nv">sanityinc/org-global-prefix-map</span> <span class="p">(</span><span class="nf">make-sparse-keymap</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;A keymap for handy global access to org helpers, particularly clocking.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nf">define-key</span> <span class="nv">sanityinc/org-global-prefix-map</span> <span class="p">(</span><span class="nv">kbd</span> <span class="s">&#34;j&#34;</span><span class="p">)</span> <span class="ss">&#39;org-clock-goto</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nf">define-key</span> <span class="nv">sanityinc/org-global-prefix-map</span> <span class="p">(</span><span class="nv">kbd</span> <span class="s">&#34;l&#34;</span><span class="p">)</span> <span class="ss">&#39;org-clock-in-last</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nf">define-key</span> <span class="nv">sanityinc/org-global-prefix-map</span> <span class="p">(</span><span class="nv">kbd</span> <span class="s">&#34;i&#34;</span><span class="p">)</span> <span class="ss">&#39;org-clock-in</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nf">define-key</span> <span class="nv">sanityinc/org-global-prefix-map</span> <span class="p">(</span><span class="nv">kbd</span> <span class="s">&#34;o&#34;</span><span class="p">)</span> <span class="ss">&#39;org-clock-out</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nf">define-key</span> <span class="nv">global-map</span> <span class="p">(</span><span class="nv">kbd</span> <span class="s">&#34;C-c o&#34;</span><span class="p">)</span> <span class="nv">sanityinc/org-global-prefix-map</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;; Various preferences</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">org-log-done</span> <span class="no">t</span>
</span></span><span class="line"><span class="cl">      <span class="nv">org-edit-timestamp-down-means-later</span> <span class="no">t</span>
</span></span><span class="line"><span class="cl">      <span class="nv">org-hide-emphasis-markers</span> <span class="no">t</span>
</span></span><span class="line"><span class="cl">      <span class="nv">org-catch-invisible-edits</span> <span class="ss">&#39;show</span>
</span></span><span class="line"><span class="cl">      <span class="nv">org-export-coding-system</span> <span class="ss">&#39;utf-8</span>
</span></span><span class="line"><span class="cl">      <span class="nv">org-fast-tag-selection-single-key</span> <span class="ss">&#39;expert</span>
</span></span><span class="line"><span class="cl">      <span class="nv">org-html-validation-link</span> <span class="no">nil</span>
</span></span><span class="line"><span class="cl">      <span class="nv">org-export-kill-product-buffer-when-displayed</span> <span class="no">t</span>
</span></span><span class="line"><span class="cl">      <span class="nv">org-tags-column</span> <span class="mi">80</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;; Lots of stuff from http://doc.norang.ca/org-mode.html</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;; Re-align tags when window shape changes</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">with-eval-after-load</span> <span class="ss">&#39;org-agenda</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">add-hook</span> <span class="ss">&#39;org-agenda-mode-hook</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="nb">lambda</span> <span class="p">()</span> <span class="p">(</span><span class="nv">add-hook</span> <span class="ss">&#39;window-configuration-change-hook</span> <span class="ss">&#39;org-agenda-align-tags</span> <span class="no">nil</span> <span class="no">t</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;;; Capturing</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">org-directory</span> <span class="s">&#34;~/Dropbox/org/&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">global-set-key</span> <span class="p">(</span><span class="nv">kbd</span> <span class="s">&#34;C-c c&#34;</span><span class="p">)</span> <span class="ss">&#39;org-capture</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">org-capture-templates</span>
</span></span><span class="line"><span class="cl">      <span class="o">`</span><span class="p">((</span><span class="s">&#34;i&#34;</span> <span class="s">&#34;inbox&#34;</span> <span class="nv">entry</span>  <span class="p">(</span><span class="nv">file</span> <span class="s">&#34;agenda/inbox.org&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="o">,</span><span class="p">(</span><span class="nf">concat</span> <span class="s">&#34;* TODO %?\n%U&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="s">&#34;n&#34;</span> <span class="s">&#34;note&#34;</span> <span class="nv">entry</span> <span class="p">(</span><span class="nv">file</span> <span class="s">&#34;agenda/note.org&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="s">&#34;* %? :NOTE:\n%U\n%a\n&#34;</span> <span class="nb">:clock-resume</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;;; Refiling</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">org-refile-use-cache</span> <span class="no">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;; Targets include this file and any file contributing to the agenda - up to 5 levels deep</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">org-refile-targets</span> <span class="o">&#39;</span><span class="p">((</span><span class="no">nil</span> <span class="nb">:maxlevel</span> <span class="o">.</span> <span class="mi">5</span><span class="p">)</span> <span class="p">(</span><span class="nv">org-agenda-files</span> <span class="nb">:maxlevel</span> <span class="o">.</span> <span class="mi">5</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">with-eval-after-load</span> <span class="ss">&#39;org-agenda</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">add-to-list</span> <span class="ss">&#39;org-agenda-after-show-hook</span> <span class="ss">&#39;org-show-entry</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">advice-add</span> <span class="ss">&#39;org-refile</span> <span class="nb">:after</span> <span class="p">(</span><span class="nb">lambda</span> <span class="p">(</span><span class="kp">&amp;rest</span> <span class="nv">_</span><span class="p">)</span> <span class="p">(</span><span class="nv">org-save-all-org-buffers</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;; Exclude DONE state tasks from refile targets</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">sanityinc/verify-refile-target</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;Exclude todo keywords with a done state from refile targets.&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">not</span> <span class="p">(</span><span class="nf">member</span> <span class="p">(</span><span class="nf">nth</span> <span class="mi">2</span> <span class="p">(</span><span class="nv">org-heading-components</span><span class="p">))</span> <span class="nv">org-done-keywords</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">org-refile-target-verify-function</span> <span class="ss">&#39;sanityinc/verify-refile-target</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">sanityinc/org-refile-anywhere</span> <span class="p">(</span><span class="kp">&amp;optional</span> <span class="nv">goto</span> <span class="nv">default-buffer</span> <span class="nv">rfloc</span> <span class="nv">msg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;A version of </span><span class="ss">`org-refile&#39;</span><span class="s"> which allows refiling to any subtree.&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">interactive</span> <span class="s">&#34;P&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">let</span> <span class="p">((</span><span class="nv">org-refile-target-verify-function</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nv">org-refile</span> <span class="nv">goto</span> <span class="nv">default-buffer</span> <span class="nv">rfloc</span> <span class="nv">msg</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">sanityinc/org-agenda-refile-anywhere</span> <span class="p">(</span><span class="kp">&amp;optional</span> <span class="nv">goto</span> <span class="nv">rfloc</span> <span class="nv">no-update</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;A version of </span><span class="ss">`org-agenda-refile&#39;</span><span class="s"> which allows refiling to any subtree.&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">interactive</span> <span class="s">&#34;P&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">let</span> <span class="p">((</span><span class="nv">org-refile-target-verify-function</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nv">org-agenda-refile</span> <span class="nv">goto</span> <span class="nv">rfloc</span> <span class="nv">no-update</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;; Targets start with the file name - allows creating level 1 tasks</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;(setq org-refile-use-outline-path (quote file))</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">org-refile-use-outline-path</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">org-outline-path-complete-in-steps</span> <span class="no">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;; Allow refile to create parent tasks with confirmation</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">org-refile-allow-creating-parent-nodes</span> <span class="ss">&#39;confirm</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;;; To-do settings</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; TODO</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; HOLD(h@)       ; 进入时添加笔记</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; HOLD(h/!)      ; 离开时添加变更信息</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; HOLD(h@/!)     ; 进入时添加笔记，离开时添加变更信息</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">org-todo-keywords</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nb">quote</span> <span class="p">((</span><span class="nv">sequence</span> <span class="s">&#34;TODO(t)&#34;</span> <span class="s">&#34;NEXT(n)&#34;</span> <span class="s">&#34;|&#34;</span> <span class="s">&#34;DONE(d!/!)&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">              <span class="p">(</span><span class="nv">sequence</span> <span class="s">&#34;PROJECT(p)&#34;</span> <span class="s">&#34;|&#34;</span> <span class="s">&#34;DONE(d!/!)&#34;</span> <span class="s">&#34;CANCELLED(c/!)&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">              <span class="p">(</span><span class="nv">sequence</span> <span class="s">&#34;WAITING(w/!)&#34;</span> <span class="s">&#34;DELEGATED(e!)&#34;</span> <span class="s">&#34;HOLD(h)&#34;</span> <span class="s">&#34;|&#34;</span> <span class="s">&#34;CANCELLED(c/!)&#34;</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">      <span class="nv">org-todo-repeat-to-state</span> <span class="s">&#34;NEXT&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">org-todo-keyword-faces</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nb">quote</span> <span class="p">((</span><span class="s">&#34;NEXT&#34;</span> <span class="nb">:inherit</span> <span class="nv">warning</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">              <span class="p">(</span><span class="s">&#34;PROJECT&#34;</span> <span class="nb">:inherit</span> <span class="nv">font-lock-string-face</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;;; Agenda views</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; 将没有时间标记的任务，放在上方显示。</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">org-agenda-sort-notime-is-late</span> <span class="no">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; 时间显示为两位数(9:30 -&gt; 09:30)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">org-agenda-time-leading-zero</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; 过滤掉部分 tags</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">org-agenda-hide-tags-regexp</span> <span class="p">(</span><span class="nv">regexp-opt</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;dynamic&#34;</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">org-agenda-files</span> <span class="p">(</span><span class="nv">file-expand-wildcards</span> <span class="s">&#34;~/Dropbox/org/agenda/*.org&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq-default</span> <span class="nv">org-agenda-clockreport-parameter-plist</span> <span class="o">&#39;</span><span class="p">(</span><span class="nb">:link</span> <span class="no">t</span> <span class="nb">:maxlevel</span> <span class="mi">3</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">let</span> <span class="p">((</span><span class="nv">active-project-match</span> <span class="s">&#34;-INBOX/PROJECT&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">setq</span> <span class="nv">org-stuck-projects</span>
</span></span><span class="line"><span class="cl">        <span class="o">`</span><span class="p">(</span><span class="o">,</span><span class="nv">active-project-match</span> <span class="p">(</span><span class="s">&#34;NEXT&#34;</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">setq</span> <span class="nv">org-agenda-compact-blocks</span> <span class="no">t</span>
</span></span><span class="line"><span class="cl">        <span class="nv">org-agenda-sticky</span> <span class="no">t</span>
</span></span><span class="line"><span class="cl">        <span class="nv">org-agenda-start-on-weekday</span> <span class="no">nil</span>
</span></span><span class="line"><span class="cl">        <span class="nv">org-agenda-span</span> <span class="ss">&#39;day</span>
</span></span><span class="line"><span class="cl">        <span class="nv">org-agenda-include-diary</span> <span class="no">nil</span>
</span></span><span class="line"><span class="cl">        <span class="nv">org-agenda-sorting-strategy</span>
</span></span><span class="line"><span class="cl">        <span class="o">&#39;</span><span class="p">((</span><span class="nv">agenda</span> <span class="nv">habit-down</span> <span class="nv">time-up</span> <span class="nv">user-defined-up</span> <span class="nv">effort-up</span> <span class="nv">category-keep</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span><span class="nv">todo</span> <span class="nv">category-up</span> <span class="nv">effort-up</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span><span class="nv">tags</span> <span class="nv">category-up</span> <span class="nv">effort-up</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span><span class="nv">search</span> <span class="nv">category-up</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="nv">org-agenda-window-setup</span> <span class="ss">&#39;current-window</span>
</span></span><span class="line"><span class="cl">        <span class="nv">org-agenda-custom-commands</span>
</span></span><span class="line"><span class="cl">        <span class="o">`</span><span class="p">((</span><span class="s">&#34;N&#34;</span> <span class="s">&#34;Notes&#34;</span> <span class="nv">tags</span> <span class="s">&#34;NOTE&#34;</span>
</span></span><span class="line"><span class="cl">           <span class="p">((</span><span class="nv">org-agenda-overriding-header</span> <span class="s">&#34;Notes&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="nv">org-tags-match-list-sublevels</span> <span class="no">t</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span><span class="s">&#34;g&#34;</span> <span class="s">&#34;GTD&#34;</span>
</span></span><span class="line"><span class="cl">           <span class="p">((</span><span class="nv">agenda</span> <span class="s">&#34;&#34;</span> <span class="no">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="nv">tags</span> <span class="s">&#34;inbox&#34;</span>
</span></span><span class="line"><span class="cl">                  <span class="p">((</span><span class="nv">org-agenda-overriding-header</span> <span class="s">&#34;Inbox&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                   <span class="p">(</span><span class="nv">org-tags-match-list-sublevels</span> <span class="no">nil</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">            <span class="c1">;; (stuck &#34;&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="c1">;;        ((org-agenda-overriding-header &#34;Stuck Projects&#34;)</span>
</span></span><span class="line"><span class="cl">            <span class="c1">;;         (org-agenda-tags-todo-honor-ignore-options t)</span>
</span></span><span class="line"><span class="cl">            <span class="c1">;;         (org-tags-match-list-sublevels t)</span>
</span></span><span class="line"><span class="cl">            <span class="c1">;;         (org-agenda-todo-ignore-scheduled &#39;future)))</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="nv">tags-todo</span> <span class="s">&#34;-INBOX&#34;</span>
</span></span><span class="line"><span class="cl">                       <span class="p">((</span><span class="nv">org-agenda-overriding-header</span> <span class="s">&#34;Next Actions&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="p">(</span><span class="nv">org-agenda-tags-todo-honor-ignore-options</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="p">(</span><span class="nv">org-agenda-todo-ignore-scheduled</span> <span class="ss">&#39;future</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="p">(</span><span class="nv">org-agenda-skip-function</span>
</span></span><span class="line"><span class="cl">                         <span class="o">&#39;</span><span class="p">(</span><span class="nb">lambda</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">                            <span class="p">(</span><span class="nb">or</span> <span class="p">(</span><span class="nv">org-agenda-skip-subtree-if</span> <span class="ss">&#39;todo</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;HOLD&#34;</span> <span class="s">&#34;WAITING&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                                <span class="p">(</span><span class="nv">org-agenda-skip-entry-if</span> <span class="ss">&#39;nottodo</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;NEXT&#34;</span><span class="p">)))))</span>
</span></span><span class="line"><span class="cl">                        <span class="p">(</span><span class="nv">org-tags-match-list-sublevels</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="p">(</span><span class="nv">org-agenda-sorting-strategy</span>
</span></span><span class="line"><span class="cl">                         <span class="o">&#39;</span><span class="p">(</span><span class="nv">todo-state-down</span> <span class="nv">effort-up</span> <span class="nv">category-keep</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="nv">tags-todo</span> <span class="o">,</span><span class="nv">active-project-match</span>
</span></span><span class="line"><span class="cl">                       <span class="p">((</span><span class="nv">org-agenda-overriding-header</span> <span class="s">&#34;Projects&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="p">(</span><span class="nv">org-tags-match-list-sublevels</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="p">(</span><span class="nv">org-agenda-sorting-strategy</span>
</span></span><span class="line"><span class="cl">                         <span class="o">&#39;</span><span class="p">(</span><span class="nv">category-keep</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="nv">tags-todo</span> <span class="s">&#34;/WAITING&#34;</span>
</span></span><span class="line"><span class="cl">                       <span class="p">((</span><span class="nv">org-agenda-overriding-header</span> <span class="s">&#34;Waiting&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="p">(</span><span class="nv">org-agenda-tags-todo-honor-ignore-options</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="p">(</span><span class="nv">org-agenda-todo-ignore-scheduled</span> <span class="ss">&#39;future</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="p">(</span><span class="nv">org-agenda-sorting-strategy</span>
</span></span><span class="line"><span class="cl">                         <span class="o">&#39;</span><span class="p">(</span><span class="nv">category-keep</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="nv">tags-todo</span> <span class="s">&#34;/DELEGATED&#34;</span>
</span></span><span class="line"><span class="cl">                       <span class="p">((</span><span class="nv">org-agenda-overriding-header</span> <span class="s">&#34;Delegated&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="p">(</span><span class="nv">org-agenda-tags-todo-honor-ignore-options</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="p">(</span><span class="nv">org-agenda-todo-ignore-scheduled</span> <span class="ss">&#39;future</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="p">(</span><span class="nv">org-agenda-sorting-strategy</span>
</span></span><span class="line"><span class="cl">                         <span class="o">&#39;</span><span class="p">(</span><span class="nv">category-keep</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="nv">tags-todo</span> <span class="s">&#34;-INBOX&#34;</span>
</span></span><span class="line"><span class="cl">                       <span class="p">((</span><span class="nv">org-agenda-overriding-header</span> <span class="s">&#34;On Hold&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="p">(</span><span class="nv">org-agenda-skip-function</span>
</span></span><span class="line"><span class="cl">                         <span class="o">&#39;</span><span class="p">(</span><span class="nb">lambda</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">                            <span class="p">(</span><span class="nb">or</span> <span class="p">(</span><span class="nv">org-agenda-skip-subtree-if</span> <span class="ss">&#39;todo</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;WAITING&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                                <span class="p">(</span><span class="nv">org-agenda-skip-entry-if</span> <span class="ss">&#39;nottodo</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;HOLD&#34;</span><span class="p">)))))</span>
</span></span><span class="line"><span class="cl">                        <span class="p">(</span><span class="nv">org-tags-match-list-sublevels</span> <span class="no">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="p">(</span><span class="nv">org-agenda-sorting-strategy</span>
</span></span><span class="line"><span class="cl">                         <span class="o">&#39;</span><span class="p">(</span><span class="nv">category-keep</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="nv">tags-todo</span> <span class="s">&#34;-INBOX/-NEXT&#34;</span>
</span></span><span class="line"><span class="cl">                       <span class="p">((</span><span class="nv">org-agenda-overriding-header</span> <span class="s">&#34;Orphaned Tasks&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="p">(</span><span class="nv">org-agenda-tags-todo-honor-ignore-options</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="p">(</span><span class="nv">org-agenda-todo-ignore-scheduled</span> <span class="ss">&#39;future</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="p">(</span><span class="nv">org-agenda-skip-function</span>
</span></span><span class="line"><span class="cl">                         <span class="o">&#39;</span><span class="p">(</span><span class="nb">lambda</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">                            <span class="p">(</span><span class="nb">or</span> <span class="p">(</span><span class="nv">org-agenda-skip-subtree-if</span> <span class="ss">&#39;todo</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;PROJECT&#34;</span> <span class="s">&#34;HOLD&#34;</span> <span class="s">&#34;WAITING&#34;</span> <span class="s">&#34;DELEGATED&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                                <span class="p">(</span><span class="nv">org-agenda-skip-subtree-if</span> <span class="ss">&#39;nottododo</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;TODO&#34;</span><span class="p">)))))</span>
</span></span><span class="line"><span class="cl">                        <span class="p">(</span><span class="nv">org-tags-match-list-sublevels</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="p">(</span><span class="nv">org-agenda-sorting-strategy</span>
</span></span><span class="line"><span class="cl">                         <span class="o">&#39;</span><span class="p">(</span><span class="nv">category-keep</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">            <span class="c1">;; (tags-todo &#34;-NEXT&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="c1">;;            ((org-agenda-overriding-header &#34;All other TODOs&#34;)</span>
</span></span><span class="line"><span class="cl">            <span class="c1">;;             (org-match-list-sublevels t)))</span>
</span></span><span class="line"><span class="cl">            <span class="p">)))))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">add-hook</span> <span class="ss">&#39;org-agenda-mode-hook</span> <span class="ss">&#39;hl-line-mode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;;; Org clock</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;; Save the running clock and all clock history when exiting Emacs, load it on startup</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">with-eval-after-load</span> <span class="ss">&#39;org</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">org-clock-persistence-insinuate</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">org-clock-persist</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">org-clock-in-resume</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;; Save clock data and notes in the LOGBOOK drawer</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">org-clock-into-drawer</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; Save state changes in the LOGBOOK drawer</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">org-log-into-drawer</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; Removes clocked tasks with 0:00 duration</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">org-clock-out-remove-zero-time-clocks</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;; Show clock sums as hours and minutes, not &#34;n days&#34; etc.</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">org-time-clocksum-format</span>
</span></span><span class="line"><span class="cl">      <span class="o">&#39;</span><span class="p">(</span><span class="nb">:hours</span> <span class="s">&#34;%d&#34;</span> <span class="nb">:require-hours</span> <span class="no">t</span> <span class="nb">:minutes</span> <span class="s">&#34;:%02d&#34;</span> <span class="nb">:require-minutes</span> <span class="no">t</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;;; Show the clocked-in task - if any - in the header line</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">sanityinc/show-org-clock-in-header-line</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">setq-default</span> <span class="nv">header-line-format</span> <span class="o">&#39;</span><span class="p">((</span><span class="s">&#34; &#34;</span> <span class="nv">org-mode-line-string</span> <span class="s">&#34; &#34;</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">sanityinc/hide-org-clock-from-header-line</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">setq-default</span> <span class="nv">header-line-format</span> <span class="no">nil</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">add-hook</span> <span class="ss">&#39;org-clock-in-hook</span> <span class="ss">&#39;sanityinc/show-org-clock-in-header-line</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">add-hook</span> <span class="ss">&#39;org-clock-out-hook</span> <span class="ss">&#39;sanityinc/hide-org-clock-from-header-line</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">add-hook</span> <span class="ss">&#39;org-clock-cancel-hook</span> <span class="ss">&#39;sanityinc/hide-org-clock-from-header-line</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">with-eval-after-load</span> <span class="ss">&#39;org-clock</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nf">define-key</span> <span class="nv">org-clock-mode-line-map</span> <span class="p">[</span><span class="nv">header-line</span> <span class="nv">mouse-2</span><span class="p">]</span> <span class="ss">&#39;org-clock-goto</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nf">define-key</span> <span class="nv">org-clock-mode-line-map</span> <span class="p">[</span><span class="nv">header-line</span> <span class="nv">mouse-1</span><span class="p">]</span> <span class="ss">&#39;org-clock-menu</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nb">and</span> <span class="vg">*is-a-mac*</span> <span class="p">(</span><span class="nf">file-directory-p</span> <span class="s">&#34;/Applications/org-clock-statusbar.app&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">add-hook</span> <span class="ss">&#39;org-clock-in-hook</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="nb">lambda</span> <span class="p">()</span> <span class="p">(</span><span class="nf">call-process</span> <span class="s">&#34;/usr/bin/osascript&#34;</span> <span class="no">nil</span> <span class="mi">0</span> <span class="no">nil</span> <span class="s">&#34;-e&#34;</span>
</span></span><span class="line"><span class="cl">                                <span class="p">(</span><span class="nf">concat</span> <span class="s">&#34;tell application \&#34;org-clock-statusbar\&#34; to clock in \&#34;&#34;</span> <span class="nv">org-clock-current-task</span> <span class="s">&#34;\&#34;&#34;</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">add-hook</span> <span class="ss">&#39;org-clock-out-hook</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="nb">lambda</span> <span class="p">()</span> <span class="p">(</span><span class="nf">call-process</span> <span class="s">&#34;/usr/bin/osascript&#34;</span> <span class="no">nil</span> <span class="mi">0</span> <span class="no">nil</span> <span class="s">&#34;-e&#34;</span>
</span></span><span class="line"><span class="cl">                                <span class="s">&#34;tell application \&#34;org-clock-statusbar\&#34; to clock out&#34;</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;; TODO: warn about inconsistent items, e.g. TODO inside non-PROJECT</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; TODO: nested projects!</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;;; Archiving</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">org-archive-mark-done</span> <span class="no">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">org-archive-location</span> <span class="s">&#34;%s_archive::* Archive&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">require-package</span> <span class="ss">&#39;org-pomodoro</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">org-pomodoro-keep-killed-pomodoro-time</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">with-eval-after-load</span> <span class="ss">&#39;org-agenda</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nf">define-key</span> <span class="nv">org-agenda-mode-map</span> <span class="p">(</span><span class="nv">kbd</span> <span class="s">&#34;P&#34;</span><span class="p">)</span> <span class="ss">&#39;org-pomodoro</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;; ;; Show iCal calendars in the org agenda</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; (when (and *is-a-mac* (require &#39;org-mac-iCal nil t))</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;   (setq org-agenda-include-diary t</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;         org-agenda-custom-commands</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;         &#39;((&#34;I&#34; &#34;Import diary from iCal&#34; agenda &#34;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;            ((org-agenda-mode-hook #&#39;org-mac-iCal)))))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;;   (add-hook &#39;org-agenda-cleanup-fancy-diary-hook</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;             (lambda ()</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;               (goto-char (point-min))</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;               (save-excursion</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;                 (while (re-search-forward &#34;^[a-z]&#34; nil t)</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;                   (goto-char (match-beginning 0))</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;                   (insert &#34;0:00-24:00 &#34;)))</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;               (while (re-search-forward &#34;^ [a-z]&#34; nil t)</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;                 (goto-char (match-beginning 0))</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;                 (save-excursion</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;                   (re-search-backward &#34;^[0-9]+:[0-9]+-[0-9]+:[0-9]+ &#34; nil t))</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;                 (insert (match-string 0))))))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">with-eval-after-load</span> <span class="ss">&#39;org</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nf">define-key</span> <span class="nv">org-mode-map</span> <span class="p">(</span><span class="nv">kbd</span> <span class="s">&#34;C-M-&lt;up&gt;&#34;</span><span class="p">)</span> <span class="ss">&#39;org-up-element</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">when</span> <span class="vg">*is-a-mac*</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nf">define-key</span> <span class="nv">org-mode-map</span> <span class="p">(</span><span class="nv">kbd</span> <span class="s">&#34;M-h&#34;</span><span class="p">)</span> <span class="no">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nf">define-key</span> <span class="nv">org-mode-map</span> <span class="p">(</span><span class="nv">kbd</span> <span class="s">&#34;C-c g&#34;</span><span class="p">)</span> <span class="ss">&#39;grab-mac-link</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">with-eval-after-load</span> <span class="ss">&#39;org</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">org-babel-do-load-languages</span>
</span></span><span class="line"><span class="cl">   <span class="ss">&#39;org-babel-load-languages</span>
</span></span><span class="line"><span class="cl">   <span class="p">(</span><span class="nv">seq-filter</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">lambda</span> <span class="p">(</span><span class="nv">pair</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nb">featurep</span> <span class="p">(</span><span class="nf">intern</span> <span class="p">(</span><span class="nf">concat</span> <span class="s">&#34;ob-&#34;</span> <span class="p">(</span><span class="nf">symbol-name</span> <span class="p">(</span><span class="nf">car</span> <span class="nv">pair</span><span class="p">))))))</span>
</span></span><span class="line"><span class="cl">    <span class="o">&#39;</span><span class="p">((</span><span class="nv">R</span> <span class="o">.</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nv">ditaa</span> <span class="o">.</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nv">rust</span> <span class="o">.</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nv">dot</span> <span class="o">.</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nv">emacs-lisp</span> <span class="o">.</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nv">gnuplot</span> <span class="o">.</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nv">haskell</span> <span class="o">.</span> <span class="no">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nv">latex</span> <span class="o">.</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nv">ledger</span> <span class="o">.</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nv">ocaml</span> <span class="o">.</span> <span class="no">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nv">octave</span> <span class="o">.</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nv">ruby</span> <span class="o">.</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nv">screen</span> <span class="o">.</span> <span class="no">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nv">sh</span> <span class="o">.</span> <span class="no">t</span><span class="p">)</span> <span class="c1">;; obsolete</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nv">shell</span> <span class="o">.</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nv">sql</span> <span class="o">.</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nv">sqlite</span> <span class="o">.</span> <span class="no">t</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">      <span class="c1">;; plantuml</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">org-babel-do-load-languages</span>
</span></span><span class="line"><span class="cl">   <span class="ss">&#39;org-babel-load-languages</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="c1">;; other Babel languages</span>
</span></span><span class="line"><span class="cl">     <span class="p">(</span><span class="nv">plantuml</span> <span class="o">.</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">     <span class="p">(</span><span class="nv">python</span> <span class="o">.</span> <span class="no">t</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">setq</span>  <span class="nv">org-plantuml-jar-path</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nf">expand-file-name</span> <span class="s">&#34;~/Dropbox/org/planuml/plantuml.jar&#34;</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">  <span class="c1">;; 这里应该就是 .zshrc 里面配置的 python3</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">setq</span> <span class="nv">org-babel-python-command</span> <span class="s">&#34;python3&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">require-package</span> <span class="ss">&#39;emacsql-sqlite-builtin</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">use-package</span> <span class="nv">org-roam</span>
</span></span><span class="line"><span class="cl">  <span class="nb">:ensure</span> <span class="no">t</span>
</span></span><span class="line"><span class="cl">  <span class="nb">:demand</span> <span class="no">t</span> <span class="c1">;; ensure org-roam is loaded by default</span>
</span></span><span class="line"><span class="cl">  <span class="nb">:init</span>
</span></span><span class="line"><span class="cl">  <span class="nb">:custom</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">org-roam-directory</span> <span class="p">(</span><span class="nv">file-truename</span> <span class="s">&#34;~/Dropbox/org/&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="c1">;; 需要 emacs-plus@29 版本</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">org-roam-database-connector</span> <span class="ss">&#39;sqlite-builtin</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">org-roam-db-location</span> <span class="s">&#34;~/Dropbox/org/org.db&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">org-roam-db-gc-threshold</span> <span class="nv">most-positive-fixnum</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">org-roam-completion-everywhere</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">org-roam-capture-templates</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">     <span class="c1">;; #+OPTIONS: toc:nil 为了导出 .md 的格式更加符合使用</span>
</span></span><span class="line"><span class="cl">     <span class="p">(</span><span class="s">&#34;d&#34;</span> <span class="s">&#34;default&#34;</span> <span class="nv">plain</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nv">file</span> <span class="s">&#34;~/Dropbox/org/templates/default.org&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="nb">:if-new</span> <span class="p">(</span><span class="nv">file</span> <span class="s">&#34;main/%&lt;%Y%m%d%H%M%S&gt;-${slug}.org&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="nb">:unnarrowed</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">     <span class="p">(</span><span class="s">&#34;a&#34;</span> <span class="s">&#34;article&#34;</span> <span class="nv">plain</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nv">file</span> <span class="s">&#34;~/Dropbox/org/templates/article.org&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="nb">:if-new</span> <span class="p">(</span><span class="nv">file</span> <span class="s">&#34;article/%&lt;%Y%m%d%H%M%S&gt;-${slug}.org&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="nb">:unnarrowed</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">     <span class="p">(</span><span class="s">&#34;b&#34;</span> <span class="s">&#34;book notes&#34;</span> <span class="nv">plain</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nv">file</span> <span class="s">&#34;~/Dropbox/org/templates/book-notes.org&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="nb">:if-new</span> <span class="p">(</span><span class="nv">file</span> <span class="s">&#34;book/%&lt;%Y%m%d%H%M%S&gt;-${slug}.org&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="nb">:unnarrowed</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">     <span class="c1">;;  (&#34;p&#34; &#34;project&#34; plain &#34;* Goals\n\n%?\n\n* Tasks\n\n** TODO Add initial tasks\n\n* Dates\n\n&#34;</span>
</span></span><span class="line"><span class="cl">     <span class="c1">;;   :if-new (file+head &#34;%&lt;%Y%m%d%H%M%S&gt;-${slug}.org&#34; &#34;#+title: ${title}\n#+category: ${title}\n#+filetags: Project&#34;)</span>
</span></span><span class="line"><span class="cl">     <span class="c1">;;   :unnarrowed t)</span>
</span></span><span class="line"><span class="cl">     <span class="c1">;;  (&#34;l&#34; &#34;programming language&#34; plain</span>
</span></span><span class="line"><span class="cl">     <span class="c1">;;   &#34;* Reference:\n\n&#34;</span>
</span></span><span class="line"><span class="cl">     <span class="c1">;;   :if-new (file+head &#34;programming language/%&lt;%Y%m%d%H%M%S&gt;-${slug}.org&#34; &#34;#+title: ${title}\n#+OPTIONS: toc:nil\n&#34;)</span>
</span></span><span class="line"><span class="cl">     <span class="c1">;;   :unnarrowed t)</span>
</span></span><span class="line"><span class="cl">     <span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">org-roam-dailies-capture-templates</span>
</span></span><span class="line"><span class="cl">   <span class="c1">;; %&lt;%H:%M&gt; 为24小时制，%&lt;%I:%M %p&gt; 为12小时制</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">     <span class="p">(</span><span class="s">&#34;d&#34;</span> <span class="s">&#34;default&#34;</span> <span class="nv">entry</span> <span class="s">&#34;** %&lt;%H:%M&gt; %?&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="nb">:if-new</span> <span class="p">(</span><span class="nv">file+head+olp</span> <span class="s">&#34;%&lt;%Y-%m-%d&gt;.org&#34;</span> <span class="s">&#34;#+title: %&lt;%Y-%m-%d&gt;\n#+ARCHIVE: journal.org::\n&#34;</span> <span class="p">(</span><span class="s">&#34;%&lt;%Y-%m-%d&gt;&#34;</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">     <span class="p">(</span><span class="s">&#34;r&#34;</span> <span class="s">&#34;read&#34;</span> <span class="nv">entry</span> <span class="s">&#34;*** %?&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="nb">:if-new</span> <span class="p">(</span><span class="nv">file+head+olp</span> <span class="s">&#34;%&lt;%Y-%m-%d&gt;.org&#34;</span> <span class="s">&#34;#+title: %&lt;%Y-%m-%d&gt;\n#+ARCHIVE: journal.org::\n&#34;</span> <span class="p">(</span><span class="s">&#34;%&lt;%Y-%m-%d&gt;&#34;</span> <span class="s">&#34;What I read? :read:&#34;</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">     <span class="p">(</span><span class="s">&#34;t&#34;</span> <span class="s">&#34;tasks&#34;</span> <span class="nv">entry</span> <span class="s">&#34;*** %?&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="nb">:if-new</span> <span class="p">(</span><span class="nv">file+head+olp</span> <span class="s">&#34;%&lt;%Y-%m-%d&gt;.org&#34;</span> <span class="s">&#34;#+title: %&lt;%Y-%m-%d&gt;\n#+ARCHIVE: journal.org::\n&#34;</span> <span class="p">(</span><span class="s">&#34;%&lt;%Y-%m-%d&gt;&#34;</span> <span class="s">&#34;Tasks :task:&#34;</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">     <span class="p">(</span><span class="s">&#34;n&#34;</span> <span class="s">&#34;notes&#34;</span> <span class="nv">entry</span> <span class="s">&#34;*** %?&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="nb">:if-new</span> <span class="p">(</span><span class="nv">file+head+olp</span> <span class="s">&#34;%&lt;%Y-%m-%d&gt;.org&#34;</span> <span class="s">&#34;#+title: %&lt;%Y-%m-%d&gt;\n#+ARCHIVE: journal.org::\n&#34;</span> <span class="p">(</span><span class="s">&#34;%&lt;%Y-%m-%d&gt;&#34;</span> <span class="s">&#34;Notes :note:&#34;</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">     <span class="p">(</span><span class="s">&#34;o&#34;</span> <span class="s">&#34;online&#34;</span> <span class="nv">entry</span> <span class="s">&#34;** %&lt;%H:%M&gt; %? :online:&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="nb">:if-new</span> <span class="p">(</span><span class="nv">file+head+olp</span> <span class="s">&#34;%&lt;%Y-%m-%d&gt;.org&#34;</span> <span class="s">&#34;#+title: %&lt;%Y-%m-%d&gt;\n#+ARCHIVE: journal.org::\n&#34;</span> <span class="p">(</span><span class="s">&#34;%&lt;%Y-%m-%d&gt;&#34;</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">     <span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="nb">:bind</span> <span class="p">((</span><span class="s">&#34;C-c n l&#34;</span> <span class="o">.</span> <span class="nv">org-roam-buffer-toggle</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="p">(</span><span class="s">&#34;C-c n f&#34;</span> <span class="o">.</span> <span class="nv">org-roam-node-find</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="p">(</span><span class="s">&#34;C-c n i&#34;</span> <span class="o">.</span> <span class="nv">org-roam-node-insert</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="p">(</span><span class="s">&#34;C-c n j&#34;</span> <span class="o">.</span> <span class="nv">org-roam-dailies-capture-today</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="p">(</span><span class="s">&#34;C-c n I&#34;</span> <span class="o">.</span> <span class="nv">org-roam-node-insert-immediate</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="p">(</span><span class="s">&#34;C-c n m&#34;</span> <span class="o">.</span> <span class="nv">dired-copy-images-links</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="nb">:map</span> <span class="nv">org-mode-map</span>
</span></span><span class="line"><span class="cl">         <span class="c1">;; Ctrl-Alt-i</span>
</span></span><span class="line"><span class="cl">         <span class="p">(</span><span class="s">&#34;C-M-i&#34;</span> <span class="o">.</span> <span class="nv">completion-at-point</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="nb">:config</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">unless</span> <span class="p">(</span><span class="nf">file-exists-p</span> <span class="nv">org-roam-directory</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nv">make-directory</span> <span class="nv">org-roam-directory</span> <span class="no">t</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">org-roam-db-autosync-enable</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="c1">;;使用侧边栏而不是完整buffer</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">add-to-list</span> <span class="ss">&#39;display-buffer-alist</span>
</span></span><span class="line"><span class="cl">               <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;\\*org-roam\\*&#34;</span>
</span></span><span class="line"><span class="cl">                 <span class="p">(</span><span class="nv">display-buffer-in-direction</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                 <span class="p">(</span><span class="nv">direction</span> <span class="o">.</span> <span class="nv">right</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                 <span class="p">(</span><span class="nv">window-width</span> <span class="o">.</span> <span class="mf">0.33</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                 <span class="p">(</span><span class="nv">window-height</span> <span class="o">.</span> <span class="nv">fit-window-to-buffer</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">setq</span> <span class="nv">org-export-backends</span> <span class="p">(</span><span class="nb">quote</span> <span class="p">(</span><span class="nv">ascii</span> <span class="nv">html</span> <span class="nv">icalendar</span> <span class="nv">latex</span> <span class="nv">md</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">  <span class="c1">;; code hightlight</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">setq</span> <span class="nv">org-src-fontify-natively</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="c1">;; If using org-roam-protocol</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">require</span> <span class="ss">&#39;org-roam-protocol</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">require</span> <span class="ss">&#39;org-roam-export</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">require</span> <span class="ss">&#39;org-tempo</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="c1">;; Copy Done To-Dos to Today</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">defun</span> <span class="nv">org-roam-copy-todo-to-today</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">interactive</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">let</span> <span class="p">((</span><span class="nv">org-refile-keep</span> <span class="no">t</span><span class="p">)</span> <span class="c1">;; Set this to nil to delete the original!</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span><span class="nv">org-after-refile-insert-hook</span> <span class="nf">#&#39;</span><span class="nv">save-buffer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="nv">today-file</span>
</span></span><span class="line"><span class="cl">          <span class="nv">pos</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nb">save-window-excursion</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nv">org-roam-dailies-capture-today</span> <span class="no">t</span> <span class="s">&#34;t&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nb">setq</span> <span class="nv">today-file</span> <span class="p">(</span><span class="nf">buffer-file-name</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nb">setq</span> <span class="nv">pos</span> <span class="p">(</span><span class="nf">point</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">;; Only refile if the target file is different than the current file</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nb">unless</span> <span class="p">(</span><span class="nf">equal</span> <span class="p">(</span><span class="nv">file-truename</span> <span class="nv">today-file</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                     <span class="p">(</span><span class="nv">file-truename</span> <span class="p">(</span><span class="nf">buffer-file-name</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nv">org-refile</span> <span class="no">nil</span> <span class="no">nil</span> <span class="p">(</span><span class="nf">list</span> <span class="s">&#34;Tasks&#34;</span> <span class="nv">today-file</span> <span class="no">nil</span> <span class="nv">pos</span><span class="p">)))))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">add-to-list</span> <span class="ss">&#39;org-after-todo-state-change-hook</span>
</span></span><span class="line"><span class="cl">               <span class="p">(</span><span class="nb">lambda</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">                 <span class="c1">;; DONE 和 CANCELLED 的 To-Dos 自动复制到今日</span>
</span></span><span class="line"><span class="cl">                 <span class="c1">;; 同时过滤掉 habit 的 To-Dos</span>
</span></span><span class="line"><span class="cl">                 <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nb">and</span> <span class="p">(</span><span class="nb">or</span> <span class="p">(</span><span class="nf">equal</span> <span class="nv">org-state</span> <span class="s">&#34;DONE&#34;</span><span class="p">)</span> <span class="p">(</span><span class="nf">equal</span> <span class="nv">org-state</span> <span class="s">&#34;CANCELLED&#34;</span><span class="p">))</span> <span class="p">(</span><span class="nv">not</span> <span class="p">(</span><span class="nv">org-find-property</span> <span class="s">&#34;STYLE&#34;</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">                   <span class="p">(</span><span class="nv">org-roam-copy-todo-to-today</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">  <span class="c1">;; node-find 的时候展示文件夹</span>
</span></span><span class="line"><span class="cl">  <span class="c1">;; org-roam-node-type</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">cl-defmethod</span> <span class="nv">org-roam-node-type</span> <span class="p">((</span><span class="nv">node</span> <span class="nv">org-roam-node</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;Return the TYPE of NODE.&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">condition-case</span> <span class="no">nil</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nf">file-name-nondirectory</span>
</span></span><span class="line"><span class="cl">         <span class="p">(</span><span class="nf">directory-file-name</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span><span class="nf">file-name-directory</span>
</span></span><span class="line"><span class="cl">           <span class="p">(</span><span class="nv">file-relative-name</span> <span class="p">(</span><span class="nv">org-roam-node-file</span> <span class="nv">node</span><span class="p">)</span> <span class="nv">org-roam-directory</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="ne">error</span> <span class="s">&#34;&#34;</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;; 在记录的时候创建新的 node 时不退出当前状态，保存新建的 node。</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">org-roam-node-insert-immediate</span> <span class="p">(</span><span class="nv">arg</span> <span class="kp">&amp;rest</span> <span class="nv">args</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">interactive</span> <span class="s">&#34;P&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">let</span> <span class="p">((</span><span class="nv">args</span> <span class="p">(</span><span class="nb">push</span> <span class="nv">arg</span> <span class="nv">args</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nv">org-roam-capture-templates</span> <span class="p">(</span><span class="nf">list</span> <span class="p">(</span><span class="nf">append</span> <span class="p">(</span><span class="nf">car</span> <span class="nv">org-roam-capture-templates</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                                  <span class="o">&#39;</span><span class="p">(</span><span class="nb">:immediate-finish</span> <span class="no">t</span><span class="p">)))))</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nf">apply</span> <span class="nf">#&#39;</span><span class="nv">org-roam-node-insert</span> <span class="nv">args</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;; C-x d 进入 dired 模式，m 来标记对应需要复制链接的图片，C-c n m 即可复制到需要的图片插入文本。</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; source: https://org-roam.discourse.group/t/is-there-a-solution-for-images-organization-in-org-roam/925</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">dired-copy-images-links</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;Works only in dired-mode, put in kill-ring,
</span></span></span><span class="line"><span class="cl"><span class="s">  ready to be yanked in some other org-mode file,
</span></span></span><span class="line"><span class="cl"><span class="s">  the links of marked image files using file-name-base as #+CAPTION.
</span></span></span><span class="line"><span class="cl"><span class="s">  If no file marked then do it on all images files of directory.
</span></span></span><span class="line"><span class="cl"><span class="s">  No file is moved nor copied anywhere.
</span></span></span><span class="line"><span class="cl"><span class="s">  This is intended to be used with org-redisplay-inline-images.&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">interactive</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">if</span> <span class="p">(</span><span class="nv">derived-mode-p</span> <span class="ss">&#39;dired-mode</span><span class="p">)</span>                           <span class="c1">; if we are in dired-mode</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nb">let*</span> <span class="p">((</span><span class="nv">marked-files</span> <span class="p">(</span><span class="nv">dired-get-marked-files</span><span class="p">))</span>         <span class="c1">; get marked file list</span>
</span></span><span class="line"><span class="cl">             <span class="p">(</span><span class="nv">number-marked-files</span>                            <span class="c1">; store number of marked files</span>
</span></span><span class="line"><span class="cl">              <span class="p">(</span><span class="nf">string-to-number</span>                              <span class="c1">; as a number</span>
</span></span><span class="line"><span class="cl">               <span class="p">(</span><span class="nv">dired-number-of-marked-files</span><span class="p">))))</span>             <span class="c1">; for later reference</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nf">=</span> <span class="nv">number-marked-files</span> <span class="mi">0</span><span class="p">)</span>                      <span class="c1">; if none marked then</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span><span class="nv">dired-toggle-marks</span><span class="p">)</span>                               <span class="c1">; mark all files</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span><span class="nb">setq</span> <span class="nv">marked-files</span> <span class="p">(</span><span class="nv">dired-get-marked-files</span><span class="p">)))</span>      <span class="c1">; get marked file list</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nf">message</span> <span class="s">&#34;Files marked for copy&#34;</span><span class="p">)</span>                    <span class="c1">; info message</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nv">dired-number-of-marked-files</span><span class="p">)</span>                       <span class="c1">; marked files info</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nv">kill-new</span> <span class="s">&#34;\n&#34;</span><span class="p">)</span>                                      <span class="c1">; start with a newline</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nb">dolist</span> <span class="p">(</span><span class="nv">marked-file</span> <span class="nv">marked-files</span><span class="p">)</span>                   <span class="c1">; walk the marked files list</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nv">org-file-image-p</span> <span class="nv">marked-file</span><span class="p">)</span>               <span class="c1">; only on image files</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="nv">kill-append</span>                                     <span class="c1">; append image to kill-ring</span>
</span></span><span class="line"><span class="cl">             <span class="p">(</span><span class="nf">concat</span> <span class="s">&#34;#+CAPTION: &#34;</span>                           <span class="c1">; as caption,</span>
</span></span><span class="line"><span class="cl">                     <span class="p">(</span><span class="nv">file-name-base</span> <span class="nv">marked-file</span><span class="p">)</span>            <span class="c1">; use file-name-base</span>
</span></span><span class="line"><span class="cl">                     <span class="s">&#34;\n#+ATTR_ORG: :width 800&#34;</span>              <span class="c1">; img width</span>
</span></span><span class="line"><span class="cl">                     <span class="s">&#34;\n[[file:&#34;</span> <span class="nv">marked-file</span> <span class="s">&#34;]]\n\n&#34;</span><span class="p">)</span> <span class="no">nil</span><span class="p">)))</span><span class="c1">; link to marked-file</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nf">=</span> <span class="nv">number-marked-files</span> <span class="mi">0</span><span class="p">)</span>                      <span class="c1">; if none were marked then</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span><span class="nv">dired-toggle-marks</span><span class="p">)))</span>                             <span class="c1">; unmark all</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nf">message</span> <span class="s">&#34;Error: Does not work outside dired-mode&#34;</span><span class="p">)</span>      <span class="c1">; can&#39;t work not in dired-mode</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nf">ding</span><span class="p">)))</span>                                                 <span class="c1">; error sound</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;; Save the corresponding buffers</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">gtd-save-org-buffers</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;Save </span><span class="ss">`org-agenda-files&#39;</span><span class="s"> buffers without user confirmation.
</span></span></span><span class="line"><span class="cl"><span class="s">See also </span><span class="ss">`org-save-all-org-buffers&#39;</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">interactive</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nf">message</span> <span class="s">&#34;Saving org-agenda-files buffers...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">save-some-buffers</span> <span class="no">t</span> <span class="p">(</span><span class="nb">lambda</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">             <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nf">member</span> <span class="p">(</span><span class="nf">buffer-file-name</span><span class="p">)</span> <span class="nv">org-agenda-files</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">               <span class="no">t</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nf">message</span> <span class="s">&#34;Saving org-agenda-files buffers... done&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; Add it after refile</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">advice-add</span> <span class="ss">&#39;org-refile</span> <span class="nb">:after</span> <span class="p">(</span><span class="nb">lambda</span> <span class="p">(</span><span class="kp">&amp;rest</span> <span class="nv">_</span><span class="p">)</span> <span class="p">(</span><span class="nv">gtd-save-org-buffers</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">log-todo-next-creation-date</span> <span class="p">(</span><span class="kp">&amp;rest</span> <span class="nv">ignore</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;Log NEXT creation time in the property drawer under the key &#39;ACTIVATED&#39;&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nb">and</span> <span class="p">(</span><span class="nv">string=</span> <span class="p">(</span><span class="nv">org-get-todo-state</span><span class="p">)</span> <span class="s">&#34;NEXT&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">             <span class="p">(</span><span class="nv">not</span> <span class="p">(</span><span class="nv">org-entry-get</span> <span class="no">nil</span> <span class="s">&#34;ACTIVATED&#34;</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nv">org-entry-put</span> <span class="no">nil</span> <span class="s">&#34;ACTIVATED&#34;</span> <span class="p">(</span><span class="nf">format-time-string</span> <span class="s">&#34;[%Y-%m-%d]&#34;</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">add-hook</span> <span class="ss">&#39;org-after-todo-state-change-hook</span> <span class="nf">#&#39;</span><span class="nv">log-todo-next-creation-date</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;; Put the text property afterwards with an advice</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">my-org-agenda-override-header</span> <span class="p">(</span><span class="nv">orig-fun</span> <span class="kp">&amp;rest</span> <span class="nv">args</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;Change the face of the overriden header string if needed.
</span></span></span><span class="line"><span class="cl"><span class="s">The propertized header text is taken from </span><span class="ss">`org-agenda-overriding-header&#39;</span><span class="s">.
</span></span></span><span class="line"><span class="cl"><span class="s">The face is only changed if the overriding header is propertized with a face.&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">let</span> <span class="p">((</span><span class="nv">pt</span> <span class="p">(</span><span class="nf">point</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nv">header</span> <span class="nv">org-agenda-overriding-header</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nf">apply</span> <span class="nv">orig-fun</span> <span class="nv">args</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">;; Only replace if there is an overriding header and not an empty string.</span>
</span></span><span class="line"><span class="cl">    <span class="c1">;; And only if the header text has a face property.</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nb">and</span> <span class="nv">header</span> <span class="p">(</span><span class="nf">&gt;</span> <span class="p">(</span><span class="nf">length</span> <span class="nv">header</span><span class="p">)</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">               <span class="p">(</span><span class="nf">get-text-property</span> <span class="mi">0</span> <span class="ss">&#39;face</span> <span class="nv">header</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nb">save-excursion</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nf">goto-char</span> <span class="nv">pt</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1">;; Search for the header text.</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nf">search-forward</span> <span class="nv">header</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nb">unwind-protect</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="nb">progn</span>
</span></span><span class="line"><span class="cl">              <span class="p">(</span><span class="nv">read-only-mode</span> <span class="mi">-1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">              <span class="c1">;; Replace it with the propertized text.</span>
</span></span><span class="line"><span class="cl">              <span class="p">(</span><span class="nf">replace-match</span> <span class="nv">header</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span><span class="nv">read-only-mode</span> <span class="mi">1</span><span class="p">))))))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">my-org-agenda-override-header-add-advices</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;Add advices to make changing work in all agenda commands.&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">interactive</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">dolist</span> <span class="p">(</span><span class="nv">fun</span> <span class="o">&#39;</span><span class="p">(</span><span class="nv">org-agenda-list</span> <span class="nv">org-todo-list</span> <span class="nv">org-search-view</span> <span class="nv">org-tags-view</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nv">advice-add</span> <span class="nv">fun</span> <span class="nb">:around</span> <span class="nf">#&#39;</span><span class="nv">my-org-agenda-override-header</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">my-org-agenda-override-header-add-advices</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; 只显示 outline 下第一个 TODO</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">my-org-agenda-skip-all-siblings-but-first</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;Skip all but the first non-done entry.&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">let</span> <span class="p">(</span><span class="nv">should-skip-entry</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">unless</span> <span class="p">(</span><span class="nv">org-current-is-todo</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nb">setq</span> <span class="nv">should-skip-entry</span> <span class="no">t</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">save-excursion</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nb">while</span> <span class="p">(</span><span class="nb">and</span> <span class="p">(</span><span class="nv">not</span> <span class="nv">should-skip-entry</span><span class="p">)</span> <span class="p">(</span><span class="nv">org-goto-sibling</span> <span class="no">t</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nv">org-current-is-todo</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span><span class="nb">setq</span> <span class="nv">should-skip-entry</span> <span class="no">t</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">when</span> <span class="nv">should-skip-entry</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nb">or</span> <span class="p">(</span><span class="nv">outline-next-heading</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span><span class="nf">goto-char</span> <span class="p">(</span><span class="nf">point-max</span><span class="p">))))))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">org-current-is-todo</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">string=</span> <span class="s">&#34;TODO&#34;</span> <span class="p">(</span><span class="nv">org-get-todo-state</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">provide</span> <span class="ss">&#39;init-org</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;; init-org.el ends here</span>
</span></span></code></pre></div><h4 id="org-babel">Org-babel</h4>
<p>输出 <code>:results</code> 有不同的选项，其中 <code>silent</code> 是指：Do not insert results in the Org mode buffer, but echo them in the minibuffer. Usage example: ‘:results output silent’.</p>
<p>Rust 运行代码块，需要安装 <a href="https://github.com/brotzeit/rustic">GitHub - brotzeit/rustic: Rust development environment for Emacs</a>，具体执行的时候会提示需要安装 <code>lsp-mode</code>​，确定即可。</p>
<h4 id="plantuml">PlantUML</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">brew install graphviz
</span></span></code></pre></div><table>
<thead>
<tr>
<th>Type</th>
<th>Symbol</th>
</tr>
</thead>
<tbody>
<tr>
<td>Zero or One</td>
<td>o|&ndash;</td>
</tr>
<tr>
<td>Exactly One</td>
<td>||&ndash;</td>
</tr>
<tr>
<td>Zero or Many</td>
<td>}o&ndash;</td>
</tr>
<tr>
<td>One or Many</td>
<td>}|&ndash;</td>
</tr>
</tbody>
</table>
<pre tabindex="0"><code class="language-nil" data-lang="nil">@startumlg
scale 2
Entity01 }|..|| Entity02
Entity03 }o..o| Entity04
Entity05 ||--o{ Entity06
Entity07 |o--|| Entity08
@enduml
</code></pre><p>PlantUML 默认的样式比较古老，可以用更加现代一些的样式：<a href="https://github.com/xuanye/plantuml-style-c4">GitHub - xuanye/plantuml-style-c4: 自定义的plantuml 样式</a>。</p>
<figure>
    <img loading="lazy" src="/ox-hugo/ERD-example.jpg"/> 
</figure>

<h3 id="init-sis-dot-el">init-sis.el</h3>
<p>根据 meow 的 <code>insert mode</code> 切换，同时根据上下文来判断切换输入法；另外在特定 <code>mode</code> 下也切换输入法，使用更加顺滑。</p>
<p>需要安装 `macism`</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">brew tap laishulu/macism
</span></span><span class="line"><span class="cl">brew install macism
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-elisp" data-lang="elisp"><span class="line"><span class="cl"><span class="c1">;;; init-sis.el  --- Custom configuration</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;; Commentary</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">require-package</span> <span class="ss">&#39;sis</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; meow insert mode switch</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defvar</span> <span class="nv">meow-leaving-insert-mode-hook</span> <span class="no">nil</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;Hook to run when leaving meow insert mode.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defvar</span> <span class="nv">meow-entering-insert-mode-hook</span> <span class="no">nil</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;Hook to run when entering meow insert mode.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">add-hook</span> <span class="ss">&#39;meow-insert-mode-hook</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">lambda</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nb">if</span> <span class="nv">meow-insert-mode</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="nf">run-hooks</span> <span class="ss">&#39;meow-entering-insert-mode-hook</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span><span class="nf">run-hooks</span> <span class="ss">&#39;meow-leaving-insert-mode-hook</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">use-package</span> <span class="nv">sis</span>
</span></span><span class="line"><span class="cl">  <span class="nb">:config</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">setq</span> <span class="nv">sis-english-source</span> <span class="s">&#34;com.apple.keylayout.ABC&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">sis-ism-lazyman-config</span>
</span></span><span class="line"><span class="cl">   <span class="s">&#34;com.apple.keylayout.ABC&#34;</span>
</span></span><span class="line"><span class="cl">   <span class="s">&#34;im.rime.inputmethod.Squirrel.Rime&#34;</span> <span class="ss">&#39;macism</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="c1">;; enable the /cursor color/ mode</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">sis-global-cursor-color-mode</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="c1">;; enable the /respect/ mode</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">sis-global-respect-mode</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="c1">;; enable the /context/ mode for all buffers</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">sis-global-context-mode</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="c1">;; enable the /inline english/ mode for all buffers</span>
</span></span><span class="line"><span class="cl">  <span class="c1">;; (sis-global-inline-mode t)</span>
</span></span><span class="line"><span class="cl">  <span class="c1">;; not delete the head spaces</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">setq</span> <span class="nv">sis-inline-tighten-head-rule</span> <span class="no">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">setq</span> <span class="nv">sis-default-cursor-color</span> <span class="s">&#34;brown3&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">setq</span> <span class="nv">sis-other-cursor-color</span> <span class="s">&#34;orange&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">setq</span> <span class="nv">sis-prefix-override-keys</span> <span class="p">(</span><span class="nf">list</span> <span class="s">&#34;C-c&#34;</span> <span class="s">&#34;C-x&#34;</span> <span class="s">&#34;C-h&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">add-hook</span> <span class="ss">&#39;meow-leaving-insert-mode-hook</span> <span class="nf">#&#39;</span><span class="nv">sis-set-english</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">add-to-list</span> <span class="ss">&#39;sis-context-hooks</span> <span class="ss">&#39;meow-entering-insert-mode-hook</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="c1">;; org title 处切换 Rime，telega 聊天时切换 Rime。</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">add-to-list</span> <span class="ss">&#39;sis-context-detectors</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">lambda</span> <span class="p">(</span><span class="kp">&amp;rest</span> <span class="nv">_</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nb">or</span> <span class="p">(</span><span class="nb">and</span> <span class="p">(</span><span class="nf">eq</span> <span class="nv">major-mode</span> <span class="ss">&#39;org-mode</span><span class="p">)</span> <span class="p">(</span><span class="nv">org-at-heading-p</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="p">(</span><span class="nf">eq</span> <span class="nv">major-mode</span> <span class="ss">&#39;telega-chat-mode</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="ss">&#39;other</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">advice-add</span> <span class="ss">&#39;org-agenda-todo</span> <span class="nb">:before</span> <span class="nf">#&#39;</span><span class="nv">sis-set-english</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">advice-add</span> <span class="ss">&#39;hydra-org-agenda-menu/body</span> <span class="nb">:after</span> <span class="nf">#&#39;</span><span class="nv">sis-set-english</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="nb">:ensure</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">provide</span> <span class="ss">&#39;init-sis</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;; init-sis.el ends here</span>
</span></span></code></pre></div><h3 id="init-font-dot-el">init-font.el</h3>
<p>使用的是 <code>Iosevka</code> 和 <code>LXGW WenKai</code> 分别作为英文和中文字体，按照 1:1 缩放，偶数字号就可以做到等高等宽。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-elisp" data-lang="elisp"><span class="line"><span class="cl"><span class="c1">;;; init-font.el --- Dired customisations -*- lexical-binding: t -*-</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;; Commentary:</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;; Code:</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;; base on https://gist.github.com/coldnew/7398835</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">qiang-font-existsp</span> <span class="p">(</span><span class="nv">font</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">if</span> <span class="p">(</span><span class="nf">null</span> <span class="p">(</span><span class="nf">x-list-fonts</span> <span class="nv">font</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">      <span class="no">nil</span>
</span></span><span class="line"><span class="cl">    <span class="no">t</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; LXGW WenKai Mono 配合 Iosevka 按照 1:1 偶数字号就可以做到等高等宽。</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defvar</span> <span class="nv">zh-font-list</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;LXGW WenKai Mono&#34;</span> <span class="s">&#34;HanaMinB&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defvar</span> <span class="nv">en-font-list</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;Iosevka&#34;</span> <span class="s">&#34;Fira Code&#34;</span> <span class="s">&#34;IBM Plex Mono&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">qiang-make-font-string</span> <span class="p">(</span><span class="nv">font-name</span> <span class="nv">font-size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">if</span> <span class="p">(</span><span class="nb">and</span> <span class="p">(</span><span class="nf">stringp</span> <span class="nv">font-size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">           <span class="p">(</span><span class="nf">equal</span> <span class="s">&#34;:&#34;</span> <span class="p">(</span><span class="nf">string</span> <span class="p">(</span><span class="nf">elt</span> <span class="nv">font-size</span> <span class="mi">0</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nf">format</span> <span class="s">&#34;%s%s&#34;</span> <span class="nv">font-name</span> <span class="nv">font-size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nf">format</span> <span class="s">&#34;%s %s&#34;</span> <span class="nv">font-name</span> <span class="nv">font-size</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">qiang-set-font</span> <span class="p">(</span><span class="nv">english-fonts</span>
</span></span><span class="line"><span class="cl">                       <span class="nv">english-font-size</span>
</span></span><span class="line"><span class="cl">                       <span class="nv">chinese-fonts</span>
</span></span><span class="line"><span class="cl">                       <span class="kp">&amp;optional</span> <span class="nv">chinese-font-scale</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">setq</span> <span class="nv">chinese-font-scale</span> <span class="p">(</span><span class="nb">or</span> <span class="nv">chinese-font-scale</span> <span class="mi">1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">setq</span> <span class="nv">face-font-rescale-alist</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nb">cl-loop</span> <span class="nv">for</span> <span class="nv">x</span> <span class="nv">in</span> <span class="nv">zh-font-list</span>
</span></span><span class="line"><span class="cl">              <span class="nv">collect</span> <span class="p">(</span><span class="nf">cons</span> <span class="nv">x</span> <span class="nv">chinese-font-scale</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="s">&#34;english-font-size could be set to \&#34;:pixelsize=18\&#34; or a integer.
</span></span></span><span class="line"><span class="cl"><span class="s">If set/leave chinese-font-scale to nil, it will follow english-font-size&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">let</span> <span class="p">((</span><span class="nv">en-font</span> <span class="p">(</span><span class="nv">qiang-make-font-string</span>
</span></span><span class="line"><span class="cl">                  <span class="p">(</span><span class="nv">cl-find-if</span> <span class="nf">#&#39;</span><span class="nv">qiang-font-existsp</span> <span class="nv">english-fonts</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                  <span class="nv">english-font-size</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nv">zh-font</span> <span class="p">(</span><span class="nf">font-spec</span> <span class="nb">:family</span> <span class="p">(</span><span class="nv">cl-find-if</span> <span class="nf">#&#39;</span><span class="nv">qiang-font-existsp</span> <span class="nv">chinese-fonts</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">;; Set the default English font</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nf">message</span> <span class="s">&#34;Set English Font to %s&#34;</span> <span class="nv">en-font</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nv">set-face-attribute</span> <span class="ss">&#39;default</span> <span class="no">nil</span> <span class="nb">:font</span> <span class="nv">en-font</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">;; Set Chinese font</span>
</span></span><span class="line"><span class="cl">    <span class="c1">;; Do not use &#39;unicode charset, it will cause the English font setting invalid</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nf">message</span> <span class="s">&#34;Set Chinese Font to %s&#34;</span> <span class="nv">zh-font</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">dolist</span> <span class="p">(</span><span class="nv">charset</span> <span class="o">&#39;</span><span class="p">(</span><span class="nv">kana</span> <span class="nv">han</span> <span class="nv">symbol</span> <span class="nv">cjk-misc</span> <span class="nv">bopomofo</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nf">set-fontset-font</span> <span class="p">(</span><span class="nf">frame-parameter</span> <span class="no">nil</span> <span class="ss">&#39;font</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="nv">charset</span> <span class="nv">zh-font</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">qiang-set-font</span> <span class="nv">en-font-list</span> <span class="mi">14</span> <span class="nv">zh-font-list</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">provide</span> <span class="ss">&#39;init-font</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;; init-font.el ends here</span>
</span></span></code></pre></div><h3 id="init-ebib-dot-el">init-ebib.el</h3>
<p>管理 Bibtex 可以方便在文章中引用，以及新增读书笔记，结合 agenda 更好的管理读书条目以及进度。（这部份配置需要精简，目前用的比较简单。）</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-elisp" data-lang="elisp"><span class="line"><span class="cl"><span class="c1">;;; init-ebib.el  --- Custom configuration</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;; Commentary</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">use-package</span> <span class="nv">bibtex</span>
</span></span><span class="line"><span class="cl">  <span class="nb">:defer</span> <span class="no">t</span>
</span></span><span class="line"><span class="cl">  <span class="nb">:config</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">setq</span> <span class="nv">bibtex-file-path</span> <span class="s">&#34;~/Dropbox/org/bib/&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">bibtex-files</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;bibtex.bib&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nv">bibtex-notes-path</span> <span class="s">&#34;~/Dropbox/org/references/&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nv">bibtex-align-at-equal-sign</span> <span class="no">t</span>
</span></span><span class="line"><span class="cl">        <span class="nv">bibtex-autokey-titleword-separator</span> <span class="s">&#34;-&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">bibtex-autokey-year-title-separator</span> <span class="s">&#34;-&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">bibtex-autokey-name-year-separator</span> <span class="s">&#34;-&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">bibtex-dialect</span> <span class="ss">&#39;biblatex</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">use-package</span> <span class="nv">ebib</span>
</span></span><span class="line"><span class="cl">  <span class="nb">:straight</span> <span class="no">t</span>
</span></span><span class="line"><span class="cl">  <span class="nb">:commands</span> <span class="nv">ebib-zotero-protocol-handler</span>
</span></span><span class="line"><span class="cl">  <span class="nb">:init</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">with-eval-after-load</span> <span class="ss">&#39;org-protocol</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">push</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;ebib-zotero&#34;</span> <span class="nb">:protocol</span> <span class="s">&#34;ebib-zotero&#34;</span> <span class="nb">:function</span> <span class="nv">ebib-zotero-protocol-handler</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="nv">org-protocol-protocol-alist</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="nb">:config</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">setq</span> <span class="nv">ebib-default-directory</span> <span class="nv">bibtex-file-path</span>
</span></span><span class="line"><span class="cl">        <span class="nv">ebib-bib-search-dirs</span> <span class="o">`</span><span class="p">(</span><span class="o">,</span><span class="nv">bibtex-file-path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nv">ebib-file-search-dirs</span> <span class="o">`</span><span class="p">(</span><span class="o">,</span><span class="p">(</span><span class="nf">concat</span> <span class="nv">bibtex-file-path</span> <span class="s">&#34;files/&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="nv">ebib-notes-directory</span> <span class="nv">bibtex-notes-path</span>
</span></span><span class="line"><span class="cl">        <span class="nv">ebib-reading-list-file</span> <span class="s">&#34;~/Dropbox/org/agenda/books.org&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nv">ebib-bibtex-dialect</span> <span class="nv">bibtex-dialect</span>
</span></span><span class="line"><span class="cl">        <span class="nv">ebib-file-associations</span> <span class="o">&#39;</span><span class="p">((</span><span class="s">&#34;pdf&#34;</span> <span class="o">.</span> <span class="s">&#34;open&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="nv">ebib-index-default-sort</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;timestamp&#34;</span> <span class="o">.</span> <span class="nv">descend</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nv">ebib-notes-template</span> <span class="s">&#34;:PROPERTIES:
</span></span></span><span class="line"><span class="cl"><span class="s">                             :ID:       %i
</span></span></span><span class="line"><span class="cl"><span class="s">                             :ROAM_REFS: @%k
</span></span></span><span class="line"><span class="cl"><span class="s">                             :END:
</span></span></span><span class="line"><span class="cl"><span class="s">                             #+title: %t
</span></span></span><span class="line"><span class="cl"><span class="s">                             #+description: %d
</span></span></span><span class="line"><span class="cl"><span class="s">                             #+date: %s
</span></span></span><span class="line"><span class="cl"><span class="s">                             %%?&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">ebib-notes-template-specifiers</span> <span class="o">&#39;</span><span class="p">((</span><span class="sc">?k</span> <span class="o">.</span> <span class="nv">ebib-create-key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                         <span class="p">(</span><span class="sc">?i</span> <span class="o">.</span> <span class="nv">ebib-create-id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                         <span class="p">(</span><span class="sc">?t</span> <span class="o">.</span> <span class="nv">ebib-create-org-title</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                         <span class="p">(</span><span class="sc">?d</span> <span class="o">.</span> <span class="nv">ebib-create-org-description</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                         <span class="p">(</span><span class="sc">?l</span> <span class="o">.</span> <span class="nv">ebib-create-org-link</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                         <span class="p">(</span><span class="sc">?s</span> <span class="o">.</span> <span class="nv">ebib-create-org-time-stamp</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="nv">ebib-preload-bib-files</span> <span class="nv">bibtex-files</span>
</span></span><span class="line"><span class="cl">        <span class="nv">ebib-use-timestamp</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">defun</span> <span class="nv">ebib-create-key</span> <span class="p">(</span><span class="nv">key</span> <span class="nv">_db</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;Return the KEY in DB for the Org mode note.&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nf">format</span> <span class="s">&#34;%s&#34;</span> <span class="nv">key</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">defun</span> <span class="nv">ebib-create-id</span> <span class="p">(</span><span class="nv">_key</span> <span class="nv">_db</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;Create an ID for the Org mode note.&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nv">org-id-new</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">defun</span> <span class="nv">ebib-create-org-time-stamp</span> <span class="p">(</span><span class="nv">_key</span> <span class="nv">_db</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;Create timestamp for the Org mode note.&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nf">format</span> <span class="s">&#34;%s&#34;</span> <span class="p">(</span><span class="nb">with-temp-buffer</span> <span class="p">(</span><span class="nv">org-insert-time-stamp</span> <span class="no">nil</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">;; ebib-zotero</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">defcustom</span> <span class="nv">ebib-zotero-translation-server</span> <span class="s">&#34;https://translate.manubot.org&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;The address of Zotero translation server.&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">:group</span> <span class="ss">&#39;ebib</span>
</span></span><span class="line"><span class="cl">    <span class="nb">:type</span> <span class="ss">&#39;string</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">defun</span> <span class="nv">ebib-zotero-translate</span> <span class="p">(</span><span class="nv">item</span> <span class="nv">server-path</span> <span class="kp">&amp;optional</span> <span class="nv">export-format</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;Convert item to EXPORT-FORMAT entry through </span><span class="ss">`ebib-zotero-translation-server&#39;</span><span class="s">.&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">let</span> <span class="p">((</span><span class="nv">export-format</span> <span class="p">(</span><span class="nb">or</span> <span class="nv">export-format</span>
</span></span><span class="line"><span class="cl">                             <span class="p">(</span><span class="nf">downcase</span> <span class="p">(</span><span class="nf">symbol-name</span> <span class="p">(</span><span class="nf">intern-soft</span> <span class="nv">bibtex-dialect</span><span class="p">))))))</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nv">shell-command-to-string</span>
</span></span><span class="line"><span class="cl">       <span class="p">(</span><span class="nf">format</span> <span class="s">&#34;curl -s -d &#39;%s&#39; -H &#39;Content-Type: text/plain&#39; &#39;%s/%s&#39; | curl -s -d @- -H &#39;Content-Type: application/json&#39; &#39;%s/export?format=%s&#39;&#34;</span> <span class="nv">item</span> <span class="nv">ebib-zotero-translation-server</span> <span class="nv">server-path</span> <span class="nv">ebib-zotero-translation-server</span> <span class="nv">export-format</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">defun</span> <span class="nv">ebib-zotero-import-url</span> <span class="p">(</span><span class="nv">url</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;Fetch a entry from zotero translation server via a URL.
</span></span></span><span class="line"><span class="cl"><span class="s">The entry is stored in the current database.&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">interactive</span> <span class="s">&#34;MURL: &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">with-temp-buffer</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nf">insert</span> <span class="p">(</span><span class="nv">ebib-zotero-translate</span> <span class="nv">url</span> <span class="s">&#34;web&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nv">when-let</span> <span class="p">((</span><span class="nv">entry-keys</span> <span class="p">(</span><span class="nv">ebib-import-entries</span> <span class="nv">ebib--cur-db</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nb">if</span> <span class="p">(</span><span class="nv">ebib--goto-entry-in-index</span> <span class="p">(</span><span class="nf">car</span> <span class="nv">entry-keys</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="nv">ebib--update-entry-buffer</span><span class="p">)))))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">defun</span> <span class="nv">ebib-zotero-import-identifier</span> <span class="p">(</span><span class="nv">identifier</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;Fetch a entry from zotero translation server via an IDENTIFIER.
</span></span></span><span class="line"><span class="cl"><span class="s">The entry is stored in the current database,
</span></span></span><span class="line"><span class="cl"><span class="s">and the identifier can be DOI, ISBN, PMID, or arXiv ID.&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">interactive</span> <span class="s">&#34;MIDENTIFIER: &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">with-temp-buffer</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nf">insert</span> <span class="p">(</span><span class="nv">ebib-zotero-translate</span> <span class="nv">identifier</span> <span class="s">&#34;search&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nv">when-let</span> <span class="p">((</span><span class="nv">entry-keys</span> <span class="p">(</span><span class="nv">ebib-import-entries</span> <span class="nv">ebib--cur-db</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nb">if</span> <span class="p">(</span><span class="nv">ebib--goto-entry-in-index</span> <span class="p">(</span><span class="nf">car</span> <span class="nv">entry-keys</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="nv">ebib--update-entry-buffer</span><span class="p">)))))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">defun</span> <span class="nv">ebib-zotero-protocol-handler</span> <span class="p">(</span><span class="nv">info</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;Process an org-protocol://ebib-zotero?href= style url with INFO.
</span></span></span><span class="line"><span class="cl"><span class="s">Calls </span><span class="ss">`ebib-zotero-import-url&#39;</span><span class="s"> with the provided URI to add a
</span></span></span><span class="line"><span class="cl"><span class="s">new BibTeX entry to the current database.
</span></span></span><span class="line"><span class="cl"><span class="s">Add the following as a browser bookmark to use:
</span></span></span><span class="line"><span class="cl"><span class="s">    javascript:location.href = \\=&#39;org-protocol://ebib-zotero?href=\\=&#39;+ \\
</span></span></span><span class="line"><span class="cl"><span class="s">            encodeURIComponent(location.href)&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">unless</span> <span class="p">(</span><span class="nf">plist-get</span> <span class="nv">info</span> <span class="nb">:href</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="ne">user-error</span> <span class="s">&#34;No URI provided&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nv">ebib</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nv">ebib-zotero-import-url</span> <span class="p">(</span><span class="nf">plist-get</span> <span class="nv">info</span> <span class="nb">:href</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">provide</span> <span class="ss">&#39;init-ebib</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;; init-ebib.el ends here</span>
</span></span></code></pre></div><h3 id="init-meow-dot-el">init-meow.el</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-elisp" data-lang="elisp"><span class="line"><span class="cl"><span class="c1">;;; init-meow.el  --- Custom configuration</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;; Commentary</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">require-package</span> <span class="ss">&#39;meow</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">require</span> <span class="ss">&#39;meow</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">meow-setup</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">setq</span> <span class="nv">meow-cheatsheet-layout</span> <span class="nv">meow-cheatsheet-layout-qwerty</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">meow-motion-overwrite-define-key</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;j&#34;</span> <span class="o">.</span> <span class="nv">meow-next</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;k&#34;</span> <span class="o">.</span> <span class="nv">meow-prev</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;&lt;escape&gt;&#34;</span> <span class="o">.</span> <span class="nv">ignore</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">meow-leader-define-key</span>
</span></span><span class="line"><span class="cl">   <span class="c1">;; SPC j/k will run the original command in MOTION state.</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;j&#34;</span> <span class="o">.</span> <span class="s">&#34;H-j&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;k&#34;</span> <span class="o">.</span> <span class="s">&#34;H-k&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="c1">;; Use SPC (0-9) for digit arguments.</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;1&#34;</span> <span class="o">.</span> <span class="nv">meow-digit-argument</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;2&#34;</span> <span class="o">.</span> <span class="nv">meow-digit-argument</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;3&#34;</span> <span class="o">.</span> <span class="nv">meow-digit-argument</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;4&#34;</span> <span class="o">.</span> <span class="nv">meow-digit-argument</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;5&#34;</span> <span class="o">.</span> <span class="nv">meow-digit-argument</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;6&#34;</span> <span class="o">.</span> <span class="nv">meow-digit-argument</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;7&#34;</span> <span class="o">.</span> <span class="nv">meow-digit-argument</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;8&#34;</span> <span class="o">.</span> <span class="nv">meow-digit-argument</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;9&#34;</span> <span class="o">.</span> <span class="nv">meow-digit-argument</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;0&#34;</span> <span class="o">.</span> <span class="nv">meow-digit-argument</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;/&#34;</span> <span class="o">.</span> <span class="nv">meow-keypad-describe-key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;?&#34;</span> <span class="o">.</span> <span class="nv">meow-cheatsheet</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">meow-normal-define-key</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;0&#34;</span> <span class="o">.</span> <span class="nv">meow-expand-0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;9&#34;</span> <span class="o">.</span> <span class="nv">meow-expand-9</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;8&#34;</span> <span class="o">.</span> <span class="nv">meow-expand-8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;7&#34;</span> <span class="o">.</span> <span class="nv">meow-expand-7</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;6&#34;</span> <span class="o">.</span> <span class="nv">meow-expand-6</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;5&#34;</span> <span class="o">.</span> <span class="nv">meow-expand-5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;4&#34;</span> <span class="o">.</span> <span class="nv">meow-expand-4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;3&#34;</span> <span class="o">.</span> <span class="nv">meow-expand-3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;2&#34;</span> <span class="o">.</span> <span class="nv">meow-expand-2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;1&#34;</span> <span class="o">.</span> <span class="nv">meow-expand-1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;-&#34;</span> <span class="o">.</span> <span class="nv">negative-argument</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;;&#34;</span> <span class="o">.</span> <span class="nv">meow-reverse</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;,&#34;</span> <span class="o">.</span> <span class="nv">meow-inner-of-thing</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;.&#34;</span> <span class="o">.</span> <span class="nv">meow-bounds-of-thing</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;[&#34;</span> <span class="o">.</span> <span class="nv">meow-beginning-of-thing</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;]&#34;</span> <span class="o">.</span> <span class="nv">meow-end-of-thing</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;a&#34;</span> <span class="o">.</span> <span class="nv">meow-append</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;A&#34;</span> <span class="o">.</span> <span class="nv">meow-open-below</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;b&#34;</span> <span class="o">.</span> <span class="nv">meow-back-word</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;B&#34;</span> <span class="o">.</span> <span class="nv">meow-back-symbol</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;c&#34;</span> <span class="o">.</span> <span class="nv">meow-change</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;d&#34;</span> <span class="o">.</span> <span class="nv">meow-delete</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;D&#34;</span> <span class="o">.</span> <span class="nv">meow-backward-delete</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;e&#34;</span> <span class="o">.</span> <span class="nv">meow-next-word</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;E&#34;</span> <span class="o">.</span> <span class="nv">meow-next-symbol</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;f&#34;</span> <span class="o">.</span> <span class="nv">meow-find</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;g&#34;</span> <span class="o">.</span> <span class="nv">meow-cancel-selection</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;G&#34;</span> <span class="o">.</span> <span class="nv">meow-grab</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;h&#34;</span> <span class="o">.</span> <span class="nv">meow-left</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;H&#34;</span> <span class="o">.</span> <span class="nv">meow-left-expand</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;i&#34;</span> <span class="o">.</span> <span class="nv">meow-insert</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;I&#34;</span> <span class="o">.</span> <span class="nv">meow-open-above</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;j&#34;</span> <span class="o">.</span> <span class="nv">meow-next</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;J&#34;</span> <span class="o">.</span> <span class="nv">meow-next-expand</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;k&#34;</span> <span class="o">.</span> <span class="nv">meow-prev</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;K&#34;</span> <span class="o">.</span> <span class="nv">meow-prev-expand</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;l&#34;</span> <span class="o">.</span> <span class="nv">meow-right</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;L&#34;</span> <span class="o">.</span> <span class="nv">meow-right-expand</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;m&#34;</span> <span class="o">.</span> <span class="nv">meow-join</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;n&#34;</span> <span class="o">.</span> <span class="nv">meow-search</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;o&#34;</span> <span class="o">.</span> <span class="nv">meow-block</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;O&#34;</span> <span class="o">.</span> <span class="nv">meow-to-block</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;p&#34;</span> <span class="o">.</span> <span class="nv">meow-yank</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;q&#34;</span> <span class="o">.</span> <span class="nv">meow-quit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;Q&#34;</span> <span class="o">.</span> <span class="nv">meow-goto-line</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;r&#34;</span> <span class="o">.</span> <span class="nv">meow-replace</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;R&#34;</span> <span class="o">.</span> <span class="nv">meow-swap-grab</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;s&#34;</span> <span class="o">.</span> <span class="nv">meow-kill</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;t&#34;</span> <span class="o">.</span> <span class="nv">meow-till</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;u&#34;</span> <span class="o">.</span> <span class="nv">meow-undo</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;U&#34;</span> <span class="o">.</span> <span class="nv">meow-undo-in-selection</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;v&#34;</span> <span class="o">.</span> <span class="nv">meow-visit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;w&#34;</span> <span class="o">.</span> <span class="nv">meow-mark-word</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;W&#34;</span> <span class="o">.</span> <span class="nv">meow-mark-symbol</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;x&#34;</span> <span class="o">.</span> <span class="nv">meow-line</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;X&#34;</span> <span class="o">.</span> <span class="nv">meow-goto-line</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;y&#34;</span> <span class="o">.</span> <span class="nv">meow-save</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;Y&#34;</span> <span class="o">.</span> <span class="nv">meow-sync-grab</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;z&#34;</span> <span class="o">.</span> <span class="nv">meow-pop-selection</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;&#39;&#34;</span> <span class="o">.</span> <span class="nv">repeat</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;&lt;escape&gt;&#34;</span> <span class="o">.</span> <span class="nv">ignore</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">meow-setup</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">meow-global-mode</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">provide</span> <span class="ss">&#39;init-meow</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;; init-meow.el ends here</span>
</span></span></code></pre></div><h3 id="beancount-dot-el">beancount.el</h3>
<p><a href="https://github.com/beancount/beancount-mode">GitHub - beancount/beancount-mode: Emacs major-mode to work with Beancount le&hellip;</a>，这里是将其中的 <code>beancount.el</code> 下载到 <code>.emacs.d/lisp/</code> 目录下，加上下列代码。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-elisp" data-lang="elisp"><span class="line"><span class="cl"><span class="p">(</span><span class="nv">add-to-list</span> <span class="ss">&#39;auto-mode-alist</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;\\.beancount\\&#39;&#34;</span> <span class="o">.</span> <span class="nv">beancount-mode</span><span class="p">))</span>
</span></span></code></pre></div><h3 id="init-epla-dot-el">init-epla.el</h3>
<p>增加 <code>use-package</code> 和 <code>straight</code> 的支持</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-elisp" data-lang="elisp"><span class="line"><span class="cl"><span class="c1">;; Bootstrap `use-package&#39;</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">unless</span> <span class="p">(</span><span class="nv">package-installed-p</span> <span class="ss">&#39;use-package</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">package-refresh-contents</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">package-install</span> <span class="ss">&#39;use-package</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">eval-and-compile</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">setq</span> <span class="nv">use-package-always-ensure</span> <span class="no">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">setq</span> <span class="nv">use-package-always-defer</span> <span class="no">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">setq</span> <span class="nv">use-package-always-demand</span> <span class="no">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">setq</span> <span class="nv">use-package-expand-minimally</span> <span class="no">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">setq</span> <span class="nv">use-package-enable-imenu-support</span> <span class="no">t</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">eval-when-compile</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">require</span> <span class="ss">&#39;use-package</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;; Install straight.el</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defvar</span> <span class="nv">bootstrap-version</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">let</span> <span class="p">((</span><span class="nv">bootstrap-file</span>
</span></span><span class="line"><span class="cl">       <span class="p">(</span><span class="nf">expand-file-name</span> <span class="s">&#34;straight/repos/straight.el/bootstrap.el&#34;</span> <span class="nv">user-emacs-directory</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nv">bootstrap-version</span> <span class="mi">5</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">unless</span> <span class="p">(</span><span class="nf">file-exists-p</span> <span class="nv">bootstrap-file</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">with-current-buffer</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nv">url-retrieve-synchronously</span>
</span></span><span class="line"><span class="cl">         <span class="s">&#34;https://raw.githubusercontent.com/raxod502/straight.el/develop/install.el&#34;</span>
</span></span><span class="line"><span class="cl">         <span class="ss">&#39;silent</span> <span class="ss">&#39;inhibit-cookies</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nf">goto-char</span> <span class="p">(</span><span class="nf">point-max</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nv">eval-print-last-sexp</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nf">load</span> <span class="nv">bootstrap-file</span> <span class="no">nil</span> <span class="ss">&#39;nomessage</span><span class="p">))</span>
</span></span></code></pre></div><h3 id="init-local-dot-el">init-local.el</h3>
<p>在 <code>init.el</code> 中有如下代码。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-elisp" data-lang="elisp"><span class="line"><span class="cl"><span class="c1">;; Allow users to provide an optional &#34;init-local&#34; containing personal settings</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">require</span> <span class="ss">&#39;init-local</span> <span class="no">nil</span> <span class="no">t</span><span class="p">)</span>
</span></span></code></pre></div><p>默认没有 <code>init-local.org</code> 这个文件，创建一个，就可以往里面塞自己的配置了。</p>
<h4 id="consult">Consult</h4>
<p>Purcell 中已经包含了这个 package，也有 <code>consult-ripgrep</code> 这个方法。需要安装 <code>ripgrep</code>​。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">brew install ripgrep
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-elisp" data-lang="elisp"><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">bms/org-roam-rg-search</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;Search org-roam directory using consult-ripgrep. With live-preview.&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">interactive</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">let</span> <span class="p">((</span><span class="nv">consult-ripgrep-command</span> <span class="s">&#34;rg --null --ignore-case --type org --line-buffered --color=always --max-columns=500 --no-heading --line-number . -e ARG OPTS&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nv">consult-ripgrep</span> <span class="nv">org-roam-directory</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">global-set-key</span> <span class="p">(</span><span class="nv">kbd</span> <span class="s">&#34;C-c rr&#34;</span><span class="p">)</span> <span class="ss">&#39;bms/org-roam-rg-search</span><span class="p">)</span>
</span></span></code></pre></div><p>搜索 <code>org-roam-directory</code> 下的内容。</p>
<h4 id="deft">Deft</h4>
<p>用作一些不想放在 <code>org-roam</code> 中的一些笔记的操作。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-elisp" data-lang="elisp"><span class="line"><span class="cl"><span class="p">(</span><span class="nv">require-package</span> <span class="ss">&#39;deft</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">deft-extensions</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;md&#34;</span> <span class="s">&#34;tex&#34;</span> <span class="s">&#34;org&#34;</span> <span class="s">&#34;mw&#34;</span> <span class="s">&#34;conf&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">deft-directory</span> <span class="s">&#34;~/Dropbox/org/&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">deft-recursive</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">advice-add</span> <span class="ss">&#39;deft-parse-title</span> <span class="nb">:override</span> <span class="nf">#&#39;</span><span class="nv">cm/deft-parse-title</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">deft-strip-summary-regexp</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nf">concat</span> <span class="s">&#34;\\(&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;[\n\t]&#34;</span> <span class="c1">;; blank</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;\\|^#\\+[[:alpha:]_]+:.*$&#34;</span> <span class="c1">;; org-mode metadata</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;\\|^#\s[-]*$&#34;</span> <span class="c1">;; org-mode metadata</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;\\|^:PROPERTIES:\n\\(.+\n\\)+:END:\n&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;\\)&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">global-set-key</span> <span class="p">[</span><span class="nv">f7</span><span class="p">]</span> <span class="ss">&#39;deft</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">global-set-key</span> <span class="p">(</span><span class="nv">kbd</span> <span class="s">&#34;C-x C-g&#34;</span><span class="p">)</span> <span class="ss">&#39;deft-find-file</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;; deft parse title</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">cm/deft-parse-title</span> <span class="p">(</span><span class="nv">file</span> <span class="nv">contents</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;Parse the given FILE and CONTENTS and determine the title.
</span></span></span><span class="line"><span class="cl"><span class="s">If </span><span class="ss">`deft-use-filename-as-title&#39;</span><span class="s"> is nil, the title is taken to
</span></span></span><span class="line"><span class="cl"><span class="s">be the first non-empty line of the FILE.  Else the base name of the FILE is
</span></span></span><span class="line"><span class="cl"><span class="s">used as title.&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">let</span> <span class="p">((</span><span class="nv">begin</span> <span class="p">(</span><span class="nf">string-match</span> <span class="s">&#34;^#\\+[tT][iI][tT][lL][eE]: .*$&#34;</span> <span class="nv">contents</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">if</span> <span class="nv">begin</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nv">string-trim</span> <span class="p">(</span><span class="nf">substring</span> <span class="nv">contents</span> <span class="nv">begin</span> <span class="p">(</span><span class="nf">match-end</span> <span class="mi">0</span><span class="p">))</span> <span class="s">&#34;#\\+[tT][iI][tT][lL][eE]: *&#34;</span> <span class="s">&#34;[\n\t ]+&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nv">deft-base-filename</span> <span class="nv">file</span><span class="p">))))</span>
</span></span></code></pre></div><h4 id="vterm">Vterm</h4>
<p>在 Emacs 中使用终端，首先要在 <code>/.zshrc</code> 中添加如下代码。（编译时需要 CMake）</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[[</span> <span class="s2">&#34;</span><span class="nv">$INSIDE_EMACS</span><span class="s2">&#34;</span> <span class="o">=</span> <span class="s1">&#39;vterm&#39;</span> <span class="o">]]</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="o">&amp;&amp;</span> <span class="o">[[</span> -n <span class="si">${</span><span class="nv">EMACS_VTERM_PATH</span><span class="si">}</span> <span class="o">]]</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="o">&amp;&amp;</span> <span class="o">[[</span> -f <span class="si">${</span><span class="nv">EMACS_VTERM_PATH</span><span class="si">}</span>/etc/emacs-vterm-zsh.sh <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    <span class="nb">source</span> <span class="si">${</span><span class="nv">EMACS_VTERM_PATH</span><span class="si">}</span>/etc/emacs-vterm-zsh.sh
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span></code></pre></div><p>这里为了方便使用需要引入 vterm-toggle</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-elisp" data-lang="elisp"><span class="line"><span class="cl"><span class="p">(</span><span class="nv">require-package</span> <span class="ss">&#39;vterm</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">require-package</span> <span class="ss">&#39;vterm-toggle</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">use-package</span> <span class="nv">vterm-toggle</span>
</span></span><span class="line"><span class="cl">  <span class="nb">:when</span> <span class="p">(</span><span class="nf">memq</span> <span class="nf">window-system</span> <span class="o">&#39;</span><span class="p">(</span><span class="nv">mac</span> <span class="nv">ns</span> <span class="nv">x</span> <span class="nv">pgtk</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="nb">:bind</span> <span class="p">(([</span><span class="nv">f8</span><span class="p">]</span> <span class="o">.</span> <span class="nv">vterm-toggle</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="p">([</span><span class="nv">f9</span><span class="p">]</span> <span class="o">.</span> <span class="nv">vterm-compile</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="nb">:map</span> <span class="nv">vterm-mode-map</span>
</span></span><span class="line"><span class="cl">         <span class="p">([</span><span class="nv">f8</span><span class="p">]</span> <span class="o">.</span> <span class="nv">vterm-toggle</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="p">([(</span><span class="nv">control</span> <span class="nb">return</span><span class="p">)]</span> <span class="o">.</span> <span class="nv">vterm-toggle-insert-cd</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="nb">:config</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">setq</span> <span class="nv">vterm-toggle-cd-auto-create-buffer</span> <span class="no">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">defvar</span> <span class="nv">vterm-compile-buffer</span> <span class="no">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">defun</span> <span class="nv">vterm-compile</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;Compile the program including the current buffer in </span><span class="ss">`vterm&#39;</span><span class="s">.&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">interactive</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">setq</span> <span class="nv">compile-command</span> <span class="p">(</span><span class="nv">compilation-read-command</span> <span class="nv">compile-command</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">let</span> <span class="p">((</span><span class="nv">vterm-toggle-use-dedicated-buffer</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span><span class="nv">vterm-toggle--vterm-dedicated-buffer</span> <span class="p">(</span><span class="nb">if</span> <span class="p">(</span><span class="nv">vterm-toggle--get-window</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                                    <span class="p">(</span><span class="nv">vterm-toggle-hide</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                                  <span class="nv">vterm-compile-buffer</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nb">with-current-buffer</span> <span class="p">(</span><span class="nv">vterm-toggle-cd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nb">setq</span> <span class="nv">vterm-compile-buffer</span> <span class="p">(</span><span class="nf">current-buffer</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nf">rename-buffer</span> <span class="s">&#34;*vterm compilation*&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nv">compilation-shell-minor-mode</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nv">vterm-send-M-w</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nv">vterm-send-string</span> <span class="nv">compile-command</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nv">vterm-send-return</span><span class="p">)))))</span>
</span></span></code></pre></div><h4 id="ox-hugo">Ox-hugo</h4>
<p>导出到 Hugo，方便与他人分享内容。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-elisp" data-lang="elisp"><span class="line"><span class="cl"><span class="p">(</span><span class="nv">require-package</span> <span class="ss">&#39;ox-hugo</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">with-eval-after-load</span> <span class="ss">&#39;ox</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">require</span> <span class="ss">&#39;ox-hugo</span><span class="p">))</span>
</span></span></code></pre></div><p>导出到 Hugo 还需要在文件头部添加</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-org" data-lang="org"><span class="line"><span class="cl"><span class="cs">#+HUGO_BASE_DIR</span><span class="c">: ~/Dropbox/hugo/</span>
</span></span><span class="line"><span class="cl"><span class="cs">#+HUGO_SECTION</span><span class="c">: posts/main</span>
</span></span><span class="line"><span class="cl"><span class="cs">#+HUGO_WEIGHT</span><span class="c">: auto</span>
</span></span><span class="line"><span class="cl"><span class="cs">#+HUGO_AUTO_SET_LASTMOD</span><span class="c">: t</span>
</span></span></code></pre></div><p>需要到处为 <code>&lt;mark&gt;&lt;/mark&gt;</code> 时<sup id="fnref:3"><a href="#fn:3" class="footnote-ref" role="doc-noteref">3</a></sup></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-org" data-lang="org"><span class="line"><span class="cl"><span class="cs">#+header</span><span class="c">: :trim-pre nil :trim-post nil</span>
</span></span><span class="line"><span class="cl"><span class="c">#+begin_mark</span>
</span></span><span class="line"><span class="cl">marked text
</span></span><span class="line"><span class="cl"><span class="c">#+end_mark</span>
</span></span></code></pre></div><h4 id="latex--auctex-plus-cdlatex">Latex(auctex + cdlatex)</h4>
<p>离线分享的时候最大程度的保持原貌的方法就是 PDF。</p>
<p>需要安装 <code>texlive</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">brew install texlive
</span></span></code></pre></div><p>Latex 语法可以参考：<a href="/posts/main/20220616162256-latex/">Latex</a></p>
<p>导出含有中文时是需要配置 CJK，<a href="https://github.com/ElegantLaTeX/ElegantPaper/blob/master/elegantpaper.cls">ElegantPaper</a> 可以跨过这一步设置，只需要将 <code>elegantpaper.cls</code> 放到需要导出 PDF 的目录下，同时安装依赖。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">brew install pygments
</span></span></code></pre></div><p>在导出文件头部增加</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-org" data-lang="org"><span class="line"><span class="cl"><span class="cs">#+LATEX_COMPILER</span><span class="c">: xelatex</span>
</span></span><span class="line"><span class="cl"><span class="cs">#+LATEX_CLASS</span><span class="c">: elegantpaper</span>
</span></span><span class="line"><span class="cl"><span class="cs">#+OPTIONS</span><span class="c">: prop:t</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-elisp" data-lang="elisp"><span class="line"><span class="cl"><span class="p">(</span><span class="nv">require-package</span> <span class="ss">&#39;auctex</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">require-package</span> <span class="ss">&#39;cdlatex</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">add-hook</span> <span class="ss">&#39;LaTeX-mode-hook</span> <span class="ss">&#39;turn-on-cdlatex</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">with-eval-after-load</span> <span class="ss">&#39;ox-latex</span>
</span></span><span class="line"><span class="cl">  <span class="c1">;; http://orgmode.org/worg/org-faq.html#using-xelatex-for-pdf-export</span>
</span></span><span class="line"><span class="cl">  <span class="c1">;; latexmk runs pdflatex/xelatex (whatever is specified) multiple times</span>
</span></span><span class="line"><span class="cl">  <span class="c1">;; automatically to resolve the cross-references.</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">setq</span> <span class="nv">org-latex-pdf-process</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;latexmk -xelatex -quiet -shell-escape -f %f&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">add-to-list</span> <span class="ss">&#39;org-latex-classes</span>
</span></span><span class="line"><span class="cl">               <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;elegantpaper&#34;</span>
</span></span><span class="line"><span class="cl">                 <span class="s">&#34;\\documentclass[lang=cn]{elegantpaper}
</span></span></span><span class="line"><span class="cl"><span class="s">                 [NO-DEFAULT-PACKAGES]
</span></span></span><span class="line"><span class="cl"><span class="s">                 [PACKAGES]
</span></span></span><span class="line"><span class="cl"><span class="s">                 [EXTRA]&#34;</span>
</span></span><span class="line"><span class="cl">                 <span class="p">(</span><span class="s">&#34;\\section{%s}&#34;</span> <span class="o">.</span> <span class="s">&#34;\\section*{%s}&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                 <span class="p">(</span><span class="s">&#34;\\subsection{%s}&#34;</span> <span class="o">.</span> <span class="s">&#34;\\subsection*{%s}&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                 <span class="p">(</span><span class="s">&#34;\\subsubsection{%s}&#34;</span> <span class="o">.</span> <span class="s">&#34;\\subsubsection*{%s}&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                 <span class="p">(</span><span class="s">&#34;\\paragraph{%s}&#34;</span> <span class="o">.</span> <span class="s">&#34;\\paragraph*{%s}&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                 <span class="p">(</span><span class="s">&#34;\\subparagraph{%s}&#34;</span> <span class="o">.</span> <span class="s">&#34;\\subparagraph*{%s}&#34;</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">setq</span> <span class="nv">org-latex-listings</span> <span class="ss">&#39;minted</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">add-to-list</span> <span class="ss">&#39;org-latex-packages-alist</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;&#34;</span> <span class="s">&#34;minted&#34;</span><span class="p">)))</span>
</span></span></code></pre></div><h3 id="init-corfu-dot-el">init-corfu.el</h3>
<p>增加了 <code>kind-icon</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-elisp" data-lang="elisp"><span class="line"><span class="cl"><span class="c1">;;; init-corfu.el --- Interactive completion in buffers -*- lexical-binding: t -*-</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;; Commentary:</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;; Code:</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;; WAITING: haskell-mode sets tags-table-list globally, breaks tags-completion-at-point-function</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; TODO Default sort order should place [a-z] before punctuation</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">tab-always-indent</span> <span class="ss">&#39;complete</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nv">maybe-require-package</span> <span class="ss">&#39;orderless</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">with-eval-after-load</span> <span class="ss">&#39;vertico</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">require</span> <span class="ss">&#39;orderless</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">setq</span> <span class="nv">completion-styles</span> <span class="o">&#39;</span><span class="p">(</span><span class="nv">orderless</span> <span class="nv">basic</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">completion-category-defaults</span> <span class="no">nil</span>
</span></span><span class="line"><span class="cl">      <span class="nv">completion-category-overrides</span> <span class="no">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">completion-cycle-threshold</span> <span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nv">maybe-require-package</span> <span class="ss">&#39;corfu</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">setq-default</span> <span class="nv">corfu-auto</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">with-eval-after-load</span> <span class="ss">&#39;eshell</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nv">add-hook</span> <span class="ss">&#39;eshell-mode-hook</span> <span class="p">(</span><span class="nb">lambda</span> <span class="p">()</span> <span class="p">(</span><span class="nb">setq-local</span> <span class="nv">corfu-auto</span> <span class="no">nil</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">setq-default</span> <span class="nv">corfu-quit-no-match</span> <span class="ss">&#39;separator</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">add-hook</span> <span class="ss">&#39;after-init-hook</span> <span class="ss">&#39;global-corfu-mode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nv">maybe-require-package</span> <span class="ss">&#39;corfu-doc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">with-eval-after-load</span> <span class="ss">&#39;corfu</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nv">add-hook</span> <span class="ss">&#39;corfu-mode-hook</span> <span class="nf">#&#39;</span><span class="nv">corfu-doc-mode</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">;; TODO: https://github.com/jdtsmith/kind-icon</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nv">maybe-require-package</span> <span class="ss">&#39;kind-icon</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">with-eval-after-load</span> <span class="ss">&#39;corfu</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nv">add-to-list</span> <span class="ss">&#39;corfu-margin-formatters</span> <span class="nf">#&#39;</span><span class="nv">kind-icon-margin-formatter</span><span class="p">)</span> <span class="c1">; Enable `kind-icon&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">provide</span> <span class="ss">&#39;init-corfu</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;; init-corfu.el ends here</span>
</span></span></code></pre></div><h3 id="init-themes-dot-el">init-themes.el</h3>
<p>用的 <a href="https://protesilaos.com/emacs/ef-themes-pictures">Screen shots of the Ef themes for GNU Emacs | Protesilaos Stavrou</a>，​<code>ef-spring</code> 作为非编码时的主题，​<code>ef-night</code> 作为编码时的主题。另外设置背景透明以及光标所在代码块按照括号高亮的函数也在放在这里。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-elisp" data-lang="elisp"><span class="line"><span class="cl"><span class="c1">;;; init-themes.el --- Defaults for themes -*- lexical-binding: t -*-</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;; Commentary:</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;; Code:</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">require-package</span> <span class="ss">&#39;ef-themes</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;; Don&#39;t prompt to confirm theme safety. This avoids problems with</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; first-time startup on Emacs &gt; 26.3.</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">custom-safe-themes</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;; If you don&#39;t customize it, this is the theme you get.</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq-default</span> <span class="nv">custom-enabled-themes</span> <span class="o">&#39;</span><span class="p">(</span><span class="nv">ef-spring</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;; Ensure that themes will be applied even if they have not been customized</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">reapply-themes</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;Forcibly load the themes listed in </span><span class="ss">`custom-enabled-themes&#39;</span><span class="s">.&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">dolist</span> <span class="p">(</span><span class="nv">theme</span> <span class="nv">custom-enabled-themes</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">unless</span> <span class="p">(</span><span class="nv">custom-theme-p</span> <span class="nv">theme</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nv">load-theme</span> <span class="nv">theme</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">custom-set-variables</span> <span class="o">`</span><span class="p">(</span><span class="nv">custom-enabled-themes</span> <span class="p">(</span><span class="nb">quote</span> <span class="o">,</span><span class="nv">custom-enabled-themes</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">add-hook</span> <span class="ss">&#39;after-init-hook</span> <span class="ss">&#39;reapply-themes</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;; Toggle between light and dark</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">light</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;Activate a light color theme.&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">interactive</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">setq</span> <span class="nv">custom-enabled-themes</span> <span class="o">&#39;</span><span class="p">(</span><span class="nv">ef-spring</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">reapply-themes</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">dark</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;Activate a dark color theme.&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">interactive</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">setq</span> <span class="nv">custom-enabled-themes</span> <span class="o">&#39;</span><span class="p">(</span><span class="nv">ef-night</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">reapply-themes</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nv">maybe-require-package</span> <span class="ss">&#39;dimmer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">setq-default</span> <span class="nv">dimmer-fraction</span> <span class="mf">0.15</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">add-hook</span> <span class="ss">&#39;after-init-hook</span> <span class="ss">&#39;dimmer-mode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">with-eval-after-load</span> <span class="ss">&#39;dimmer</span>
</span></span><span class="line"><span class="cl">    <span class="c1">;; TODO: file upstream as a PR</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nv">advice-add</span> <span class="ss">&#39;frame-set-background-mode</span> <span class="nb">:after</span> <span class="p">(</span><span class="nb">lambda</span> <span class="p">(</span><span class="kp">&amp;rest</span> <span class="nv">args</span><span class="p">)</span> <span class="p">(</span><span class="nv">dimmer-process-all</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">with-eval-after-load</span> <span class="ss">&#39;dimmer</span>
</span></span><span class="line"><span class="cl">    <span class="c1">;; Don&#39;t dim in terminal windows. Even with 256 colours it can</span>
</span></span><span class="line"><span class="cl">    <span class="c1">;; lead to poor contrast.  Better would be to vary dimmer-fraction</span>
</span></span><span class="line"><span class="cl">    <span class="c1">;; according to frame type.</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">defun</span> <span class="nv">sanityinc/display-non-graphic-p</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nv">not</span> <span class="p">(</span><span class="nv">display-graphic-p</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nv">add-to-list</span> <span class="ss">&#39;dimmer-exclusion-predicates</span> <span class="ss">&#39;sanityinc/display-non-graphic-p</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;; fake transparency</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; (defun user/change-background-opacity (alpha)</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;   (interactive &#34;nOpacity: &#34;)</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;   (if (and (&gt;= alpha 0) (&lt;= alpha 100))</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;       (user/set-background-opacity alpha)</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;     (format-message &#34;Opacity has to be between 0 and 100 but is %d.&#34; alpha)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;; (defun user/set-background-opacity (alpha)</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;   (set-frame-parameter (selected-frame) &#39;alpha alpha)</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;   (add-to-list &#39;default-frame-alist (cons &#39;alpha alpha)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;; (user/set-background-opacity 90)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;; true transparency</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">kb/toggle-window-transparency</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;Toggle transparency.&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">interactive</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">let</span> <span class="p">((</span><span class="nv">alpha-transparency</span> <span class="mi">50</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">pcase</span> <span class="p">(</span><span class="nf">frame-parameter</span> <span class="no">nil</span> <span class="ss">&#39;alpha-background</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nv">alpha-transparency</span> <span class="p">(</span><span class="nv">set-frame-parameter</span> <span class="no">nil</span> <span class="ss">&#39;alpha-background</span> <span class="mi">100</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="no">t</span> <span class="p">(</span><span class="nv">set-frame-parameter</span> <span class="no">nil</span> <span class="ss">&#39;alpha-background</span> <span class="nv">alpha-transparency</span><span class="p">)))))</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">kb/toggle-window-transparency</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; 高亮光标所在的括号内容，提高阅读效率。</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">unless</span> <span class="p">(</span><span class="nv">package-installed-p</span> <span class="ss">&#39;highlight-blocks</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">package-install</span> <span class="ss">&#39;highlight-blocks</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">require</span> <span class="ss">&#39;highlight-blocks</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">highlight-blocks--get-bounds</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;Get the bounds of the nested blocks the point is in.
</span></span></span><span class="line"><span class="cl"><span class="s">The returned value is a list of conses, where car is the start of a
</span></span></span><span class="line"><span class="cl"><span class="s">block and cdr is the end of a block, starting from the outermost
</span></span></span><span class="line"><span class="cl"><span class="s">block.&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">let</span> <span class="p">((</span><span class="nv">result</span> <span class="o">&#39;</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nv">parse-sexp-ignore-comments</span> <span class="no">t</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">condition-case</span> <span class="no">nil</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nb">let*</span> <span class="p">((</span><span class="nv">parse-state</span> <span class="p">(</span><span class="nv">syntax-ppss</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">               <span class="p">(</span><span class="nv">starting-pos</span> <span class="p">(</span><span class="nb">if</span> <span class="p">(</span><span class="nb">or</span> <span class="p">(</span><span class="nf">nth</span> <span class="mi">3</span> <span class="nv">parse-state</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                     <span class="p">(</span><span class="nf">nth</span> <span class="mi">4</span> <span class="nv">parse-state</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                                 <span class="p">(</span><span class="nf">nth</span> <span class="mi">8</span> <span class="nv">parse-state</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                               <span class="p">(</span><span class="nf">point</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">               <span class="p">(</span><span class="nv">begins</span> <span class="p">(</span><span class="nf">nreverse</span> <span class="p">(</span><span class="nf">nth</span> <span class="mi">9</span> <span class="nv">parse-state</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">               <span class="p">(</span><span class="nv">end</span> <span class="nv">starting-pos</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">               <span class="p">(</span><span class="nv">i</span> <span class="mi">0</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span><span class="nb">while</span> <span class="p">(</span><span class="nb">or</span> <span class="p">(</span><span class="nf">eq</span> <span class="nv">highlight-blocks-max-innermost-block-count</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                     <span class="p">(</span><span class="nf">&lt;</span> <span class="nv">i</span> <span class="nv">highlight-blocks-max-innermost-block-count</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="nb">setq</span> <span class="nv">end</span> <span class="p">(</span><span class="nf">scan-lists</span> <span class="nv">end</span> <span class="mi">1</span> <span class="mi">1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="nb">push</span> <span class="p">(</span><span class="nf">cons</span> <span class="p">(</span><span class="nb">pop</span> <span class="nv">begins</span><span class="p">)</span> <span class="nv">end</span><span class="p">)</span> <span class="nv">result</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="nb">setq</span> <span class="nv">i</span> <span class="p">(</span><span class="nf">1+</span> <span class="nv">i</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nv">scan-error</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; 修改下这个函数函数的返回值，可以只高亮当前所在的块</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nv">last</span> <span class="nv">result</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; Put the mode hooks where you want it, for example</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">add-hook</span> <span class="ss">&#39;emacs-lisp-mode-hook</span>       <span class="ss">&#39;highlight-blocks--get-bounds</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; (add-hook &#39;lisp-interaction-mode-hook &#39;highlight-blocks-mode)</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; (add-hook &#39;lisp-mode-hook             &#39;highlight-blocks-mode)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">provide</span> <span class="ss">&#39;init-themes</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;; init-themes.el ends here</span>
</span></span></code></pre></div><h3 id="init-elfeed-dot-el">init-elfeed.el</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-elisp" data-lang="elisp"><span class="line"><span class="cl"><span class="c1">;;; init-elfeed.el  --- Custom configuration</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;; Commentary</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">require-package</span> <span class="ss">&#39;elfeed</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">global-set-key</span> <span class="p">(</span><span class="nv">kbd</span> <span class="s">&#34;C-x w&#34;</span><span class="p">)</span> <span class="ss">&#39;elfeed</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">use-package</span> <span class="nv">elfeed-org</span>
</span></span><span class="line"><span class="cl">  <span class="nb">:ensure</span> <span class="no">t</span>
</span></span><span class="line"><span class="cl">  <span class="nb">:config</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">elfeed-org</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">setq</span> <span class="nv">rmh-elfeed-org-files</span> <span class="p">(</span><span class="nf">list</span> <span class="s">&#34;~/Dropbox/org/elfeed.org&#34;</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">concatenate-authors</span> <span class="p">(</span><span class="nv">authors-list</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;Given AUTHORS-LIST, list of plists; return string of all authors
</span></span></span><span class="line"><span class="cl"><span class="s">concatenated.&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nf">mapconcat</span>
</span></span><span class="line"><span class="cl">   <span class="p">(</span><span class="nb">lambda</span> <span class="p">(</span><span class="nv">author</span><span class="p">)</span> <span class="p">(</span><span class="nf">plist-get</span> <span class="nv">author</span> <span class="nb">:name</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">   <span class="nv">authors-list</span> <span class="s">&#34;, &#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">my-search-print-fn</span> <span class="p">(</span><span class="nv">entry</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;Print ENTRY to the buffer.&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">let*</span> <span class="p">((</span><span class="nv">date</span> <span class="p">(</span><span class="nv">elfeed-search-format-date</span> <span class="p">(</span><span class="nv">elfeed-entry-date</span> <span class="nv">entry</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">         <span class="p">(</span><span class="nv">title</span> <span class="p">(</span><span class="nb">or</span> <span class="p">(</span><span class="nv">elfeed-meta</span> <span class="nv">entry</span> <span class="nb">:title</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="p">(</span><span class="nv">elfeed-entry-title</span> <span class="nv">entry</span><span class="p">)</span> <span class="s">&#34;&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">         <span class="p">(</span><span class="nv">title-faces</span> <span class="p">(</span><span class="nv">elfeed-search--faces</span> <span class="p">(</span><span class="nv">elfeed-entry-tags</span> <span class="nv">entry</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">         <span class="p">(</span><span class="nv">feed</span> <span class="p">(</span><span class="nv">elfeed-entry-feed</span> <span class="nv">entry</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">         <span class="p">(</span><span class="nv">feed-title</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span><span class="nb">when</span> <span class="nv">feed</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="nb">or</span> <span class="p">(</span><span class="nv">elfeed-meta</span> <span class="nv">feed</span> <span class="nb">:title</span><span class="p">)</span> <span class="p">(</span><span class="nv">elfeed-feed-title</span> <span class="nv">feed</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">         <span class="p">(</span><span class="nv">entry-authors</span> <span class="p">(</span><span class="nv">concatenate-authors</span>
</span></span><span class="line"><span class="cl">                         <span class="p">(</span><span class="nv">elfeed-meta</span> <span class="nv">entry</span> <span class="nb">:authors</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">         <span class="p">(</span><span class="nv">tags</span> <span class="p">(</span><span class="nf">mapcar</span> <span class="nf">#&#39;symbol-name</span> <span class="p">(</span><span class="nv">elfeed-entry-tags</span> <span class="nv">entry</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">         <span class="p">(</span><span class="nv">tags-str</span> <span class="p">(</span><span class="nf">mapconcat</span>
</span></span><span class="line"><span class="cl">                    <span class="p">(</span><span class="nb">lambda</span> <span class="p">(</span><span class="nv">s</span><span class="p">)</span> <span class="p">(</span><span class="nf">propertize</span> <span class="nv">s</span> <span class="ss">&#39;face</span>
</span></span><span class="line"><span class="cl">                                            <span class="ss">&#39;elfeed-search-tag-face</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                    <span class="nv">tags</span> <span class="s">&#34;,&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">         <span class="p">(</span><span class="nv">title-width</span> <span class="p">(</span><span class="nf">-</span> <span class="p">(</span><span class="nv">window-width</span><span class="p">)</span> <span class="mi">10</span>
</span></span><span class="line"><span class="cl">                         <span class="nv">elfeed-search-trailing-width</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">         <span class="p">(</span><span class="nv">title-column</span> <span class="p">(</span><span class="nv">elfeed-format-column</span>
</span></span><span class="line"><span class="cl">                        <span class="nv">title</span> <span class="p">(</span><span class="nv">elfeed-clamp</span>
</span></span><span class="line"><span class="cl">                               <span class="nv">elfeed-search-title-min-width</span>
</span></span><span class="line"><span class="cl">                               <span class="nv">title-width</span>
</span></span><span class="line"><span class="cl">                               <span class="nv">elfeed-search-title-max-width</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="nb">:left</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">         <span class="p">(</span><span class="nv">authors-width</span> <span class="mi">135</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="p">(</span><span class="nv">authors-column</span> <span class="p">(</span><span class="nv">elfeed-format-column</span>
</span></span><span class="line"><span class="cl">                        <span class="nv">entry-authors</span> <span class="p">(</span><span class="nv">elfeed-clamp</span>
</span></span><span class="line"><span class="cl">                               <span class="nv">elfeed-search-title-min-width</span>
</span></span><span class="line"><span class="cl">                               <span class="nv">authors-width</span>
</span></span><span class="line"><span class="cl">                               <span class="mi">131</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="nb">:left</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nf">insert</span> <span class="p">(</span><span class="nf">propertize</span> <span class="nv">date</span> <span class="ss">&#39;face</span> <span class="ss">&#39;elfeed-search-date-face</span><span class="p">)</span> <span class="s">&#34; &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nf">insert</span> <span class="p">(</span><span class="nf">propertize</span> <span class="nv">title-column</span>
</span></span><span class="line"><span class="cl">                        <span class="ss">&#39;face</span> <span class="nv">title-faces</span> <span class="ss">&#39;kbd-help</span> <span class="nv">title</span><span class="p">)</span> <span class="s">&#34; &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nf">insert</span> <span class="p">(</span><span class="nf">propertize</span> <span class="nv">authors-column</span>
</span></span><span class="line"><span class="cl">                        <span class="ss">&#39;face</span> <span class="ss">&#39;elfeed-search-date-face</span>
</span></span><span class="line"><span class="cl">                        <span class="ss">&#39;kbd-help</span> <span class="nv">entry-authors</span><span class="p">)</span> <span class="s">&#34; &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">;; (when feed-title</span>
</span></span><span class="line"><span class="cl">    <span class="c1">;;   (insert (propertize entry-authors</span>
</span></span><span class="line"><span class="cl">    <span class="c1">;; &#39;face &#39;elfeed-search-feed-face) &#34; &#34;))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">when</span> <span class="nv">entry-authors</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nf">insert</span> <span class="p">(</span><span class="nf">propertize</span> <span class="nv">feed-title</span>
</span></span><span class="line"><span class="cl">                          <span class="ss">&#39;face</span> <span class="ss">&#39;elfeed-search-feed-face</span><span class="p">)</span> <span class="s">&#34; &#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">;; (when tags</span>
</span></span><span class="line"><span class="cl">    <span class="c1">;;   (insert &#34;(&#34; tags-str &#34;)&#34;))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">elfeed-search-print-entry-function</span> <span class="nf">#&#39;</span><span class="nv">my-search-print-fn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">provide</span> <span class="ss">&#39;init-elfeed</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;; init-elfeed.el ends here</span>
</span></span></code></pre></div><h3 id="init-telega-dot-el">init-telega.el</h3>
<p><code>brew install tdlib</code> 的版本过低，需要自行编译，参考 <a href="https://tdlib.github.io/td/build.html?language=Swift">TDLib build instructions</a> 。这个之后需要 <code>M-x telega-server-build</code> 重新加载 telega-server。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">xcode-select --install
</span></span><span class="line"><span class="cl">/bin/bash -c <span class="s2">&#34;</span><span class="k">$(</span>curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh<span class="k">)</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">brew install gperf cmake openssl
</span></span><span class="line"><span class="cl">git clone https://github.com/tdlib/td.git
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> td
</span></span><span class="line"><span class="cl">rm -rf build
</span></span><span class="line"><span class="cl">mkdir build
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> build
</span></span><span class="line"><span class="cl">cmake -DCMAKE_BUILD_TYPE<span class="o">=</span>Release -DOPENSSL_ROOT_DIR<span class="o">=</span>/usr/local/opt/openssl/ -DCMAKE_INSTALL_PREFIX:PATH<span class="o">=</span>/usr/local ..
</span></span><span class="line"><span class="cl">cmake --build . --target install
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> ..
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> ..
</span></span><span class="line"><span class="cl">ls -l /usr/local
</span></span></code></pre></div><p>其中 tblib 的版本当前需要 1.8.4，可以切换到 1.8.4 的版本。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">git checkout b447c32fe94c3d62d74c6b9608649c791641c3e5
</span></span></code></pre></div><table>
<thead>
<tr>
<th>快捷键</th>
<th>功能</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>C-c C-v</code></td>
<td>发送图片</td>
<td><code>brew install pngpaste</code></td>
</tr>
<tr>
<td><code>!</code></td>
<td>点赞</td>
<td></td>
</tr>
<tr>
<td><code>C-c C-a</code></td>
<td>Attachment type</td>
<td>其中 markup 可以发送 md 等格式</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-elisp" data-lang="elisp"><span class="line"><span class="cl"><span class="c1">;;; init-telega.el  --- Custom configuration</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;; Commentary</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">require-package</span> <span class="ss">&#39;telega</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nf">define-key</span> <span class="nv">global-map</span> <span class="p">(</span><span class="nv">kbd</span> <span class="s">&#34;C-c t&#34;</span><span class="p">)</span> <span class="nv">telega-prefix-map</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; 去除昵称、回复行的背景高亮</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">my-telega-chat-mode</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">set-face-attribute</span> <span class="ss">&#39;telega-msg-heading</span> <span class="no">nil</span>
</span></span><span class="line"><span class="cl">                      <span class="nb">:underline</span> <span class="o">&#39;</span><span class="p">(</span><span class="nb">:style</span> <span class="nv">line</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                      <span class="nb">:inherit</span> <span class="no">nil</span>
</span></span><span class="line"><span class="cl">                      <span class="nb">:background</span> <span class="no">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">set-face-attribute</span> <span class="ss">&#39;telega-msg-inline-reply</span> <span class="no">nil</span>
</span></span><span class="line"><span class="cl">                      <span class="nb">:underline</span> <span class="o">&#39;</span><span class="p">(</span><span class="nb">:style</span> <span class="nv">line</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">set-face-attribute</span> <span class="ss">&#39;telega-msg-self-title</span> <span class="no">nil</span>
</span></span><span class="line"><span class="cl">                      <span class="nb">:foreground</span> <span class="s">&#34;#FFB11B&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">set-face-attribute</span> <span class="ss">&#39;telega-msg-user-title</span> <span class="no">nil</span>
</span></span><span class="line"><span class="cl">                      <span class="nb">:weight</span> <span class="ss">&#39;bold</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="c1">;; (setf (alist-get 2 telega-avatar-factors-alist) &#39;(0.4 . 0.1))</span>
</span></span><span class="line"><span class="cl">  <span class="c1">;; 缩小 emoji 显示，防止头像裂开。</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">add-to-list</span> <span class="ss">&#39;face-font-rescale-alist</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;Apple Color Emoji&#34;</span> <span class="o">.</span> <span class="mf">0.8</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">add-hook</span> <span class="ss">&#39;telega-chat-mode-hook</span> <span class="ss">&#39;my-telega-chat-mode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">provide</span> <span class="ss">&#39;init-telega</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;; init-telega.el ends here</span>
</span></span></code></pre></div><h3 id="init-org-modern-dot-el">init-org-modern.el</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-elisp" data-lang="elisp"><span class="line"><span class="cl"><span class="c1">;;; init-org-modern.el  --- Custom configuration</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;; Commentary</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">require-package</span> <span class="ss">&#39;org-modern</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">use-package</span> <span class="nv">org-modern</span>
</span></span><span class="line"><span class="cl">  <span class="nb">:after</span> <span class="nv">org</span>
</span></span><span class="line"><span class="cl">  <span class="nb">:hook</span> <span class="p">(</span><span class="nv">org-mode</span> <span class="o">.</span> <span class="nv">org-modern-mode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="nb">:init</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">setq</span> <span class="nv">org-modern-block</span> <span class="no">nil</span>
</span></span><span class="line"><span class="cl">        <span class="nv">org-modern-radio-target</span> <span class="no">nil</span>
</span></span><span class="line"><span class="cl">        <span class="nv">org-modern-internal-target</span> <span class="no">nil</span>
</span></span><span class="line"><span class="cl">        <span class="nv">org-modern-list</span> <span class="no">nil</span>
</span></span><span class="line"><span class="cl">        <span class="c1">;; org-modern-star nil</span>
</span></span><span class="line"><span class="cl">        <span class="nv">org-modern-timestamp</span> <span class="no">nil</span>
</span></span><span class="line"><span class="cl">        <span class="c1">;; org-modern-checkbox nil</span>
</span></span><span class="line"><span class="cl">        <span class="nv">org-modern-todo</span> <span class="no">nil</span>
</span></span><span class="line"><span class="cl">        <span class="c1">;; org-modern-footnote nil</span>
</span></span><span class="line"><span class="cl">        <span class="nv">org-modern-block-name</span> <span class="no">nil</span>
</span></span><span class="line"><span class="cl">        <span class="nv">org-modern-priority</span> <span class="no">nil</span>
</span></span><span class="line"><span class="cl">        <span class="nv">org-modern-progress</span> <span class="no">nil</span>
</span></span><span class="line"><span class="cl">        <span class="nv">org-modern-keyword</span> <span class="no">nil</span>
</span></span><span class="line"><span class="cl">        <span class="nv">org-modern-table</span> <span class="no">nil</span>
</span></span><span class="line"><span class="cl">        <span class="nv">org-modern-tag</span> <span class="no">nil</span>
</span></span><span class="line"><span class="cl">        <span class="nv">org-modern-statistics</span> <span class="no">nil</span>
</span></span><span class="line"><span class="cl">        <span class="nv">org-modern-horizontal-rule</span> <span class="no">nil</span>
</span></span><span class="line"><span class="cl">        <span class="nv">org-ellipsis</span> <span class="s">&#34;[+]&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">custom-set-faces</span>
</span></span><span class="line"><span class="cl"> <span class="o">&#39;</span><span class="p">(</span><span class="nv">org-ellipsis</span> <span class="p">((</span><span class="no">t</span> <span class="p">(</span><span class="nb">:foreground</span> <span class="s">&#34;#90B44B&#34;</span><span class="p">)))))</span> <span class="c1">;; 鶸萌黄</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">provide</span> <span class="ss">&#39;init-org-modern</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;; init-org-modern.el ends here</span>
</span></span></code></pre></div><h3 id="init-quick-menus-dot-el">init-quick-menus.el</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-elisp" data-lang="elisp"><span class="line"><span class="cl"><span class="c1">;;; init-quick-menus.el  --- Custom configuration</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;; Commentary</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; org-starter</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">require-package</span> <span class="ss">&#39;org-starter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">org-refile-use-outline-path</span> <span class="ss">&#39;file</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">use-package</span> <span class="nv">org-starter</span>
</span></span><span class="line"><span class="cl">  <span class="nb">:config</span>
</span></span><span class="line"><span class="cl">  <span class="c1">;; (add-hook! &#39;after-init-hook &#39;org-starter-load-all-files-in-path)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">org-starter-def</span> <span class="s">&#34;~/Dropbox/org&#34;</span>
</span></span><span class="line"><span class="cl">                   <span class="nb">:files</span>
</span></span><span class="line"><span class="cl">                   <span class="p">(</span><span class="s">&#34;agenda/inbox.org&#34;</span>                <span class="nb">:agenda</span> <span class="no">t</span>   <span class="nb">:key</span> <span class="s">&#34;i&#34;</span> <span class="nb">:refile</span> <span class="p">(</span><span class="nb">:maxlevel</span> <span class="o">.</span> <span class="mi">2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                   <span class="p">(</span><span class="s">&#34;agenda/work.org&#34;</span>                 <span class="nb">:agenda</span> <span class="no">t</span>   <span class="nb">:key</span> <span class="s">&#34;w&#34;</span> <span class="nb">:refile</span> <span class="p">(</span><span class="nb">:maxlevel</span> <span class="o">.</span> <span class="mi">2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                   <span class="p">(</span><span class="s">&#34;agenda/technical-debt.org&#34;</span>       <span class="nb">:agenda</span> <span class="no">t</span>   <span class="nb">:key</span> <span class="s">&#34;t&#34;</span> <span class="nb">:refile</span> <span class="p">(</span><span class="nb">:maxlevel</span> <span class="o">.</span> <span class="mi">2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                   <span class="p">(</span><span class="s">&#34;agenda/personal.org&#34;</span>             <span class="nb">:agenda</span> <span class="no">t</span>   <span class="nb">:key</span> <span class="s">&#34;p&#34;</span> <span class="nb">:refile</span> <span class="p">(</span><span class="nb">:maxlevel</span> <span class="o">.</span> <span class="mi">2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                   <span class="p">(</span><span class="s">&#34;agenda/books.org&#34;</span>                <span class="nb">:agenda</span> <span class="no">t</span>   <span class="nb">:key</span> <span class="s">&#34;b&#34;</span> <span class="nb">:refile</span> <span class="p">(</span><span class="nb">:maxlevel</span> <span class="o">.</span> <span class="mi">2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                   <span class="p">(</span><span class="s">&#34;agenda/someday.org&#34;</span>              <span class="nb">:agenda</span> <span class="no">t</span>   <span class="nb">:key</span> <span class="s">&#34;s&#34;</span> <span class="nb">:refile</span> <span class="p">(</span><span class="nb">:maxlevel</span> <span class="o">.</span> <span class="mi">2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                   <span class="p">(</span><span class="s">&#34;agenda/agenda.org&#34;</span>               <span class="nb">:agenda</span> <span class="no">t</span>   <span class="nb">:key</span> <span class="s">&#34;a&#34;</span> <span class="nb">:refile</span> <span class="p">(</span><span class="nb">:maxlevel</span> <span class="o">.</span> <span class="mi">2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                   <span class="p">(</span><span class="s">&#34;agenda/note.org&#34;</span>                 <span class="nb">:agenda</span> <span class="no">t</span>   <span class="nb">:key</span> <span class="s">&#34;n&#34;</span> <span class="nb">:refile</span> <span class="p">(</span><span class="nb">:maxlevel</span> <span class="o">.</span> <span class="mi">2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                   <span class="p">(</span><span class="s">&#34;daily/journal.org&#34;</span>               <span class="nb">:agenda</span> <span class="no">t</span>   <span class="nb">:key</span> <span class="s">&#34;j&#34;</span> <span class="nb">:refile</span> <span class="p">(</span><span class="nb">:maxlevel</span> <span class="o">.</span> <span class="mi">2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                   <span class="p">(</span><span class="s">&#34;beancount/2022.beancount&#34;</span>        <span class="nb">:agenda</span> <span class="no">nil</span> <span class="nb">:key</span> <span class="s">&#34;c&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                   <span class="p">(</span><span class="s">&#34;beancount/account.beancount&#34;</span>     <span class="nb">:agenda</span> <span class="no">nil</span> <span class="nb">:key</span> <span class="s">&#34;m&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                   <span class="p">(</span><span class="s">&#34;beancount/credit.beancount&#34;</span>      <span class="nb">:agenda</span> <span class="no">nil</span> <span class="nb">:key</span> <span class="s">&#34;e&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                   <span class="p">(</span><span class="s">&#34;beancount/insurance.beancount&#34;</span>   <span class="nb">:agenda</span> <span class="no">nil</span> <span class="nb">:key</span> <span class="s">&#34;u&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                   <span class="p">(</span><span class="s">&#34;beancount/salary.beancount&#34;</span>      <span class="nb">:agenda</span> <span class="no">nil</span> <span class="nb">:key</span> <span class="s">&#34;l&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                   <span class="p">(</span><span class="s">&#34;beancount/house.beancount&#34;</span>       <span class="nb">:agenda</span> <span class="no">nil</span> <span class="nb">:key</span> <span class="s">&#34;h&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                   <span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; hydra</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">require-package</span> <span class="ss">&#39;hydra</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="p">(</span><span class="nv">defhydra</span> <span class="nv">hydra-org-agenda-menu</span> <span class="p">(</span><span class="nb">:color</span> <span class="nv">blue</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">  Org-agenda-menu
</span></span></span><span class="line"><span class="cl"><span class="s">  ^^^^------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="s">  _i_: inbox     _w_: work      _b_: books     _t_: technical-debt
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s">  _a_: agenda    _p_: personal  _n_: note      _s_: someday   _j_: journal
</span></span></span><span class="line"><span class="cl"><span class="s">  Beancount-menu
</span></span></span><span class="line"><span class="cl"><span class="s">  ^^^^------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="s">  _c_: 2022      _m_: account   _e_: credit    _u_: insurance
</span></span></span><span class="line"><span class="cl"><span class="s">  _l_: salary    _h_: house
</span></span></span><span class="line"><span class="cl"><span class="s">  &#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="s">&#34;i&#34;</span> <span class="nv">org-starter-find-file:inbox</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="s">&#34;w&#34;</span> <span class="nv">org-starter-find-file:work</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="s">&#34;t&#34;</span> <span class="nv">org-starter-find-file:technical-debt</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="s">&#34;p&#34;</span> <span class="nv">org-starter-find-file:personal</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="s">&#34;b&#34;</span> <span class="nv">org-starter-find-file:books</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="s">&#34;n&#34;</span> <span class="nv">org-starter-find-file:note</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="s">&#34;s&#34;</span> <span class="nv">org-starter-find-file:someday</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="s">&#34;a&#34;</span> <span class="nv">org-starter-find-file:agenda</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="s">&#34;j&#34;</span> <span class="nv">org-starter-find-file:journal</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="s">&#34;c&#34;</span> <span class="nv">org-starter-find-file:2022</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="s">&#34;m&#34;</span> <span class="nv">org-starter-find-file:account</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="s">&#34;e&#34;</span> <span class="nv">org-starter-find-file:credit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="s">&#34;u&#34;</span> <span class="nv">org-starter-find-file:insurance</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="s">&#34;l&#34;</span> <span class="nv">org-starter-find-file:salary</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="s">&#34;h&#34;</span> <span class="nv">org-starter-find-file:house</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span><span class="nb">:bind</span><span class="p">(</span><span class="s">&#34;C-c e&#34;</span> <span class="o">.</span> <span class="nv">hydra-org-agenda-menu/body</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">provide</span> <span class="ss">&#39;init-quick-menus</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;; init-quick-menus.el ends here</span>
</span></span></code></pre></div><h3 id="init-tree-sitter-dot-el">init-tree-sitter.el</h3>
<p>其中 <code>elisp</code> 官方还未支持，需要自己编译后放入 <code>tree-sitter-langs</code> 下面。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">git clone https://github.com/Wilfred/tree-sitter-elisp
</span></span><span class="line"><span class="cl">gcc ./src/parser.c -fPIC -I./ --shared -o elisp.so
</span></span><span class="line"><span class="cl">cp ./elisp.so ~/.tree-sitter-langs/bin
</span></span></code></pre></div><p>这里第二步的时候报错了</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">./src/parser.c:1:10: error: <span class="s1">&#39;tree_sitter/parser.h&#39;</span> file not found with &lt;angled&gt; include<span class="p">;</span> use <span class="s2">&#34;quotes&#34;</span> instead
</span></span><span class="line"><span class="cl"><span class="c1">#include &lt;tree_sitter/parser.h&gt;</span>
</span></span><span class="line"><span class="cl">         ^~~~~~~~~~~~~~~~~~~~~~
</span></span><span class="line"><span class="cl">         <span class="s2">&#34;tree_sitter/parser.h&#34;</span>
</span></span><span class="line"><span class="cl"><span class="m">1</span> error generated.
</span></span></code></pre></div><p>这里需要将 <code>src/parser.c</code> 头部按照提示修改一下。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-diff" data-lang="diff"><span class="line"><span class="cl"><span class="gd">- #include &lt;tree_sitter/parser.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="gd"></span><span class="gi">+ #include &#34;tree_sitter/parser.h&#34;
</span></span></span></code></pre></div><p>第三步，由于我是通过 MELPA 安装，路径为 <code>.emacs.d/elpa-29.0/tree-sitter-langs-version/bin</code>​，其中 <code>version</code> 为具体的版本号。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-elisp" data-lang="elisp"><span class="line"><span class="cl"><span class="c1">;;; init-tree-sitter.el --- Configure for tree sitter</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;; Commentary:</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">require-package</span> <span class="ss">&#39;tree-sitter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">require-package</span> <span class="ss">&#39;tree-sitter-langs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">require</span> <span class="ss">&#39;tree-sitter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">require</span> <span class="ss">&#39;tree-sitter-langs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;;; Code:</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">global-tree-sitter-mode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">add-hook</span> <span class="ss">&#39;tree-sitter-after-on-hook</span> <span class="nf">#&#39;</span><span class="nv">tree-sitter-hl-mode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;; Load the language definition for Rust, if it hasn&#39;t been loaded.</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; Return the language object.</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">tree-sitter-require</span> <span class="ss">&#39;rust</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">tree-sitter-require</span> <span class="ss">&#39;python</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">tree-sitter-require</span> <span class="ss">&#39;javascript</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;; Add Emacs-Lisp for tree-sitter:</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; 1. git clone https://github.com/Wilfred/tree-sitter-elisp</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; 2. gcc ./src/parser.c -fPIC -I./ --shared -o elisp.so</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; 3. cp ./elisp.so ~/.tree-sitter-langs/bin (~/.tree-sitter-langs/bin is path of your tree-sitter-langs repo)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">tree-sitter-load</span> <span class="ss">&#39;elisp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">add-to-list</span> <span class="ss">&#39;tree-sitter-major-mode-language-alist</span> <span class="o">&#39;</span><span class="p">(</span><span class="nv">emacs-lisp-mode</span> <span class="o">.</span> <span class="nv">elisp</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">add-to-list</span> <span class="ss">&#39;tree-sitter-major-mode-language-alist</span> <span class="o">&#39;</span><span class="p">(</span><span class="nv">inferior-emacs-lisp-mode</span> <span class="o">.</span> <span class="nv">elisp</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">provide</span> <span class="ss">&#39;init-tree-sitter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;; init-tree-sitter.el ends here</span>
</span></span></code></pre></div><h3 id="init-org-enhance-dot-el">init-org-enhance.el</h3>
<p>一些增强 org 功能的函数，可以方便使用。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-elisp" data-lang="elisp"><span class="line"><span class="cl"><span class="c1">;;; init-org.el --- Org-mode config -*- lexical-binding: t -*-</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;; Commentary:</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; =============================================================</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; ==============  Org-roam-backlinks-search  ==================</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; =============================================================</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; https://github.com/Vidianos-Giannitsis/Dotfiles/blob/master/emacs/.emacs.d/libs/zettelkasten.org#org-roam-backlinks-search</span>
</span></span><span class="line"><span class="cl"> <span class="p">(</span><span class="nb">defcustom</span> <span class="nv">org-roam-backlinks-choices</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;View Backlinks&#34;</span> <span class="s">&#34;Go to Node&#34;</span> <span class="s">&#34;Quit&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="s">&#34;List of choices for </span><span class="ss">`org-roam-backlinks-node-read&#39;</span><span class="s">.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="p">(</span><span class="nb">defun</span> <span class="nv">org-roam-backlinks-query*</span> <span class="p">(</span><span class="nv">NODE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="s">&#34;Gets the backlinks of NODE with </span><span class="ss">`org-roam-db-query&#39;</span><span class="s">.&#34;</span>
</span></span><span class="line"><span class="cl">   <span class="p">(</span><span class="nv">org-roam-db-query</span>
</span></span><span class="line"><span class="cl">          <span class="p">[</span><span class="nb">:select</span> <span class="p">[</span><span class="nv">source</span> <span class="nv">dest</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                   <span class="nb">:from</span> <span class="nv">links</span>
</span></span><span class="line"><span class="cl">                   <span class="nb">:where</span> <span class="p">(</span><span class="nf">=</span> <span class="nv">dest</span> <span class="nv">$s1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                   <span class="nb">:and</span> <span class="p">(</span><span class="nf">=</span> <span class="nv">type</span> <span class="s">&#34;id&#34;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span><span class="nv">org-roam-node-id</span> <span class="nv">NODE</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="p">(</span><span class="nb">defun</span> <span class="nv">org-roam-backlinks-p</span> <span class="p">(</span><span class="nv">SOURCE</span> <span class="nv">NODE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="s">&#34;Predicate function that checks if NODE is a backlink of SOURCE.&#34;</span>
</span></span><span class="line"><span class="cl">   <span class="p">(</span><span class="nb">let*</span> <span class="p">((</span><span class="nv">source-id</span> <span class="p">(</span><span class="nv">org-roam-node-id</span> <span class="nv">SOURCE</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">           <span class="p">(</span><span class="nv">backlinks</span> <span class="p">(</span><span class="nv">org-roam-backlinks-query*</span> <span class="nv">SOURCE</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">           <span class="p">(</span><span class="nv">id</span> <span class="p">(</span><span class="nv">org-roam-node-id</span> <span class="nv">NODE</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">           <span class="p">(</span><span class="nv">id-list</span> <span class="p">(</span><span class="nf">list</span> <span class="nv">id</span> <span class="nv">source-id</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">     <span class="p">(</span><span class="nf">member</span> <span class="nv">id-list</span> <span class="nv">backlinks</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="p">(</span><span class="nb">defun</span> <span class="nv">org-roam-backlinks-poi-or-moc-p</span> <span class="p">(</span><span class="nv">NODE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="s">&#34;Check if NODE has the tag POI or the tag MOC.  Return t if it does.&#34;</span>
</span></span><span class="line"><span class="cl">   <span class="p">(</span><span class="nb">or</span> <span class="p">(</span><span class="nf">string-equal</span> <span class="p">(</span><span class="nf">car</span> <span class="p">(</span><span class="nv">org-roam-node-tags</span> <span class="nv">NODE</span><span class="p">))</span> <span class="s">&#34;POI&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nf">string-equal</span> <span class="p">(</span><span class="nf">car</span> <span class="p">(</span><span class="nv">org-roam-node-tags</span> <span class="nv">NODE</span><span class="p">))</span> <span class="s">&#34;MOC&#34;</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="p">(</span><span class="nb">defun</span> <span class="nv">org-roam-backlinks--read-node-backlinks</span> <span class="p">(</span><span class="nv">source</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="s">&#34;Runs </span><span class="ss">`org-roam-node-read&#39;</span><span class="s"> on the backlinks of SOURCE.
</span></span></span><span class="line"><span class="cl"><span class="s"> The predicate used as </span><span class="ss">`org-roam-node-read&#39;</span><span class="s">&#39;s filter-fn is
</span></span></span><span class="line"><span class="cl"><span class="s"> </span><span class="ss">`org-roam-backlinks-p&#39;</span><span class="s">.&#34;</span>
</span></span><span class="line"><span class="cl">   <span class="p">(</span><span class="nv">org-roam-node-read</span> <span class="no">nil</span> <span class="p">(</span><span class="nv">apply-partially</span> <span class="nf">#&#39;</span><span class="nv">org-roam-backlinks-p</span> <span class="nv">source</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="p">(</span><span class="nb">defun</span> <span class="nv">org-roam-backlinks-node-read</span> <span class="p">(</span><span class="nv">node</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="s">&#34;Read a NODE and run </span><span class="ss">`org-roam-backlinks--read-node-backlinks&#39;</span><span class="s">.
</span></span></span><span class="line"><span class="cl"><span class="s"> Upon selecting a backlink, prompt the user for what to do with
</span></span></span><span class="line"><span class="cl"><span class="s"> the backlink. The prompt is created with </span><span class="ss">`completing-read&#39;</span><span class="s"> with
</span></span></span><span class="line"><span class="cl"><span class="s"> valid options being everything in the list
</span></span></span><span class="line"><span class="cl"><span class="s"> </span><span class="ss">`org-roam-backlinks-choices&#39;</span><span class="s">.
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s"> If the user decides to view the selected node&#39;s backlinks, the
</span></span></span><span class="line"><span class="cl"><span class="s"> function recursively runs itself with the selection as its
</span></span></span><span class="line"><span class="cl"><span class="s"> argument. If they decide they want to go to the selected node,
</span></span></span><span class="line"><span class="cl"><span class="s"> the function runs </span><span class="ss">`find-file&#39;</span><span class="s"> and the file associated to that
</span></span></span><span class="line"><span class="cl"><span class="s"> node. Lastly, if they choose to quit, the function exits
</span></span></span><span class="line"><span class="cl"><span class="s"> silently.&#34;</span>
</span></span><span class="line"><span class="cl">   <span class="p">(</span><span class="nb">let*</span> <span class="p">((</span><span class="nv">backlink</span> <span class="p">(</span><span class="nv">org-roam-backlinks--read-node-backlinks</span> <span class="nv">node</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">           <span class="p">(</span><span class="nv">choice</span> <span class="p">(</span><span class="nf">completing-read</span> <span class="s">&#34;What to do with NODE: &#34;</span>
</span></span><span class="line"><span class="cl">                                    <span class="nv">org-roam-backlinks-choices</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">     <span class="p">(</span><span class="nb">cond</span>
</span></span><span class="line"><span class="cl">      <span class="p">((</span><span class="nf">string-equal</span>
</span></span><span class="line"><span class="cl">         <span class="nv">choice</span>
</span></span><span class="line"><span class="cl">         <span class="p">(</span><span class="nf">car</span> <span class="nv">org-roam-backlinks-choices</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nv">org-roam-backlinks-node-read</span> <span class="nv">backlink</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">      <span class="p">((</span><span class="nf">string-equal</span>
</span></span><span class="line"><span class="cl">         <span class="nv">choice</span>
</span></span><span class="line"><span class="cl">         <span class="p">(</span><span class="nv">cadr</span> <span class="nv">org-roam-backlinks-choices</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nv">find-file</span> <span class="p">(</span><span class="nv">org-roam-node-file</span> <span class="nv">backlink</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">      <span class="p">((</span><span class="nf">string-equal</span>
</span></span><span class="line"><span class="cl">         <span class="nv">choice</span>
</span></span><span class="line"><span class="cl">         <span class="p">(</span><span class="nv">caddr</span> <span class="nv">org-roam-backlinks-choices</span><span class="p">))))))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="p">(</span><span class="nb">defun</span> <span class="nv">org-roam-backlinks-search</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">   <span class="s">&#34;Select an </span><span class="ss">`org-roam-node&#39;</span><span class="s"> and recursively search its backlinks.
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s"> This function is a starter function for
</span></span></span><span class="line"><span class="cl"><span class="s"> </span><span class="ss">`org-roam-backlinks-node-read&#39;</span><span class="s"> which gets the initial node
</span></span></span><span class="line"><span class="cl"><span class="s"> selection from </span><span class="ss">`org-roam-node-list&#39;</span><span class="s">. For more information about
</span></span></span><span class="line"><span class="cl"><span class="s"> this function, check </span><span class="ss">`org-roam-backlinks-node-read&#39;</span><span class="s">.&#34;</span>
</span></span><span class="line"><span class="cl">   <span class="p">(</span><span class="nb">interactive</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="p">(</span><span class="nb">let</span> <span class="p">((</span><span class="nv">node</span> <span class="p">(</span><span class="nv">org-roam-node-read</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">     <span class="p">(</span><span class="nv">org-roam-backlinks-node-read</span> <span class="nv">node</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="p">(</span><span class="nb">defun</span> <span class="nv">org-roam-backlinks-search-from-moc-or-poi</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">   <span class="s">&#34;</span><span class="ss">`org-roam-backlinks-search&#39;</span><span class="s"> with an initial selection filter.
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s"> Since nodes tagged as \&#34;MOC\&#34; or \&#34;POI\&#34; are the entry points to
</span></span></span><span class="line"><span class="cl"><span class="s"> my personal zettelkasten, I have this helper function which is
</span></span></span><span class="line"><span class="cl"><span class="s"> identical to </span><span class="ss">`org-roam-backlinks-search&#39;</span><span class="s"> but filters initial
</span></span></span><span class="line"><span class="cl"><span class="s"> selection to only those notes. That way, they initial selection
</span></span></span><span class="line"><span class="cl"><span class="s"> has a point as it will be on a node that has a decent amount of
</span></span></span><span class="line"><span class="cl"><span class="s"> backlinks.&#34;</span>
</span></span><span class="line"><span class="cl">   <span class="p">(</span><span class="nb">interactive</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="p">(</span><span class="nb">let</span> <span class="p">((</span><span class="nv">node</span> <span class="p">(</span><span class="nv">org-roam-node-read</span> <span class="no">nil</span> <span class="nf">#&#39;</span><span class="nv">org-roam-backlinks-poi-or-moc-p</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">     <span class="p">(</span><span class="nv">org-roam-backlinks-node-read</span> <span class="nv">node</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;; =============================================================</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; ===========  Dynamic org-agenda with org-roam  ==============</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; =============================================================</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; https://gist.github.com/d12frosted/a60e8ccb9aceba031af243dff0d19b2e</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">vulpea-dynamic-p</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;Return non-nil if current buffer has any todo entry.
</span></span></span><span class="line"><span class="cl"><span class="s">TODO entries marked as done are ignored, meaning the this
</span></span></span><span class="line"><span class="cl"><span class="s">function returns nil if current buffer contains only completed
</span></span></span><span class="line"><span class="cl"><span class="s">tasks.&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">seq-find</span>                                 <span class="c1">; (3)</span>
</span></span><span class="line"><span class="cl">   <span class="p">(</span><span class="nb">lambda</span> <span class="p">(</span><span class="nv">type</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">     <span class="p">(</span><span class="nf">eq</span> <span class="nv">type</span> <span class="ss">&#39;todo</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">   <span class="p">(</span><span class="nv">org-element-map</span>                         <span class="c1">; (2)</span>
</span></span><span class="line"><span class="cl">       <span class="p">(</span><span class="nv">org-element-parse-buffer</span> <span class="ss">&#39;headline</span><span class="p">)</span> <span class="c1">; (1)</span>
</span></span><span class="line"><span class="cl">       <span class="ss">&#39;headline</span>
</span></span><span class="line"><span class="cl">     <span class="p">(</span><span class="nb">lambda</span> <span class="p">(</span><span class="nv">h</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="p">(</span><span class="nv">org-element-property</span> <span class="nb">:todo-type</span> <span class="nv">h</span><span class="p">)))))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">vulpea-dynamic-update-tag</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;Update dynamic tag in the current buffer.&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nb">and</span> <span class="p">(</span><span class="nv">not</span> <span class="p">(</span><span class="nf">active-minibuffer-window</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">               <span class="p">(</span><span class="nv">vulpea-buffer-p</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nb">save-excursion</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nf">goto-char</span> <span class="p">(</span><span class="nf">point-min</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nb">let*</span> <span class="p">((</span><span class="nv">tags</span> <span class="p">(</span><span class="nv">vulpea-buffer-tags-get</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">               <span class="p">(</span><span class="nv">original-tags</span> <span class="nv">tags</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span><span class="nb">if</span> <span class="p">(</span><span class="nv">vulpea-dynamic-p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">              <span class="p">(</span><span class="nb">setq</span> <span class="nv">tags</span> <span class="p">(</span><span class="nf">cons</span> <span class="s">&#34;dynamic&#34;</span> <span class="nv">tags</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="nb">setq</span> <span class="nv">tags</span> <span class="p">(</span><span class="nv">remove</span> <span class="s">&#34;dynamic&#34;</span> <span class="nv">tags</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">          <span class="c1">;; cleanup duplicates</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span><span class="nb">setq</span> <span class="nv">tags</span> <span class="p">(</span><span class="nv">seq-uniq</span> <span class="nv">tags</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">          <span class="c1">;; update tags if changed</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nb">or</span> <span class="p">(</span><span class="nv">seq-difference</span> <span class="nv">tags</span> <span class="nv">original-tags</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="p">(</span><span class="nv">seq-difference</span> <span class="nv">original-tags</span> <span class="nv">tags</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="nf">apply</span> <span class="nf">#&#39;</span><span class="nv">vulpea-buffer-tags-set</span> <span class="nv">tags</span><span class="p">))))))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">vulpea-buffer-p</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;Return non-nil if the currently visited buffer is a note.&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">and</span> <span class="nf">buffer-file-name</span>
</span></span><span class="line"><span class="cl">       <span class="p">(</span><span class="nv">string-prefix-p</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nf">expand-file-name</span> <span class="p">(</span><span class="nf">file-name-as-directory</span> <span class="nv">org-roam-directory</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nf">file-name-directory</span> <span class="nf">buffer-file-name</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">vulpea-dynamic-files</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;Return a list of note files containing &#39;dynamic&#39; tag.&#34;</span> <span class="c1">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nv">seq-uniq</span>
</span></span><span class="line"><span class="cl">     <span class="p">(</span><span class="nv">seq-map</span>
</span></span><span class="line"><span class="cl">      <span class="nf">#&#39;car</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nv">org-roam-db-query</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span><span class="nb">:select</span> <span class="p">[</span><span class="nv">nodes:file</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="nb">:from</span> <span class="nv">tags</span>
</span></span><span class="line"><span class="cl">        <span class="nb">:left-join</span> <span class="nv">nodes</span>
</span></span><span class="line"><span class="cl">        <span class="nb">:on</span> <span class="p">(</span><span class="nf">=</span> <span class="nv">tags:node-id</span> <span class="nv">nodes:id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">:where</span> <span class="p">(</span><span class="nv">like</span> <span class="nv">tag</span> <span class="p">(</span><span class="nb">quote</span> <span class="s">&#34;%\&#34;dynamic\&#34;%&#34;</span><span class="p">))]))))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">vulpea-agenda-files-update</span> <span class="p">(</span><span class="kp">&amp;rest</span> <span class="nv">_</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;Update the value of </span><span class="ss">`org-agenda-files&#39;</span><span class="s">.&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">;; (setq org-agenda-files (vulpea-dynamic-files)))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">setq</span> <span class="nv">org-agenda-files</span> <span class="p">(</span><span class="nv">seq-uniq</span>
</span></span><span class="line"><span class="cl">                          <span class="p">(</span><span class="nf">append</span>
</span></span><span class="line"><span class="cl">                           <span class="p">(</span><span class="nv">vulpea-dynamic-files</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                           <span class="p">(</span><span class="nv">file-expand-wildcards</span> <span class="s">&#34;~/Dropbox/org/agenda/*.org&#34;</span><span class="p">)))))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">add-hook</span> <span class="ss">&#39;find-file-hook</span> <span class="nf">#&#39;</span><span class="nv">vulpea-dynamic-update-tag</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">add-hook</span> <span class="ss">&#39;before-save-hook</span> <span class="nf">#&#39;</span><span class="nv">vulpea-dynamic-update-tag</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">advice-add</span> <span class="ss">&#39;org-agenda</span> <span class="nb">:before</span> <span class="nf">#&#39;</span><span class="nv">vulpea-agenda-files-update</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">advice-add</span> <span class="ss">&#39;org-todo-list</span> <span class="nb">:before</span> <span class="nf">#&#39;</span><span class="nv">vulpea-agenda-files-update</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;; functions borrowed from `vulpea&#39; library</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; https://github.com/d12frosted/vulpea/blob/6a735c34f1f64e1f70da77989e9ce8da7864e5ff/vulpea-buffer.el</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">vulpea-buffer-tags-get</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;Return filetags value in current buffer.&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">vulpea-buffer-prop-get-list</span> <span class="s">&#34;filetags&#34;</span> <span class="s">&#34;[ :]&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">vulpea-buffer-tags-set</span> <span class="p">(</span><span class="kp">&amp;rest</span> <span class="nv">tags</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;Set TAGS in current buffer.
</span></span></span><span class="line"><span class="cl"><span class="s">If filetags value is already set, replace it.&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">if</span> <span class="nv">tags</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nv">vulpea-buffer-prop-set</span>
</span></span><span class="line"><span class="cl">       <span class="s">&#34;filetags&#34;</span> <span class="p">(</span><span class="nf">concat</span> <span class="s">&#34;:&#34;</span> <span class="p">(</span><span class="nv">string-join</span> <span class="nv">tags</span> <span class="s">&#34;:&#34;</span><span class="p">)</span> <span class="s">&#34;:&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nv">vulpea-buffer-prop-remove</span> <span class="s">&#34;filetags&#34;</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">vulpea-buffer-tags-add</span> <span class="p">(</span><span class="nv">tag</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;Add a TAG to filetags in current buffer.&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">let*</span> <span class="p">((</span><span class="nv">tags</span> <span class="p">(</span><span class="nv">vulpea-buffer-tags-get</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">         <span class="p">(</span><span class="nv">tags</span> <span class="p">(</span><span class="nf">append</span> <span class="nv">tags</span> <span class="p">(</span><span class="nf">list</span> <span class="nv">tag</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nf">apply</span> <span class="nf">#&#39;</span><span class="nv">vulpea-buffer-tags-set</span> <span class="nv">tags</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">vulpea-buffer-tags-remove</span> <span class="p">(</span><span class="nv">tag</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;Remove a TAG from filetags in current buffer.&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">let*</span> <span class="p">((</span><span class="nv">tags</span> <span class="p">(</span><span class="nv">vulpea-buffer-tags-get</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">         <span class="p">(</span><span class="nv">tags</span> <span class="p">(</span><span class="nf">delete</span> <span class="nv">tag</span> <span class="nv">tags</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nf">apply</span> <span class="nf">#&#39;</span><span class="nv">vulpea-buffer-tags-set</span> <span class="nv">tags</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">vulpea-buffer-prop-set</span> <span class="p">(</span><span class="nv">name</span> <span class="nv">value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;Set a file property called NAME to VALUE in buffer file.
</span></span></span><span class="line"><span class="cl"><span class="s">If the property is already set, replace its value.&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">setq</span> <span class="nv">name</span> <span class="p">(</span><span class="nf">downcase</span> <span class="nv">name</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">org-with-point-at</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">let</span> <span class="p">((</span><span class="nv">case-fold-search</span> <span class="no">t</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nb">if</span> <span class="p">(</span><span class="nf">re-search-forward</span> <span class="p">(</span><span class="nf">concat</span> <span class="s">&#34;^#\\+&#34;</span> <span class="nv">name</span> <span class="s">&#34;:\\(.*\\)&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                             <span class="p">(</span><span class="nf">point-max</span><span class="p">)</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span><span class="nf">replace-match</span> <span class="p">(</span><span class="nf">concat</span> <span class="s">&#34;#+&#34;</span> <span class="nv">name</span> <span class="s">&#34;: &#34;</span> <span class="nv">value</span><span class="p">)</span> <span class="ss">&#39;fixedcase</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nb">while</span> <span class="p">(</span><span class="nb">and</span> <span class="p">(</span><span class="nv">not</span> <span class="p">(</span><span class="nf">eobp</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                    <span class="p">(</span><span class="nf">looking-at</span> <span class="s">&#34;^[#:]&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span><span class="nb">if</span> <span class="p">(</span><span class="nb">save-excursion</span> <span class="p">(</span><span class="nf">end-of-line</span><span class="p">)</span> <span class="p">(</span><span class="nf">eobp</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">              <span class="p">(</span><span class="nb">progn</span>
</span></span><span class="line"><span class="cl">                <span class="p">(</span><span class="nf">end-of-line</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="p">(</span><span class="nf">insert</span> <span class="s">&#34;\n&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="nf">forward-line</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="nf">beginning-of-line</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nf">insert</span> <span class="s">&#34;#+&#34;</span> <span class="nv">name</span> <span class="s">&#34;: &#34;</span> <span class="nv">value</span> <span class="s">&#34;\n&#34;</span><span class="p">)))))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">vulpea-buffer-prop-set-list</span> <span class="p">(</span><span class="nv">name</span> <span class="nv">values</span> <span class="kp">&amp;optional</span> <span class="nv">separators</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;Set a file property called NAME to VALUES in current buffer.
</span></span></span><span class="line"><span class="cl"><span class="s">VALUES are quoted and combined into single string using
</span></span></span><span class="line"><span class="cl"><span class="s"></span><span class="ss">`combine-and-quote-strings&#39;</span><span class="s">.
</span></span></span><span class="line"><span class="cl"><span class="s">If SEPARATORS is non-nil, it should be a regular expression
</span></span></span><span class="line"><span class="cl"><span class="s">matching text that separates, but is not part of, the substrings.
</span></span></span><span class="line"><span class="cl"><span class="s">If nil it defaults to </span><span class="ss">`split-string-default-separators&#39;</span><span class="s">, normally
</span></span></span><span class="line"><span class="cl"><span class="s">\&#34;[ \f\t\n\r\v]+\&#34;, and OMIT-NULLS is forced to t.
</span></span></span><span class="line"><span class="cl"><span class="s">If the property is already set, replace its value.&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">vulpea-buffer-prop-set</span>
</span></span><span class="line"><span class="cl">   <span class="nv">name</span> <span class="p">(</span><span class="nv">combine-and-quote-strings</span> <span class="nv">values</span> <span class="nv">separators</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">vulpea-buffer-prop-get</span> <span class="p">(</span><span class="nv">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;Get a buffer property called NAME as a string.&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">org-with-point-at</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nf">re-search-forward</span> <span class="p">(</span><span class="nf">concat</span> <span class="s">&#34;^#\\+&#34;</span> <span class="nv">name</span> <span class="s">&#34;: \\(.*\\)&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                             <span class="p">(</span><span class="nf">point-max</span><span class="p">)</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nf">buffer-substring-no-properties</span>
</span></span><span class="line"><span class="cl">       <span class="p">(</span><span class="nf">match-beginning</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="p">(</span><span class="nf">match-end</span> <span class="mi">1</span><span class="p">)))))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">vulpea-buffer-prop-get-list</span> <span class="p">(</span><span class="nv">name</span> <span class="kp">&amp;optional</span> <span class="nv">separators</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;Get a buffer property NAME as a list using SEPARATORS.
</span></span></span><span class="line"><span class="cl"><span class="s">If SEPARATORS is non-nil, it should be a regular expression
</span></span></span><span class="line"><span class="cl"><span class="s">matching text that separates, but is not part of, the substrings.
</span></span></span><span class="line"><span class="cl"><span class="s">If nil it defaults to </span><span class="ss">`split-string-default-separators&#39;</span><span class="s">, normally
</span></span></span><span class="line"><span class="cl"><span class="s">\&#34;[ \f\t\n\r\v]+\&#34;, and OMIT-NULLS is forced to t.&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">let</span> <span class="p">((</span><span class="nv">value</span> <span class="p">(</span><span class="nv">vulpea-buffer-prop-get</span> <span class="nv">name</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nb">and</span> <span class="nv">value</span> <span class="p">(</span><span class="nv">not</span> <span class="p">(</span><span class="nv">string-empty-p</span> <span class="nv">value</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nv">split-string-and-unquote</span> <span class="nv">value</span> <span class="nv">separators</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">vulpea-buffer-prop-remove</span> <span class="p">(</span><span class="nv">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;Remove a buffer property called NAME.&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">org-with-point-at</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nf">re-search-forward</span> <span class="p">(</span><span class="nf">concat</span> <span class="s">&#34;\\(^#\\+&#34;</span> <span class="nv">name</span> <span class="s">&#34;:.*\n?\\)&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                             <span class="p">(</span><span class="nf">point-max</span><span class="p">)</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nf">replace-match</span> <span class="s">&#34;&#34;</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;; =============================================================</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; ======================  Archiving  ==========================</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; =============================================================</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;; (setq org-archive-mark-done nil)</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; (setq org-archive-location &#34;%s_archive::* Archive&#34;)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;; https://gist.github.com/kepi/2f4acc3cc93403c75fbba5684c5d852d</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; org-archive-subtree-hierarchical.el</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; version 0.2</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; modified from https://lists.gnu.org/archive/html/emacs-orgmode/2014-08/msg00109.html</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; modified from https://stackoverflow.com/a/35475878/259187</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;; In orgmode</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; * A</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; ** AA</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; *** AAA</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; ** AB</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; *** ABA</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; Archiving AA will remove the subtree from the original file and create</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; it like that in archive target:</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;; * AA</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; ** AAA</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;; And this give you</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; * A</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; ** AA</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; *** AAA</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; Install file to your include path and include in your init file with:</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;  (require &#39;org-archive-subtree-hierarchical)</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;  (setq org-archive-default-command &#39;org-archive-subtree-hierarchical)</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">provide</span> <span class="ss">&#39;org-archive-subtree-hierarchical</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">org-archive-default-command</span> <span class="ss">&#39;org-archive-subtree-hierarchical</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">require</span> <span class="ss">&#39;org-archive</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">org-archive-subtree-hierarchical--line-content-as-string</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;Returns the content of the current line as a string&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">save-excursion</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nf">beginning-of-line</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nf">buffer-substring-no-properties</span>
</span></span><span class="line"><span class="cl">     <span class="p">(</span><span class="nf">line-beginning-position</span><span class="p">)</span> <span class="p">(</span><span class="nf">line-end-position</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">org-archive-subtree-hierarchical--org-child-list</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;This function returns all children of a heading as a list. &#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">interactive</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">save-excursion</span>
</span></span><span class="line"><span class="cl">    <span class="c1">;; this only works with org-version &gt; 8.0, since in previous</span>
</span></span><span class="line"><span class="cl">    <span class="c1">;; org-mode versions the function (org-outline-level) returns</span>
</span></span><span class="line"><span class="cl">    <span class="c1">;; gargabe when the point is not on a heading.</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">if</span> <span class="p">(</span><span class="nf">=</span> <span class="p">(</span><span class="nv">org-outline-level</span><span class="p">)</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nv">outline-next-visible-heading</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nv">org-goto-first-child</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">let</span> <span class="p">((</span><span class="nv">child-list</span> <span class="p">(</span><span class="nf">list</span> <span class="p">(</span><span class="nv">org-archive-subtree-hierarchical--line-content-as-string</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nb">while</span> <span class="p">(</span><span class="nv">org-goto-sibling</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nb">setq</span> <span class="nv">child-list</span> <span class="p">(</span><span class="nf">cons</span> <span class="p">(</span><span class="nv">org-archive-subtree-hierarchical--line-content-as-string</span><span class="p">)</span> <span class="nv">child-list</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">      <span class="nv">child-list</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">org-archive-subtree-hierarchical--org-struct-subtree</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;This function returns the tree structure in which a subtree
</span></span></span><span class="line"><span class="cl"><span class="s">belongs as a list.&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">interactive</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">let</span> <span class="p">((</span><span class="nv">archive-tree</span> <span class="no">nil</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">save-excursion</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nb">while</span> <span class="p">(</span><span class="nv">org-up-heading-safe</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nb">let</span> <span class="p">((</span><span class="nv">heading</span>
</span></span><span class="line"><span class="cl">               <span class="p">(</span><span class="nf">buffer-substring-no-properties</span>
</span></span><span class="line"><span class="cl">                <span class="p">(</span><span class="nf">line-beginning-position</span><span class="p">)</span> <span class="p">(</span><span class="nf">line-end-position</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span><span class="nb">if</span> <span class="p">(</span><span class="nf">eq</span> <span class="nv">archive-tree</span> <span class="no">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">              <span class="p">(</span><span class="nb">setq</span> <span class="nv">archive-tree</span> <span class="p">(</span><span class="nf">list</span> <span class="nv">heading</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="nb">setq</span> <span class="nv">archive-tree</span> <span class="p">(</span><span class="nf">cons</span> <span class="nv">heading</span> <span class="nv">archive-tree</span><span class="p">))))))</span>
</span></span><span class="line"><span class="cl">    <span class="nv">archive-tree</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">org-archive-subtree-hierarchical</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;This function archives a subtree hierarchical&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">interactive</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">let</span> <span class="p">((</span><span class="nv">org-tree</span> <span class="p">(</span><span class="nv">org-archive-subtree-hierarchical--org-struct-subtree</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nv">this-buffer</span> <span class="p">(</span><span class="nf">current-buffer</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nv">file</span> <span class="p">(</span><span class="nv">abbreviate-file-name</span>
</span></span><span class="line"><span class="cl">               <span class="p">(</span><span class="nb">or</span> <span class="p">(</span><span class="nf">buffer-file-name</span> <span class="p">(</span><span class="nf">buffer-base-buffer</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                   <span class="p">(</span><span class="ne">error</span> <span class="s">&#34;No file associated to buffer&#34;</span><span class="p">)))))</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">save-excursion</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nb">setq</span> <span class="nv">location</span> <span class="nv">org-archive-location</span>
</span></span><span class="line"><span class="cl">            <span class="nv">afile</span> <span class="p">(</span><span class="nf">car</span> <span class="p">(</span><span class="nv">org-archive--compute-location</span>
</span></span><span class="line"><span class="cl">                                   <span class="p">(</span><span class="nb">or</span> <span class="p">(</span><span class="nv">org-entry-get</span> <span class="no">nil</span> <span class="s">&#34;ARCHIVE&#34;</span> <span class="ss">&#39;inherit</span><span class="p">)</span> <span class="nv">location</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">            <span class="c1">;; heading (org-extract-archive-heading location)</span>
</span></span><span class="line"><span class="cl">            <span class="nv">infile-p</span> <span class="p">(</span><span class="nf">equal</span> <span class="nv">file</span> <span class="p">(</span><span class="nv">abbreviate-file-name</span> <span class="p">(</span><span class="nb">or</span> <span class="nv">afile</span> <span class="s">&#34;&#34;</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nb">unless</span> <span class="nv">afile</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="ne">error</span> <span class="s">&#34;Invalid </span><span class="ss">`org-archive-location&#39;</span><span class="s">&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nb">if</span> <span class="p">(</span><span class="nf">&gt;</span> <span class="p">(</span><span class="nf">length</span> <span class="nv">afile</span><span class="p">)</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span><span class="nb">setq</span> <span class="nv">newfile-p</span> <span class="p">(</span><span class="nv">not</span> <span class="p">(</span><span class="nf">file-exists-p</span> <span class="nv">afile</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="nv">visiting</span> <span class="p">(</span><span class="nv">find-buffer-visiting</span> <span class="nv">afile</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="nv">buffer</span> <span class="p">(</span><span class="nb">or</span> <span class="nv">visiting</span> <span class="p">(</span><span class="nv">find-file-noselect</span> <span class="nv">afile</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nb">setq</span> <span class="nv">buffer</span> <span class="p">(</span><span class="nf">current-buffer</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nb">unless</span> <span class="nv">buffer</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="ne">error</span> <span class="s">&#34;Cannot access file \&#34;%s\&#34;&#34;</span> <span class="nv">afile</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nv">org-cut-subtree</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nf">set-buffer</span> <span class="nv">buffer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nv">org-mode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nf">goto-char</span> <span class="p">(</span><span class="nf">point-min</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nb">while</span> <span class="p">(</span><span class="nv">not</span> <span class="p">(</span><span class="nf">equal</span> <span class="nv">org-tree</span> <span class="no">nil</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nb">let</span> <span class="p">((</span><span class="nv">child-list</span> <span class="p">(</span><span class="nv">org-archive-subtree-hierarchical--org-child-list</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span><span class="nb">if</span> <span class="p">(</span><span class="nf">member</span> <span class="p">(</span><span class="nf">car</span> <span class="nv">org-tree</span><span class="p">)</span> <span class="nv">child-list</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">              <span class="p">(</span><span class="nb">progn</span>
</span></span><span class="line"><span class="cl">                <span class="p">(</span><span class="nf">search-forward</span> <span class="p">(</span><span class="nf">car</span> <span class="nv">org-tree</span><span class="p">)</span> <span class="no">nil</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="p">(</span><span class="nb">setq</span> <span class="nv">org-tree</span> <span class="p">(</span><span class="nf">cdr</span> <span class="nv">org-tree</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="nb">progn</span>
</span></span><span class="line"><span class="cl">              <span class="p">(</span><span class="nf">goto-char</span> <span class="p">(</span><span class="nf">point-max</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">              <span class="p">(</span><span class="nv">newline</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">              <span class="p">(</span><span class="nv">org-insert-struct</span> <span class="nv">org-tree</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">              <span class="p">(</span><span class="nb">setq</span> <span class="nv">org-tree</span> <span class="no">nil</span><span class="p">)))))</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nv">newline</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nv">org-yank</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nv">not</span> <span class="p">(</span><span class="nf">eq</span> <span class="nv">this-buffer</span> <span class="nv">buffer</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nv">save-buffer</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nf">message</span> <span class="s">&#34;Subtree archived %s&#34;</span>
</span></span><span class="line"><span class="cl">               <span class="p">(</span><span class="nf">concat</span> <span class="s">&#34;in file: &#34;</span> <span class="p">(</span><span class="nv">abbreviate-file-name</span> <span class="nv">afile</span><span class="p">))))))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">org-insert-struct</span> <span class="p">(</span><span class="nv">struct</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;TODO&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">interactive</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">when</span> <span class="nv">struct</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nf">insert</span> <span class="p">(</span><span class="nf">car</span> <span class="nv">struct</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nv">newline</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nv">org-insert-struct</span> <span class="p">(</span><span class="nf">cdr</span> <span class="nv">struct</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">org-archive-subtree</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">org-archive-subtree-hierarchical</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;; =============================================================</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; ==============  Hierachy for title nodes  ===================</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; =============================================================</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; Codes blow are used to general a hierachy for title nodes that under a file</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">cl-defmethod</span> <span class="nv">org-roam-node-doom-filetitle</span> <span class="p">((</span><span class="nv">node</span> <span class="nv">org-roam-node</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;Return the value of \&#34;#+title:\&#34; (if any) from file that NODE resides in.
</span></span></span><span class="line"><span class="cl"><span class="s">If there&#39;s no file-level title in the file, return empty string.&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">or</span> <span class="p">(</span><span class="nb">if</span> <span class="p">(</span><span class="nf">=</span> <span class="p">(</span><span class="nv">org-roam-node-level</span> <span class="nv">node</span><span class="p">)</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span><span class="nv">org-roam-node-title</span> <span class="nv">node</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nv">org-roam-get-keyword</span> <span class="s">&#34;TITLE&#34;</span> <span class="p">(</span><span class="nv">org-roam-node-file</span> <span class="nv">node</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">      <span class="s">&#34;&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">cl-defmethod</span> <span class="nv">org-roam-node-doom-hierarchy</span> <span class="p">((</span><span class="nv">node</span> <span class="nv">org-roam-node</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;Return hierarchy for NODE, constructed of its file title, OLP and direct title.
</span></span></span><span class="line"><span class="cl"><span class="s">  If some elements are missing, they will be stripped out.&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">let</span> <span class="p">((</span><span class="nv">title</span>     <span class="p">(</span><span class="nv">org-roam-node-title</span> <span class="nv">node</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nv">olp</span>       <span class="p">(</span><span class="nv">org-roam-node-olp</span>   <span class="nv">node</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nv">level</span>     <span class="p">(</span><span class="nv">org-roam-node-level</span> <span class="nv">node</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nv">filetitle</span> <span class="p">(</span><span class="nv">org-roam-node-doom-filetitle</span> <span class="nv">node</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nv">separator</span> <span class="p">(</span><span class="nf">propertize</span> <span class="s">&#34; &gt; &#34;</span> <span class="ss">&#39;face</span> <span class="ss">&#39;shadow</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">cl-case</span> <span class="nv">level</span>
</span></span><span class="line"><span class="cl">      <span class="c1">;; node is a top-level file</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="mi">0</span> <span class="nv">filetitle</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="c1">;; node is a level 1 heading</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="mi">1</span> <span class="p">(</span><span class="nf">concat</span> <span class="p">(</span><span class="nf">propertize</span> <span class="nv">filetitle</span> <span class="ss">&#39;face</span> <span class="o">&#39;</span><span class="p">(</span><span class="nv">shadow</span> <span class="nv">italic</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                 <span class="nv">separator</span> <span class="nv">title</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">      <span class="c1">;; node is a heading with an arbitrary outline path</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="no">t</span> <span class="p">(</span><span class="nf">concat</span> <span class="p">(</span><span class="nf">propertize</span> <span class="nv">filetitle</span> <span class="ss">&#39;face</span> <span class="o">&#39;</span><span class="p">(</span><span class="nv">shadow</span> <span class="nv">italic</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                 <span class="nv">separator</span> <span class="p">(</span><span class="nf">propertize</span> <span class="p">(</span><span class="nv">string-join</span> <span class="nv">olp</span> <span class="s">&#34; &gt; &#34;</span><span class="p">)</span> <span class="ss">&#39;face</span> <span class="o">&#39;</span><span class="p">(</span><span class="nv">shadow</span> <span class="nv">italic</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                 <span class="nv">separator</span> <span class="nv">title</span><span class="p">)))))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">org-roam-node-display-template</span> <span class="p">(</span><span class="nf">concat</span> <span class="s">&#34;${type:15} ${doom-hierarchy:80} &#34;</span> <span class="p">(</span><span class="nf">propertize</span> <span class="s">&#34;${tags:*}&#34;</span> <span class="ss">&#39;face</span> <span class="ss">&#39;org-tag</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">provide</span> <span class="ss">&#39;init-org-enhance</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;; init-org-enhance.el ends here</span>
</span></span></code></pre></div><h2 id="export">Export</h2>
<p>对于只需要导出某个 header 下的内容的需求，只需要在 header 上加上 <code>:export:</code> 即可。</p>
<h3 id="markdown-file">Markdown file</h3>
<p>这里用的是 <a href="https://github.com/kawabata/ox-pandoc">ox-pandoc</a>， ~M-x org-pandoc-export-as-gfm~算是我找到最符合 MarkDown 语法的转换了，Emacs 自己的转换会将 Table 转换成 HTML 标签的格式。</p>
<h3 id="hugo">Hugo</h3>
<p>在文件头部添加</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">#+HUGO_BASE_DIR: ~/Dropbox/hugo/
</span></span><span class="line"><span class="cl">#+HUGO_SECTION: posts/main
</span></span><span class="line"><span class="cl">#+HUGO_WEIGHT: auto
</span></span><span class="line"><span class="cl">#+HUGO_AUTO_SET_LASTMOD: t
</span></span></code></pre></div><p>需要导出为 <code>&lt;mark&gt;&lt;/mark&gt;</code> 时<sup id="fnref1:3"><a href="#fn:3" class="footnote-ref" role="doc-noteref">3</a></sup></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-org" data-lang="org"><span class="line"><span class="cl"><span class="c">#+begin_mark</span>
</span></span><span class="line"><span class="cl">marked text
</span></span><span class="line"><span class="cl"><span class="c">#+end_mark</span>
</span></span></code></pre></div><p>需要导出为块级 <code>&lt;mark&gt;&lt;/mark&gt;</code> 时，也就是前后的空格不进行 trim。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-org" data-lang="org"><span class="line"><span class="cl"><span class="cs">#+header</span><span class="c">: :trim-pre nil :trim-post nil</span>
</span></span><span class="line"><span class="cl"><span class="c">#+begin_mark</span>
</span></span><span class="line"><span class="cl">marked text
</span></span><span class="line"><span class="cl"><span class="c">#+end_mark</span>
</span></span></code></pre></div><h3 id="latex">Latex</h3>
<h4 id="dependency">Dependency</h4>
<p>需要安装 texlive</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">brew install texlive
</span></span></code></pre></div><h4 id="latex-语法">Latex 语法</h4>
<p><a href="/posts/main/20220616162256-latex/">Latex 语法</a></p>
<h4 id="pdf-导出报错">PDF 导出报错</h4>
<ul>
<li><code>Unicode character 考 (U+8003) not set up for use with LaTeX.</code> 是因为 Latex 本身不支持中文。</li>
</ul>
<h4 id="中文-pdf-导出设置">中文 PDF 导出设置</h4>
<ol>
<li>使用 <a href="https://github.com/ElegantLaTeX/ElegantPaper">ElegantPaper</a>，需要将 elegantpaper.cls 文件放在 org 目录下。</li>
<li>安装依赖</li>
</ol>
<p>代码块需要用到 <code>minted</code>​，需要用到 <code>pygments</code> 作为依赖。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">brew install pygments
</span></span></code></pre></div><ol>
<li>导出文件头部增加</li>
</ol>
<!--listend-->
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-org" data-lang="org"><span class="line"><span class="cl"><span class="cs">#+LATEX_COMPILER</span><span class="c">: xelatex</span>
</span></span><span class="line"><span class="cl"><span class="cs">#+LATEX_CLASS</span><span class="c">: elegantpaper</span>
</span></span><span class="line"><span class="cl"><span class="cs">#+OPTIONS</span><span class="c">: prop:t</span>
</span></span></code></pre></div><div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p><a href="https://orgmode.org/manual/Tracking-your-habits.html">Tracking your habits</a>&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2">
<p><a href="https://gist.github.com/kepi/2f4acc3cc93403c75fbba5684c5d852d">Hierarchical archiving for Org-mode</a>&#160;<a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:3">
<p><a href="https://ox-hugo.scripter.co/doc/org-special-blocks/">Org Special Blocks</a>&#160;<a href="#fnref:3" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a>&#160;<a href="#fnref1:3" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</div>
]]></content:encoded>
    </item>
    
    <item>
      <title>Git Skills</title>
      <link>https://sheerwill.live/posts/main/20220503160055-git-skills/</link>
      <pubDate>Mon, 19 Sep 2022 22:57:55 +0800</pubDate>
      
      <guid>https://sheerwill.live/posts/main/20220503160055-git-skills/</guid>
      <description>删除以往的提交记录 git checkout --orphan latest_branch git add -A git commit -am &amp;#34;commit message&amp;#34; git branch -D main git branch -m main git push -f origin main 发现上次提交的内容有误，需要再次修改，但不想重复提交，而是合并到上一次提</description>
      <content:encoded><![CDATA[<h2 id="删除以往的提交记录">删除以往的提交记录</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">git checkout --orphan latest_branch
</span></span><span class="line"><span class="cl">git add -A
</span></span><span class="line"><span class="cl">git commit -am <span class="s2">&#34;commit message&#34;</span>
</span></span><span class="line"><span class="cl">git branch -D main
</span></span><span class="line"><span class="cl">git branch -m main
</span></span><span class="line"><span class="cl">git push -f origin main
</span></span></code></pre></div><h2 id="发现上次提交的内容有误-需要再次修改-但不想重复提交-而是合并到上一次提交中-并且不更新提交-comment">发现上次提交的内容有误，需要再次修改，但不想重复提交，而是合并到上一次提交中，并且不更新提交 comment。</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">git commit --amend --no-edit
</span></span></code></pre></div><h3 id="amend-修改最新的一次-commit-将这次的-stage-change-直接添加到上一次-commit-中"><code>--amend</code>: 修改最新的一次 commit，将这次的 stage change 直接添加到上一次 commit 中。</h3>
<h3 id="no-edit-不修改上一次-commit-的-comment-直接使用上一次的-comment-如果需要修改的是最新一次-comment-的内容-则不需要该参数-就可以修改-comment"><code>--no-edit</code>: 不修改上一次 commit 的 comment，直接使用上一次的 comment。如果需要修改的是最新一次 comment 的内容，则不需要该参数，就可以修改 comment。</h3>
]]></content:encoded>
    </item>
    
    <item>
      <title>Tools to Increase Productivity and Efficiency</title>
      <link>https://sheerwill.live/posts/main/20220506185941-tools_to_increase_productivity_and_efficiency/</link>
      <pubDate>Wed, 31 Aug 2022 22:52:43 +0800</pubDate>
      
      <guid>https://sheerwill.live/posts/main/20220506185941-tools_to_increase_productivity_and_efficiency/</guid>
      <description>Misc Templatemaker 制作各种纸盒的教程，可以选择对应的例子下载剪裁的 PDF。 Wi-Phi – Wireless Philosophy 很赞的网站：Wireless Philosophy，简称 Wi-Phi ，一个开放的哲学</description>
      <content:encoded><![CDATA[<h2 id="misc">Misc</h2>
<ol>
<li>
<p><a href="https://www.templatemaker.nl/zh-cn/">Templatemaker</a></p>
<p>制作各种纸盒的教程，可以选择对应的例子下载剪裁的 PDF。</p>
</li>
<li>
<p><a href="https://www.wi-phi.com/">Wi-Phi – Wireless Philosophy</a></p>
<p>很赞的网站：Wireless Philosophy，简称 Wi-Phi ，一个开放的哲学网站，致力于以轻松有趣的动画形式阐释哲学问题及哲学思维方式。建于2013年，现在已经有105个哲学动画上线了。</p>
</li>
</ol>
<h2 id="writing">Writing</h2>
<ol>
<li>
<p><a href="https://github.com/doocs/md">WeChat Markdown Editor</a></p>
<p>一款高度简洁的微信 Markdown 编辑器：支持 Markdown 语法、色盘取色、多图上传、一键下载文档、自定义 CSS 样式、一键重置等特性。</p>
</li>
</ol>
<h3 id="查找-citations-的网站">查找 citations 的网站</h3>
<ol>
<li>
<p><a href="https://zbib.org/">zoterobib</a></p>
<p>Your bibliography is empty. To add a source, paste or type its URL, ISBN, DOI, PMID, arXiv ID, or title into the search box above</p>
</li>
<li>
<p><a href="https://www.doi2bib.org/">doi2bib</a></p>
<p>give us a DOI and we will do our best to get you the BibTeX entry</p>
</li>
<li>
<p><a href="https://www.bibsonomy.org/">BibSonomy</a></p>
<p>The easy way to manage scientific publications and bookmarks</p>
<p>BibSonomy helps you to manage your publications and bookmarks, to collaborate with your colleagues and to find new interesting material for your research.</p>
</li>
<li>
<p><a href="http://www.bibtexsearch.com/">BibTeX Search</a></p>
<p>You&rsquo;re searching over millions of BibTeX records&hellip;</p>
</li>
<li>
<p><a href="https://scholar.google.com/">Google Scholar</a></p>
<p>站在巨人的肩膀上</p>
</li>
</ol>
<h4 id="book">Book</h4>
<p>For books I usually use a site, where it is possible to get Bibtex citations from Amazon.com articles. This is very good for books, and some inproceedings and incollections might be found here as well.</p>
<ol>
<li><a href="https://lead.to/amazon/com/">Amazon</a></li>
</ol>
<h4 id="article">Article</h4>
<p>As a Software Engineer I quite often have to deal with technical papers from ACM or IEEE. Both their catalogs provide Bibtex export capabilities.</p>
<ol>
<li>
<p><a href="https://dl.acm.org/">ACM</a></p>
</li>
<li>
<p><a href="https://ieeexplore.ieee.org/Xplore/home.jsp">IEEE Xplore</a></p>
<p>Advancing Technology for Humanity</p>
</li>
</ol>
<h2 id="book">Book</h2>
<ol>
<li>
<p><a href="http://libgen.rs/">Library Genesis</a></p>
<p>电子书资源查找，中英文都有，英文相对较多。</p>
</li>
<li>
<p><a href="https://www.loudreader.com/">Ebook Reader for web</a></p>
<p>在线阅读 PDF、azw3、epub、mobi 几种格式。</p>
</li>
</ol>
<h2 id="video">Video</h2>
<ol>
<li>
<p><a href="https://sound-effects.bbcrewind.co.uk/">BBC Sound effects</a></p>
<p>BBC 提供的免费下载的音效的网站。</p>
</li>
</ol>
<h2 id="medicine">Medicine</h2>
<ol>
<li>
<p><a href="https://www.msdmanuals.cn/">默沙东诊疗手册</a></p>
<p>顾名思义，权威的诊疗查询手册。</p>
</li>
</ol>
<h2 id="design">Design</h2>
<h3 id="color-picker">Color Picker</h3>
<ul>
<li>
<p><a href="https://nipponcolors.com/">日本の伝統色</a></p>
<p>日本的一个颜色拾取网站，很漂亮。</p>
</li>
</ul>
<h3 id="plantuml">PlantUML</h3>
<ul>
<li>
<p><a href="https://real-world-plantuml.com/">Real World PlantUML</a></p>
<p>PlantUML 例子</p>
</li>
</ul>
<h2 id="chrome-extension">Chrome extension</h2>
<ol>
<li>
<p><a href="https://www.languagereactor.com/">Language Reactor</a></p>
<p>提供 NetFlix、Youtube、TurtleTube、Video File、Text 的翻译，以及 Flashcards。</p>
</li>
</ol>
<h2 id="front-end">Front-End</h2>
<ol>
<li>
<p><a href="https://codepen.io/">codepen</a></p>
<p>The best place to build, test, and discover front-end code</p>
</li>
</ol>
]]></content:encoded>
    </item>
    
    <item>
      <title>Doom Emacs</title>
      <link>https://sheerwill.live/posts/main/20220505220832-doom-emacs/</link>
      <pubDate>Mon, 29 Aug 2022 21:30:20 +0800</pubDate>
      
      <guid>https://sheerwill.live/posts/main/20220505220832-doom-emacs/</guid>
      <description>Introduction Emacs outshines all other editing software in approximately the same way that the noonday sun does the stars. It is not just bigger and brighter; it simply makes everything else vanish. – Neal Stephenson, In the Beginning was the Command Line (1998) Install Emacs With Homebrew First, Doom’s dependencies: brew install git ripgrep brew install coreutils fd xcode-selected --install emacs-mac. It offers good integration</description>
      <content:encoded><![CDATA[<h2 id="introduction">Introduction</h2>
<blockquote>
<p>Emacs outshines all other editing software in approximately the same way that the noonday sun does the stars. It is not just bigger and brighter; it simply makes everything else vanish.</p>
<p>– Neal Stephenson, In the Beginning was the Command Line (1998)</p>
</blockquote>
<h2 id="install-emacs-with-homebrew">Install Emacs With Homebrew</h2>
<p>First, Doom’s dependencies:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">brew install git ripgrep
</span></span><span class="line"><span class="cl">brew install coreutils fd
</span></span><span class="line"><span class="cl">xcode-selected --install
</span></span></code></pre></div><p><a href="https://bitbucket.org/mituharu/emacs-mac/src">emacs-mac</a>. It offers good integration with macOS, native emojis and better childframe support.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">brew tap d12frosted/emacs-plus
</span></span><span class="line"><span class="cl">brew install emacs-plus --with-native-comp --with-modern-vscode-icon
</span></span><span class="line"><span class="cl">ln -s /usr/local/opt/emacs-plus@29/Emacs.app /Applications
</span></span></code></pre></div><h2 id="doom-emacs">Doom Emacs</h2>
<p>With Emacs and Doom&rsquo;s dependencies installed, next is to install Doom Emacs itself:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">git clone https://github.com/hlissner/doom-emacs ~/.emacs.d
</span></span><span class="line"><span class="cl">~/.emacs.d/bin/doom install
</span></span></code></pre></div><p>如果提示 <code>.emacs.d</code> 已存在，删除重新执行上述命令即可。</p>
<p><code>.zshrc</code> 中需要添加 <code>export PATH=&quot;$HOME/.emacs.d/bin:$PATH</code> ，这样就可以直接使用 <code>doom</code> 命令了。</p>
<h3 id="doom-doctor-问题"><code>Doom Doctor</code> 问题</h3>
<ol>
<li>Warning: unable to detect fonts because fontconfig isn&rsquo;t installed</li>
</ol>
<!--listend-->
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">brew install fontconfig
</span></span></code></pre></div><ol>
<li>! Couldn&rsquo;t find shellcheck. Shell script linting will not work</li>
</ol>
<!--listend-->
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">brew install shellcheck
</span></span></code></pre></div><ol>
<li>Couldn&rsquo;t find the dot executable (from graphviz). org-roam will not be able to generate graph visualizations.</li>
</ol>
<!--listend-->
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">brew install graphviz
</span></span></code></pre></div><ol>
<li>This installed grep binary was not built with support for PCRE lookaheads. Some advanced consult filtering features will not work as a result, see the module readme.</li>
</ol>
<!--listend-->
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">#  因为 Mac 本身安装的是 BSD 的。</span>
</span></span><span class="line"><span class="cl">grep --version
</span></span><span class="line"><span class="cl"><span class="c1"># 可以看到 grep (BSD grep, GNU compatible) 2.6.0-FreeBSD ，即 BSD 版本。</span>
</span></span><span class="line"><span class="cl">brew install grep
</span></span><span class="line"><span class="cl"><span class="c1"># 安装 GNU 的 grep，并在 .zshrc 中配置 PATH=&#34;/usr/local/opt/grep/libexec/gnubin:$PATH&#34; 即可。再次查看版本可以看到如下。</span>
</span></span><span class="line"><span class="cl"><span class="c1"># grep (GNU grep) 3.7</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Packaged by Homebrew</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Copyright (C) 2021 Free Software Foundation, Inc.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># License GPLv3+: GNU GPL version 3 or later &lt;https://gnu.org/licenses/gpl.html&gt;.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># This is free software: you are free to change and redistribute it.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># There is NO WARRANTY, to the extent permitted by law.</span>
</span></span></code></pre></div><h2 id="org-roam">Org-roam</h2>
<p>具体的配置文件在 <code>.doom.d/</code> 下，参见 <a href="https://github.com/LuciusChen/dotfiles/tree/master/.doom.d">.doom.d</a>。</p>
<h2 id="shortcuts">Shortcuts</h2>
<table>
<thead>
<tr>
<th>Shortcuts</th>
<th>功能</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>C-RET</code></td>
<td>在当前 headline 所属的内容后建立一个同级 headline</td>
<td>无 headline 时创建一个一级 headline</td>
</tr>
<tr>
<td><code>M-RET</code></td>
<td>在当前 headline 后建立一个同级 headline</td>
<td>同上</td>
</tr>
<tr>
<td><code>M-right</code></td>
<td>降低当前 headline 的层级</td>
<td></td>
</tr>
<tr>
<td><code>M-left</code></td>
<td>提高当前 headline 的层级</td>
<td></td>
</tr>
<tr>
<td><code>M-up</code></td>
<td>将当前 headline 及其内容作为整体向上移动</td>
<td></td>
</tr>
<tr>
<td><code>M-down</code></td>
<td>将当前 headline 及其内容作为整体向下移动</td>
<td></td>
</tr>
<tr>
<td><code>C-return</code></td>
<td>在当前列表项的内容后建立一个同级列表项</td>
<td>光标在列表项同一行时有效</td>
</tr>
<tr>
<td><code>M-RET</code></td>
<td>在当前列表项后建立一个同级列表项</td>
<td>同上</td>
</tr>
<tr>
<td><code>M-right</code></td>
<td>降低当前列表项的层级</td>
<td>同上</td>
</tr>
<tr>
<td><code>M-left</code></td>
<td>提高当前列表项的层级</td>
<td>同上</td>
</tr>
<tr>
<td><code>M-up</code></td>
<td>将当前列表项及其内容作为整体向上移动</td>
<td>同上</td>
</tr>
<tr>
<td><code>M-down</code></td>
<td>将当前列表项及其内容作为整体向下移动</td>
<td>同上</td>
</tr>
<tr>
<td><code>C-x-o</code></td>
<td>切换窗口</td>
<td>C-x 中有很多操作，可以看提示。</td>
</tr>
<tr>
<td><code>C-c C-c</code></td>
<td>在创建 node 编写完毕后快速保存</td>
<td></td>
</tr>
<tr>
<td><code>C-g</code></td>
<td>取消操作</td>
<td></td>
</tr>
<tr>
<td><code>C-x-d</code></td>
<td>进入 dired 模式</td>
<td></td>
</tr>
<tr>
<td><code>SPC f r</code></td>
<td>查找最近文件</td>
<td></td>
</tr>
<tr>
<td><code>C-c C-x C-v</code></td>
<td>显示图片</td>
<td></td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>Shortcuts</th>
<th>功能</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>C-c C-s</code></td>
<td></td>
<td>设置任务开始时间</td>
</tr>
<tr>
<td><code>C-c C-d</code></td>
<td>设置任务截止时间</td>
<td></td>
</tr>
<tr>
<td><code>C-c C-t</code></td>
<td>改变任务状态</td>
<td></td>
</tr>
<tr>
<td><code>S-Up/Down</code></td>
<td>设置任务优先级 [#A], [#B], [#C]</td>
<td></td>
</tr>
<tr>
<td><code>C-c C-x C-i</code></td>
<td>开始任务计时</td>
<td></td>
</tr>
<tr>
<td><code>C-c C-x C-o</code></td>
<td>终止任务计时</td>
<td></td>
</tr>
<tr>
<td><code>C-c [</code></td>
<td>将当前文件加入 Org-Agenda</td>
<td></td>
</tr>
<tr>
<td><code>C-c ]</code></td>
<td>将当前文件从 Org-Agenda 移除</td>
<td></td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>Shortcuts</th>
<th>功能</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>t</code></td>
<td>在 Org-Agenda 的任务条目上， 修改任务状态。</td>
<td></td>
</tr>
<tr>
<td><code>C-c C-x C-a</code></td>
<td>归档</td>
<td></td>
</tr>
<tr>
<td><code>C-c C-w</code></td>
<td>activate refile</td>
<td></td>
</tr>
<tr>
<td><code>I</code></td>
<td>在 Org-Agenda 的任务条目上， 开始计时。</td>
<td></td>
</tr>
<tr>
<td><code>O</code></td>
<td>在 Org-Agenda 的任务条目上， 终止计时。</td>
<td></td>
</tr>
<tr>
<td><code>z</code></td>
<td>在任务上添加 note</td>
<td></td>
</tr>
<tr>
<td><code>R</code></td>
<td>clock mode, 显示耗时。</td>
<td></td>
</tr>
<tr>
<td><code>C-c C-x C-l</code></td>
<td>预览 Latex</td>
<td></td>
</tr>
<tr>
<td><code>C-c \</code></td>
<td>按 tag 搜索</td>
<td>好像只能单文件内</td>
</tr>
<tr>
<td><code>C-C C-o</code></td>
<td>打开链接</td>
<td></td>
</tr>
</tbody>
</table>
<h2 id="org-grammar">Org grammar</h2>
<h3 id="basic">basic</h3>
<p>This is almost anything you need to know about Org mode syntax:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-org" data-lang="org"><span class="line"><span class="cl"><span class="gh">*</span><span class="gs"> This Is A Heading</span>
</span></span><span class="line"><span class="cl"><span class="gu">**</span> This Is A Sub-Heading
</span></span><span class="line"><span class="cl"><span class="gu">***</span> And A Sub-Sub-Heading
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Paragraphs are separated by at least one empty line.
</span></span><span class="line"><span class="cl"><span class="gs">*bold*</span> <span class="ge">/italic/</span> <span class="gl">_underlined_</span> <span class="gd">+strikethrough+</span> <span class="nc">=monospaced=</span>
</span></span><span class="line"><span class="cl">[[<span class="na">http://Karl-Voit.at</span>][<span class="nt">Link description</span>]]
</span></span><span class="line"><span class="cl">http://Karl-Voit.at → link without description
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">- </span>list item
</span></span><span class="line"><span class="cl"><span class="k">- </span>another item
</span></span><span class="line"><span class="cl">  <span class="k">- </span>sub-item
</span></span><span class="line"><span class="cl">    <span class="k">1.</span> also enumerated
</span></span><span class="line"><span class="cl">    <span class="k">2.</span> if you like
</span></span><span class="line"><span class="cl"><span class="k">- [ ]</span> yet to be done
</span></span><span class="line"><span class="cl"><span class="k">- [X]</span> item which is done
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">: Simple pre-formatted text such as for source code.
</span></span><span class="line"><span class="cl">: This also respects the line breaks. <span class="gs">*bold*</span> is not bold here.
</span></span></code></pre></div><h3 id="code-block">code block</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">myresult</span> <span class="o">=</span> <span class="mi">42</span> <span class="o">*</span> <span class="mi">23</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Hello Europe! &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">myresult</span><span class="p">))</span>
</span></span></code></pre></div><h3 id="table">table</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-org" data-lang="org"><span class="line"><span class="cl"><span class="s">| My Column 1 | My Column 2 | Last Column |</span>
</span></span><span class="line"><span class="cl"><span class="s">|-------------+-------------+-------------|</span>
</span></span><span class="line"><span class="cl"><span class="s">|          42 | foo         | bar         |</span>
</span></span><span class="line"><span class="cl"><span class="s">|          23 | baz         | abcdefg     |</span>
</span></span><span class="line"><span class="cl"><span class="s">|-------------+-------------+-------------|</span>
</span></span><span class="line"><span class="cl"><span class="s">|          65 |             |             |</span>
</span></span></code></pre></div><h2 id="export">Export</h2>
<p>对于只需要导出某个 header 下的内容的需求，只需要在 header 上加上 <code>:export:</code> 即可。</p>
<h3 id="markdown-file">Markdown file</h3>
<p>这里用的是 <a href="https://github.com/kawabata/ox-pandoc">ox-pandoc</a>， <code>M-x org-pandoc-export-as-gfm</code> 算是我找到最符合 MarkDown 语法的转换了，Emacs 自己的转换会将 Table 转换成 HTML 标签的格式。</p>
<h3 id="hugo">Hugo</h3>
<p>在文件头部添加</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">#+HUGO_BASE_DIR: ~/Dropbox/hugo/
</span></span><span class="line"><span class="cl">#+HUGO_SECTION: posts/main
</span></span><span class="line"><span class="cl">#+HUGO_WEIGHT: auto
</span></span><span class="line"><span class="cl">#+HUGO_AUTO_SET_LASTMOD: t
</span></span></code></pre></div><p>需要导出为 <code>&lt;mark&gt;&lt;/mark&gt;</code> 时<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-org" data-lang="org"><span class="line"><span class="cl"><span class="c">#+begin_mark</span>
</span></span><span class="line"><span class="cl">marked text
</span></span><span class="line"><span class="cl"><span class="c">#+end_mark</span>
</span></span></code></pre></div><p>需要导出为块级 <code>&lt;mark&gt;&lt;/mark&gt;</code> 时，也就是前后的空格不进行 trim。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-org" data-lang="org"><span class="line"><span class="cl"><span class="cs">#+header</span><span class="c">: :trim-pre nil :trim-post nil</span>
</span></span><span class="line"><span class="cl"><span class="c">#+begin_mark</span>
</span></span><span class="line"><span class="cl">marked text
</span></span><span class="line"><span class="cl"><span class="c">#+end_mark</span>
</span></span></code></pre></div><h3 id="latex">Latex</h3>
<h4 id="dependency">Dependency</h4>
<p>需要安装 texlive</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">brew install texlive
</span></span></code></pre></div><h4 id="latex-语法">Latex 语法</h4>
<p><a href="/posts/main/20220616162256-latex/">Latex 语法</a></p>
<h4 id="pdf-导出报错">PDF 导出报错</h4>
<ul>
<li><code>Unicode character 考 (U+8003) not set up for use with LaTeX.</code> 是因为 Latex 本身不支持中文。</li>
</ul>
<h4 id="中文-pdf-导出设置">中文 PDF 导出设置</h4>
<ol>
<li>使用 <a href="https://github.com/ElegantLaTeX/ElegantPaper">ElegantPaper</a>，需要将 elegantpaper.cls 文件放在 org 目录下。</li>
<li>安装依赖</li>
</ol>
<!--listend-->
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">brew install pygments
</span></span></code></pre></div><ol>
<li>导出文件头部增加</li>
</ol>
<!--listend-->
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-org" data-lang="org"><span class="line"><span class="cl"><span class="cs">#+LATEX_COMPILER</span><span class="c">: xelatex</span>
</span></span><span class="line"><span class="cl"><span class="cs">#+LATEX_CLASS</span><span class="c">: elegantpaper</span>
</span></span><span class="line"><span class="cl"><span class="cs">#+OPTIONS</span><span class="c">: prop:t</span>
</span></span></code></pre></div><div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p><a href="https://ox-hugo.scripter.co/doc/org-special-blocks/">Org Special Blocks</a>&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</div>
]]></content:encoded>
    </item>
    
    <item>
      <title>Personal Knowledge Wiki</title>
      <link>https://sheerwill.live/posts/main/20220508195206-personal_knowledge_wiki/</link>
      <pubDate>Thu, 25 Aug 2022 13:34:27 +0800</pubDate>
      
      <guid>https://sheerwill.live/posts/main/20220508195206-personal_knowledge_wiki/</guid>
      <description>Hardware HHKB Logitech MX Master 3 for Mac MacBook Pro (15-inch, 2017) DELL U2417H Bose QC 35 NFAUDIO 二单元娄氏动铁 NF2u Sony A7M3 iPhone 11 Pro Kindle Paper White Software Git Git Skills Design Tools Figma Excalidraw Pinboard Tools to Increase Productivity and Efficiency Workflow HammerSpoon Hugo Karabiner-Elements Doom Emacs Vanilla Emacs with Purcell Beancount Latex Anki Editor VSCode Terminal Squirrel 输入法词</description>
      <content:encoded><![CDATA[<h2 id="hardware">Hardware</h2>
<ul>
<li>HHKB</li>
<li>Logitech MX Master 3 for Mac</li>
<li>MacBook Pro (15-inch, 2017)</li>
<li>DELL U2417H</li>
<li>Bose QC 35</li>
<li>NFAUDIO 二单元娄氏动铁 NF2u</li>
<li>Sony A7M3</li>
<li>iPhone 11 Pro</li>
<li>Kindle Paper White</li>
</ul>
<h2 id="software">Software</h2>
<h3 id="git">Git</h3>
<ul>
<li><a href="/posts/main/20220503160055-git-skills/">Git Skills</a></li>
</ul>
<h3 id="design-tools">Design Tools</h3>
<ul>
<li><a href="/posts/main/20220503154744-figma/">Figma</a></li>
<li>Excalidraw</li>
</ul>
<h3 id="pinboard">Pinboard</h3>
<ul>
<li><a href="/posts/main/20220506185941-tools_to_increase_productivity_and_efficiency/">Tools to Increase Productivity and Efficiency</a></li>
</ul>
<h3 id="workflow">Workflow</h3>
<ul>
<li><a href="/posts/main/20220520185239-hammerspoon/">HammerSpoon</a></li>
<li><a href="/posts/main/20220607104757-hugo/">Hugo</a></li>
<li><a href="/posts/main/20220805101927-karabiner_elements/">Karabiner-Elements</a></li>
<li><a href="113872fb-68e6-4865-9b95-cf3f6de57191">Doom Emacs</a></li>
<li><a href="/posts/main/20220723211325-vanilla_emacs_with_purcell/">Vanilla Emacs with Purcell</a></li>
<li><a href="/posts/main/20220821223012-beancount/">Beancount</a></li>
<li><a href="/posts/main/20220616162256-latex/">Latex</a></li>
<li><a href="/posts/main/20220706112803-anki/">Anki</a></li>
</ul>
<h3 id="editor">Editor</h3>
<ul>
<li><a href="/posts/main/20220629203733-vscode/">VSCode</a></li>
<li><a href="/posts/main/20220629204553-terminal/">Terminal</a></li>
</ul>
<h3 id="squirrel">Squirrel</h3>
<p>输入法词库扩充 - <a href="https://github.com/felixonmars/fcitx5-pinyin-zhwiki">肥猫百万维基词库</a></p>
<p>下载 Releases 中的 <code>zhwiki.dict.yaml</code> 到 <code>/Library/Rime/</code> 下，我使用的是「朙月拼音・简化字」版本，因此可以在 <code>luna_pinyin_simp.custom.yaml</code> 中找到下面配置。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c">#  載入朙月拼音擴充詞庫</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">&#34;translator/dictionary&#34;: </span><span class="l">luna_pinyin.extended</span><span class="w">
</span></span></span></code></pre></div><p>扩展的词库都配置在 <code>luna_pinyin.extended.dict.yaml</code> 中，添加需要扩展的词库即可。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">import_tables</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">luna_pinyin</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">luna_pinyin.sgmain</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">luna_pinyin.hanyu</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">luna_pinyin.poetry</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">luna_pinyin.cn_en</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">zhwiki</span><span class="w">
</span></span></span></code></pre></div><h3 id="chrome-extensions">Chrome Extensions</h3>
<h4 id="online-dictionary-helper">Online Dictionary Helper</h4>
<p>和 Anki 配合记忆单词十分好用</p>
<h4 id="dark-reader">Dark Reader</h4>
<p>可以让浏览器的界面变成超级舒服的棕黄色，很适合阅读。</p>
<h4 id="為什麼你們就是不能加個空格呢">為什麼你們就是不能加個空格呢？</h4>
<p>强迫症福音，可以给网页中英文之间自动加上空格。</p>
<h4 id="the-great-suspender">The Great Suspender</h4>
<p>将暂时不用的 Chrome Tabs 暂停，降低内存的使用。</p>
<h4 id="rsshub-radar-chrome-web-store"><a href="https://chrome.google.com/webstore/detail/rsshub-radar/kefjpfngnndepjbopdmoebkipbgkggaa/related">RSSHub Radar - Chrome Web Store</a></h4>
<p>识别当前网站的 RSS</p>
<h3 id="calibre">Calibre</h3>
<h4 id="e-book-viewer">E-book viewer</h4>
<p>字体设置，Preferences &gt; Styles 中添加下面的 CSS。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-css" data-lang="css"><span class="line"><span class="cl"><span class="nt">body</span> <span class="o">&gt;</span> <span class="o">*,</span> <span class="nt">span</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">font-family</span><span class="p">:</span> <span class="s2">&#34;LXGW WenKai Screen&#34;</span> <span class="cp">!important</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="photos">Photos</h3>
<p>因为现在 iCloud 导出的照片会将 Live photos 转换成 <code>.MOV</code> 格式的视频，所以先要删除这部份视频。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">rm -f *<span class="o">[</span>IMG<span class="o">]</span>*.MOV
</span></span></code></pre></div><p>然后执行脚本分发照片。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">io</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">shutil</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">pyheif</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">exifread</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">PIL.Image</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">PIL.ExifTags</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">listdir</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">isfile</span><span class="p">,</span> <span class="n">join</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">mkexifdirs</span> <span class="p">(</span><span class="n">filedicts</span><span class="p">,</span> <span class="n">timeStr</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">dirlocal</span> <span class="o">=</span> <span class="nb">dir</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">timeStr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">timeStr</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">st_birthtime</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y:%m:</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">dirlocal</span> <span class="o">=</span> <span class="nb">dir</span> <span class="o">+</span> <span class="s1">&#39;no-exif/&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="n">timeStr</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">timeStr</span><span class="p">,</span> <span class="s2">&#34;%Y:%m:</span><span class="si">%d</span><span class="s2"> %H:%M:%S&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">filedicts</span><span class="p">[</span><span class="s1">&#39;timeStr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">timeStr</span>
</span></span><span class="line"><span class="cl">    <span class="n">filedicts</span><span class="p">[</span><span class="s1">&#39;directory&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dirlocal</span> <span class="o">+</span> <span class="n">timeStr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">filedicts</span><span class="p">[</span><span class="s1">&#39;directorySec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dirlocal</span> <span class="o">+</span> <span class="n">timeStr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">timeStr</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">movefile</span> <span class="p">(</span><span class="n">filedicts</span><span class="p">,</span> <span class="n">joined</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">directory</span> <span class="o">=</span> <span class="n">filedicts</span><span class="p">[</span><span class="s1">&#39;directory&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">directorySec</span> <span class="o">=</span> <span class="n">filedicts</span><span class="p">[</span><span class="s1">&#39;directorySec&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">directorySec</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">directorySec</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">directorySec</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">directorySec</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 目标路径存在</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 目标路径下无相同文件存在</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">directorySec</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directorySec</span><span class="p">,</span> <span class="n">filename</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">        <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">joined</span><span class="p">,</span> <span class="n">directorySec</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">joined</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 目标文件夹</span>
</span></span><span class="line"><span class="cl"><span class="nb">dir</span> <span class="o">=</span> <span class="s1">&#39;/Users/luciuschen/Dropbox/Media/Photos/Girl/&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 存在 exif 信息并且当中含有 DateTime，则在当前目录下按照 DateTime 分类</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 不存在 exif 或者 exif 中不含有 DateTime，则在 no-exif 文件夹下进行分类</span>
</span></span><span class="line"><span class="cl"><span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">listdir</span><span class="p">(</span><span class="nb">dir</span><span class="p">)</span> <span class="k">if</span> <span class="n">isfile</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="nb">dir</span><span class="p">,</span> <span class="n">f</span><span class="p">))]</span>
</span></span><span class="line"><span class="cl"><span class="n">filedicts</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;timeStr&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;directory&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;directorySec&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">continue</span>
</span></span><span class="line"><span class="cl">    <span class="n">joined</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">((</span><span class="s1">&#39;png&#39;</span><span class="p">,</span> <span class="s1">&#39;jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;jpeg&#39;</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">        <span class="n">img</span> <span class="o">=</span> <span class="n">PIL</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">joined</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">_getexif</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="n">exif</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">PIL</span><span class="o">.</span><span class="n">ExifTags</span><span class="o">.</span><span class="n">TAGS</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span> <span class="n">v</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">img</span><span class="o">.</span><span class="n">_getexif</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">PIL</span><span class="o">.</span><span class="n">ExifTags</span><span class="o">.</span><span class="n">TAGS</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="s1">&#39;DateTime&#39;</span> <span class="ow">in</span> <span class="n">exif</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">mkexifdirs</span> <span class="p">(</span><span class="n">filedicts</span><span class="p">,</span> <span class="n">exif</span><span class="p">[</span><span class="s1">&#39;DateTime&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">19</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">mkexifdirs</span><span class="p">(</span><span class="n">filedicts</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">mkexifdirs</span><span class="p">(</span><span class="n">filedicts</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">movefile</span><span class="p">(</span><span class="n">filedicts</span><span class="p">,</span> <span class="n">joined</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">filename</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&#34;.heic&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">heif_file</span> <span class="o">=</span> <span class="n">pyheif</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">tags</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">metadata</span> <span class="ow">in</span> <span class="n">heif_file</span><span class="o">.</span><span class="n">metadata</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># data 数据中前六个字符 b&#39;Exif 是我们不需要的</span>
</span></span><span class="line"><span class="cl">            <span class="n">file_stream</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="mi">6</span><span class="p">:])</span>
</span></span><span class="line"><span class="cl">            <span class="n">tags</span> <span class="o">=</span> <span class="n">exifread</span><span class="o">.</span><span class="n">process_file</span><span class="p">(</span><span class="n">file_stream</span><span class="p">,</span> <span class="n">details</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">tags</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">tags</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">tags</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;EXIF DateTimeOriginal&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="n">mkexifdirs</span> <span class="p">(</span><span class="n">filedicts</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">tags</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;EXIF DateTimeOriginal&#34;</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">                <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">mkexifdirs</span><span class="p">(</span><span class="n">filedicts</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">mkexifdirs</span><span class="p">(</span><span class="n">filedicts</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">movefile</span><span class="p">(</span><span class="n">filedicts</span><span class="p">,</span> <span class="n">joined</span><span class="p">)</span>
</span></span></code></pre></div><p>优化版本，这里将处理没有 exif 信息和有 exif 信息的方法合并，不同的部分作为参数。（后续需要学一下 macro 和 generics 的区别和使用场景）</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">io</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">shutil</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">pyheif</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">exifread</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">PIL.Image</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">PIL.ExifTags</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">listdir</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">isfile</span><span class="p">,</span> <span class="n">join</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">mkexifdirs</span> <span class="p">(</span><span class="n">filedicts</span><span class="p">,</span> <span class="n">timeStr</span><span class="p">,</span> <span class="n">dirlocal</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">timeStr</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">timeStr</span><span class="p">,</span> <span class="s2">&#34;%Y:%m:</span><span class="si">%d</span><span class="s2"> %H:%M:%S&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">filedicts</span><span class="p">[</span><span class="s1">&#39;timeStr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">timeStr</span>
</span></span><span class="line"><span class="cl">    <span class="n">filedicts</span><span class="p">[</span><span class="s1">&#39;directory&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dirlocal</span> <span class="o">+</span> <span class="n">timeStr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">filedicts</span><span class="p">[</span><span class="s1">&#39;directorySec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dirlocal</span> <span class="o">+</span> <span class="n">timeStr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">timeStr</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">movefile</span> <span class="p">(</span><span class="n">filedicts</span><span class="p">,</span> <span class="n">joined</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">directory</span> <span class="o">=</span> <span class="n">filedicts</span><span class="p">[</span><span class="s1">&#39;directory&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">directorySec</span> <span class="o">=</span> <span class="n">filedicts</span><span class="p">[</span><span class="s1">&#39;directorySec&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">directorySec</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">directorySec</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 目标路径存在</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 目标路径下无相同文件存在</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">directorySec</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directorySec</span><span class="p">,</span> <span class="n">filename</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">        <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">joined</span><span class="p">,</span> <span class="n">directorySec</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">joined</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">dir</span> <span class="o">=</span> <span class="s1">&#39;/Users/luciuschen/&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 存在 exif 信息并且当中含有 DateTime，则在当前目录下按照 DateTime 分类</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 不存在 exif 或者 exif 中不含有 DateTime，则在 no-exif 文件夹下进行分类</span>
</span></span><span class="line"><span class="cl"><span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">listdir</span><span class="p">(</span><span class="nb">dir</span><span class="p">)</span> <span class="k">if</span> <span class="n">isfile</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="nb">dir</span><span class="p">,</span> <span class="n">f</span><span class="p">))]</span>
</span></span><span class="line"><span class="cl"><span class="n">filedicts</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;timeStr&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;directory&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;directorySec&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">continue</span>
</span></span><span class="line"><span class="cl">    <span class="n">joined</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">filebirthtime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">st_birthtime</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y:%m:</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">((</span><span class="s1">&#39;png&#39;</span><span class="p">,</span> <span class="s1">&#39;jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;jpeg&#39;</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">        <span class="n">img</span> <span class="o">=</span> <span class="n">PIL</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">joined</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">_getexif</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="n">exif</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">PIL</span><span class="o">.</span><span class="n">ExifTags</span><span class="o">.</span><span class="n">TAGS</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span> <span class="n">v</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">img</span><span class="o">.</span><span class="n">_getexif</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">PIL</span><span class="o">.</span><span class="n">ExifTags</span><span class="o">.</span><span class="n">TAGS</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="s1">&#39;DateTime&#39;</span> <span class="ow">in</span> <span class="n">exif</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">mkexifdirs</span> <span class="p">(</span><span class="n">filedicts</span><span class="p">,</span> <span class="n">exif</span><span class="p">[</span><span class="s1">&#39;DateTime&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">19</span><span class="p">],</span> <span class="nb">dir</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">mkexifdirs</span><span class="p">(</span><span class="n">filedicts</span><span class="p">,</span> <span class="n">filebirthtime</span><span class="p">,</span> <span class="nb">dir</span> <span class="o">+</span> <span class="s1">&#39;no-exif/&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">mkexifdirs</span><span class="p">(</span><span class="n">filedicts</span><span class="p">,</span> <span class="n">filebirthtime</span><span class="p">,</span> <span class="nb">dir</span> <span class="o">+</span> <span class="s1">&#39;no-exif/&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">movefile</span><span class="p">(</span><span class="n">filedicts</span><span class="p">,</span> <span class="n">joined</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">filename</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&#34;.heic&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">heif_file</span> <span class="o">=</span> <span class="n">pyheif</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">tags</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">metadata</span> <span class="ow">in</span> <span class="n">heif_file</span><span class="o">.</span><span class="n">metadata</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># data 数据中前六个字符 b&#39;Exif 是我们不需要的</span>
</span></span><span class="line"><span class="cl">            <span class="n">file_stream</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="mi">6</span><span class="p">:])</span>
</span></span><span class="line"><span class="cl">            <span class="n">tags</span> <span class="o">=</span> <span class="n">exifread</span><span class="o">.</span><span class="n">process_file</span><span class="p">(</span><span class="n">file_stream</span><span class="p">,</span> <span class="n">details</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">tags</span> <span class="ow">and</span> <span class="n">tags</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;EXIF DateTimeOriginal&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">mkexifdirs</span> <span class="p">(</span><span class="n">filedicts</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">tags</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;EXIF DateTimeOriginal&#34;</span><span class="p">)),</span> <span class="nb">dir</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">mkexifdirs</span><span class="p">(</span><span class="n">filedicts</span><span class="p">,</span> <span class="n">filebirthtime</span><span class="p">,</span> <span class="nb">dir</span> <span class="o">+</span> <span class="s1">&#39;no-exif/&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">movefile</span><span class="p">(</span><span class="n">filedicts</span><span class="p">,</span> <span class="n">joined</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span>
</span></span></code></pre></div>]]></content:encoded>
    </item>
    
    <item>
      <title>Distribution System</title>
      <link>https://sheerwill.live/posts/main/20220602202933-distribution_system/</link>
      <pubDate>Wed, 24 Aug 2022 21:10:20 +0800</pubDate>
      
      <guid>https://sheerwill.live/posts/main/20220602202933-distribution_system/</guid>
      <description>Remote Procedure Call Remote Procedure Call (RPC) 使得调用远程函数就像调用本地函数一样，这样就不需要关心资源的具体问题，实际上 RPC 是将方法调用转换成了网络通信。但是遇到通信失败怎</description>
      <content:encoded><![CDATA[<h2 id="remote-procedure-call">Remote Procedure Call</h2>
<p><a href="/posts/main/20220603220847-remote_procedure_call_rpc/">Remote Procedure Call (RPC)</a> 使得调用远程函数就像调用本地函数一样，这样就不需要关心资源的具体问题，实际上 RPC 是将方法调用转换成了网络通信。但是遇到通信失败怎么办？</p>
<ol>
<li>如果在函数调用过程中，服务挂了？</li>
<li>如果消息丢失了？</li>
<li>如果消息延迟了？</li>
<li>如果出了问题，回复消息是否安全？</li>
</ol>
<p>要解决这些问题，就需要将网络以及节点之间的情况抽象出来，以及时序的问题。在设计分布式算法时，需要更加抽象一点，以便更好的推理整个过程。</p>
<h2 id="system-model">System model</h2>
<h3 id="network-behaviour">Network behaviour</h3>
<p><a href="/posts/main/20220602202247-the_two_generals_problem/">The two generals problem</a> 描述了网络通信丢失的场景。</p>
<p>假设两个节点之是间双向的点对点的通信。</p>
<h4 id="reliable-links">Reliable links</h4>
<p>一条消息只会在被一个节点发送的时候才会收到，并且消息是可以重新排序的。</p>
<p>中间没有伪造消息等行为，发送了就一定会被收到。</p>
<h4 id="fair-loss-links">Fair-loss links</h4>
<p>消息可能会丢失、重复或重新排序，如果你一直重新发送，消息终将会传递过去。</p>
<p>每次发送消息成功的概率都是非零，这个时候只要一直重试，我们就假设消息一定会传递到另外一个节点。</p>
<p><strong>Fair-lose links 其实可以通过不断的重试以及并且对重复收到的消息去重，就可以达到 Reliable links 的效果。</strong></p>
<h4 id="arbitrary-links">Arbitrary links</h4>
<p>可能传递过程中会有恶意的第三方对消息进行干预。</p>
<p>比如公共场合的公共 WiFi 就会出现这种情况。</p>
<p><strong>Arbitrary links 通过 TLS 的加持，就可以达到 Fair-loss links 的效果。</strong></p>
<h3 id="nodes-behaviour">Nodes behaviour</h3>
<p><a href="/posts/main/20220602202317-the_byzantine_generals_problem/">The Byzantine generals problem</a> 描述了节点出错，导致全体协作策略失败以及容错率的问题。</p>
<p>假设每个节点都执行指定的算法，假设有以下情况。</p>
<h4 id="crash-stop--fail-stop">Crash-stop (fail-stop)</h4>
<p>如果一个节点出现问题挂了，并且在这之后永远停机。</p>
<h4 id="crash-recovery--fail-recovery">Crash-recovery (fail-recovery)</h4>
<p>一个节点挂了，并丢失了内存状态，但会在过段时间后恢复。</p>
<h4 id="byzantine-fail-arbitrary">Byzantine （fail-arbitrary)</h4>
<p>节点偏离了原本的算法，可能会发生任何事情，包括崩溃或者恶意的行为。</p>
<h3 id="synchrony--timing--assumption">Synchrony (timing) assumption</h3>
<h4 id="synchronous">Synchronous</h4>
<p>消息延迟不超过已知的上限。到达这个上限后，消息要么被传递，要么丢失。节点以已知的速度执行算法。每一步代码的执行都有执行时间的上限。</p>
<h4 id="partically-synchronous">Partically synchronous</h4>
<p>系统中一部分时间内是异步的，另一部分是同步的。</p>
<h4 id="asynchronous">Asynchronous</h4>
<p>消息可以任意地被延迟，节点可以任意地暂停，并没有时序上的保证。</p>
<h2 id="clocks-and-time-in-distributed-systems">Clocks and time in distributed systems</h2>
<p>分布式系统中经常涉及到需要测量时间，比如：</p>
<ul>
<li>Schedulers, timeouts, failure detectors, retry timers</li>
<li>Performance measurements, statistics, profiling (performance analysis也称为profiling)</li>
<li>Log files &amp; databases: record when an event occurred</li>
<li>Data with time-limited validity (e.g. cache entries)</li>
<li><strong>Determining order of events across several nodes</strong></li>
</ul>
<p>分布式系统中会遇到两种类型的时钟：</p>
<ul>
<li>physical clocks: count number of seconds elapsed</li>
<li>logical clocks: count events, e.g. messages sent</li>
</ul>
<h3 id="clock-synchronisation">Clock synchronisation</h3>
<p>物理时钟会有时间上的偏移，通常是通过和电脑、手机、电视等相对准确的地方来校准物理时钟的时间，比如手表，老式的钟摆。</p>
<p>电脑上的时间同样会有偏移，是通过 <a href="/posts/main/20220602202411-network_time_protocol_ntp/">Network Time Protocol(NTP)</a> 来校准电脑的时间，也就是物理时钟的校准。</p>
<h2 id="broadcast-protocols-and-logical-time">Broadcast protocols and logical time</h2>
<figure>
    <img loading="lazy" src="/ox-hugo/ordering-of-messages.png"
         alt="Figure 1: ordering-of-messages"/> <figcaption>
            <p><span class="figure-number">Figure 1: </span>ordering-of-messages</p>
        </figcaption>
</figure>

<p>\(m_{1}\) = &ldquo;A says: The moon is made of cheese!&rdquo;</p>
<p>\(m_{2}\) = &ldquo;B says: Oh no it isn&rsquo;t!&rdquo;</p>
<p>User C sees \(m_{2}\) first, \(m_{1}\) second, even though logically \(m_{1}\) <a href="/posts/main/20220602202832-causality_and_happen_before_relation/">happened before</a> \(m_{2}\).</p>
<p><strong>Problem</strong>: even with synced clocks, \(t_{2 }&lt; t_{1}\) is possible. Timestamp order is inconsistent with expected order!</p>
<p>即便我们已经通过 NTP 尽量保证物理时钟上的同步，但这个时候依旧会发生因果关系不一致的情况，所以这个时候就需要逻辑时钟。</p>
<p>逻辑时钟是在分布式系统中专门用于捕获系统中发生事件之间的因果关系，因此逻辑时钟其实就是一种计数器，每次事件发生的时候都会往前递增，所以随着事件的发生它会随着时间向前移动，但它和物理时间并没有实际的关系。</p>
<h3 id="logical-time">Logical time</h3>
<p>Logical clocks: designed to <strong>capture causal dependencies</strong>.</p>
<p>\((e_{1} \rightarrow e_{2}) \Longrightarrow (T(e_{1}) &lt; T(e_{2}))\)</p>
<p>当事件1发生在事件2之前，那么事件1的时间戳应该小于事件2的时间戳，这是逻辑时钟要保证的最基本的原则。</p>
<p>下面将研究一下两种逻辑时钟：</p>
<ul>
<li>
<p><a href="/posts/main/20220609201658-lamport_clocks/">Lamprot clocks</a> 是在分布式系统中的每个节点都维护一个计数器，每一个当前节点事件 \(e\) 发生时自增 ；发送消息时，也会附带上当前节点的计数 \(t\) ，消息接收者收到消息后，取出消息中的计数器与当前节点计数器比较，去最大值后自增 1。</p>
<p>这样可以实现局部顺序，再加上节点名称，形成(时间戳，节点名称)的组合后，就可以扩展为全局顺序。</p>
<p>但这样也有缺点，算法在时间戳相同，节点名称不同的平行事件的顺序判定时，会出现与实际情况不符的情况。<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup></p>
</li>
<li>
<p><a href="/posts/main/20220602235916-vector_clocks/">Vector clocks</a> 除了是向量之外，向量时钟算法与 Lamport 时钟非常相似。一个节点的向量时钟的初始值是系统中的每个节点的事件数，也就是 0。每当节点 \(N_{i}\) 发生事件时，它就会增加其向量钟中的第 \(i\) 个条目（它自己的条目）。(In practice, this vector is often implemented as a map from node IDs to integers rather than an array of integers. 在实践中，这里的向量通常是节点 ID 对应 Integer 的 map，而不是 Integer 的数组。)。当一个消息在网络上被发送时，发送者当前的向量时间戳被附加到该消息上。最后，当一个消息被接收时，接收者将消息中的向量时间戳与它的本地时间戳合并，方法是取两个向量的元素的最大值，然后接收者增加它自己的条目</p>
<p>这样就可以弥补 Lamport 的缺点，可以完全确定每个事件的因果顺序。</p>
</li>
</ul>
<h3 id="delivery-order-in-broadcast-protocols">Delivery order in broadcast protocols</h3>
<p>许多网络提供点对点（单播）的信息传递，其中一个信息有一个特定的收件人。广播协议对网络进行了概括，使一条信息被发送到某个组的所有节点。组的成员可能是固定的，或者系统可能提供节点加入和离开组的机制。</p>
<p>一些局域网在硬件层面提供组播或广播（例如，IP 组播），但互联网上的通信通常只允许单播。此外，硬件级的组播通常是在 best-effort 基础上提供的，允许消息被丢弃；要使其可靠，需要类似于这里讨论的重传协议。</p>
<p>上面提到的 node behaviour 和 synchrony 的系统模型假设直接延伸到广播组。</p>
<h4 id="broadcast-protocols">Broadcast protocols</h4>
<p>Broadcast (multicast) is <strong>group communication</strong>:</p>
<ul>
<li>一个节点发送消息，所有组内节点传递。</li>
<li>组内成为可以是固定的也可以是动态的</li>
<li>如果一个节点发生错误，剩余的组内成员顶上。</li>
<li>Note: 这个观念比 IP 组播更加普遍</li>
</ul>
<p>建立在之前讲到的系统模型上：</p>
<ul>
<li>可以是 <strong>best-effort</strong> (可能会丢失消息) 或者 <strong>reliable</strong> (非故障节点传递每条消息，重传丢失的消息。)</li>
<li>Asynchronous / partially synchronous timing model \(\Longrightarrow\) 消息延迟​<strong>没有上限</strong></li>
</ul>
<h4 id="receiving-versus-delivering">Receiving versus delivering</h4>
<figure>
    <img loading="lazy" src="/ox-hugo/receive-versus-deliver.png"
         alt="Figure 2: receive-versus-deliver"/> <figcaption>
            <p><span class="figure-number">Figure 2: </span>receive-versus-deliver</p>
        </figcaption>
</figure>

<p>假定网络提供点对点的发送/接收，在广播算法​从网络中​<strong>收到</strong>​消息后，传递给应用前会在缓存或者队列当中。</p>
<p>下面将研究三种不同形式的「广播」。所有这些都是可靠的：每条消息最终都会被传递到每个非故障节点，但没有时间上的保证。然而，它们在每个节点上传递信息的顺序方面存在差异。事实证明，这种顺序上的差异对实现广播的算法有非常根本的影响。</p>
<h4 id="forms-of-reliable-broadcast">Forms of reliable broadcast</h4>
<ul>
<li>
<p><a href="/posts/main/20220616105609-fifo_broadcast/">FIFO broadcast</a></p>
<p>如果 \(m_{1}\) 和 \(m_{2}\) 从相同的节点广播，并且 broadcast(\(m_{1}\)) \(\longrightarrow\) broadcast(\(m_{2}\))，那么 \(m_{1}\) 必然在 \(m_{2}\) 之前被传递。</p>
</li>
<li>
<p><a href="/posts/main/20220616132407-causal_broadcast/">Causal broadcast</a></p>
<p>如果 broadcast(\(m_{1}\)) \(\longrightarrow\) broadcast(\(m_{2}\)) 那么 \(m_{1}\) 必然在 \(m_{2}\) 之前被传递。</p>
</li>
<li>
<p><a href="/posts/main/20220616135058-total_order_broadcast/">Total order broadcast</a></p>
<p>如果在同一个节点 \(m_{1}\) 在 \(m_{2}\) 之前被传递，那么所有节点 \(m_{1}\) 必然在 \(m_{2}\) 之前被传递。</p>
</li>
<li>
<p><strong>FIFO-total order broadcast</strong></p>
<p>是 FIFO broadcast 和 Total order broadcast 的结合</p>
</li>
</ul>
<h4 id="relationships-between-broadcast-models">Relationships between broadcast models</h4>
<figure>
    <img loading="lazy" src="/ox-hugo/broadcast-models-relationship.png"
         alt="Figure 3: broadcast-models-relationship"/> <figcaption>
            <p><span class="figure-number">Figure 3: </span>broadcast-models-relationship</p>
        </figcaption>
</figure>

<p>FIFO-total order broadcast 是一个严格意义上比因果广播更强的模型；换句话说，每个有效的 FIFO-total order broadcast 协议也是一个有效的 causal broadcast 协议（反过来就不是了），其他协议也是如此。</p>
<h3 id="broadcast-algorithms">Broadcast algorithms</h3>
<p>实现广播算法，简单来说，涉及到两个步骤。</p>
<ol>
<li>确保每个节点都能收到每天消息</li>
<li>以正确的顺序传递这些消息</li>
</ol>
<p>首先研究如何可靠地传递消息，当一个节点想要广播一条消息时，它就单独向其他每个节点发送消息，使用上面提到过的 reliable links。但很可能一条消息丢失，发送的节点在重新发送前就崩溃了，这种情况下，丢失的这条消息对应的节点就无法接收到这条消息。</p>
<p>为了提高可靠性，可以让其他节点帮忙。例如，当一个节点第一次收到一个特定消息时，它就把消息转发给其他每个节点（这种被称为急性可靠广播（Eager reliable broadcast））。这种算法确保了即使一些节点崩溃，所有剩下的非故障的节点都会收到每条消息。然而，这种算法很低效：在没有故障的情况下，每条消息在由 \(n\) 个节点组成的小组中要发送 \(O(n^{2})\) 次，每个节点要收到每条消息 \(n-1\) 次，意味着占用了大量的带宽。</p>
<p>eager reliable broadcast 的变体沿着不同维度（比如容错性、所有节点接收消息的时间和被使用的带宽）优化，其中最常见的是流言协议（Gossip protocols，也被叫做流行病协议（Epidemic protocols））。在这些协议中，一个想广播消息的节点将其发送给随机选择的少量固定数量的节点。第一次收到信息时，一个节点会将其转发给固定数量的随机选择的节点。这类似于流言、谣言或传染病在人群中的传播方式。</p>
<p>Gossip protocols 并不能保证所有节点都能收到消息：在随机选择节点时，有可能总是遗漏了一些节点。然而，如果算法的参数选择得当，信息不被传递的概率很小。Gossip protocols 很有吸引力，在正确的参数下，对消息丢失和节点崩溃有很强的弹性，同时还能保持高效。其实核裂变的发生过程，也类似于这种协议。</p>
<p>可以在 eager reliable broadcast 或 gossip protocol 的基础上，建立 FIFO、causal 或者 total order broadcast。</p>
<ul>
<li><a href="/posts/main/20220616105609-fifo_broadcast/#fifo-broadcast-algorithm">FIFO broadcast algorithm</a></li>
<li><a href="/posts/main/20220616132407-causal_broadcast/#causal-broadcast-algorithm">Causal broadcast algorithm</a></li>
<li><a href="/posts/main/20220616135058-total_order_broadcast/#total-order-broadcast-algorithms">Total order broadcast algorithms</a></li>
</ul>
<h2 id="replication">Replication</h2>
<p>现在要讨论的是复制的问题，也就是在多个节点上维护相同数据的复制体，每个节点被称为副本。复制是许多分布式数据库、文件系统和其他存储系统的一个标准特征。它是我们实现容错的主要机制之一：如果一个副本出现故障，我们可以继续访问其他副本上的数据副本。<sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup></p>
<ul>
<li>在不同节点维护相同数据的副本</li>
<li>数据库、文件系统、缓存等等</li>
<li>维护相同数据的节点叫做副本</li>
<li>如果一些副本出错，其他副本依旧是可访问的。</li>
<li>将负载分散到多个副本</li>
<li>如果数据没有变化，维护很简单，只需要复制。</li>
<li>专注于数据变化</li>
</ul>
<p>相较于 <a href="https://zh.wikipedia.org/zh-cn/RAID">RAID</a> (Redundant Array of Independent Disks)：在单个计算机内复制。</p>
<ul>
<li>RAID 只有一个控制器；在分布式系统中，每个节点都是独立的。</li>
<li>副本可以在全世界靠近用户的地方分布（CDN 本质其实是一种大规模分布式多级缓存系统）</li>
</ul>
<h3 id="manipulating-remote-state">Manipulating remote state</h3>
<p>在更新不同节点数据时，丢失数据或者丢失 TCP 返回的 \(ACK\)<sup id="fnref:3"><a href="#fn:3" class="footnote-ref" role="doc-noteref">3</a></sup> 时，就会使得不同节点之间的副本不一致，不满足幂等性（Idempotent）。为了解决这个问题，可以给每次更新操作都加上一个逻辑时间戳，并将其作为数据存储在数据库当中；当需要删除这条记录时，实际上并没有删除，而是写入一个特殊的值（称为墓碑 tombstone），将其标记为删除。（其实就类似于软删除）</p>
<figure>
    <img loading="lazy" src="/ox-hugo/reconciling-replicas.png"
         alt="Figure 4: reconciling-replicas"/> <figcaption>
            <p><span class="figure-number">Figure 4: </span>reconciling-replicas</p>
        </figcaption>
</figure>

<p>在许多副本系统中，副本运行一个协议来检测和调和任何差异（这被称为反熵 anti-entropy），以便副本最终持有相同数据的一致副本。由于有了 tombstone，反熵过程可以分辨出已经被删除的记录和尚未被创建的记录之间的差异。由于有了逻辑时间戳，可以分辨出一条记录的哪个版本比较老，哪个版本比较新。然后，反熵过程会保留较新的记录并丢弃较旧的记录。</p>
<figure>
    <img loading="lazy" src="/ox-hugo/concurrent-reconciling-replicas.png"
         alt="Figure 5: concurrent-reconciling-replicas"/> <figcaption>
            <p><span class="figure-number">Figure 5: </span>concurrent-reconciling-replicas</p>
        </figcaption>
</figure>

<p>如果同时两个请求分别想把两个副本的 \(x\) 的值进行修改。</p>
<ul>
<li>
<p><strong>Last writer wins</strong> (LWW):</p>
<p>采用 Lamport clocks 时，$t<sub>2</sub> &gt; t<sub>1</sub>$则保留 \(v_{2}\) 丢弃 \(v_{1}\)。</p>
</li>
<li>
<p><strong>Multi-value register</strong>:</p>
<p>采用 Vector clocks 时，\(t_{2 }\gt t_{1}\) 则保留 \(v_{2}\) 丢弃 \(v_{1}\); \(t_{2} \rVert t_{1}\) 则 \(\{v_{1}, v_{2}\}\) 都保留。</p>
</li>
</ul>
<p>向量时钟的缺点是它们会变得很昂贵：每个客户端都需要在向量中输入一个条目，在有大量客户端的系统中（或者客户端每次重启都会有新的身份），这些向量会变得很大，可能会比数据本身占用更多内存。更多类型的逻辑时钟，如点状版本向量（Dotted version vectors）<sup id="fnref:4"><a href="#fn:4" class="footnote-ref" role="doc-noteref">4</a></sup>，已经被开发出来以优化这种类型的系统。</p>
<h3 id="quorums">Quorums</h3>
<p>具体如何进行复制的细节对系统的可靠性有很大影响。如果没有容错，拥有多个副本会使可靠性变差：副本越多，任何一个副本在任何时候出现故障的概率就越大（假设故障不是完全相关的）。然而，如果系统在一些有问题的复制体中仍然继续工作，那么可靠性就会提高：所有副本在同一时间出现问题的概率要比一个副本出现问题的概率低很多。</p>
<h4 id="read-after-write-consistency">Read-after-write consistency</h4>
<figure>
    <img loading="lazy" src="/ox-hugo/read-after-write-consistency.png"
         alt="Figure 6: read-after-write-consistency"/> <figcaption>
            <p><span class="figure-number">Figure 6: </span>read-after-write-consistency</p>
        </figcaption>
</figure>

<p>一个副本写入了数据，从另外一个副本读取，用户并没有读取到他刚刚提交的内容。如果要保持读写一致性（read-after-write consistency），则要两个节点都同时写入和读取，一旦有一个不可访问就会破坏读写一致性，没有任何容错率可言。</p>
<h4 id="quorum--2-out-of-3">Quorum (2 out of 3)</h4>
<figure>
    <img loading="lazy" src="/ox-hugo/quorum.png"
         alt="Figure 7: quorum"/> <figcaption>
            <p><span class="figure-number">Figure 7: </span>quorum</p>
        </figcaption>
</figure>

<p>通过使用三个副本可以解决这个难题<sup id="fnref:5"><a href="#fn:5" class="footnote-ref" role="doc-noteref">5</a></sup>。将每个读写请求发送到所有三个副本，但只要收到 \(≥2\) 个响应，就认为请求成功。在这个例子中，写在复制体 \(B\) 和 \(C\) 上成功，而读在副本 \(A\) 和 \(B\) 上成功。对读和写都采用 &ldquo;三选二 &ldquo;的策略，可以保证至少有一个对读的响应来自看到最近写的副本（在这个例子中，这是副本 \(B\)）。</p>
<p>对于同一个请求，不同的副本可能会返回不同的响应：在上图中，\(A\) 处读取会返回初始值 \((t_{0}, v_{0})\)，而 \(B\) 处的读取会返回该客户端之前写入的 \((t_{1}, v_{1})\)。利用时间戳，客户端可以知道哪个响应是最近的，将 \(v_{1}\) 返回给 Application。</p>
<p>在这个例子中，响应写请求的副本集合 \((B, C)\) 是一个 write quorum，而响应读请求的集合 \((A, B)\) 是一个 read quorum。一般来说，quorum 是一个最小的节点集合，它必须对某个请求作出响应才能成功。为了确保读写一致性，write quorum 和 read quorum 必须有一个非空的交集：换句话说，read quorum 必须包含至少一个已经被承认的 write quorum。</p>
<p>在分布式系统中，常见的 majority quorum 是由超过半数的节点组成的任意子集。在三个节点的系统 \(\{A, B, C\}\) 中，majority quorum 可以是 \(\{A, B\}\)、\(\{A, C\}\) 和 \(\{B, C\}\)。通常来讲，奇数节点的系统，\(\frac{n+1}{2}\) 大小的任意子集就是 majority quorum，偶数节点的系统，需要四舍五入 \(\left \lceil \frac{n+1}{2} \right \rceil = \frac{n+2}{2}\)<sup id="fnref:6"><a href="#fn:6" class="footnote-ref" role="doc-noteref">6</a></sup>。majority quorum 有个特性：任意两个 quorums 至少有一个共同的元素，也就是交集至少有一个节点。</p>
<p>只要不超过 \(n-w\) 个副本不可用（\(w\) 是 write quorum 的数量），系统就可以正常的处理更新；同样的，只要不超过 \(n-r\) 个副本不可以（\(r\) 是 read quorum 的数量），系统就可以正常的处理读请求。对于 majority quorum 来说，三个副本的系统可以容错一个节点，五个副本的系统可以容错两个节点，以此类推。</p>
<p>在这种基于 quorum 的方法下，一些副本会错过一些更新。上图中，副本 \(A\) 错过了 \((t_{1}, v_{1})\)。让副本互相同步使其数据一致的方法上面提到过，叫做反熵（anti-entropy）。</p>
<figure>
    <img loading="lazy" src="/ox-hugo/read-repair.png"
         alt="Figure 8: read-repair"/> <figcaption>
            <p><span class="figure-number">Figure 8: </span>read-repair</p>
        </figcaption>
</figure>

<p>另外一个方法是让客户端帮助完成传播更新的过程。例如上图中，客户端从 \(B\) 读取了 \((t_{1}, v_{1})\)，但从 \(A\) 接收到的是 \((t_{0}, v_{0})\)，而 \(C\) 没有回应。这个时候客户端使用原始的时间戳 \(t_{1}\) 将最新的值发送给 \(A\) 和 \(C\)，\(C\) 如果已经更新了，也不过只是浪费一点点带宽。这种复制模式的数据库通常称为 Dynamo-style。</p>
<h3 id="replication-using-broadcast">Replication using broadcast</h3>
<p>在 quorum 中，基本上使用了 best-effort 以及客户端辅助使其他副本数据一致的方法，但这些都是不可靠的，中途会发生丢失，并且排序无法保证。</p>
<h4 id="state-machine-replication--smr">State machine replication (SMR)</h4>
<p>FIFO-total order broadcast: 每个节点以​<strong>相同的顺序</strong>​传递​<strong>相同的消息</strong>​。</p>
<ul>
<li>FIFO-total order broadcast 将每次更新，更新到所有副本。</li>
<li>副本通过传递的消息来确认自身状态</li>
<li>更新具有确定性</li>
<li>副本是一种状态机：开始于固定的初始状态，以相同的顺序经历相同序列状态的变换 \(\Longrightarrow\) 所有副本都以相同的状态结尾</li>
</ul>
<p>利用 FIFO-total order broadcast 很容易建立一个复制系统：将每个更新请求广播给副本，副本基于传递的每个消息更新其状态。副本作为一个状态机，其输入是消息的传递，这种就叫做 state machine replication (SMR)。只要更新逻辑是确定的：任何两个处于相同状态的复制体，被赋予相同的输入，最终必须处于相同的下一个状态。甚至错误也必须是确定的：如果一个副本的更新成功了，但在另一个副本上失败了，它们就会变得不一致。</p>
<p>SMR 的一个优秀特点是，从一个状态到下一个状态只要是确定的，其中的逻辑可以任意复杂。例如，可以处理具有任意业务逻辑的整个数据库事务，而这个逻辑可以同时依赖于广播信息和数据库的当前状态。一些分布式数据库以每个副本独立执行相同的确定性交易代码（这被称为主动复制）来实现复制。这一原则也是区块链、加密货币和分布式账本的基础：区块链中的 &ldquo;区块链 &ldquo;无非是由 <a href="/posts/main/20220616135058-total_order_broadcast/">Total order broadcast</a> 传递的消息序列，每个副本都确定性地执行这些区块中描述的交易，以确定账本的状态（例如，谁拥有哪些钱）。一个 &ldquo;智能合约 &ldquo;只是一个确定的程序，当一个特定的消息被传递时，副本会执行这个程序。</p>
<blockquote>
<p><strong>on</strong> request to perform update \(u\) <strong>do</strong> <br />
\(\qquad\)​send \(u\) via FIFO-total order broadcast <br />
<strong>end on</strong></p>
<p><strong>on</strong> delivering \(u\) through FIFO-total order broadcast <strong>do</strong> <br />
\(\qquad\)​update state using arbitrary deterministic logic! <br />
<strong>end on</strong></p>
</blockquote>
<p>密切相关的概念：</p>
<ul>
<li>可序列化事务（按传递顺序执行）</li>
<li>区块链、分布式账本、智能合约。</li>
</ul>
<p>限制：</p>
<ul>
<li>不能立即更新状态，必须等待广播传递。</li>
<li>需要容错的 total order broadcast</li>
</ul>
<p>State machine replication 的缺点是 total order broadcast 的限制。当一个节点想通过 total order broadcast 来广播一个消息时，它不能立即将该消息传递给自己。之前讲过，传递给自己的消息也要遵从总秩序，所以当使用状态机复制时，想要更新其状态的副本要等待广播，与其他节点协调，并等待更新信息被传递给自己。状态机复制的容错性取决于底层 total order broadcast 的容错性。尽管如此，基于 total order replication 的复制还是被广泛使用。</p>
<p>在 <a href="/posts/main/20220616135058-total_order_broadcast/">Total order broadcast</a> 中提到过一种实现方法是指定一个节点作为 Leader，并将所有的消息通过它来路由，保证传递的顺序。这一原则也被广泛应用于数据库副本：许多数据库系统指定一个副本作为 leader，primary 或者 master。所有修改数据库的事务都需要在 leader 副本上执行。虽然 leader 会同时执行多个事务，但事务提交时会按照总的顺序提交。当事务提交后， leader 副本将数据变动广播给所有的 follow 副本，follow 副本按照之前提交的顺序在本地进行事务提交，这种方法被称为被动复制（passive replication）或者主从复制（primary-backup replication），这样的方式其实和 <a href="/posts/main/20220616135058-total_order_broadcast/">Total order broadcast</a> 是等效的。</p>
<p>至于之前提到的其他广播方式，也可以用作复制，但需要更加小心，保证副本之间数据的一致性。</p>
<h2 id="the-raft-consensus-algorithm">The Raft consensus algorithm</h2>
<p>为了实现容错的 FIFO-total order broadcast，Raft 的具体实现细节可以参见 <a href="/posts/main/20220623152601-raft_consensus_algorithm/">Raft consensus algorithm</a>，另外有个非常好的动画<a href="http://thesecretlivesofdata.com/raft/">示意网站</a>可以更加直观的观察整个过程。。</p>
<p>集群内的节点都对选举出的领袖采取信任，因此 Raft 不是一种拜占庭容错算法。</p>
<h2 id="replica-consistency">Replica consistency</h2>
<p>事务的关键是原子性。当一个事务跨越多个节点时，希望整个事务仍然具有原子性：也就是说，要么所有节点都必须提交事务且具有持久性，要么所有节点都回滚。因此，各节点之间就事务应该终止回滚还是提交要达成一致。这里说的一致和 Raft 中的不太一样，细节上有很大不同。</p>
<table>
<thead>
<tr>
<th>Consensus</th>
<th>Atomic commit</th>
</tr>
</thead>
<tbody>
<tr>
<td>一个或多个节点提出一个值</td>
<td>每个节点投票是否提交或中止</td>
</tr>
<tr>
<td>任意一个提出的值都可以被承认</td>
<td>如果所有的节点投票提交那么就必须提交；如果所有的节点都投票中止那么就必须中止。</td>
</tr>
<tr>
<td>只要 quorum 数量的节点可以工作，崩溃的节点是可以被容忍的。</td>
<td>如果不分的节点崩溃，必须中止。</td>
</tr>
</tbody>
</table>
<p>用来保证多个节点 atomic commitment 最常用的算法是 two-phase commit protocol (2PC)，也有 three-phase commit protocol，但这里不做研究。</p>
<figure>
    <img loading="lazy" src="/ox-hugo/Two-phase%20commit%20%282PC%29.png"
         alt="Figure 9: Two-phase commit (2PC)"/> <figcaption>
            <p><span class="figure-number">Figure 9: </span>Two-phase commit (2PC)</p>
        </figcaption>
</figure>

<p>当使用 two-phase 提交时，客户端首先在参与交易的每个副本上启动一个常规的单节点交易，并在这些交易中执行常规的读写操作。当客户端准备好提交交易时，它向交易协调者（一个管理 2PC 协议的指定节点）发送提交请求。(在一些系统中，协调器是客户端的一部分）。</p>
<p>协调器首先向参与交易的每个副本发送一个准备消息，每个副本都会回复一个消息，表明它是否能够提交交易（这是协议的第一阶段）。副本实际上还没有提交交易，但它们必须确保在第二阶段中，当协调者发出指示，它们一定能够提交交易。这就意味着，副本必须将交易的所有内容更新写入磁盘，并在回复准备信息之前检查完整性约束，同时继续持有交易的任何锁。</p>
<p>协调器收集响应，并决定是否实际提交交易。如果所有节点都回复 OK，协调者就决定提交；如果任何节点想放弃，或者任何节点未能在某个超时时间内回复，协调者就决定放弃。然后，协调者将其决定发送给每个副本，它们都按照指示提交或放弃（这是第二阶段）。如果决定是提交，每个副本保证能够提交其事务，因为之前的准备请求奠定了基础。如果决定放弃，副本就会回滚该事务。</p>
<h2 id="reference">Reference</h2>
<ul>
<li>Cachin, Guerraoui, Rodrigues (2011) Introduction to Reliable and Secure Distributed Programming (2. Ed.)., Springer.</li>
</ul>
<div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p>if \(a \rVert b\) we could have either \(a ≺ b\) or \(b ≺ a\), so the order of the two events is determined arbitrarily by the algorithm.&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2">
<p>replication 翻译成「复制」，名词；replica 翻译成「副本」，名词。&#160;<a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:3">
<p>后面整理 TCP 相关内容时，可以加个链接。&#160;<a href="#fnref:3" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:4">
<p>待学习&#160;<a href="#fnref:4" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:5">
<p><a href="/posts/main/20220615143721-quorum/">基于 Quorum 投票的冗余控制算法</a>&#160;<a href="#fnref:5" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:6">
<p>向上去整&#160;<a href="#fnref:6" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</div>
]]></content:encoded>
    </item>
    
    <item>
      <title>Beancount</title>
      <link>https://sheerwill.live/posts/main/20220821223012-beancount/</link>
      <pubDate>Sun, 21 Aug 2022 22:31:02 +0800</pubDate>
      
      <guid>https://sheerwill.live/posts/main/20220821223012-beancount/</guid>
      <description>precision Beancount 会统计写过的每个货币的金额，然后选择最常见的作为显示格式，如果大多数时候都是整数，它就会用整数显示，所以最好尽量都写成你想要看到的精度，</description>
      <content:encoded><![CDATA[<h2 id="precision">precision</h2>
<p>Beancount 会统计写过的每个货币的金额，然后选择最常见的作为显示格式，如果大多数时候都是整数，它就会用整数显示，所以最好尽量都写成你想要看到的精度，比如不要写「9 CNY」而是「9 CNY」，保持大部分金额都是你需要的精度。</p>
]]></content:encoded>
    </item>
    
    <item>
      <title>HammerSpoon</title>
      <link>https://sheerwill.live/posts/main/20220520185239-hammerspoon/</link>
      <pubDate>Fri, 05 Aug 2022 20:09:36 +0800</pubDate>
      
      <guid>https://sheerwill.live/posts/main/20220520185239-hammerspoon/</guid>
      <description>Introduction 配置的整体如下，通过不同的 Hyper key 在键盘上设置了两层功能，软件控制以及窗口管理。 ├── Spoons │ ├── Emojis.spoon │ ├── SpoonInstall.spoon │ └── TextClipboardHistory.spoon ├── conf.moon ├── control.moon ├── headphones.moon</description>
      <content:encoded><![CDATA[<h2 id="introduction">Introduction</h2>
<p>配置的整体如下，通过不同的 Hyper key 在键盘上设置了两层功能，软件控制以及窗口管理。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">├── Spoons
</span></span><span class="line"><span class="cl">│   ├── Emojis.spoon
</span></span><span class="line"><span class="cl">│   ├── SpoonInstall.spoon
</span></span><span class="line"><span class="cl">│   └── TextClipboardHistory.spoon
</span></span><span class="line"><span class="cl">├── conf.moon
</span></span><span class="line"><span class="cl">├── control.moon
</span></span><span class="line"><span class="cl">├── headphones.moon
</span></span><span class="line"><span class="cl">├── init.lua
</span></span><span class="line"><span class="cl">├── keyboard.moon
</span></span><span class="line"><span class="cl">├── layout.moon
</span></span><span class="line"><span class="cl">├── main.moon
</span></span><span class="line"><span class="cl">├── mouse.moon
</span></span><span class="line"><span class="cl">├── pwd.moon
</span></span><span class="line"><span class="cl">├── reload.moon
</span></span><span class="line"><span class="cl">├── space.moon
</span></span><span class="line"><span class="cl">├── tips.moon
</span></span><span class="line"><span class="cl">├── usb.moon
</span></span><span class="line"><span class="cl">├── util.moon
</span></span><span class="line"><span class="cl">└── wifi.moon
</span></span></code></pre></div><figure>
    <img loading="lazy" src="/ox-hugo/HammerSpoon.png"
         alt="Figure 1: HammerSpoon"/> <figcaption>
            <p><span class="figure-number">Figure 1: </span>HammerSpoon</p>
        </figcaption>
</figure>

<p>其中提示 App 键位的界面如下。</p>
<figure>
    <img loading="lazy" src="/ox-hugo/HammerSpoon-Tips.png"
         alt="Figure 2: HammerSpoon-Tips"/> <figcaption>
            <p><span class="figure-number">Figure 2: </span>HammerSpoon-Tips</p>
        </figcaption>
</figure>

]]></content:encoded>
    </item>
    
    <item>
      <title>Karabiner-Elements</title>
      <link>https://sheerwill.live/posts/main/20220805101927-karabiner_elements/</link>
      <pubDate>Fri, 05 Aug 2022 10:49:35 +0800</pubDate>
      
      <guid>https://sheerwill.live/posts/main/20220805101927-karabiner_elements/</guid>
      <description>平时是使用苹果内置键盘以及 HHKB，因为键位有一些不同，设置上也会有一些区别。 Figure 1: Karabiner-Elements --- global: check_for_updates_on_startup: true show_in_menu_bar: true show_profile_name_in_menu_bar: true profiles: - complex_modifications: parameters: basic.simultaneous_threshold_milliseconds: 50 basic.to_delayed_action_delay_milliseconds: 500 basic.to_if_alone_timeout_milliseconds: 1000 basic.to_if_held_down_threshold_milliseconds: 500 mouse_motion_to_scroll.speed: 100 rules: - description: Change tab to</description>
      <content:encoded><![CDATA[<p>平时是使用苹果内置键盘以及 HHKB，因为键位有一些不同，设置上也会有一些区别。</p>
<figure>
    <img loading="lazy" src="/ox-hugo/Karabiner-Elements.png"
         alt="Figure 1: Karabiner-Elements"/> <figcaption>
            <p><span class="figure-number">Figure 1: </span>Karabiner-Elements</p>
        </figcaption>
</figure>

<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">global</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">check_for_updates_on_startup</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">show_in_menu_bar</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">show_profile_name_in_menu_bar</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">profiles</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">complex_modifications</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">parameters</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">basic.simultaneous_threshold_milliseconds</span><span class="p">:</span><span class="w"> </span><span class="m">50</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">basic.to_delayed_action_delay_milliseconds</span><span class="p">:</span><span class="w"> </span><span class="m">500</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">basic.to_if_alone_timeout_milliseconds</span><span class="p">:</span><span class="w"> </span><span class="m">1000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">basic.to_if_held_down_threshold_milliseconds</span><span class="p">:</span><span class="w"> </span><span class="m">500</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">mouse_motion_to_scroll.speed</span><span class="p">:</span><span class="w"> </span><span class="m">100</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l">Change tab to cmd+alt+ctrl if pressed with other keys</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">manipulators</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="l">tab</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">modifiers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">optional</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span>- <span class="l">any</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="l">left_control</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">modifiers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span>- <span class="l">left_command</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span>- <span class="l">left_option</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">to_if_alone</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="l">tab</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">basic</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l">Command + Esc to Command + `</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">manipulators</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="l">escape</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">modifiers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">mandatory</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span>- <span class="l">left_command</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="l">grave_accent_and_tilde</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">modifiers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span>- <span class="l">left_command</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">basic</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l">Change escape to cmd+shift+ctrl if pressed with other keys</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">manipulators</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="l">escape</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">modifiers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">optional</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span>- <span class="l">any</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="l">left_shift</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">modifiers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span>- <span class="l">left_command</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span>- <span class="l">left_control</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">to_if_alone</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="l">escape</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">basic</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;HHKB RCtF: Function keys&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">manipulators</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;1&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">modifiers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">mandatory</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span>- <span class="l">right_command</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="l">f1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">basic</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">modifiers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">mandatory</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span>- <span class="l">right_command</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="l">f2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">basic</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;3&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">modifiers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">mandatory</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span>- <span class="l">right_command</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="l">f3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">basic</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;4&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">modifiers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">mandatory</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span>- <span class="l">right_command</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="l">f4</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">basic</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;5&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">modifiers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">mandatory</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span>- <span class="l">right_command</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="l">f5</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">basic</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;6&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">modifiers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">mandatory</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span>- <span class="l">right_command</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="l">f6</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">basic</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;7&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">modifiers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">mandatory</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span>- <span class="l">right_command</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="l">f7</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">basic</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;8&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">modifiers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">mandatory</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span>- <span class="l">right_command</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="l">f8</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">basic</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;9&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">modifiers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">mandatory</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span>- <span class="l">right_command</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="l">f9</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">basic</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;0&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">modifiers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">mandatory</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span>- <span class="l">right_command</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="l">f10</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">basic</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="l">hyphen</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">modifiers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">mandatory</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span>- <span class="l">right_command</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="l">f11</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">basic</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="l">equal_sign</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">modifiers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">mandatory</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span>- <span class="l">right_command</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="l">f12</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">basic</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">devices</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">disable_built_in_keyboard_if_exists</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">fn_function_keys</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">identifiers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">is_keyboard</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">is_pointing_device</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">product_id</span><span class="p">:</span><span class="w"> </span><span class="m">6425</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">vendor_id</span><span class="p">:</span><span class="w"> </span><span class="m">1241</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">ignore</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">manipulate_caps_lock_led</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">simple_modifications</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">disable_built_in_keyboard_if_exists</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">fn_function_keys</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">identifiers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">is_keyboard</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">is_pointing_device</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">product_id</span><span class="p">:</span><span class="w"> </span><span class="m">256</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">vendor_id</span><span class="p">:</span><span class="w"> </span><span class="m">2131</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">ignore</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">manipulate_caps_lock_led</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">simple_modifications</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">disable_built_in_keyboard_if_exists</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">fn_function_keys</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">identifiers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">is_keyboard</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">is_pointing_device</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">product_id</span><span class="p">:</span><span class="w"> </span><span class="m">34304</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">vendor_id</span><span class="p">:</span><span class="w"> </span><span class="m">1452</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">ignore</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">manipulate_caps_lock_led</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">simple_modifications</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">fn_function_keys</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="l">f1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="l">display_brightness_decrement</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="l">f2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="l">display_brightness_increment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="l">f3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="l">mission_control</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="l">f4</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="l">launchpad</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="l">f5</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="l">illumination_decrement</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="l">f6</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="l">illumination_increment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="l">f7</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="l">rewind</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="l">f8</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="l">play_or_pause</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="l">f9</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="l">fastforward</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="l">f10</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="l">mute</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="l">f11</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="l">volume_decrement</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="l">f12</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="l">volume_increment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;⌨️&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">parameters</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">delay_milliseconds_before_open_device</span><span class="p">:</span><span class="w"> </span><span class="m">1000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">selected</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">simple_modifications</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">virtual_hid_keyboard</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">caps_lock_delay_milliseconds</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">country_code</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">indicate_sticky_modifier_keys_state</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">keyboard_type</span><span class="p">:</span><span class="w"> </span><span class="l">ansi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">mouse_key_xy_scale</span><span class="p">:</span><span class="w"> </span><span class="m">100</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">complex_modifications</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">parameters</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">basic.simultaneous_threshold_milliseconds</span><span class="p">:</span><span class="w"> </span><span class="m">50</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">basic.to_delayed_action_delay_milliseconds</span><span class="p">:</span><span class="w"> </span><span class="m">500</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">basic.to_if_alone_timeout_milliseconds</span><span class="p">:</span><span class="w"> </span><span class="m">1000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">basic.to_if_held_down_threshold_milliseconds</span><span class="p">:</span><span class="w"> </span><span class="m">500</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">mouse_motion_to_scroll.speed</span><span class="p">:</span><span class="w"> </span><span class="m">100</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l">Change tab to cmd+alt+ctrl if pressed with other keys</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">manipulators</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="l">tab</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">modifiers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">optional</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span>- <span class="l">any</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="l">left_control</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">modifiers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span>- <span class="l">left_command</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span>- <span class="l">left_option</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">to_if_alone</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="l">tab</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">basic</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">description</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="l">Change grave_accent_and_tilde to cmd+shift+ctrl if pressed with</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="l">other keys</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">manipulators</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="l">grave_accent_and_tilde</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">modifiers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">optional</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span>- <span class="l">any</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="l">left_shift</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">modifiers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span>- <span class="l">left_command</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span>- <span class="l">left_control</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">to_if_alone</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="l">grave_accent_and_tilde</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">basic</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;HHKB RCtF: Function keys&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">manipulators</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;1&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">modifiers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">mandatory</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span>- <span class="l">right_command</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="l">f1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">basic</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">modifiers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">mandatory</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span>- <span class="l">right_command</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="l">f2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">basic</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;3&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">modifiers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">mandatory</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span>- <span class="l">right_command</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="l">f3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">basic</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;4&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">modifiers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">mandatory</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span>- <span class="l">right_command</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="l">f4</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">basic</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;5&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">modifiers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">mandatory</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span>- <span class="l">right_command</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="l">f5</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">basic</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;6&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">modifiers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">mandatory</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span>- <span class="l">right_command</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="l">f6</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">basic</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;7&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">modifiers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">mandatory</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span>- <span class="l">right_command</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="l">f7</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">basic</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;8&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">modifiers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">mandatory</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span>- <span class="l">right_command</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="l">f8</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">basic</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;9&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">modifiers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">mandatory</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span>- <span class="l">right_command</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="l">f9</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">basic</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;0&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">modifiers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">mandatory</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span>- <span class="l">right_command</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="l">f10</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">basic</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="l">hyphen</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">modifiers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">mandatory</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span>- <span class="l">right_command</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="l">f11</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">basic</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="l">equal_sign</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">modifiers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">mandatory</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span>- <span class="l">right_command</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="l">f12</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">basic</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">devices</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">fn_function_keys</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="l">f1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">consumer_key_code</span><span class="p">:</span><span class="w"> </span><span class="l">display_brightness_decrement</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="l">f2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">consumer_key_code</span><span class="p">:</span><span class="w"> </span><span class="l">display_brightness_increment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="l">f3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="l">mission_control</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="l">f4</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="l">launchpad</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="l">f5</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="l">illumination_decrement</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="l">f6</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="l">illumination_increment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="l">f7</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">consumer_key_code</span><span class="p">:</span><span class="w"> </span><span class="l">rewind</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="l">f8</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">consumer_key_code</span><span class="p">:</span><span class="w"> </span><span class="l">play_or_pause</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="l">f9</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">consumer_key_code</span><span class="p">:</span><span class="w"> </span><span class="l">fastforward</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="l">f10</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">consumer_key_code</span><span class="p">:</span><span class="w"> </span><span class="l">mute</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="l">f11</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">consumer_key_code</span><span class="p">:</span><span class="w"> </span><span class="l">volume_decrement</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="l">f12</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">consumer_key_code</span><span class="p">:</span><span class="w"> </span><span class="l">volume_increment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">parameters</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">delay_milliseconds_before_open_device</span><span class="p">:</span><span class="w"> </span><span class="m">1000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">selected</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">simple_modifications</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="l">caps_lock</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">key_code</span><span class="p">:</span><span class="w"> </span><span class="l">left_control</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">virtual_hid_keyboard</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">country_code</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">indicate_sticky_modifier_keys_state</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">mouse_key_xy_scale</span><span class="p">:</span><span class="w"> </span><span class="m">100</span><span class="w">
</span></span></span></code></pre></div>]]></content:encoded>
    </item>
    
    <item>
      <title>Callback Hell</title>
      <link>https://sheerwill.live/posts/main/20220616092944-callback_hell/</link>
      <pubDate>Wed, 27 Jul 2022 19:19:35 +0800</pubDate>
      
      <guid>https://sheerwill.live/posts/main/20220616092944-callback_hell/</guid>
      <description>重构小程序前端校验接口返参处理 原本代码是通过嵌套回调，控制提示之间的前后依赖关系，形成了回调地狱，需要重构。 主要是用 Map (ES6+) 处理 if (code){} else if (cod</description>
      <content:encoded><![CDATA[<h2 id="重构小程序前端校验接口返参处理">重构小程序前端校验接口返参处理</h2>
<p>原本代码是通过嵌套回调，控制提示之间的前后依赖关系，形成了回调地狱，需要重构。</p>
<p>主要是用 <code>Map</code> (ES6+) 处理 <code>if (code){} else if (code){}</code>​，并且利用 <code>Promise</code> 封装函数，配合 <code>async</code> 和 <code>await</code> (ES7+)，使得异步操作同步化，抽离出嵌套的逻辑。后续代码维护只需要区分「仅提示」和「打断」两种模式，不需要考虑提示之间的互相依赖，后期维护成本大大降低。</p>
<p>比较业务代码可以发现，代码量直接干掉了 2/3。</p>
<h3 id="原始代码">原始代码</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="c1">// util.js
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">    封装wx.request请求
</span></span></span><span class="line"><span class="cl"><span class="cm">    url 接口url
</span></span></span><span class="line"><span class="cl"><span class="cm">    params 请求参数
</span></span></span><span class="line"><span class="cl"><span class="cm">    md 请求方式
</span></span></span><span class="line"><span class="cl"><span class="cm">    load 是否显示loading等待框
</span></span></span><span class="line"><span class="cl"><span class="cm">  */</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">getResult</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">params</span><span class="p">,</span> <span class="nx">md</span><span class="p">,</span> <span class="nx">cb</span><span class="p">,</span> <span class="nx">load</span><span class="p">,</span> <span class="nx">ctype</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//封装wx,request请求
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kd">var</span> <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nx">load</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">wx</span><span class="p">.</span><span class="nx">showLoading</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">      <span class="nx">mask</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">title</span><span class="o">:</span> <span class="s2">&#34;拼命加载中&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="kd">var</span> <span class="nx">requestParams</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">url</span><span class="o">:</span> <span class="nx">ycConfig</span><span class="p">[</span><span class="nx">ycConfig</span><span class="p">.</span><span class="nx">env</span><span class="p">].</span><span class="nx">domain_url</span> <span class="o">+</span> <span class="nx">url</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">data</span><span class="o">:</span> <span class="nx">params</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">dataType</span><span class="o">:</span> <span class="s2">&#34;json&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">method</span><span class="o">:</span> <span class="nx">md</span> <span class="o">?</span> <span class="nx">md</span> <span class="o">:</span> <span class="s2">&#34;POST&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">header</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;content-type&#34;</span><span class="o">:</span> <span class="nx">ctype</span> <span class="o">||</span> <span class="s2">&#34;application/json&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">wx</span><span class="p">.</span><span class="nx">hideLoading</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">data</span> <span class="o">&amp;&amp;</span> <span class="nx">res</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="s2">&#34;error&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">typeof</span> <span class="nx">cb</span> <span class="o">==</span> <span class="s2">&#34;function&#34;</span> <span class="o">&amp;&amp;</span> <span class="nx">cb</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">typeof</span> <span class="nx">cb</span> <span class="o">==</span> <span class="s2">&#34;function&#34;</span> <span class="o">&amp;&amp;</span> <span class="nx">cb</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nx">complete</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="p">{},</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fail</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">wx</span><span class="p">.</span><span class="nx">hideLoading</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="nx">wx</span><span class="p">.</span><span class="nx">showToast</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">        <span class="nx">title</span><span class="o">:</span> <span class="s2">&#34;网络连接异常&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">icon</span><span class="o">:</span> <span class="s2">&#34;none&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="cl">  <span class="nx">wx</span><span class="p">.</span><span class="nx">request</span><span class="p">(</span><span class="nx">requestParams</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">getResult</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="c1">// app.js
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">let</span> <span class="p">{</span> <span class="nx">getResult</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&#34;utils/util.js&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">App</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">  <span class="nx">getResult</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">params</span><span class="p">,</span> <span class="nx">md</span><span class="p">,</span> <span class="nx">cb</span><span class="p">,</span> <span class="nx">load</span><span class="p">,</span> <span class="nx">ctype</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">url</span> <span class="o">!=</span> <span class="s2">&#34;/ffpLogin.pl&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kd">var</span> <span class="nx">userInfo</span> <span class="o">=</span> <span class="nx">wx</span><span class="p">.</span><span class="nx">getStorageSync</span><span class="p">(</span><span class="s2">&#34;globalUserInfo&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">//判断是否有效
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nx">isEmpty</span><span class="p">(</span><span class="nx">userInfo</span><span class="p">.</span><span class="nx">wechatLoginToken</span><span class="p">)</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">        <span class="nx">isEmpty</span><span class="p">(</span><span class="nx">userInfo</span><span class="p">.</span><span class="nx">wechatOpenId</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">wx</span><span class="p">.</span><span class="nx">clearStorage</span><span class="p">();</span> <span class="c1">//清理登录缓存数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">wx</span><span class="p">.</span><span class="nx">showToast</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">          <span class="nx">title</span><span class="o">:</span> <span class="s2">&#34;登录失效,请重新登录!&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nx">icon</span><span class="o">:</span> <span class="s2">&#34;none&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nx">wx</span><span class="p">.</span><span class="nx">reLaunch</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">          <span class="nx">url</span><span class="o">:</span> <span class="s2">&#34;/pages/login/login&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="nx">params</span><span class="p">.</span><span class="nx">wechatLoginToken</span> <span class="o">=</span> <span class="nx">userInfo</span><span class="p">.</span><span class="nx">wechatLoginToken</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">params</span><span class="p">.</span><span class="nx">wechatOpenId</span> <span class="o">=</span> <span class="nx">userInfo</span><span class="p">.</span><span class="nx">wechatOpenId</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">dic</span> <span class="o">=</span> <span class="p">{};</span>
</span></span><span class="line"><span class="cl">    <span class="nx">dic</span><span class="p">.</span><span class="nx">cipher</span> <span class="o">=</span> <span class="nx">that</span><span class="p">.</span><span class="nx">encryption</span><span class="p">(</span><span class="nx">params</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nx">temp_cb</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">code</span> <span class="o">==</span> <span class="s2">&#34;8888&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">wx</span><span class="p">.</span><span class="nx">clearStorage</span><span class="p">();</span> <span class="c1">//清理登录缓存数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">wx</span><span class="p">.</span><span class="nx">showToast</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">          <span class="nx">title</span><span class="o">:</span> <span class="s2">&#34;登录失效,请重新登录!&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nx">icon</span><span class="o">:</span> <span class="s2">&#34;none&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nx">wx</span><span class="p">.</span><span class="nx">reLaunch</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">          <span class="nx">url</span><span class="o">:</span> <span class="s2">&#34;/pages/login/login&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">typeof</span> <span class="nx">cb</span> <span class="o">==</span> <span class="s2">&#34;function&#34;</span> <span class="o">&amp;&amp;</span> <span class="nx">cb</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">getResult</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">dic</span><span class="p">,</span> <span class="nx">md</span><span class="p">,</span> <span class="nx">temp_cb</span><span class="p">,</span> <span class="nx">load</span><span class="p">,</span> <span class="nx">ctype</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="nx">Page</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//提交订单
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">formSubmit</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">formSubmitRes</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">paraDic</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">regPhone</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">regPhone</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">shipName</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">shipName</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">customer</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">customerName</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">planType</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">planCateID</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">customerType</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">customerID</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">arriveTime</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">isAllMention</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">arrivalTime</span> <span class="o">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">takeSite</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">isTakeSite</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">takeSiteID</span> <span class="o">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//提交订单
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">app</span><span class="p">.</span><span class="nx">getResult</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;/oilPlan/checkInfo.pl&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">paraDic</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;POST&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="kd">function</span> <span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">var</span> <span class="nx">appleDetailDic</span> <span class="o">=</span> <span class="p">{};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">isTakeSite</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nx">appleDetailDic</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">regPhone</span><span class="o">:</span> <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">regPhone</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">planType</span><span class="o">:</span> <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">planCateID</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">customerType</span><span class="o">:</span> <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">customerID</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">siteId</span><span class="o">:</span> <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">saleSiteID</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">shipName</span><span class="o">:</span> <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">shipName</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">customer</span><span class="o">:</span> <span class="nx">formSubmitRes</span><span class="p">.</span><span class="nx">detail</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">customerName</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">takeSite</span><span class="o">:</span> <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">takeSiteID</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">planCode</span><span class="o">:</span> <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">planCode</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">pagesType</span><span class="o">:</span> <span class="s2">&#34;0&#34;</span><span class="p">,</span> <span class="c1">//type 0 新增，1 修改
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">isAgain</span><span class="o">:</span> <span class="s2">&#34;1&#34;</span><span class="p">,</span> <span class="c1">//修改识别
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">shipLength</span><span class="o">:</span> <span class="nx">formSubmitRes</span><span class="p">.</span><span class="nx">detail</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">shipLength</span><span class="p">,</span> <span class="c1">//船舶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">shipType</span><span class="o">:</span> <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">shipTypeSelect</span><span class="p">,</span> <span class="c1">//船舶类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">shipLoad</span><span class="o">:</span> <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">shipLoadSelect</span><span class="p">,</span> <span class="c1">//载重
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">isAllMention</span><span class="o">:</span> <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">isAllMention</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">nineyards</span><span class="o">:</span> <span class="nx">formSubmitRes</span><span class="p">.</span><span class="nx">detail</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">nineyards</span><span class="p">,</span> <span class="c1">//九位码
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">arrivalTime</span><span class="o">:</span> <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">arrivalTime</span><span class="p">,</span> <span class="c1">//预计到站时间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">otherPhone</span><span class="o">:</span> <span class="nx">formSubmitRes</span><span class="p">.</span><span class="nx">detail</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">otherPhone</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="p">};</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nx">appleDetailDic</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">regPhone</span><span class="o">:</span> <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">regPhone</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">planType</span><span class="o">:</span> <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">planCateID</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">customerType</span><span class="o">:</span> <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">customerID</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">siteId</span><span class="o">:</span> <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">saleSiteID</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">shipName</span><span class="o">:</span> <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">shipName</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">customer</span><span class="o">:</span> <span class="nx">formSubmitRes</span><span class="p">.</span><span class="nx">detail</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">customerName</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">takeSite</span><span class="o">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">planCode</span><span class="o">:</span> <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">planCode</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">pagesType</span><span class="o">:</span> <span class="s2">&#34;0&#34;</span><span class="p">,</span> <span class="c1">//type 0 新增，1 修改
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">isAgain</span><span class="o">:</span> <span class="s2">&#34;1&#34;</span><span class="p">,</span> <span class="c1">//修改识别
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">shipLength</span><span class="o">:</span> <span class="nx">formSubmitRes</span><span class="p">.</span><span class="nx">detail</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">shipLength</span><span class="p">,</span> <span class="c1">//船舶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">shipType</span><span class="o">:</span> <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">shipTypeSelect</span><span class="p">,</span> <span class="c1">//船舶类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">shipLoad</span><span class="o">:</span> <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">shipLoadSelect</span><span class="p">,</span> <span class="c1">//载重
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">isAllMention</span><span class="o">:</span> <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">isAllMention</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">nineyards</span><span class="o">:</span> <span class="nx">formSubmitRes</span><span class="p">.</span><span class="nx">detail</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">nineyards</span><span class="p">,</span> <span class="c1">//九位码
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">arrivalTime</span><span class="o">:</span> <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">arrivalTime</span><span class="p">,</span> <span class="c1">//预计到站时间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">otherPhone</span><span class="o">:</span> <span class="nx">formSubmitRes</span><span class="p">.</span><span class="nx">detail</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">otherPhone</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="p">};</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">code</span> <span class="o">==</span> <span class="s2">&#34;0000&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="c1">//判断是否修改
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="k">if</span> <span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">isDataChange</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//修改
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">wx</span><span class="p">.</span><span class="nx">navigateTo</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">              <span class="nx">url</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;/pages/plan/applyDetail/applyDetail?appleDetailDic=&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">appleDetailDic</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="p">});</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//再来一单的申请详情页
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">wx</span><span class="p">.</span><span class="nx">navigateTo</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">              <span class="nx">url</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;/pages/plan/planAgain-detail/planAgain-detail?appleDetailDic=&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">appleDetailDic</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="p">});</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">code</span> <span class="o">==</span> <span class="s2">&#34;0003&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nx">wx</span><span class="p">.</span><span class="nx">showModal</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">            <span class="nx">title</span><span class="o">:</span> <span class="s2">&#34;提示&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">content</span><span class="o">:</span> <span class="nx">res</span><span class="p">.</span><span class="nx">msg</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">success</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">confirm</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//创建新船
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nx">app</span><span class="p">.</span><span class="nx">getResult</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                  <span class="s2">&#34;/oilPlan/addShip.pl&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="nx">paraDic</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="s2">&#34;POST&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="kd">function</span> <span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">code</span> <span class="o">==</span> <span class="s2">&#34;0000&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                      <span class="k">if</span> <span class="p">(</span><span class="nx">appleDetailDic</span><span class="p">.</span><span class="nx">customerType</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="nx">app</span><span class="p">.</span><span class="nx">getResult</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                          <span class="s2">&#34;/oilPlan/checkInfo.pl&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                          <span class="nx">paraDic</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                          <span class="s2">&#34;POST&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                          <span class="kd">function</span> <span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                            <span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">code</span> <span class="o">==</span> <span class="s2">&#34;0000&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                              <span class="c1">//判断是否修改
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                              <span class="k">if</span> <span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">isDataChange</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                <span class="c1">//修改
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                                <span class="nx">wx</span><span class="p">.</span><span class="nx">navigateTo</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">                                  <span class="nx">url</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                                    <span class="s2">&#34;/pages/plan/applyDetail/applyDetail?appleDetailDic=&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                                    <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">appleDetailDic</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                                <span class="p">});</span>
</span></span><span class="line"><span class="cl">                              <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                <span class="c1">//再来一单的申请详情页
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                                <span class="nx">wx</span><span class="p">.</span><span class="nx">navigateTo</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">                                  <span class="nx">url</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                                    <span class="s2">&#34;/pages/plan/planAgain-detail/planAgain-detail?appleDetailDic=&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                                    <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">appleDetailDic</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                                <span class="p">});</span>
</span></span><span class="line"><span class="cl">                              <span class="p">}</span>
</span></span><span class="line"><span class="cl">                            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">code</span> <span class="o">==</span> <span class="s2">&#34;0010&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                              <span class="c1">//点击弹框
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                              <span class="nx">wx</span><span class="p">.</span><span class="nx">showModal</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">                                <span class="nx">title</span><span class="o">:</span> <span class="s2">&#34;提示&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                <span class="nx">content</span><span class="o">:</span> <span class="nx">res</span><span class="p">.</span><span class="nx">msg</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                <span class="nx">confirmText</span><span class="o">:</span> <span class="s2">&#34;确定&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                <span class="nx">cancelText</span><span class="o">:</span> <span class="s2">&#34;取消&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                <span class="nx">success</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                  <span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">confirm</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                    <span class="c1">//判断是否修改
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                                    <span class="kr">debugger</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                                    <span class="k">if</span> <span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">isDataChange</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                      <span class="c1">//修改
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                                      <span class="nx">wx</span><span class="p">.</span><span class="nx">navigateTo</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">                                        <span class="nx">url</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                                          <span class="s2">&#34;/pages/plan/applyDetail/applyDetail?appleDetailDic=&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                                          <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">appleDetailDic</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                                      <span class="p">});</span>
</span></span><span class="line"><span class="cl">                                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                      <span class="c1">//再来一单的申请详情页
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                                      <span class="nx">wx</span><span class="p">.</span><span class="nx">navigateTo</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">                                        <span class="nx">url</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                                          <span class="s2">&#34;/pages/plan/planAgain-detail/planAgain-detail?appleDetailDic=&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                                          <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">appleDetailDic</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                                      <span class="p">});</span>
</span></span><span class="line"><span class="cl">                                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                                  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">cancel</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                  <span class="p">}</span>
</span></span><span class="line"><span class="cl">                                <span class="p">},</span>
</span></span><span class="line"><span class="cl">                              <span class="p">});</span>
</span></span><span class="line"><span class="cl">                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                              <span class="nx">wx</span><span class="p">.</span><span class="nx">showToast</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">                                <span class="nx">title</span><span class="o">:</span> <span class="nx">res</span><span class="p">.</span><span class="nx">msg</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                <span class="nx">icon</span><span class="o">:</span> <span class="s2">&#34;none&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                              <span class="p">});</span>
</span></span><span class="line"><span class="cl">                            <span class="p">}</span>
</span></span><span class="line"><span class="cl">                          <span class="p">},</span>
</span></span><span class="line"><span class="cl">                          <span class="s2">&#34;ture&#34;</span>
</span></span><span class="line"><span class="cl">                        <span class="p">);</span>
</span></span><span class="line"><span class="cl">                      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">isDataChange</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                          <span class="c1">//修改
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                          <span class="nx">wx</span><span class="p">.</span><span class="nx">navigateTo</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">                            <span class="nx">url</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                              <span class="s2">&#34;/pages/plan/applyDetail/applyDetail?appleDetailDic=&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                              <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">appleDetailDic</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                          <span class="p">});</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                          <span class="c1">//再来一单的申请详情页
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                          <span class="nx">wx</span><span class="p">.</span><span class="nx">navigateTo</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">                            <span class="nx">url</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                              <span class="s2">&#34;/pages/plan/planAgain-detail/planAgain-detail?appleDetailDic=&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                              <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">appleDetailDic</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                          <span class="p">});</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}</span>
</span></span><span class="line"><span class="cl">                      <span class="p">}</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                      <span class="nx">wx</span><span class="p">.</span><span class="nx">showToast</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">                        <span class="nx">title</span><span class="o">:</span> <span class="nx">res</span><span class="p">.</span><span class="nx">msg</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="nx">icon</span><span class="o">:</span> <span class="s2">&#34;none&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                      <span class="p">});</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                  <span class="p">},</span>
</span></span><span class="line"><span class="cl">                  <span class="s2">&#34;ture&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="p">);</span>
</span></span><span class="line"><span class="cl">              <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">cancel</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">          <span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">code</span> <span class="o">==</span> <span class="s2">&#34;0008&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="c1">//点击弹框
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="nx">wx</span><span class="p">.</span><span class="nx">showModal</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">            <span class="nx">title</span><span class="o">:</span> <span class="s2">&#34;提示&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">content</span><span class="o">:</span> <span class="nx">res</span><span class="p">.</span><span class="nx">msg</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">confirmText</span><span class="o">:</span> <span class="s2">&#34;仍然选择&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">cancelText</span><span class="o">:</span> <span class="s2">&#34;重新选择&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">success</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">confirm</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">paraDic</span><span class="p">.</span><span class="nx">ignore</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="nx">app</span><span class="p">.</span><span class="nx">getResult</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                  <span class="s2">&#34;/oilPlan/checkInfo.pl&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="nx">paraDic</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="s2">&#34;POST&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="kd">function</span> <span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">code</span> <span class="o">==</span> <span class="s2">&#34;0000&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                      <span class="k">if</span> <span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">isDataChange</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="c1">//修改
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="nx">wx</span><span class="p">.</span><span class="nx">navigateTo</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">                          <span class="nx">url</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                            <span class="s2">&#34;/pages/plan/applyDetail/applyDetail?appleDetailDic=&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                            <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">appleDetailDic</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                        <span class="p">});</span>
</span></span><span class="line"><span class="cl">                      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="c1">//再来一单的申请详情页
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="nx">wx</span><span class="p">.</span><span class="nx">navigateTo</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">                          <span class="nx">url</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                            <span class="s2">&#34;/pages/plan/planAgain-detail/planAgain-detail?appleDetailDic=&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                            <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">appleDetailDic</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                        <span class="p">});</span>
</span></span><span class="line"><span class="cl">                      <span class="p">}</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">code</span> <span class="o">==</span> <span class="s2">&#34;0010&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                      <span class="c1">//点击弹框
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                      <span class="nx">wx</span><span class="p">.</span><span class="nx">showModal</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">                        <span class="nx">title</span><span class="o">:</span> <span class="s2">&#34;提示&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="nx">content</span><span class="o">:</span> <span class="nx">res</span><span class="p">.</span><span class="nx">msg</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="nx">confirmText</span><span class="o">:</span> <span class="s2">&#34;确定&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="nx">cancelText</span><span class="o">:</span> <span class="s2">&#34;取消&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="nx">success</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                          <span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">confirm</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                            <span class="c1">//判断是否修改
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                            <span class="k">if</span> <span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">isDataChange</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                              <span class="c1">//修改
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                              <span class="nx">wx</span><span class="p">.</span><span class="nx">navigateTo</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">                                <span class="nx">url</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                                  <span class="s2">&#34;/pages/plan/applyDetail/applyDetail?appleDetailDic=&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                                  <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">appleDetailDic</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                              <span class="p">});</span>
</span></span><span class="line"><span class="cl">                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                              <span class="c1">//再来一单的申请详情页
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                              <span class="nx">wx</span><span class="p">.</span><span class="nx">navigateTo</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">                                <span class="nx">url</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                                  <span class="s2">&#34;/pages/plan/planAgain-detail/planAgain-detail?appleDetailDic=&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                                  <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">appleDetailDic</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                              <span class="p">});</span>
</span></span><span class="line"><span class="cl">                            <span class="p">}</span>
</span></span><span class="line"><span class="cl">                          <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">cancel</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                          <span class="p">}</span>
</span></span><span class="line"><span class="cl">                        <span class="p">},</span>
</span></span><span class="line"><span class="cl">                      <span class="p">});</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">code</span> <span class="o">==</span> <span class="s2">&#34;0003&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                      <span class="nx">wx</span><span class="p">.</span><span class="nx">showModal</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">                        <span class="nx">title</span><span class="o">:</span> <span class="s2">&#34;提示&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="nx">content</span><span class="o">:</span> <span class="nx">res</span><span class="p">.</span><span class="nx">msg</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="nx">success</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                          <span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">confirm</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                            <span class="kd">var</span> <span class="nx">paraDic</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                              <span class="nx">shipName</span><span class="o">:</span> <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">shipName</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                              <span class="nx">customer</span><span class="o">:</span> <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">customerName</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                              <span class="nx">customerType</span><span class="o">:</span> <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">customerID</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="p">};</span>
</span></span><span class="line"><span class="cl">                            <span class="c1">//创建新船
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                            <span class="nx">app</span><span class="p">.</span><span class="nx">getResult</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                              <span class="s2">&#34;/oilPlan/addShip.pl&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                              <span class="nx">paraDic</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                              <span class="s2">&#34;POST&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                              <span class="kd">function</span> <span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                <span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">code</span> <span class="o">==</span> <span class="s2">&#34;0000&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                  <span class="k">if</span> <span class="p">(</span><span class="nx">appleDetailDic</span><span class="p">.</span><span class="nx">customerType</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                    <span class="kd">var</span> <span class="nx">paraDic</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                      <span class="nx">regPhone</span><span class="o">:</span> <span class="nx">appleDetailDic</span><span class="p">.</span><span class="nx">regPhone</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                      <span class="nx">shipName</span><span class="o">:</span> <span class="nx">appleDetailDic</span><span class="p">.</span><span class="nx">shipName</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                      <span class="nx">customer</span><span class="o">:</span> <span class="nx">appleDetailDic</span><span class="p">.</span><span class="nx">customer</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                      <span class="nx">planType</span><span class="o">:</span> <span class="nx">appleDetailDic</span><span class="p">.</span><span class="nx">planType</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                      <span class="nx">customerType</span><span class="o">:</span> <span class="nx">appleDetailDic</span><span class="p">.</span><span class="nx">customerType</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                      <span class="nx">arriveTime</span><span class="o">:</span> <span class="nx">appleDetailDic</span><span class="p">.</span><span class="nx">arriveTime</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                      <span class="nx">takeSite</span><span class="o">:</span> <span class="nx">appleDetailDic</span><span class="p">.</span><span class="nx">takeSite</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                    <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                    <span class="nx">app</span><span class="p">.</span><span class="nx">getResult</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                                      <span class="s2">&#34;/oilPlan/checkInfo.pl&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                      <span class="nx">paraDic</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                      <span class="s2">&#34;POST&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                      <span class="kd">function</span> <span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                        <span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">code</span> <span class="o">==</span> <span class="s2">&#34;0000&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                          <span class="c1">//判断是否修改
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                                          <span class="k">if</span> <span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">isDataChange</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                            <span class="c1">//修改
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                                            <span class="nx">wx</span><span class="p">.</span><span class="nx">navigateTo</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">                                              <span class="nx">url</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                                                <span class="s2">&#34;/pages/plan/applyDetail/applyDetail?appleDetailDic=&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                                                <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">appleDetailDic</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                                            <span class="p">});</span>
</span></span><span class="line"><span class="cl">                                          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                            <span class="c1">//再来一单的申请详情页
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                                            <span class="nx">wx</span><span class="p">.</span><span class="nx">navigateTo</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">                                              <span class="nx">url</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                                                <span class="s2">&#34;/pages/plan/planAgain-detail/planAgain-detail?appleDetailDic=&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                                                <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">appleDetailDic</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                                            <span class="p">});</span>
</span></span><span class="line"><span class="cl">                                          <span class="p">}</span>
</span></span><span class="line"><span class="cl">                                        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">code</span> <span class="o">==</span> <span class="s2">&#34;0010&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                          <span class="c1">//点击弹框
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                                          <span class="nx">wx</span><span class="p">.</span><span class="nx">showModal</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">                                            <span class="nx">title</span><span class="o">:</span> <span class="s2">&#34;提示&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                            <span class="nx">content</span><span class="o">:</span> <span class="nx">res</span><span class="p">.</span><span class="nx">msg</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                            <span class="nx">confirmText</span><span class="o">:</span> <span class="s2">&#34;确定&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                            <span class="nx">cancelText</span><span class="o">:</span> <span class="s2">&#34;取消&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                            <span class="nx">success</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                              <span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">confirm</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                                <span class="c1">//判断是否修改
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                                                <span class="kr">debugger</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                                                <span class="k">if</span> <span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">isDataChange</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                                  <span class="c1">//修改
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                                                  <span class="nx">wx</span><span class="p">.</span><span class="nx">navigateTo</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">                                                    <span class="nx">url</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                                                      <span class="s2">&#34;/pages/plan/applyDetail/applyDetail?appleDetailDic=&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                                                      <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                                                        <span class="nx">appleDetailDic</span>
</span></span><span class="line"><span class="cl">                                                      <span class="p">),</span>
</span></span><span class="line"><span class="cl">                                                  <span class="p">});</span>
</span></span><span class="line"><span class="cl">                                                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                                  <span class="c1">//再来一单的申请详情页
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                                                  <span class="nx">wx</span><span class="p">.</span><span class="nx">navigateTo</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">                                                    <span class="nx">url</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                                                      <span class="s2">&#34;/pages/plan/planAgain-detail/planAgain-detail?appleDetailDic=&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                                                      <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                                                        <span class="nx">appleDetailDic</span>
</span></span><span class="line"><span class="cl">                                                      <span class="p">),</span>
</span></span><span class="line"><span class="cl">                                                  <span class="p">});</span>
</span></span><span class="line"><span class="cl">                                                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                                              <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">cancel</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                              <span class="p">}</span>
</span></span><span class="line"><span class="cl">                                            <span class="p">},</span>
</span></span><span class="line"><span class="cl">                                          <span class="p">});</span>
</span></span><span class="line"><span class="cl">                                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                          <span class="nx">wx</span><span class="p">.</span><span class="nx">showToast</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">                                            <span class="nx">title</span><span class="o">:</span> <span class="nx">res</span><span class="p">.</span><span class="nx">msg</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                            <span class="nx">icon</span><span class="o">:</span> <span class="s2">&#34;none&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                          <span class="p">});</span>
</span></span><span class="line"><span class="cl">                                        <span class="p">}</span>
</span></span><span class="line"><span class="cl">                                      <span class="p">},</span>
</span></span><span class="line"><span class="cl">                                      <span class="s2">&#34;ture&#34;</span>
</span></span><span class="line"><span class="cl">                                    <span class="p">);</span>
</span></span><span class="line"><span class="cl">                                  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                    <span class="k">if</span> <span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">isDataChange</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                      <span class="c1">//修改
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                                      <span class="nx">wx</span><span class="p">.</span><span class="nx">navigateTo</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">                                        <span class="nx">url</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                                          <span class="s2">&#34;/pages/plan/applyDetail/applyDetail?appleDetailDic=&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                                          <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">appleDetailDic</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                                      <span class="p">});</span>
</span></span><span class="line"><span class="cl">                                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                      <span class="c1">//再来一单的申请详情页
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                                      <span class="nx">wx</span><span class="p">.</span><span class="nx">navigateTo</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">                                        <span class="nx">url</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                                          <span class="s2">&#34;/pages/plan/planAgain-detail/planAgain-detail?appleDetailDic=&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                                          <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">appleDetailDic</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                                      <span class="p">});</span>
</span></span><span class="line"><span class="cl">                                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                                  <span class="p">}</span>
</span></span><span class="line"><span class="cl">                                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                  <span class="nx">wx</span><span class="p">.</span><span class="nx">showToast</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">                                    <span class="nx">title</span><span class="o">:</span> <span class="nx">res</span><span class="p">.</span><span class="nx">msg</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                    <span class="nx">icon</span><span class="o">:</span> <span class="s2">&#34;none&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                  <span class="p">});</span>
</span></span><span class="line"><span class="cl">                                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                              <span class="p">},</span>
</span></span><span class="line"><span class="cl">                              <span class="s2">&#34;ture&#34;</span>
</span></span><span class="line"><span class="cl">                            <span class="p">);</span>
</span></span><span class="line"><span class="cl">                          <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">cancel</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                          <span class="p">}</span>
</span></span><span class="line"><span class="cl">                        <span class="p">},</span>
</span></span><span class="line"><span class="cl">                      <span class="p">});</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                      <span class="nx">wx</span><span class="p">.</span><span class="nx">showToast</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">                        <span class="nx">title</span><span class="o">:</span> <span class="nx">res</span><span class="p">.</span><span class="nx">msg</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="nx">icon</span><span class="o">:</span> <span class="s2">&#34;none&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                      <span class="p">});</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                  <span class="p">},</span>
</span></span><span class="line"><span class="cl">                  <span class="s2">&#34;ture&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="p">);</span>
</span></span><span class="line"><span class="cl">              <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">cancel</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">          <span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">code</span> <span class="o">==</span> <span class="s2">&#34;0010&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="c1">//点击弹框
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="nx">wx</span><span class="p">.</span><span class="nx">showModal</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">            <span class="nx">title</span><span class="o">:</span> <span class="s2">&#34;提示&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">content</span><span class="o">:</span> <span class="nx">res</span><span class="p">.</span><span class="nx">msg</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">confirmText</span><span class="o">:</span> <span class="s2">&#34;确定&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">cancelText</span><span class="o">:</span> <span class="s2">&#34;取消&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">success</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">confirm</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//判断是否修改
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="kr">debugger</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">isDataChange</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                  <span class="c1">//修改
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                  <span class="nx">wx</span><span class="p">.</span><span class="nx">navigateTo</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">url</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                      <span class="s2">&#34;/pages/plan/applyDetail/applyDetail?appleDetailDic=&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                      <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">appleDetailDic</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                  <span class="p">});</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                  <span class="c1">//再来一单的申请详情页
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                  <span class="nx">wx</span><span class="p">.</span><span class="nx">navigateTo</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">url</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                      <span class="s2">&#34;/pages/plan/planAgain-detail/planAgain-detail?appleDetailDic=&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                      <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">appleDetailDic</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                  <span class="p">});</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">              <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">cancel</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">          <span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nx">wx</span><span class="p">.</span><span class="nx">showToast</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">            <span class="nx">title</span><span class="o">:</span> <span class="nx">res</span><span class="p">.</span><span class="nx">msg</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">icon</span><span class="o">:</span> <span class="s2">&#34;none&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;ture&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span></code></pre></div><h3 id="重构后的代码">重构后的代码</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="c1">// util.js
</span></span></span><span class="line"><span class="cl"><span class="c1">// 封装 wx.request() 返回 Promise
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">const</span> <span class="nx">wxRequest</span> <span class="o">=</span> <span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">params</span><span class="p">,</span> <span class="nx">md</span><span class="p">,</span> <span class="nx">load</span><span class="p">,</span> <span class="nx">ctype</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nx">load</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">wx</span><span class="p">.</span><span class="nx">showLoading</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">      <span class="nx">mask</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">title</span><span class="o">:</span> <span class="s2">&#34;拼命加载中&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="kd">let</span> <span class="nx">taskController</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kd">let</span> <span class="nx">task</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">taskController</span> <span class="o">=</span> <span class="nx">wx</span><span class="p">.</span><span class="nx">request</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">      <span class="nx">url</span><span class="o">:</span> <span class="nx">ycConfig</span><span class="p">[</span><span class="nx">ycConfig</span><span class="p">.</span><span class="nx">env</span><span class="p">].</span><span class="nx">domain_url</span> <span class="o">+</span> <span class="nx">url</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">data</span><span class="o">:</span> <span class="nx">params</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">dataType</span><span class="o">:</span> <span class="s2">&#34;json&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">method</span><span class="o">:</span> <span class="nx">md</span> <span class="o">?</span> <span class="nx">md</span> <span class="o">:</span> <span class="s2">&#34;POST&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">header</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;content-type&#34;</span><span class="o">:</span> <span class="nx">ctype</span> <span class="o">||</span> <span class="s2">&#34;application/json&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nx">success</span><span class="o">:</span> <span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">wx</span><span class="p">.</span><span class="nx">hideLoading</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="nx">resolve</span><span class="p">(</span><span class="nx">res</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nx">fail</span><span class="o">:</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">reject</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nx">wx</span><span class="p">.</span><span class="nx">hideLoading</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">          <span class="nx">wx</span><span class="p">.</span><span class="nx">showToast</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">            <span class="nx">title</span><span class="o">:</span> <span class="s2">&#34;网络连接异常&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">icon</span><span class="o">:</span> <span class="s2">&#34;none&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="p">});</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="p">{</span> <span class="nx">task</span><span class="p">,</span> <span class="nx">taskController</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">wxRequest</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="c1">// app.js
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">let</span> <span class="p">{</span> <span class="nx">wxRequest</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&#34;utils/util.js&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">App</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">  <span class="nx">getRequest</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">params</span><span class="p">,</span> <span class="nx">md</span><span class="p">,</span> <span class="nx">load</span><span class="p">,</span> <span class="nx">ctype</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">url</span> <span class="o">!=</span> <span class="s2">&#34;/ffpLogin.pl&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kd">var</span> <span class="nx">userInfo</span> <span class="o">=</span> <span class="nx">wx</span><span class="p">.</span><span class="nx">getStorageSync</span><span class="p">(</span><span class="s2">&#34;globalUserInfo&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">//判断是否有效
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nx">isEmpty</span><span class="p">(</span><span class="nx">userInfo</span><span class="p">.</span><span class="nx">wechatLoginToken</span><span class="p">)</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">        <span class="nx">isEmpty</span><span class="p">(</span><span class="nx">userInfo</span><span class="p">.</span><span class="nx">wechatOpenId</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">wx</span><span class="p">.</span><span class="nx">clearStorage</span><span class="p">();</span> <span class="c1">//清理登录缓存数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">wx</span><span class="p">.</span><span class="nx">showToast</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">          <span class="nx">title</span><span class="o">:</span> <span class="s2">&#34;登录失效,请重新登录!&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nx">icon</span><span class="o">:</span> <span class="s2">&#34;none&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nx">wx</span><span class="p">.</span><span class="nx">reLaunch</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">          <span class="nx">url</span><span class="o">:</span> <span class="s2">&#34;/pages/login/login&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="nx">params</span><span class="p">.</span><span class="nx">wechatLoginToken</span> <span class="o">=</span> <span class="nx">userInfo</span><span class="p">.</span><span class="nx">wechatLoginToken</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">params</span><span class="p">.</span><span class="nx">wechatOpenId</span> <span class="o">=</span> <span class="nx">userInfo</span><span class="p">.</span><span class="nx">wechatOpenId</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">dic</span> <span class="o">=</span> <span class="p">{};</span>
</span></span><span class="line"><span class="cl">    <span class="nx">dic</span><span class="p">.</span><span class="nx">cipher</span> <span class="o">=</span> <span class="nx">that</span><span class="p">.</span><span class="nx">encryption</span><span class="p">(</span><span class="nx">params</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">wxRequest</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">dic</span><span class="p">,</span> <span class="nx">md</span><span class="p">,</span> <span class="nx">load</span><span class="p">,</span> <span class="nx">ctype</span><span class="p">).</span><span class="nx">task</span><span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">code</span> <span class="o">==</span> <span class="s2">&#34;8888&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nx">wx</span><span class="p">.</span><span class="nx">clearStorage</span><span class="p">();</span> <span class="c1">//清理登录缓存数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="nx">wx</span><span class="p">.</span><span class="nx">showToast</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">            <span class="nx">title</span><span class="o">:</span> <span class="s2">&#34;登录失效,请重新登录!&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">icon</span><span class="o">:</span> <span class="s2">&#34;none&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">          <span class="nx">wx</span><span class="p">.</span><span class="nx">reLaunch</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">            <span class="nx">url</span><span class="o">:</span> <span class="s2">&#34;/pages/login/login&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="p">});</span>
</span></span><span class="line"><span class="cl">          <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nx">resolve</span><span class="p">(</span><span class="nx">res</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="c1">// 业务代码
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">Page</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">  <span class="nx">checkInfo</span><span class="o">:</span> <span class="p">(</span><span class="nx">paraDic</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">app</span><span class="p">.</span><span class="nx">getRequest</span><span class="p">(</span><span class="s2">&#34;/oilPlan/checkInfo.pl&#34;</span><span class="p">,</span> <span class="nx">paraDic</span><span class="p">,</span> <span class="s2">&#34;POST&#34;</span><span class="p">,</span> <span class="s2">&#34;ture&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nx">addShip</span><span class="o">:</span> <span class="p">(</span><span class="nx">paraDic</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">app</span><span class="p">.</span><span class="nx">getRequest</span><span class="p">(</span><span class="s2">&#34;/oilPlan/addShip.pl&#34;</span><span class="p">,</span> <span class="nx">paraDic</span><span class="p">,</span> <span class="s2">&#34;POST&#34;</span><span class="p">,</span> <span class="s2">&#34;ture&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nx">innerRouter</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">isDataChange</span><span class="p">,</span> <span class="nx">appleDetailDic</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">isDataChange</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">//修改
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="nx">wx</span><span class="p">.</span><span class="nx">navigateTo</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">        <span class="nx">url</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">          <span class="s2">&#34;/pages/plan/applyDetail/applyDetail?appleDetailDic=&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">          <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">appleDetailDic</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">//再来一单的申请详情页
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="nx">wx</span><span class="p">.</span><span class="nx">navigateTo</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">        <span class="nx">url</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">          <span class="s2">&#34;/pages/plan/planAgain-detail/planAgain-detail?appleDetailDic=&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">          <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">appleDetailDic</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//提交订单
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">formSubmit</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">formSubmitRes</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">paraDic</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">regPhone</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">regPhone</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">shipName</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">shipName</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">customer</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">customerName</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">planType</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">planCateID</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">customerType</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">customerID</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">arriveTime</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">isAllMention</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">arrivalTime</span> <span class="o">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">takeSite</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">isTakeSite</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">takeSiteID</span> <span class="o">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">appleDetailDic</span> <span class="o">=</span> <span class="p">{};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">isTakeSite</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">appleDetailDic</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">regPhone</span><span class="o">:</span> <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">regPhone</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">planType</span><span class="o">:</span> <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">planCateID</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">customerType</span><span class="o">:</span> <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">customerID</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">siteId</span><span class="o">:</span> <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">saleSiteID</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">shipName</span><span class="o">:</span> <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">shipName</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">customer</span><span class="o">:</span> <span class="nx">formSubmitRes</span><span class="p">.</span><span class="nx">detail</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">customerName</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">takeSite</span><span class="o">:</span> <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">takeSiteID</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">planCode</span><span class="o">:</span> <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">planCode</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">pagesType</span><span class="o">:</span> <span class="s2">&#34;0&#34;</span><span class="p">,</span> <span class="c1">//type 0 新增，1 修改
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">isAgain</span><span class="o">:</span> <span class="s2">&#34;1&#34;</span><span class="p">,</span> <span class="c1">//修改识别
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">shipLength</span><span class="o">:</span> <span class="nx">formSubmitRes</span><span class="p">.</span><span class="nx">detail</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">shipLength</span><span class="p">,</span> <span class="c1">//船舶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">shipType</span><span class="o">:</span> <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">shipTypeSelect</span><span class="p">,</span> <span class="c1">//船舶类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">shipLoad</span><span class="o">:</span> <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">shipLoadSelect</span><span class="p">,</span> <span class="c1">//载重
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">isAllMention</span><span class="o">:</span> <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">isAllMention</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">nineyards</span><span class="o">:</span> <span class="nx">formSubmitRes</span><span class="p">.</span><span class="nx">detail</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">nineyards</span><span class="p">,</span> <span class="c1">//九位码
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">arrivalTime</span><span class="o">:</span> <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">arrivalTime</span><span class="p">,</span> <span class="c1">//预计到站时间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">otherPhone</span><span class="o">:</span> <span class="nx">formSubmitRes</span><span class="p">.</span><span class="nx">detail</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">otherPhone</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">appleDetailDic</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">regPhone</span><span class="o">:</span> <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">regPhone</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">planType</span><span class="o">:</span> <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">planCateID</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">customerType</span><span class="o">:</span> <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">customerID</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">siteId</span><span class="o">:</span> <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">saleSiteID</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">shipName</span><span class="o">:</span> <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">shipName</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">customer</span><span class="o">:</span> <span class="nx">formSubmitRes</span><span class="p">.</span><span class="nx">detail</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">customerName</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">takeSite</span><span class="o">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">planCode</span><span class="o">:</span> <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">planCode</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">pagesType</span><span class="o">:</span> <span class="s2">&#34;0&#34;</span><span class="p">,</span> <span class="c1">//type 0 新增，1 修改
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">isAgain</span><span class="o">:</span> <span class="s2">&#34;1&#34;</span><span class="p">,</span> <span class="c1">//修改识别
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">shipLength</span><span class="o">:</span> <span class="nx">formSubmitRes</span><span class="p">.</span><span class="nx">detail</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">shipLength</span><span class="p">,</span> <span class="c1">//船舶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">shipType</span><span class="o">:</span> <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">shipTypeSelect</span><span class="p">,</span> <span class="c1">//船舶类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">shipLoad</span><span class="o">:</span> <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">shipLoadSelect</span><span class="p">,</span> <span class="c1">//载重
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">isAllMention</span><span class="o">:</span> <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">isAllMention</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">nineyards</span><span class="o">:</span> <span class="nx">formSubmitRes</span><span class="p">.</span><span class="nx">detail</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">nineyards</span><span class="p">,</span> <span class="c1">//九位码
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">arrivalTime</span><span class="o">:</span> <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">arrivalTime</span><span class="p">,</span> <span class="c1">//预计到站时间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">otherPhone</span><span class="o">:</span> <span class="nx">formSubmitRes</span><span class="p">.</span><span class="nx">detail</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">otherPhone</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">statusCode</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Map</span><span class="p">([</span>
</span></span><span class="line"><span class="cl">      <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;0000&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nx">msg</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="c1">// 跳转新页面
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="nx">that</span><span class="p">.</span><span class="nx">innerRouter</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">isDataChange</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nx">appleDetailDic</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="p">],</span>
</span></span><span class="line"><span class="cl">      <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;0001&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nx">msg</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nx">wx</span><span class="p">.</span><span class="nx">showToast</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">            <span class="nx">title</span><span class="o">:</span> <span class="nx">msg</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">icon</span><span class="o">:</span> <span class="s2">&#34;none&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="p">],</span>
</span></span><span class="line"><span class="cl">      <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;0003&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="kr">async</span> <span class="p">(</span><span class="nx">msg</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="c1">// wx.showModal(Object object) 支持 Promise 风格调用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="kr">const</span> <span class="nx">modalResult</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">wx</span><span class="p">.</span><span class="nx">showModal</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">            <span class="nx">title</span><span class="o">:</span> <span class="s2">&#34;提示&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">content</span><span class="o">:</span> <span class="nx">msg</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="p">});</span>
</span></span><span class="line"><span class="cl">          <span class="k">if</span> <span class="p">(</span><span class="nx">modalResult</span><span class="p">.</span><span class="nx">confirm</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kr">await</span> <span class="nx">that</span><span class="p">.</span><span class="nx">addShip</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">paraDic</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nx">showMessage</span><span class="p">(</span><span class="kr">await</span> <span class="nx">that</span><span class="p">.</span><span class="nx">checkInfo</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">paraDic</span><span class="p">),</span> <span class="nx">options</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="p">],</span>
</span></span><span class="line"><span class="cl">      <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;0008&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="kr">async</span> <span class="p">(</span><span class="nx">msg</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="kr">const</span> <span class="nx">modalResult</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">wx</span><span class="p">.</span><span class="nx">showModal</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">            <span class="nx">title</span><span class="o">:</span> <span class="s2">&#34;提示&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">content</span><span class="o">:</span> <span class="nx">msg</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="p">});</span>
</span></span><span class="line"><span class="cl">          <span class="k">if</span> <span class="p">(</span><span class="nx">modalResult</span><span class="p">.</span><span class="nx">confirm</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">options</span><span class="p">.</span><span class="nx">paraDic</span><span class="p">.</span><span class="nx">ignore</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="nx">showMessage</span><span class="p">(</span><span class="kr">await</span> <span class="nx">that</span><span class="p">.</span><span class="nx">checkInfo</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">paraDic</span><span class="p">),</span> <span class="nx">options</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="p">],</span>
</span></span><span class="line"><span class="cl">      <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;0010&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="kr">async</span> <span class="p">(</span><span class="nx">msg</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="kr">const</span> <span class="nx">modalResult</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">wx</span><span class="p">.</span><span class="nx">showModal</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">            <span class="nx">title</span><span class="o">:</span> <span class="s2">&#34;提示&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">content</span><span class="o">:</span> <span class="nx">msg</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="p">});</span>
</span></span><span class="line"><span class="cl">          <span class="k">if</span> <span class="p">(</span><span class="nx">modalResult</span><span class="p">.</span><span class="nx">confirm</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 跳转新页面
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">that</span><span class="p">.</span><span class="nx">innerRouter</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">isDataChange</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nx">appleDetailDic</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">]);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 除仅提示外的后端 code
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kr">const</span> <span class="nx">showToastArr</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;0000&#34;</span><span class="p">,</span> <span class="s2">&#34;0008&#34;</span><span class="p">,</span> <span class="s2">&#34;0003&#34;</span><span class="p">,</span> <span class="s2">&#34;0010&#34;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 根据请求后台得到的 code 处理不同逻辑
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kr">const</span> <span class="nx">showMessage</span> <span class="o">=</span> <span class="p">(</span><span class="nx">res</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">code</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">code</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">[...</span><span class="nx">statusCode</span><span class="p">].</span><span class="nx">map</span><span class="p">(([</span><span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">])</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">key</span> <span class="o">===</span> <span class="p">(</span><span class="o">!</span><span class="nx">showToastArr</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span> <span class="o">?</span> <span class="s2">&#34;0001&#34;</span> <span class="o">:</span> <span class="nx">code</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="o">?</span> <span class="nx">value</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">msg</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="o">:</span> <span class="s2">&#34;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{};</span>
</span></span><span class="line"><span class="cl">      <span class="nx">options</span><span class="p">.</span><span class="nx">appleDetailDic</span> <span class="o">=</span> <span class="nx">appleDetailDic</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">options</span><span class="p">.</span><span class="nx">isDataChange</span> <span class="o">=</span> <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">isDataChange</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">options</span><span class="p">.</span><span class="nx">paraDic</span> <span class="o">=</span> <span class="nx">paraDic</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">showMessage</span><span class="p">(</span><span class="kr">await</span> <span class="nx">that</span><span class="p">.</span><span class="nx">checkInfo</span><span class="p">(</span><span class="nx">paraDic</span><span class="p">),</span> <span class="nx">options</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">})();</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span></code></pre></div>]]></content:encoded>
    </item>
    
    <item>
      <title>Causal broadcast</title>
      <link>https://sheerwill.live/posts/main/20220616132407-causal_broadcast/</link>
      <pubDate>Wed, 27 Jul 2022 11:33:02 +0800</pubDate>
      
      <guid>https://sheerwill.live/posts/main/20220616132407-causal_broadcast/</guid>
      <description>Definition Causal broadcast 算法有点类似于 FIFO broadcast： 每条被广播的消息附上的不是一个序列号，而是一个整数的向量。这种算法有时被称为向量时钟算法，向量时钟</description>
      <content:encoded><![CDATA[<h2 id="definition">Definition</h2>
<p>Causal broadcast 算法有点类似于 <a href="/posts/main/20220616105609-fifo_broadcast/">FIFO broadcast</a>：</p>
<p>每条被广播的消息附上的不是一个序列号，而是一个整数的向量。这种算法有时被称为向量时钟算法，向量时钟算法中，向量元素计算每个节点发生的事件数量，而在 causal broadcast 算法中，向量元素计算来自每个发送者的已发送的消息数量。</p>
<p>如果节点 \(C\) 在 \(m_{1}\) 之前收到 \(m_{2}\)，\(C\) 的广播算法将不得不保留（延迟或缓冲）\(m_{2}\)，直到 \(m_{1}\) 被传递之后，以确保消息按因果顺序传递​。在下图的例子中，消息 \(m_{2}\) 和 \(m_{3}\) 是​<strong>同时广播</strong>​的。节点 \(A\) 和 \(C\) 按照 \(m_{1}\)、\(m_{3}\)、\(m_{2}\) 的顺序传递消息，而节点 \(B\) 按照 \(m_{1}\)、\(m_{2}\)、$m<sub>3</sub>$的顺序传递。这些传递顺序中的任何一个都是可以接受的，因为它们都与因果关系一致。</p>
<figure>
    <img loading="lazy" src="/ox-hugo/causal-broadcast.png"
         alt="Figure 1: causal-broadcast"/> <figcaption>
            <p><span class="figure-number">Figure 1: </span>causal-broadcast</p>
        </figcaption>
</figure>

<p>有因果关系的信息必须按因果顺序传递。并行的消息可以按照任何顺序传递。</p>
<p>上图：broadcast(\(m_{1}\)) \(\longrightarrow\) broadcast(\(m_{2}\)) and broadcast(\(m_{1}\)) \(\longrightarrow\) broadcast(\(m_{2}\)) and broadcast(\(m_{1}\)) broadcast(\(m_{3}\)) \(\Longrightarrow\) valid orders are: (\(m_{1}\), \(m_{2}\), \(m_{3}\)) or (\(m_{1}\), \(m_{3}\), \(m_{2}\))</p>
<h2 id="causal-broadcast-algorithm">Causal broadcast algorithm</h2>
<blockquote>
<p><strong>on</strong> initialisation <strong>do</strong> <br />
\(\qquad sendSeq := 0; delivered := \langle0, 0, . . ., 0\rangle; buﬀer := \{\}\) <br />
<strong>end on</strong></p>
<p><strong>on</strong> request to broadcast \(m\) at node \(N_{i}\) <strong>do</strong> <br />
\(\qquad deps := delivered; deps[i] := sendSeq\) <br />
\(\qquad\)​send (\(i, deps, m\)) via reliable broadcast <br />
\(\qquad sendSeq := sendSeq + 1\) <br />
<strong>end on</strong></p>
<p><strong>on</strong> receiving \(msg\) from reliable broadcast at node \(N_{i}\) <strong>do</strong> <br />
\(\qquad buﬀer := buﬀer ∪ {msg}\) <br />
\(\qquad\)​<strong>while</strong> \(∃(sender, deps, m) ∈ buﬀer. deps ≤ delivered\) <strong>do</strong> <br />
\(\qquad\qquad\)​deliver \(m\) to the application <br />
\(\qquad\qquad buﬀer := buﬀer \ {(sender, deps, m)}\)<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup> <br />
\(\qquad\qquad delivered[sender] := delivered[sender] + 1\) <br />
\(\qquad\)​<strong>end while</strong> <br />
<strong>end on</strong></p>
</blockquote>
<p>每个节点的本地状态由 \(sendSeq\)、\(delivered\) 和 \(buﬀer\) 组成，它们的含义与 <a href="/posts/main/20220616105609-fifo_broadcast/">FIFO broadcast</a> 算法中相同。当一个节点想要广播一个消息时，我们会附上发送节点的编号 \(i\) 和 \(deps\)（表示该消息因果关系的向量）。\(deps\) 就是节点本地 \(delivered\) 的复制，统计了每个节点发送消息并传递到该节点的数量。在这次广播之前，所有已经在本地交付的消息必须出现在广播消息的因果顺序之前。然后将发送节点自己的这个向量的元素更新为等于 \(sendSeq\)，这就​<strong>保证了这个节点所广播的每条消息都与同一节点所广播的前一条消息有因果关系</strong>​。</p>
<p>当收到一个消息时，算法首先将其添加到 \(buﬀer\) 中，就像 <a href="/posts/main/20220616105609-fifo_broadcast/">FIFO broadcast</a> 一样，然后在 \(buﬀer\) 中搜索任何准备好的消息。比较 \(deps ≤ delivered\)。如果这个节点已经交付了所有在因果顺序上必须在这个消息之前的消息，那么，任何在因果关系上准备好的消息都会被传递给 Application，并从 \(buﬀer\) 中移除，并且将 \(delivered\) 中的相应条目被递增。</p>
<h2 id="summary">Summary</h2>
<p>Causal broadcast 的保持因果顺序的原理和 <a href="/posts/main/20220602235916-vector_clocks/">Vector clocks</a> 很相似，向量中的每个条目，前者是消息发送者已发送消息的数量，后者是每个节点发生事件的数量。deps 取代 <a href="/posts/main/20220616105609-fifo_broadcast/">FIFO broadcast</a> 中的 sendSeq 附带在广播的信息中，这样通过在 <a href="/posts/main/20220602235916-vector_clocks/">Vector clocks</a> 中介绍的向量比较方法，可以确定消息之间的因果关系来控制消息传递的顺序。</p>
<div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p>删除 \(buﬀer\) 中的 \({(sender, deps, m)}\)&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</div>
]]></content:encoded>
    </item>
    
    <item>
      <title>Emacs</title>
      <link>https://sheerwill.live/posts/main/20220505220832-emacs/</link>
      <pubDate>Sat, 16 Jul 2022 22:44:32 +0800</pubDate>
      
      <guid>https://sheerwill.live/posts/main/20220505220832-emacs/</guid>
      <description>Introduction Emacs outshines all other editing software in approximately the same way that the noonday sun does the stars. It is not just bigger and brighter; it simply makes everything else vanish. – Neal Stephenson, In the Beginning was the Command Line (1998) Install Emacs With Homebrew First, Doom’s dependencies: brew install git ripgrep brew install coreutils fd xcode-selected --install emacs-mac. It offers good integration</description>
      <content:encoded><![CDATA[<h2 id="introduction">Introduction</h2>
<blockquote>
<p>Emacs outshines all other editing software in approximately the same way that the noonday sun does the stars. It is not just bigger and brighter; it simply makes everything else vanish.</p>
<p>– Neal Stephenson, In the Beginning was the Command Line (1998)</p>
</blockquote>
<h2 id="install-emacs-with-homebrew">Install Emacs With Homebrew</h2>
<p>First, Doom’s dependencies:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">brew install git ripgrep
</span></span><span class="line"><span class="cl">brew install coreutils fd
</span></span><span class="line"><span class="cl">xcode-selected --install
</span></span></code></pre></div><p><a href="https://bitbucket.org/mituharu/emacs-mac/src">emacs-mac</a>. It offers good integration with macOS, native emojis and better childframe support.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">brew tap d12frosted/emacs-plus
</span></span><span class="line"><span class="cl">brew install emacs-plus --with-native-comp --with-modern-vscode-icon
</span></span><span class="line"><span class="cl">ln -s /usr/local/opt/emacs-plus@29/Emacs.app /Applications
</span></span></code></pre></div><h2 id="doom-emacs">Doom Emacs</h2>
<p>With Emacs and Doom&rsquo;s dependencies installed, next is to install Doom Emacs itself:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">git clone https://github.com/hlissner/doom-emacs ~/.emacs.d
</span></span><span class="line"><span class="cl">~/.emacs.d/bin/doom install
</span></span></code></pre></div><p>如果提示 <code>.emacs.d</code> 已存在，删除重新执行上述命令即可。</p>
<p><code>.zshrc</code> 中需要添加 <code>export PATH=&quot;$HOME/.emacs.d/bin:$PATH</code> ，这样就可以直接使用 <code>doom</code> 命令了。</p>
<h3 id="doom-doctor-问题"><code>Doom Doctor</code> 问题</h3>
<ol>
<li>Warning: unable to detect fonts because fontconfig isn&rsquo;t installed</li>
</ol>
<!--listend-->
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">brew install fontconfig
</span></span></code></pre></div><ol>
<li>! Couldn&rsquo;t find shellcheck. Shell script linting will not work</li>
</ol>
<!--listend-->
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">brew install shellcheck
</span></span></code></pre></div><ol>
<li>Couldn&rsquo;t find the dot executable (from graphviz). org-roam will not be able to generate graph visualizations.</li>
</ol>
<!--listend-->
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">brew install graphviz
</span></span></code></pre></div><ol>
<li>This installed grep binary was not built with support for PCRE lookaheads. Some advanced consult filtering features will not work as a result, see the module readme.</li>
</ol>
<!--listend-->
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">#  因为 Mac 本身安装的是 BSD 的。</span>
</span></span><span class="line"><span class="cl">grep --version
</span></span><span class="line"><span class="cl"><span class="c1"># 可以看到 grep (BSD grep, GNU compatible) 2.6.0-FreeBSD ，即 BSD 版本。</span>
</span></span><span class="line"><span class="cl">brew install grep
</span></span><span class="line"><span class="cl"><span class="c1"># 安装 GNU 的 grep，并在 .zshrc 中配置 PATH=&#34;/usr/local/opt/grep/libexec/gnubin:$PATH&#34; 即可。再次查看版本可以看到如下。</span>
</span></span><span class="line"><span class="cl"><span class="c1"># grep (GNU grep) 3.7</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Packaged by Homebrew</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Copyright (C) 2021 Free Software Foundation, Inc.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># License GPLv3+: GNU GPL version 3 or later &lt;https://gnu.org/licenses/gpl.html&gt;.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># This is free software: you are free to change and redistribute it.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># There is NO WARRANTY, to the extent permitted by law.</span>
</span></span></code></pre></div><h2 id="org-roam">Org-roam</h2>
<p>具体的配置文件在 <code>.doom.d/</code> 下，参见 <a href="https://github.com/LuciusChen/dotfiles/tree/master/.doom.d">.doom.d</a>。</p>
<h2 id="shortcuts">Shortcuts</h2>
<table>
<thead>
<tr>
<th>Shortcuts</th>
<th>功能</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>C-RET</code></td>
<td>在当前 headline 所属的内容后建立一个同级 headline</td>
<td>无 headline 时创建一个一级 headline</td>
</tr>
<tr>
<td><code>M-RET</code></td>
<td>在当前 headline 后建立一个同级 headline</td>
<td>同上</td>
</tr>
<tr>
<td><code>M-right</code></td>
<td>降低当前 headline 的层级</td>
<td></td>
</tr>
<tr>
<td><code>M-left</code></td>
<td>提高当前 headline 的层级</td>
<td></td>
</tr>
<tr>
<td><code>M-up</code></td>
<td>将当前 headline 及其内容作为整体向上移动</td>
<td></td>
</tr>
<tr>
<td><code>M-down</code></td>
<td>将当前 headline 及其内容作为整体向下移动</td>
<td></td>
</tr>
<tr>
<td><code>C-return</code></td>
<td>在当前列表项的内容后建立一个同级列表项</td>
<td>光标在列表项同一行时有效</td>
</tr>
<tr>
<td><code>M-RET</code></td>
<td>在当前列表项后建立一个同级列表项</td>
<td>同上</td>
</tr>
<tr>
<td><code>M-right</code></td>
<td>降低当前列表项的层级</td>
<td>同上</td>
</tr>
<tr>
<td><code>M-left</code></td>
<td>提高当前列表项的层级</td>
<td>同上</td>
</tr>
<tr>
<td><code>M-up</code></td>
<td>将当前列表项及其内容作为整体向上移动</td>
<td>同上</td>
</tr>
<tr>
<td><code>M-down</code></td>
<td>将当前列表项及其内容作为整体向下移动</td>
<td>同上</td>
</tr>
<tr>
<td><code>C-x-o</code></td>
<td>切换窗口</td>
<td>C-x 中有很多操作，可以看提示。</td>
</tr>
<tr>
<td><code>C-c C-c</code></td>
<td>在创建 node 编写完毕后快速保存</td>
<td></td>
</tr>
<tr>
<td><code>C-g</code></td>
<td>取消操作</td>
<td></td>
</tr>
<tr>
<td><code>C-x-d</code></td>
<td>进入 dired 模式</td>
<td></td>
</tr>
<tr>
<td><code>SPC f r</code></td>
<td>查找最近文件</td>
<td></td>
</tr>
<tr>
<td><code>C-c C-x C-v</code></td>
<td>显示图片</td>
<td></td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>Shortcuts</th>
<th>功能</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>C-c C-s</code></td>
<td></td>
<td>设置任务开始时间</td>
</tr>
<tr>
<td><code>C-c C-d</code></td>
<td>设置任务截止时间</td>
<td></td>
</tr>
<tr>
<td><code>C-c C-t</code></td>
<td>改变任务状态</td>
<td></td>
</tr>
<tr>
<td><code>S-Up/Down</code></td>
<td>设置任务优先级 [#A], [#B], [#C]</td>
<td></td>
</tr>
<tr>
<td><code>C-c C-x C-i</code></td>
<td>开始任务计时</td>
<td></td>
</tr>
<tr>
<td><code>C-c C-x C-o</code></td>
<td>终止任务计时</td>
<td></td>
</tr>
<tr>
<td><code>C-c [</code></td>
<td>将当前文件加入 Org-Agenda</td>
<td></td>
</tr>
<tr>
<td><code>C-c ]</code></td>
<td>将当前文件从 Org-Agenda 移除</td>
<td></td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>Shortcuts</th>
<th>功能</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>t</code></td>
<td>在 Org-Agenda 的任务条目上， 修改任务状态。</td>
<td></td>
</tr>
<tr>
<td><code>C-c C-x C-a</code></td>
<td>归档</td>
<td></td>
</tr>
<tr>
<td><code>C-c C-w</code></td>
<td>activate refile</td>
<td></td>
</tr>
<tr>
<td><code>I</code></td>
<td>在 Org-Agenda 的任务条目上， 开始计时。</td>
<td></td>
</tr>
<tr>
<td><code>O</code></td>
<td>在 Org-Agenda 的任务条目上， 终止计时。</td>
<td></td>
</tr>
<tr>
<td><code>z</code></td>
<td>在任务上添加 note</td>
<td></td>
</tr>
<tr>
<td><code>R</code></td>
<td>clock mode, 显示耗时。</td>
<td></td>
</tr>
<tr>
<td><code>C-c C-x C-l</code></td>
<td>预览 Latex</td>
<td></td>
</tr>
<tr>
<td><code>C-c \</code></td>
<td>按 tag 搜索</td>
<td>好像只能单文件内</td>
</tr>
<tr>
<td><code>C-C C-o</code></td>
<td>打开链接</td>
<td></td>
</tr>
</tbody>
</table>
<h2 id="org-grammar">Org grammar</h2>
<h3 id="basic">basic</h3>
<p>This is almost anything you need to know about Org mode syntax:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-org" data-lang="org"><span class="line"><span class="cl"><span class="gh">*</span><span class="gs"> This Is A Heading</span>
</span></span><span class="line"><span class="cl"><span class="gu">**</span> This Is A Sub-Heading
</span></span><span class="line"><span class="cl"><span class="gu">***</span> And A Sub-Sub-Heading
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Paragraphs are separated by at least one empty line.
</span></span><span class="line"><span class="cl"><span class="gs">*bold*</span> <span class="ge">/italic/</span> <span class="gl">_underlined_</span> <span class="gd">+strikethrough+</span> <span class="nc">=monospaced=</span>
</span></span><span class="line"><span class="cl">[[<span class="na">http://Karl-Voit.at</span>][<span class="nt">Link description</span>]]
</span></span><span class="line"><span class="cl">http://Karl-Voit.at → link without description
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">- </span>list item
</span></span><span class="line"><span class="cl"><span class="k">- </span>another item
</span></span><span class="line"><span class="cl">  <span class="k">- </span>sub-item
</span></span><span class="line"><span class="cl">    <span class="k">1.</span> also enumerated
</span></span><span class="line"><span class="cl">    <span class="k">2.</span> if you like
</span></span><span class="line"><span class="cl"><span class="k">- [ ]</span> yet to be done
</span></span><span class="line"><span class="cl"><span class="k">- [X]</span> item which is done
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">: Simple pre-formatted text such as for source code.
</span></span><span class="line"><span class="cl">: This also respects the line breaks. <span class="gs">*bold*</span> is not bold here.
</span></span></code></pre></div><h3 id="code-block">code block</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">myresult</span> <span class="o">=</span> <span class="mi">42</span> <span class="o">*</span> <span class="mi">23</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Hello Europe! &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">myresult</span><span class="p">))</span>
</span></span></code></pre></div><h3 id="table">table</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-org" data-lang="org"><span class="line"><span class="cl"><span class="s">| My Column 1 | My Column 2 | Last Column |</span>
</span></span><span class="line"><span class="cl"><span class="s">|-------------+-------------+-------------|</span>
</span></span><span class="line"><span class="cl"><span class="s">|          42 | foo         | bar         |</span>
</span></span><span class="line"><span class="cl"><span class="s">|          23 | baz         | abcdefg     |</span>
</span></span><span class="line"><span class="cl"><span class="s">|-------------+-------------+-------------|</span>
</span></span><span class="line"><span class="cl"><span class="s">|          65 |             |             |</span>
</span></span></code></pre></div><h2 id="export">Export</h2>
<p>对于只需要导出某个 header 下的内容的需求，只需要在 header 上加上 <code>:export:</code> 即可。</p>
<h3 id="markdown-file">Markdown file</h3>
<p>这里用的是 <a href="https://github.com/kawabata/ox-pandoc">ox-pandoc</a>， ~M-x org-pandoc-export-as-gfm~算是我找到最符合 MarkDown 语法的转换了，Emacs 自己的转换会将 Table 转换成 HTML 标签的格式。</p>
<h3 id="hugo">Hugo</h3>
<p>在文件头部添加</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">#+HUGO_BASE_DIR: ~/Dropbox/hugo/
</span></span><span class="line"><span class="cl">#+HUGO_SECTION: posts/main
</span></span><span class="line"><span class="cl">#+HUGO_WEIGHT: auto
</span></span><span class="line"><span class="cl">#+HUGO_AUTO_SET_LASTMOD: t
</span></span></code></pre></div><p>需要导出为 <code>&lt;mark&gt;&lt;/mark&gt;</code> 时<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-org" data-lang="org"><span class="line"><span class="cl"><span class="c">#+begin_mark</span>
</span></span><span class="line"><span class="cl">marked text
</span></span><span class="line"><span class="cl"><span class="c">#+end_mark</span>
</span></span></code></pre></div><p>需要导出为块级 <code>&lt;mark&gt;&lt;/mark&gt;</code> 时，也就是前后的空格不进行 trim。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-org" data-lang="org"><span class="line"><span class="cl"><span class="cs">#+header</span><span class="c">: :trim-pre nil :trim-post nil</span>
</span></span><span class="line"><span class="cl"><span class="c">#+begin_mark</span>
</span></span><span class="line"><span class="cl">marked text
</span></span><span class="line"><span class="cl"><span class="c">#+end_mark</span>
</span></span></code></pre></div><h3 id="latex">Latex</h3>
<h4 id="dependency">Dependency</h4>
<p>需要安装 texlive</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">brew install texlive
</span></span></code></pre></div><h4 id="latex-语法">Latex 语法</h4>
<p><a href="/posts/main/20220616162256-latex/">Latex 语法</a></p>
<h4 id="pdf-导出报错">PDF 导出报错</h4>
<ul>
<li><code>Unicode character 考 (U+8003) not set up for use with LaTeX.</code> 是因为 Latex 本身不支持中文。</li>
</ul>
<h4 id="中文-pdf-导出设置">中文 PDF 导出设置</h4>
<ol>
<li>使用 <a href="https://github.com/ElegantLaTeX/ElegantPaper">ElegantPaper</a>，需要将 elegantpaper.cls 文件放在 org 目录下。</li>
<li>安装依赖</li>
</ol>
<!--listend-->
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">brew install pygments
</span></span></code></pre></div><ol>
<li>导出文件头部增加</li>
</ol>
<!--listend-->
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-org" data-lang="org"><span class="line"><span class="cl"><span class="cs">#+LATEX_COMPILER</span><span class="c">: xelatex</span>
</span></span><span class="line"><span class="cl"><span class="cs">#+LATEX_CLASS</span><span class="c">: elegantpaper</span>
</span></span><span class="line"><span class="cl"><span class="cs">#+OPTIONS</span><span class="c">: prop:t</span>
</span></span></code></pre></div><div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p><a href="https://ox-hugo.scripter.co/doc/org-special-blocks/">Org Special Blocks</a>&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</div>
]]></content:encoded>
    </item>
    
    <item>
      <title>Terminal</title>
      <link>https://sheerwill.live/posts/main/20220629204553-terminal/</link>
      <pubDate>Tue, 12 Jul 2022 16:42:41 +0800</pubDate>
      
      <guid>https://sheerwill.live/posts/main/20220629204553-terminal/</guid>
      <description>Starship brew install starship add eval &amp;quot;$(starship init zsh)&amp;quot; to .zshrc mkdir -p ~/.config &amp;amp;&amp;amp; touch ~/.config/starship.toml 默认配置 # 设置配置范例，开启编辑器的自动补全 &amp;#34;$schema&amp;#34; = &amp;#39;https://starship.rs/config-schema.json&amp;#39; # 在命令之间插入空行 add_newline = false # ~/.config/starship.toml # A minimal left prompt format = &amp;#34;&amp;#34;&amp;#34;$character&amp;#34;&amp;#34;&amp;#34; # move the rest of</description>
      <content:encoded><![CDATA[<h2 id="starship">Starship</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">brew install starship
</span></span></code></pre></div><p>add <code>eval &quot;$(starship init zsh)&quot;</code> to .zshrc</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">mkdir -p ~/.config <span class="o">&amp;&amp;</span> touch ~/.config/starship.toml
</span></span></code></pre></div><p>默认配置</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-toml" data-lang="toml"><span class="line"><span class="cl"><span class="c"># 设置配置范例，开启编辑器的自动补全</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;$schema&#34;</span> <span class="p">=</span> <span class="s1">&#39;https://starship.rs/config-schema.json&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># 在命令之间插入空行</span>
</span></span><span class="line"><span class="cl"><span class="nx">add_newline</span> <span class="p">=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl"><span class="c"># ~/.config/starship.toml</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># A minimal left prompt</span>
</span></span><span class="line"><span class="cl"><span class="nx">format</span> <span class="p">=</span> <span class="s2">&#34;&#34;&#34;$character&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c"># move the rest of the prompt to the right</span>
</span></span><span class="line"><span class="cl"><span class="nx">right_format</span> <span class="p">=</span> <span class="s2">&#34;&#34;&#34;$all&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="nx">line_break</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nx">disabled</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl"><span class="c"># 将提示符的“❯”替换为“➜”</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="nx">character</span><span class="p">]</span> <span class="c"># “character”是我们正在配置的组件</span>
</span></span><span class="line"><span class="cl"><span class="nx">success_symbol</span> <span class="p">=</span> <span class="s2">&#34;[❯](bold green)&#34;</span> <span class="c"># 设置“success_symbol” 字段为绿色加粗的“➜”</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># 禁用 package 组件，完全隐藏它的提示符</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="nx">package</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nx">disabled</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="nx">localip</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nx">ssh_only</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl"><span class="nx">format</span> <span class="p">=</span> <span class="s2">&#34;@[$localipv4](bold red) &#34;</span>
</span></span><span class="line"><span class="cl"><span class="nx">disabled</span> <span class="p">=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="nx">time</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nx">disabled</span> <span class="p">=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl"><span class="nx">time_format</span> <span class="p">=</span> <span class="s2">&#34;%R&#34;</span> <span class="c"># Hour:Minute Format</span>
</span></span><span class="line"><span class="cl"><span class="nx">style</span> <span class="p">=</span> <span class="s2">&#34;bg:none&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nx">format</span> <span class="p">=</span> <span class="s1">&#39;[[♥ $time ](bg:none)]($style)&#39;</span>
</span></span></code></pre></div><h2 id="exa">Exa</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">brew install exa
</span></span></code></pre></div><p>add to <code>.zshrc</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">alias</span> <span class="nv">ls</span><span class="o">=</span><span class="s1">&#39;exa&#39;</span>
</span></span><span class="line"><span class="cl"><span class="nb">alias</span> <span class="nv">la</span><span class="o">=</span><span class="s1">&#39;exa -a&#39;</span>
</span></span><span class="line"><span class="cl"><span class="nb">alias</span> <span class="nv">ll</span><span class="o">=</span><span class="s1">&#39;exa -lh&#39;</span>
</span></span><span class="line"><span class="cl"><span class="c1">#alias la=&#39;exa -lah&#39;</span>
</span></span><span class="line"><span class="cl"><span class="nb">alias</span> <span class="nv">lr</span><span class="o">=</span><span class="s1">&#39;exa -lR&#39;</span>
</span></span></code></pre></div><h2 id="ohmyzsh">Ohmyzsh</h2>
<h3 id="plugin">Plugin</h3>
<ul>
<li><a href="https://github.com/zsh-users/zsh-autosuggestions">zsh-autosuggestions</a></li>
</ul>
]]></content:encoded>
    </item>
    
    <item>
      <title>Vector clocks</title>
      <link>https://sheerwill.live/posts/main/20220602235916-vector_clocks/</link>
      <pubDate>Tue, 12 Jul 2022 12:03:15 +0800</pubDate>
      
      <guid>https://sheerwill.live/posts/main/20220602235916-vector_clocks/</guid>
      <description>给定的 Lamport 时间戳 \(L(a)\) 和 \(L(b)\) 并且 \(L(a) &amp;lt; L(b)\)，我们推断不出 \(a \rightarrow b\) 或者 \(a || b\).1 要区分平行的这些事件，需要 vertor clocks: 假定分布式系统中有 \(n\) 个节点，\(N = \l</description>
      <content:encoded><![CDATA[<p>给定的 Lamport 时间戳 \(L(a)\) 和 \(L(b)\) 并且 \(L(a) &lt; L(b)\)，我们推断不出 \(a \rightarrow b\) 或者 \(a || b\).<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup></p>
<p>要区分平行的这些事件，需要 <strong>vertor clocks</strong>:</p>
<ul>
<li>假定分布式系统中有 \(n\) 个节点，\(N = \langle​N_{1}, N_{2}, &hellip;, N_{n}\rangle\)</li>
<li><strong>事件 \(a\)</strong> 的向量时间戳写成 \(V(a) = \langle​t_{1}, t_{2}, &hellip;, t_{n}\rangle\)</li>
<li>\(t_{i}\) 是 \(N_{i}\) 节点发生时间的数量</li>
<li>每个​<strong>节点</strong>​都有一个当前的向量时间戳 \(T\)</li>
<li>节点 \(N_{i}\) 上的事件，向量时间戳 \(T[i]\) 递增。</li>
<li>每个消息都附带上向量时间戳</li>
<li>接收者将消息中的向量时间戳合并到本地</li>
</ul>
<p>除了标量和向量之间的区别之外，向量时钟算法与 Lamport 时钟非常相似。一个节点的向量时钟的初始值是系统中的每个节点的事件数，也就是 0。每当节点 \(N_{i}\) 发生事件时，它就会增加其向量钟中的第 \(i\) 个条目（它自己的条目）。(In practice, this vector is often implemented as a map from node IDs to integers rather than an array of integers. 在实践中，这里的向量通常是节点 ID 对应 Integer 的 map，而不是 Integer 的数组。)。当一个消息在网络上被发送时，发送者当前的向量时间戳被附加到该消息上。最后，当一个消息被接收时，接收者将消息中的向量时间戳与它的本地时间戳合并，方法是取两个向量的元素的最大值，然后接收者增加它自己的条目。</p>
<h2 id="vector-clocks-algorithm">Vector clocks algorithm</h2>
<blockquote>
<p><strong>on</strong> initialisation at node \(N_{i}\) <strong>do</strong> <br />
\(\qquad T := \langle0, 0, &hellip;, 0\rangle\) ▻ local variable at node \(N_{i}\) <br />
<strong>end on</strong></p>
<p><strong>on</strong> any event occurring at node \(N_{i}\) <strong>do</strong> <br />
\(\qquad T[i] = T[i] + 1\) <br />
<strong>end on</strong></p>
<p><strong>on</strong> request to send message \(m\) at node N<sub>i</sub> <strong>do</strong> <br />
\(\qquad T[i] := T[i] + 1\); send \((T, m)\) via network <br />
<strong>end on</strong></p>
<p><strong>on</strong> receiving \((T&rsquo;, m)\) at node \(N_{i}\) via the network <strong>do</strong> <br />
\(\qquad T[j] := max(T[j], T&rsquo;[j])\) for every \(j \in {1, &hellip;, n}\) <br />
\(\qquad T[i] := T[i] + 1\); deliver \(m\) to the application <br />
<strong>end on</strong></p>
</blockquote>
<h2 id="vector-clocks-example">Vector clocks example</h2>
<p>假定节点向量是 \(N = \langle​A, B, C\rangle\):</p>
<figure>
    <img loading="lazy" src="/ox-hugo/vector-example.png"
         alt="Figure 1: vector-example"/> <figcaption>
            <p><span class="figure-number">Figure 1: </span>vector-example</p>
        </figcaption>
</figure>

<p>事件 \(e\) 的向量时间戳是一系列事件的集合， \(e\) 和它的因果以来：\({e} \cup {a | a \rightarrow e}\)<sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup><sup>, </sup><sup id="fnref:3"><a href="#fn:3" class="footnote-ref" role="doc-noteref">3</a></sup></p>
<p>比如，\(\langle2, 2, 0\rangle\)，第一个 2 是表示来自于 \(A\) 的两个事件，第二个 2 是表示来自于 \(B\) 的两个事件，并且没有来自于 \(C\) 的事件。</p>
<h2 id="vector-clocks-ordering">Vector clocks ordering</h2>
<p>Define the following order on vector timestamps(in a system with \(n\) nodes):</p>
<ul>
<li>\(T = T&rsquo;\) iff \(T[i] = T&rsquo;[i]\) for all \(i \in {1, &hellip;, n}\)<sup id="fnref:4"><a href="#fn:4" class="footnote-ref" role="doc-noteref">4</a></sup></li>
<li>\(T \le T&rsquo;\) iff \(T[i] \le T&rsquo;[i]\) for all $ ∈ {1, &hellip;, n}$</li>
<li>\(T &lt; T&rsquo;\) iff \(T \le T&rsquo;\) and \(T \neq T&rsquo;\)</li>
<li>\(T || T&rsquo;\) iff \(T &gt; T&rsquo;\) and \(T&rsquo; &gt; T\)</li>
</ul>
<p>\(V(a) \le V(b)\) iff \(({a} \cup {e | e \rightarrow a}) ⊆ ({b} \cup{} {e | e \rightarrow b})\)</p>
<p>Properties of this order:</p>
<ul>
<li>\((V(a) &lt; V(b)) \iff (a \rightarrow b)\)</li>
<li>\((V(a) = V(b)) \iff (a = b)\)</li>
<li>\((V(a) \rVert V(b)) \iff (a \rVert b)\)</li>
</ul>
<p>然后，我们对向量的时间戳进行部分排序。如果第一个向量的每个元素都小于或等于第二个向量的相应元素，我们就说一个向量小于或等于另一个向量。如果一个向量小于或等于另一个向量，并且它们至少有一个元素是不同的，那么这个向量就严格小于另一个向量。然而，如果一个向量在一个元素中的值较大，而另一个向量在另一个元素中的值较大，那么这两个向量是不可比的。例如，\(T = \langle2, 2, 0\rangle\) 和 \(T&rsquo; = \langle0, 0, 1\rangle\) 是不可比的，因为 \(T[1] &gt; T&rsquo;[1]\) 但 \(T[3] &lt; T&rsquo;[3]\)。</p>
<p>向量时间戳的部分顺序与发生之前关系所定义的部分顺序完全对应。因此，向量时钟算法为我们提供了一种在实践中计算发生前关系的机制。</p>
<div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p>具体参考 <a href="/posts/main/20220609201658-lamport_clocks/">Lamport Clocks</a> 中的逻辑双条件。&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2">
<p>\(\cup\) 并集的意思，\(\cap\) 交集的意思。&#160;<a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:3">
<p>集合的描述方法，描述格式为 \({x | P(x)，x ∈ Ω}\)。&#160;<a href="#fnref:3" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:4">
<p>if and only if，相当于 \(\iff\)，其 Latex 写作 <code>\iff</code>​。&#160;<a href="#fnref:4" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</div>
]]></content:encoded>
    </item>
    
    <item>
      <title>iTerm2</title>
      <link>https://sheerwill.live/posts/main/20220629204553-iterm2/</link>
      <pubDate>Sat, 09 Jul 2022 22:08:10 +0800</pubDate>
      
      <guid>https://sheerwill.live/posts/main/20220629204553-iterm2/</guid>
      <description>Starship brew install starship add eval &amp;quot;$(starship init zsh)&amp;quot; to .zshrc mkdir -p ~/.config &amp;amp;&amp;amp; touch ~/.config/starship.toml 默认配置 # 设置配置范例，开启编辑器的自动补全 &amp;#34;$schema&amp;#34; = &amp;#39;https://starship.rs/config-schema.json&amp;#39; # 在命令之间插入空行 add_newline = false # ~/.config/starship.toml # A minimal left prompt format = &amp;#34;&amp;#34;&amp;#34;$character&amp;#34;&amp;#34;&amp;#34; # move the rest of</description>
      <content:encoded><![CDATA[<h2 id="starship">Starship</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">brew install starship
</span></span></code></pre></div><p>add <code>eval &quot;$(starship init zsh)&quot;</code> to .zshrc</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">mkdir -p ~/.config <span class="o">&amp;&amp;</span> touch ~/.config/starship.toml
</span></span></code></pre></div><p>默认配置</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-toml" data-lang="toml"><span class="line"><span class="cl"><span class="c"># 设置配置范例，开启编辑器的自动补全</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;$schema&#34;</span> <span class="p">=</span> <span class="s1">&#39;https://starship.rs/config-schema.json&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># 在命令之间插入空行</span>
</span></span><span class="line"><span class="cl"><span class="nx">add_newline</span> <span class="p">=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl"><span class="c"># ~/.config/starship.toml</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># A minimal left prompt</span>
</span></span><span class="line"><span class="cl"><span class="nx">format</span> <span class="p">=</span> <span class="s2">&#34;&#34;&#34;$character&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c"># move the rest of the prompt to the right</span>
</span></span><span class="line"><span class="cl"><span class="nx">right_format</span> <span class="p">=</span> <span class="s2">&#34;&#34;&#34;$all&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="nx">line_break</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nx">disabled</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl"><span class="c"># 将提示符的“❯”替换为“➜”</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="nx">character</span><span class="p">]</span> <span class="c"># “character”是我们正在配置的组件</span>
</span></span><span class="line"><span class="cl"><span class="nx">success_symbol</span> <span class="p">=</span> <span class="s2">&#34;[❯](bold green)&#34;</span> <span class="c"># 设置“success_symbol” 字段为绿色加粗的“➜”</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># 禁用 package 组件，完全隐藏它的提示符</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="nx">package</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nx">disabled</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="nx">localip</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nx">ssh_only</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl"><span class="nx">format</span> <span class="p">=</span> <span class="s2">&#34;@[$localipv4](bold red) &#34;</span>
</span></span><span class="line"><span class="cl"><span class="nx">disabled</span> <span class="p">=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="nx">time</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nx">disabled</span> <span class="p">=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl"><span class="nx">time_format</span> <span class="p">=</span> <span class="s2">&#34;%R&#34;</span> <span class="c"># Hour:Minute Format</span>
</span></span><span class="line"><span class="cl"><span class="nx">style</span> <span class="p">=</span> <span class="s2">&#34;bg:none&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nx">format</span> <span class="p">=</span> <span class="s1">&#39;[[♥ $time ](bg:none)]($style)&#39;</span>
</span></span></code></pre></div><h2 id="exa">Exa</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">brew install exa
</span></span></code></pre></div><p>add to <code>.zshrc</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="nb">alias</span> <span class="nv">ls</span><span class="o">=</span><span class="s1">&#39;exa&#39;</span>
</span></span><span class="line"><span class="cl"><span class="nb">alias</span> <span class="nv">la</span><span class="o">=</span><span class="s1">&#39;exa -a&#39;</span>
</span></span><span class="line"><span class="cl"><span class="nb">alias</span> <span class="nv">ll</span><span class="o">=</span><span class="s1">&#39;exa -lh&#39;</span>
</span></span><span class="line"><span class="cl"><span class="c1">#alias la=&#39;exa -lah&#39;</span>
</span></span><span class="line"><span class="cl"><span class="nb">alias</span> <span class="nv">lr</span><span class="o">=</span><span class="s1">&#39;exa -lR&#39;</span>
</span></span></code></pre></div><h2 id="ohmyzsh">Ohmyzsh</h2>
<h3 id="plugin">Plugin</h3>
<ul>
<li><a href="https://github.com/zsh-users/zsh-autosuggestions">zsh-autosuggestions</a></li>
</ul>
]]></content:encoded>
    </item>
    
    <item>
      <title>Anki</title>
      <link>https://sheerwill.live/posts/main/20220706112803-anki/</link>
      <pubDate>Wed, 06 Jul 2022 11:58:16 +0800</pubDate>
      
      <guid>https://sheerwill.live/posts/main/20220706112803-anki/</guid>
      <description>Online Dictionary Helper Figure 1: online-dictionary-helper-result Chrome extension 在线词典助手 Settings Figure 2: online-dictionary-helper-setting Anki Template 模板的样式是根据卡片内容来设置的，其中 glossary 中本身就带了样式。 front &amp;lt;div class=&amp;#34;section&amp;#34;&amp;gt; &amp;lt;div id=&amp;#34;front&amp;#34; class=&amp;#34;items&amp;#34;&amp;gt; {{expression}}&amp;lt;span class=&amp;#34;audio&amp;#34;&amp;gt;{{audio}}&amp;lt;/span&amp;gt; &amp;lt;/div&amp;gt; {{#reading}} &amp;lt;hr /&amp;gt; &amp;lt;div id=&amp;#34;front-extra1&amp;#34; class=&amp;#34;items&amp;#34;&amp;gt; &amp;lt;span&amp;gt;{{reading}}&amp;amp;nbsp;&amp;lt;/span&amp;gt; &amp;lt;span&amp;gt;{{extrainfo}}&amp;lt;/span&amp;gt; &amp;lt;/div&amp;gt; {{/reading}} &amp;lt;/div&amp;gt; back</description>
      <content:encoded><![CDATA[<h2 id="online-dictionary-helper">Online Dictionary Helper</h2>
<figure>
    <img loading="lazy" src="/ox-hugo/online-dictionary-helper-result.png"
         alt="Figure 1: online-dictionary-helper-result"/> <figcaption>
            <p><span class="figure-number">Figure 1: </span>online-dictionary-helper-result</p>
        </figcaption>
</figure>

<h3 id="chrome-extension">Chrome extension</h3>
<p><a href="https://chrome.google.com/webstore/detail/online-dictionary-helper/lppjdajkacanlmpbbcdkccjkdbpllajb">在线词典助手</a></p>
<h3 id="settings">Settings</h3>
<figure>
    <img loading="lazy" src="/ox-hugo/online-dictionary-helper-setting.png"
         alt="Figure 2: online-dictionary-helper-setting"/> <figcaption>
            <p><span class="figure-number">Figure 2: </span>online-dictionary-helper-setting</p>
        </figcaption>
</figure>

<h3 id="anki-template">Anki Template</h3>
<p>模板的样式是根据卡片内容来设置的，其中 <code>glossary</code> 中本身就带了样式。</p>
<h4 id="front">front</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;section&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&#34;front&#34;</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;items&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    {{expression}}<span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;audio&#34;</span><span class="p">&gt;</span>{{audio}}<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  {{#reading}}
</span></span><span class="line"><span class="cl">  <span class="p">&lt;</span><span class="nt">hr</span> <span class="p">/&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&#34;front-extra1&#34;</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;items&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">span</span><span class="p">&gt;</span>{{reading}}<span class="ni">&amp;nbsp;</span><span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">span</span><span class="p">&gt;</span>{{extrainfo}}<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  {{/reading}}
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span></code></pre></div><h4 id="back">back</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl">{{FrontSide}}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;section&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&#34;back&#34;</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;items&#34;</span><span class="p">&gt;</span>{{glossary}}<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  {{#sentence}}
</span></span><span class="line"><span class="cl">  <span class="p">&lt;</span><span class="nt">hr</span> <span class="p">/&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&#34;back-extra1&#34;</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;items&#34;</span><span class="p">&gt;</span>{{sentence}}<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  {{/sentence}} {{#url}}
</span></span><span class="line"><span class="cl">  <span class="p">&lt;</span><span class="nt">hr</span> <span class="p">/&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&#34;back-extra2&#34;</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;items&#34;</span><span class="p">&gt;&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&#34;{{url}}&#34;</span><span class="p">&gt;</span>Source<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  {{/url}}
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span></code></pre></div><h4 id="style">style</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-css" data-lang="css"><span class="line"><span class="cl"><span class="c">/*
</span></span></span><span class="line"><span class="cl"><span class="c">ODH Template
</span></span></span><span class="line"><span class="cl"><span class="c">author:ninja huang
</span></span></span><span class="line"><span class="cl"><span class="c">site:https://github.com/ninja33/odh
</span></span></span><span class="line"><span class="cl"><span class="c">*/</span>
</span></span><span class="line"><span class="cl"><span class="p">.</span><span class="nc">star</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">color</span><span class="p">:</span> <span class="mh">#ffbb00</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">.</span><span class="nc">card</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">margin</span><span class="p">:</span> <span class="mi">12</span><span class="kt">px</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">text-align</span><span class="p">:</span> <span class="kc">left</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">background-color</span><span class="p">:</span> <span class="mh">#fff</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">.</span><span class="nc">section</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">color</span><span class="p">:</span> <span class="mh">#414141</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">background-color</span><span class="p">:</span> <span class="mh">#fafafa</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">font-family</span><span class="p">:</span> <span class="s2">&#34;Segoe UI&#34;</span><span class="p">,</span> <span class="n">Arial</span><span class="p">,</span> <span class="s2">&#34;Microsoft Yahei&#34;</span><span class="p">,</span> <span class="kc">sans-serif</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">font-size</span><span class="p">:</span> <span class="mi">16</span><span class="kt">px</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">box-shadow</span><span class="p">:</span> <span class="mi">1</span><span class="kt">px</span> <span class="mi">1</span><span class="kt">px</span> <span class="mi">5</span><span class="kt">px</span> <span class="mi">0</span><span class="kt">px</span> <span class="nb">rgba</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="mi">0</span> <span class="mi">0</span><span class="kt">px</span> <span class="mi">0</span><span class="kt">px</span> <span class="mi">1</span><span class="kt">px</span> <span class="nb">rgba</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">border-radius</span><span class="p">:</span> <span class="mi">4</span><span class="kt">px</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">margin</span><span class="p">:</span> <span class="mi">12</span><span class="kt">px</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">.</span><span class="nc">items</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">margin</span><span class="p">:</span> <span class="mi">0</span> <span class="mi">12</span><span class="kt">px</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">padding</span><span class="p">:</span> <span class="mi">10</span><span class="kt">px</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">.</span><span class="nc">audio</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">margin-left</span><span class="p">:</span> <span class="mi">5</span><span class="kt">px</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">.</span><span class="nc">audio</span> <span class="nt">img</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">width</span><span class="p">:</span> <span class="mi">64</span><span class="kt">px</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">height</span><span class="p">:</span> <span class="mi">64</span><span class="kt">px</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">vertical-align</span><span class="p">:</span> <span class="kc">middle</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nt">hr</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">border</span><span class="p">:</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">margin</span><span class="p">:</span> <span class="mi">0</span> <span class="mi">12</span><span class="kt">px</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">border-top</span><span class="p">:</span> <span class="mi">1</span><span class="kt">px</span> <span class="kc">solid</span> <span class="mh">#e5e5e5</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">.</span><span class="nc">items</span> <span class="nt">hr</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">border</span><span class="p">:</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">margin</span><span class="p">:</span> <span class="mi">12</span><span class="kt">px</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">border-top</span><span class="p">:</span> <span class="mi">1</span><span class="kt">px</span> <span class="kc">solid</span> <span class="mh">#e5e5e5</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">#</span><span class="nn">front</span><span class="o">,</span>
</span></span><span class="line"><span class="cl"><span class="p">#</span><span class="nn">back</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">line-height</span><span class="p">:</span> <span class="mf">1.5</span><span class="kt">em</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">#</span><span class="nn">front</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">font-size</span><span class="p">:</span> <span class="mi">2</span><span class="kt">em</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">font-weight</span><span class="p">:</span> <span class="kc">bold</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">text-align</span><span class="p">:</span> <span class="kc">left</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">#</span><span class="nn">back</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">#</span><span class="nn">front-extra1</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">font-size</span><span class="p">:</span> <span class="mf">0.8</span><span class="kt">em</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">#</span><span class="nn">front-extra2</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">#</span><span class="nn">back-extra1</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">#</span><span class="nn">back-extra1</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div>]]></content:encoded>
    </item>
    
    <item>
      <title>Stub</title>
      <link>https://sheerwill.live/posts/main/20220604180341-stub/</link>
      <pubDate>Thu, 30 Jun 2022 14:18:17 +0800</pubDate>
      
      <guid>https://sheerwill.live/posts/main/20220604180341-stub/</guid>
      <description>在开发过程中，stub 很多时候就是针对不可控制的部分进行模拟，例如 Mock。 在分布式中，stub 就是用于转换远程过程调用（RPC）期间客户端</description>
      <content:encoded><![CDATA[<ol>
<li>在开发过程中，stub 很多时候就是针对不可控制的部分进行模拟，例如 Mock。</li>
<li>在分布式中，stub 就是用于转换远程过程调用（RPC）期间客户端和服务端之间传递参数的一段代码。</li>
</ol>
]]></content:encoded>
    </item>
    
    <item>
      <title>VSCode</title>
      <link>https://sheerwill.live/posts/main/20220629203733-vscode/</link>
      <pubDate>Wed, 29 Jun 2022 22:51:37 +0800</pubDate>
      
      <guid>https://sheerwill.live/posts/main/20220629203733-vscode/</guid>
      <description>Extensions ESLint Markdown All in One Markdown Preview Github MoonScript Language One Dark Pro Prettier - Code formatter Settings { &amp;#34;editor.fontFamily&amp;#34;: &amp;#34;&amp;#39;Iosevka&amp;#39;, LXGW WenKai Mono, Menlo, Monaco, &amp;#39;Courier New&amp;#39;, monospace&amp;#34;, &amp;#34;editor.fontLigatures&amp;#34;: true, &amp;#34;editor.fontSize&amp;#34;: 14, &amp;#34;security.workspace.trust.untrustedFiles&amp;#34;: &amp;#34;open&amp;#34;, &amp;#34;editor.bracketPairColorization.enabled&amp;#34;: true, &amp;#34;editor.renderWhitespace&amp;#34;: &amp;#34;boundary&amp;#34;, &amp;#34;workbench.colorCustomizations&amp;#34;: { &amp;#34;editorBracketHighlight.foreground1&amp;#34;: &amp;#34;#EFBB24&amp;#34;, &amp;#34;editorBracketHighlight.foreground2&amp;#34;: &amp;#34;#F8C3CD&amp;#34;, &amp;#34;editorBracketHighlight.foreground3&amp;#34;: &amp;#34;#A5DEE4&amp;#34;, &amp;#34;editorBracketHighlight.foreground4&amp;#34;: &amp;#34;#8A6BBE&amp;#34;, &amp;#34;editorBracketHighlight.foreground5&amp;#34;: &amp;#34;#90B44B&amp;#34;, &amp;#34;editorBracketHighlight.foreground6&amp;#34;: &amp;#34;#FFB11B&amp;#34;, &amp;#34;editorBracketHighlight.unexpectedBracket.foreground&amp;#34;: &amp;#34;#E83015&amp;#34;, &amp;#34;tab.activeBackground&amp;#34;: &amp;#34;#724832&amp;#34;, &amp;#34;scrollbarSlider.background&amp;#34;: &amp;#34;#91AD70&amp;#34;, &amp;#34;scrollbarSlider.hoverBackground&amp;#34;: &amp;#34;#91AD70&amp;#34;, &amp;#34;scrollbarSlider.activeBackground&amp;#34;: &amp;#34;#91AD70&amp;#34; }, &amp;#34;[javascript]&amp;#34;: { &amp;#34;editor.defaultFormatter&amp;#34;: &amp;#34;esbenp.prettier-vscode&amp;#34; }, &amp;#34;[html]&amp;#34;: { &amp;#34;editor.</description>
      <content:encoded><![CDATA[<h2 id="extensions">Extensions</h2>
<ul>
<li>ESLint</li>
<li>Markdown All in One</li>
<li>Markdown Preview Github</li>
<li>MoonScript Language</li>
<li>One Dark Pro</li>
<li>Prettier - Code formatter</li>
</ul>
<h2 id="settings">Settings</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;editor.fontFamily&#34;</span><span class="p">:</span> <span class="s2">&#34;&#39;Iosevka&#39;, LXGW WenKai Mono, Menlo, Monaco, &#39;Courier New&#39;, monospace&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;editor.fontLigatures&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;editor.fontSize&#34;</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;security.workspace.trust.untrustedFiles&#34;</span><span class="p">:</span> <span class="s2">&#34;open&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;editor.bracketPairColorization.enabled&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;editor.renderWhitespace&#34;</span><span class="p">:</span> <span class="s2">&#34;boundary&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;workbench.colorCustomizations&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;editorBracketHighlight.foreground1&#34;</span><span class="p">:</span> <span class="s2">&#34;#EFBB24&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;editorBracketHighlight.foreground2&#34;</span><span class="p">:</span> <span class="s2">&#34;#F8C3CD&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;editorBracketHighlight.foreground3&#34;</span><span class="p">:</span> <span class="s2">&#34;#A5DEE4&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;editorBracketHighlight.foreground4&#34;</span><span class="p">:</span> <span class="s2">&#34;#8A6BBE&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;editorBracketHighlight.foreground5&#34;</span><span class="p">:</span> <span class="s2">&#34;#90B44B&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;editorBracketHighlight.foreground6&#34;</span><span class="p">:</span> <span class="s2">&#34;#FFB11B&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;editorBracketHighlight.unexpectedBracket.foreground&#34;</span><span class="p">:</span> <span class="s2">&#34;#E83015&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;tab.activeBackground&#34;</span><span class="p">:</span> <span class="s2">&#34;#724832&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;scrollbarSlider.background&#34;</span><span class="p">:</span> <span class="s2">&#34;#91AD70&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;scrollbarSlider.hoverBackground&#34;</span><span class="p">:</span> <span class="s2">&#34;#91AD70&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;scrollbarSlider.activeBackground&#34;</span><span class="p">:</span> <span class="s2">&#34;#91AD70&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;[javascript]&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;editor.defaultFormatter&#34;</span><span class="p">:</span> <span class="s2">&#34;esbenp.prettier-vscode&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;[html]&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;editor.defaultFormatter&#34;</span><span class="p">:</span> <span class="s2">&#34;esbenp.prettier-vscode&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;[markdown]&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;editor.defaultFormatter&#34;</span><span class="p">:</span> <span class="s2">&#34;esbenp.prettier-vscode&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;editor.inlineSuggest.enabled&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;workbench.colorTheme&#34;</span><span class="p">:</span> <span class="s2">&#34;One Dark Pro Darker&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;[json]&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;editor.defaultFormatter&#34;</span><span class="p">:</span> <span class="s2">&#34;esbenp.prettier-vscode&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;[css]&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;editor.defaultFormatter&#34;</span><span class="p">:</span> <span class="s2">&#34;esbenp.prettier-vscode&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div>]]></content:encoded>
    </item>
    
    <item>
      <title>Hugo</title>
      <link>https://sheerwill.live/posts/main/20220607104757-hugo/</link>
      <pubDate>Wed, 29 Jun 2022 19:10:14 +0800</pubDate>
      
      <guid>https://sheerwill.live/posts/main/20220607104757-hugo/</guid>
      <description>Install brew install hugo Add backlink 在 themes/xxx/layouts/partials/ 下新增 ~backlink.html~，内容如下。 {{ $re := $.File.BaseFileName }} {{ $backlinks := slice }} {{ range .Site.AllPages }} {{ if and (findRE $re .RawContent) (not (eq $re .File.BaseFileName)) }} {{ $backlinks = $backlinks | append . }} {{ end }} {{ end</description>
      <content:encoded><![CDATA[<h2 id="install">Install</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">brew install hugo
</span></span></code></pre></div><h2 id="add-backlink">Add backlink</h2>
<p>在 <code>themes/xxx/layouts/partials/</code> 下新增 ~backlink.html~，内容如下。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl">{{ $re := $.File.BaseFileName }}
</span></span><span class="line"><span class="cl">{{ $backlinks := slice }}
</span></span><span class="line"><span class="cl">{{ range .Site.AllPages }}
</span></span><span class="line"><span class="cl">   {{ if and (findRE $re .RawContent) (not (eq $re .File.BaseFileName)) }}
</span></span><span class="line"><span class="cl">	  {{ $backlinks = $backlinks | append . }}
</span></span><span class="line"><span class="cl">   {{ end }}
</span></span><span class="line"><span class="cl">{{ end }}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">{{ if gt (len $backlinks) 0 }}
</span></span><span class="line"><span class="cl">  <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;bl-section&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">	<span class="p">&lt;</span><span class="nt">h4</span><span class="p">&gt;</span>Links to this note<span class="p">&lt;/</span><span class="nt">h4</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">	<span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;backlinks&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">	  <span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">	   {{ range $backlinks }}
</span></span><span class="line"><span class="cl">		  <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&#34;{{ .RelPermalink }}&#34;</span><span class="p">&gt;</span>{{ .Title }}<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">	   {{ end }}
</span></span><span class="line"><span class="cl">	 <span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">	<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">{{ else  }}
</span></span><span class="line"><span class="cl">  <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;bl-section&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">	<span class="p">&lt;</span><span class="nt">h4</span><span class="p">&gt;</span>No notes link to this note<span class="p">&lt;/</span><span class="nt">h4</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">{{ end }}
</span></span></code></pre></div><p>在 <code>themes/xxx/layouts/_default/single.html</code> 中增加下面代码，放到合适的地方。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl">{{ partial &#34;backlinks.html&#34; . }}
</span></span></code></pre></div><p>放在文章下方的话可以插入如下位置</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;post-content&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    {{- if not (.Param &#34;disableAnchoredHeadings&#34;) }}
</span></span><span class="line"><span class="cl">    {{- partial &#34;anchored_headings.html&#34; .Content -}}
</span></span><span class="line"><span class="cl">    {{- else }}{{ .Content }}{{ end }}
</span></span><span class="line"><span class="cl">    {{ partial &#34;backlinks.html&#34; . }}
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span></code></pre></div><h2 id="mathjax-support">MathJax support</h2>
<h3 id="方案1">方案1</h3>
<p>在 <code>themes/xxx/layouts/_default/single.html</code> 中 <code>header</code> 中增加下面代码。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;text/javascript&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="na">src</span><span class="o">=</span><span class="s">&#34;https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</span></span></code></pre></div><h3 id="方案2">方案2</h3>
<p>增加 <code>themes/xxx/layouts/partials/mathjax.html</code> 文件，并在其中增加下面代码，实现即便是页面间的跳转，也可以实时渲染公式。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">MathJax</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">tex</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">inlineMath</span><span class="o">:</span> <span class="p">[[</span><span class="s1">&#39;$&#39;</span><span class="p">,</span> <span class="s1">&#39;$&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;\\(&#39;</span><span class="p">,</span> <span class="s1">&#39;\\)&#39;</span><span class="p">]],</span>
</span></span><span class="line"><span class="cl">      <span class="nx">displayMath</span><span class="o">:</span> <span class="p">[[</span><span class="s1">&#39;$$&#39;</span><span class="p">,</span><span class="s1">&#39;$$&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;\\[&#39;</span><span class="p">,</span> <span class="s1">&#39;\\]&#39;</span><span class="p">]],</span>
</span></span><span class="line"><span class="cl">      <span class="nx">processEscapes</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">processEnvironments</span><span class="o">:</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nx">options</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">skipHtmlTags</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;script&#39;</span><span class="p">,</span> <span class="s1">&#39;noscript&#39;</span><span class="p">,</span> <span class="s1">&#39;style&#39;</span><span class="p">,</span> <span class="s1">&#39;textarea&#39;</span><span class="p">,</span> <span class="s1">&#39;pre&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;load&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nb">document</span><span class="p">.</span><span class="nx">querySelectorAll</span><span class="p">(</span><span class="s2">&#34;mjx-container&#34;</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nx">x</span><span class="p">.</span><span class="nx">parentElement</span><span class="p">.</span><span class="nx">classList</span> <span class="o">+=</span> <span class="s1">&#39;has-jax&#39;</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&#34;https://polyfill.io/v3/polyfill.min.js?features=es6&#34;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;text/javascript&#34;</span> <span class="na">id</span><span class="o">=</span><span class="s">&#34;MathJax-script&#34;</span> <span class="na">async</span>
</span></span><span class="line"><span class="cl">  <span class="na">src</span><span class="o">=</span><span class="s">&#34;https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML&#34;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">style</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">code</span><span class="p">.</span><span class="nc">has-jax</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">font</span><span class="p">:</span> <span class="kc">inherit</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">font-size</span><span class="p">:</span> <span class="mi">100</span><span class="kt">%</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">background</span><span class="p">:</span> <span class="kc">inherit</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">border</span><span class="p">:</span> <span class="kc">inherit</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">color</span><span class="p">:</span> <span class="mh">#515151</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">style</span><span class="p">&gt;</span>
</span></span></code></pre></div><p>在 <code>themes/xxx/layouts/_default/header.html</code> 中增加下面代码，放到合适的地方。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl">{{ partial &#34;mathjax.html&#34; . }}
</span></span></code></pre></div><p>如果不想所有页面都加载 MathJax，就添加下面代码。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl">{{ if .Params.mathjax }}{{ partial &#34;mathjax.html&#34; . }}{{ end }}
</span></span></code></pre></div><p>并通过 <a href="https://ox-hugo.scripter.co/doc/custom-front-matter/">Custom Front-matter Parameters</a> 设置 <code>mathjax: true~。具体是添加下面代码到需要导出并用 MathJax 展示的 org 文件头部，导出后就是 ~.md</code> 文件中的 metadata。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-org" data-lang="org"><span class="line"><span class="cl"><span class="cs">#+HUGO_CUSTOM_FRONT_MATTER</span><span class="c">: :mathjax true</span>
</span></span></code></pre></div>]]></content:encoded>
    </item>
    
    <item>
      <title>How I Take Notes</title>
      <link>https://sheerwill.live/posts/article/20220505162419-how_i_take_notes/</link>
      <pubDate>Wed, 29 Jun 2022 16:42:16 +0800</pubDate>
      
      <guid>https://sheerwill.live/posts/article/20220505162419-how_i_take_notes/</guid>
      <description>Introduction 最先接触到 Zettlekasten (German: &amp;ldquo;slip box&amp;rdquo;, plural zettlekästen) 是从 @Tisoga 的推文中得知，如获至宝。在这之前用过 MWeb（内测用户）、iA Writer、Bear、</description>
      <content:encoded><![CDATA[<h2 id="introduction">Introduction</h2>
<p>最先接触到 <a href="https://en.wikipedia.org/wiki/Zettelkasten">Zettlekasten</a> (German: &ldquo;slip box&rdquo;, plural zettlekästen) 是从 @Tisoga 的推文中得知，如获至宝。在这之前用过 MWeb（内测用户）、iA Writer、Bear、Notion、Obsidian（当时还不知道 Backlinks），都觉得不太合适，尤其是第一步文件夹的分类就让我头疼，很多内容是互相交叉的，并不是简单的可以归在一个分类下面，若是细分的分类过多，又会过于混乱，最后的结果就是“垃圾场”。</p>
<ul>
<li>根据 Zettlekasten 衍生出来的各种 APP 中的 Backlinks 将笔记串联起来，作为一个草稿箱，定期去整理回顾形成自己的知识。</li>
</ul>
<p>另外一个极为吸引我的就是 Daily Notes 或者 Journals，非常适合我当前的工作场景。「生产问题」或者「零碎的需求」会不断从打断我的工作，有时候会非常紧急需要优先处理「需求」或者「生产问题」，解决后会有两种情况。</p>
<ul>
<li>
<p>问题或需求解决后，要花一些时间梳理之前在做的事情才能够重新接续之前的思路继续工作。</p>
</li>
<li>
<p>问题解决后几个月遇到相同或类似的问题，虽然记得解决过，但是当时解决的思路以及细节需要注意的地方就模糊不清了。通常为了万无一失需要重复上次的工作，仔细查看过代码结合业务后，才能作出正确的判断，确保干净利落地解决问题。</p>
</li>
</ul>
<p>上面两种情况完全可以用 Journals 记录解决问题前的工作思路，记录解决问题后的思路，来避免上述两种情况发生。</p>
<figure>
    <img loading="lazy" src="/ox-hugo/take-notes-sankey.png"
         alt="Figure 1: take-notes-sankey"/> <figcaption>
            <p><span class="figure-number">Figure 1: </span>take-notes-sankey</p>
        </figcaption>
</figure>

<p>信息大爆炸的副作用就是信噪比降低，通过分阶段的信息处理，不断地归纳、处理形成自己的想法，并将其固化下来，作为知识库。</p>
<h2 id="流程设计">流程设计</h2>
<ol>
<li>
<p>图中的流程其实就是多层的过滤器。</p>
<p>从最初的信息源处到 Logseq 的过程，只需要考虑这个信息源是否值得读，是否值得扩展，答案确定则大胆地记入 Logseq。其中零散的思绪及文章阅读记录在 Journals 中，书籍这类大部头则在 page 中记录，前者因为零散在 Journals 中，需要加 page 的双链或 Tag。</p>
<p>Logseq 中 Journals 中的事件重要的会被我移到 Org-roam 中的 Journals.org 文件中，这个文件类似于日记的作用，并不是每天都会记录，记录多了之后按照年份进行分割。</p>
<p>从 Logseq 到 Org-roam 则是知识固化的过程，需要考虑该知识是否以后会被自己再次用到，是否值得扩展，答案确定则精炼后记入，并标明灵感来源，引用材料。因此，Logseq 中记录的都只能算是草稿，需要再次的整合，提高信噪比。</p>
</li>
<li>
<p>对信息源处理时，可以用 Excalidraw 进行流程图、思维图等图的草稿绘制。后续有时间的时候再用 Figma 重新绘制，视觉和逻辑上的重新设计，使得阐述的内容更加直观。</p>
<p>对于产品来说，通过<a href="/posts/main/20220503145636-build_diagram/">设计降低理解门槛和使用门槛</a>，是一件挺重要的事情。输出文章同样如此。</p>
</li>
<li>
<p>Org-roam 中也有收集想法的地方，Inbox.org，定期会进行清理。 notes 中 outline 结构是由 <code>*</code> 实现的，导出时是标题格式，为了随时可以导出发布，要注意 outline 结构。输出是通过 Org-export-dispatch 来转为 .md 或 .html 文件，为了更符合使用的格式，在 <a href="/posts/main/20220505220832-emacs/">Emacs</a> 中做了一些设置。</p>
</li>
<li>
<p>Org-roam-ui 非常优秀，不管是 UI 还是操作性，可以明晰的查看笔记之间的关联，知识是否形成闭环，哪些知识还需要进行拓展阅读。</p>
</li>
</ol>
<h2 id="准则">准则</h2>
<ul>
<li>
<p>卡片应该具有原子性。这点和编程的原则很像，一个方法只做一件事，在这里也就是只记录一个主题的内容。</p>
</li>
<li>
<p>卡片内容应该具有独立性。这点和上面并不冲突，设想一下，为了保持每个卡片的纯净，X 和 Y 之间的关系，你可能会用 Z 去链接他们。但回顾的时候，没有 Z，单纯回顾 X 或 Y 无法得知两者之间的关联。所以这里不管在 X 或者 Y 中去描述与对方的关系都是可以的，一点点内容的冗余可以使得内容更加独立。</p>
</li>
<li>
<p>遵守奥卡姆剃刀原则。对新工具充分调研，是否满足自己的需求后再考虑替换或增加到现有工作流当中。</p>
</li>
<li>
<p>Literature Notes 需要及时回顾，在一两天内转化为 Permanent Notes 或者直接删掉。</p>
</li>
</ul>
<h2 id="误区">误区</h2>
<ul>
<li>
<p>All-In-One 的思想。Markdown 的扩展语法实现并不统一，扩展语法的内容导出时经常要手动兼容，或不可再用。云端服务的不可持续性，互联网这么多年已经太多的云端服务用着用着就停掉了。</p>
</li>
<li>
<p>Permanent Notes 并不是不需要回顾和修改了。</p>
</li>
<li>
<p>记太多的内容。从资料中复制大量的原文。笔记应该是对所读内容的提炼：用自己的话改写观点和概念有助于加强理解。</p>
</li>
<li>
<p>太复杂的笔记流程。复杂的工作流通常需要自动化，但自动化不利于笔记的整理，形成最重笔记时应该慎重考虑哪些是需要保留的，否则知识库就会变成垃圾场。</p>
</li>
</ul>
]]></content:encoded>
    </item>
    
    <item>
      <title>The core of efficiency improvement</title>
      <link>https://sheerwill.live/posts/main/20220602185216-the_core_of_efficiency_improvement/</link>
      <pubDate>Wed, 29 Jun 2022 12:57:51 +0800</pubDate>
      
      <guid>https://sheerwill.live/posts/main/20220602185216-the_core_of_efficiency_improvement/</guid>
      <description>其实提高时间利用率，就是两点，事件所需时间的准确评估，另外一个就是牛逼的执行力。</description>
      <content:encoded><![CDATA[<p>其实提高时间利用率，就是两点，事件所需时间的准确评估，另外一个就是牛逼的执行力。</p>
]]></content:encoded>
    </item>
    
    <item>
      <title>Refactoring Code</title>
      <link>https://sheerwill.live/posts/main/20220506193054-refactoring_code/</link>
      <pubDate>Wed, 29 Jun 2022 12:49:44 +0800</pubDate>
      
      <guid>https://sheerwill.live/posts/main/20220506193054-refactoring_code/</guid>
      <description>Refactoring Code How To Find Time Complexity Of An Algorithm
JavaScript Refactoring Tips Refactoring Condition statements Converting callbacks to promises Refactoring Promise chains with async/await Refactoring Code examples Callback Hell </description>
      <content:encoded><![CDATA[<h2 id="refactoring-code">Refactoring Code</h2>
<p><a href="/posts/main/20220506193205-how_to_find_time_complexity_of_an_algorithm/">How To Find Time Complexity Of An Algorithm</a></p>
<h3 id="javascript">JavaScript</h3>
<h4 id="refactoring-tips">Refactoring Tips</h4>
<ol>
<li><a href="/posts/main/20220506193520-refactoring_condition_statements/">Refactoring Condition statements</a></li>
<li><a href="/posts/main/20220506193545-converting_callbacks_to_promises/">Converting callbacks to promises</a></li>
<li><a href="/posts/main/20220506193624-refactoring_promise_chains_with_async_await/">Refactoring Promise chains with async/await</a></li>
</ol>
<h4 id="refactoring-code-examples">Refactoring Code examples</h4>
<ul>
<li><a href="/posts/main/20220616092944-callback_hell/">Callback Hell</a></li>
</ul>
]]></content:encoded>
    </item>
    
    <item>
      <title>MySQL</title>
      <link>https://sheerwill.live/posts/main/20220530185321-mysql/</link>
      <pubDate>Wed, 29 Jun 2022 12:49:27 +0800</pubDate>
      
      <guid>https://sheerwill.live/posts/main/20220530185321-mysql/</guid>
      <description>Troubleshoot Issues in MySQL
Sort Chinese text fields alphabetically by first letter</description>
      <content:encoded><![CDATA[<p><a href="/posts/main/20220530180443-troubleshoot_issues_in_mysql/">Troubleshoot Issues in MySQL</a></p>
<p><a href="/posts/main/20220601104443-sort_chinese_text_fields_alphabetically_by_first_letter/">Sort Chinese text fields alphabetically by first letter</a></p>
]]></content:encoded>
    </item>
    
    <item>
      <title>The two generals problem</title>
      <link>https://sheerwill.live/posts/main/20220602202247-the_two_generals_problem/</link>
      <pubDate>Wed, 29 Jun 2022 12:48:52 +0800</pubDate>
      
      <guid>https://sheerwill.live/posts/main/20220602202247-the_two_generals_problem/</guid>
      <description>两军问题（英语：Two Generals&amp;rsquo; Problem）是计算机领域中的一个思想实验。两军问题显示，通过不可靠的通信通道交换信息并达成共识是难以实现的。在该</description>
      <content:encoded><![CDATA[<p>两军问题（英语：Two Generals&rsquo; Problem）是计算机领域中的一个思想实验。两军问题显示，通过不可靠的通信通道交换信息并达成共识是难以实现的。在该问题中，两支军队的将军只能通过派遣信使穿越敌方领土来互相通信，以此约定在同一时间点共同进攻。该问题希望求解如何在两位将军派出的任何信使都可能被俘虏的情况下，就发动攻击的时间点达成一致。</p>
<p>两军问题是拜占庭将军问题的一个特例，常被编入与计算机网络相关的入门课程中。在传输控制协议（TCP）相关的课程中，该问题可用作解释 TCP 协议无法保证通信双方之间的状态一致性的原因。该问题也适用于其他存在信息丢失的双方通信的情况。作为认识逻辑的一个重要概念，该问题突出了共识（英语：Common_knowledge_(logic)）的重要性。一些学者也将此问题称作两军悖论（英语：Two Generals Paradox）或协同进攻问题（英语：Coordinated Attack Problem）。两军问题是第一个被证明无解的计算机通信问题。该证明的重要意义在于，其显示了对于存在通信错误的更广泛的问题（如拜占庭将军问题），同样是无解的。这也为所有分布式一致性协议的实现提供了一个符合现实的预期。</p>
]]></content:encoded>
    </item>
    
    <item>
      <title>The Byzantine generals problem</title>
      <link>https://sheerwill.live/posts/main/20220602202317-the_byzantine_generals_problem/</link>
      <pubDate>Wed, 29 Jun 2022 12:48:39 +0800</pubDate>
      
      <guid>https://sheerwill.live/posts/main/20220602202317-the_byzantine_generals_problem/</guid>
      <description>拜占庭将军问题（Byzantine Generals Problem），是由莱斯利·兰波特在其同名论文中提出的分布式对等网络通信容错问题。 在分布式计算中，不同</description>
      <content:encoded><![CDATA[<p>拜占庭将军问题（Byzantine Generals Problem），是由莱斯利·兰波特在其同名论文中提出的分布式对等网络通信容错问题。</p>
<p>在分布式计算中，不同的计算机通过通讯交换信息达成共识而按照同一套协作策略行动。但有时候，系统中的成员计算机可能出错而发送错误的信息，用于传递信息的通讯网络也可能导致信息损坏，使得网络中不同的成员关于全体协作的策略得出不同结论，从而破坏系统一致性。拜占庭将军问题被认为是容错性问题中最难的问题类型之一。</p>
<p>容错率：Theorem: need 3ƒ+1 generals in total to tolerate ƒ malicious generals.</p>
]]></content:encoded>
    </item>
    
    <item>
      <title>Remote Procedure Call (RPC)</title>
      <link>https://sheerwill.live/posts/main/20220603220847-remote_procedure_call_rpc/</link>
      <pubDate>Wed, 29 Jun 2022 12:47:37 +0800</pubDate>
      
      <guid>https://sheerwill.live/posts/main/20220603220847-remote_procedure_call_rpc/</guid>
      <description>Remote Procedure Call 是一种=软件通信协议=，程序可以在不了解网络细节的前提下，向位于网络上的另外一台计算机中的本地程序请求服务。PRC 被用来像本地系统一样</description>
      <content:encoded><![CDATA[<p>Remote Procedure Call 是一种=软件通信协议=，程序可以在不了解网络细节的前提下，向位于网络上的另外一台计算机中的本地程序请求服务。PRC 被用来像本地系统一样调用远程系统上的其他进程。</p>
<p>RPC 是通过 Interface Definition Language (IDL) 来描述接口，使得在不同的平台上运行的不同程序编写的程序可以相互通信。(IDL 是不以任何一种特定编程语言的方式指定类型签名或者函数调用的语言。)</p>
<p>基本上，你可以用 IDL 定义客户端和服务端之间的接口，这样 RPC 机制就可以创建跨网络调用功能所需要的代码存根（Code <a href="/posts/main/20220604180341-stub/">Stub</a>）。</p>
<pre tabindex="0"><code class="language-nil" data-lang="nil">+----------------+
| Client         |
|  +----------+  |         +---------------+
|  |   main   |  |         | Server        |
|  |----------|  |         |  +----------+ |
|  | stub_cli |----(comms)---&gt;| stub_svr | |
|  +----------+  |         |  |----------| |
+----------------+         |  | function | |
                           |  +----------+ |
                           +---------------+
</code></pre><p>在这个例子中，~main~ 没有在同一个程序中调用函数，而是调用了一个客户端存根函数（与函数的原型相同），该函数负责将信息打包，并通过通讯通道将其传送给另一个进程。</p>
<p>这里可以是同一台机器或者不同机器，RPC 的优势之一就是能够随意移动服务器。</p>
<p>在服务器中，有个「监听者」进程，它将接收这些信息并将其传递给服务器。服务器的存根接收信息，解包并将其传递给真正执行的函数。</p>
<p>真正的函数运行后返回结果给到服务器存根，服务器存根可以将返回的信息打包，并将其传回给客户端存根。客户端存根再将其解包并传回给 ~main~。</p>
<p>实际上的 IDL 大概像下面这样：</p>
<pre tabindex="0"><code class="language-nil" data-lang="nil">[   uuid(f9f6be21-fd32-5577-8f2d-0800132bd567),
    version(0),
    endpoint(&#34;ncadg_ip_udp:[1234]&#34;, &#34;dds:[19]&#34;)
] interface function_iface {
    [idempotent] void function(
        [in] int handle,
        [out] int *status
    );
}
</code></pre><p>头部是一些用于链接客户端和服务端的网络信息，RPC 发生在「会话层」中。接口部分才是 IDL 编译器建立客户端和服务器端存根的地方，以便客户端和服务端能够进行通讯，使得 RPC 正常工作。</p>
]]></content:encoded>
    </item>
    
    <item>
      <title>Quorum</title>
      <link>https://sheerwill.live/posts/main/20220615143721-quorum/</link>
      <pubDate>Wed, 29 Jun 2022 12:47:21 +0800</pubDate>
      
      <guid>https://sheerwill.live/posts/main/20220615143721-quorum/</guid>
      <description>Quorum 机制，是一种分布式系统中常用的，用来保证数据冗余和最终一致性的投票算法，其主要数学思想来源于鸽巢原理。 基于 Quorum 投票的冗余控制算法 在有冗余数据</description>
      <content:encoded><![CDATA[<p>Quorum 机制，是一种分布式系统中常用的，用来保证数据冗余和最终一致性的投票算法，其主要数学思想来源于鸽巢原理。</p>
<h2 id="基于-quorum-投票的冗余控制算法">基于 Quorum 投票的冗余控制算法</h2>
<p>在有冗余数据的分布式存储系统当中，冗余数据对象会在不同的机器之间存放多份拷贝。但是同一时刻一个数据对象的多份拷贝只能用于读或者用于写。</p>
<p>该算法可以保证同一份数据对象的多份拷贝不会被超过两个访问对象读写。</p>
<p>分布式系统中的每一份数据拷贝对象都被赋予一票。每一个读操作获得的票数必须大于最小读票数（read quorum）（\(V_{r}\)），每个写操作获得的票数必须大于最小写票数（write quorum）(\(V_{w}\)）才能读或者写。如果系统有V票（意味着一个数据对象有 \(V\) 份冗余拷贝），那么最小读写票数(quorum)应满足如下限制：</p>
<ol>
<li>\(V_{r} + V_{w} &gt; V\)</li>
<li>\(V_{w} &gt; \frac{V}{2}\)</li>
</ol>
<p>第一条规则保证了一个数据不会被同时读写。当一个写操作请求过来的时候，它必须要获得 \(V_{w}\) 个冗余拷贝的许可。而剩下的数量是 \(V - V_{w}\) 不够 \(V_{r}\)，因此不能再有读请求过来了。同理，当读请求已经获得了 \(V_{r}\) 个冗余拷贝的许可时，写请求就无法获得许可了。</p>
<p>第二条规则保证了数据的串行化修改。一份数据的冗余拷贝不可能同时被两个写请求修改。</p>
<h2 id="算法的好处">算法的好处</h2>
<p>在分布式系统中，冗余数据是保证可靠性的手段，因此冗余数据的一致性维护就非常重要。一般而言，一个写操作必须要对所有的冗余数据都更新完成了，才能称为成功结束。比如一份数据在5台设备上有冗余，因为不知道读数据会落在哪一台设备上，那么一次写操作，必须5台设备都更新完成，写操作才能返回。</p>
<p>对于写操作比较频繁的系统，这个操作的瓶颈非常大。Quorum 算法可以让写操作只要写完3台就返回。剩下的由系统内部缓慢同步完成。而读操作，则需要也至少读3台，才能保证至少可以读到一个最新的数据。</p>
<p>Quorum 的读写最小票数可以用来做为系统在读、写性能方面的一个可调节参数。写票数 \(V_{w}\) 越大，则读票数 \(V_{r}\) 越小，这时候系统读的开销就小。反之则写的开销就小。</p>
]]></content:encoded>
    </item>
    
    <item>
      <title>Lamport clocks</title>
      <link>https://sheerwill.live/posts/main/20220609201658-lamport_clocks/</link>
      <pubDate>Wed, 29 Jun 2022 12:47:08 +0800</pubDate>
      
      <guid>https://sheerwill.live/posts/main/20220609201658-lamport_clocks/</guid>
      <description>Lamport clocks algorithm on initialisation do \(\qquad t := 0\) ▻ each node has its own local variable t end on on any event occurring at the local node do \(\qquad t := t + 1\) end on on request to send message \(m\) do \(\qquad t := t + 1\); send \((t, m)\) via the underlying network link end on on receiving \((t′, m)\)</description>
      <content:encoded><![CDATA[<h2 id="lamport-clocks-algorithm">Lamport clocks algorithm</h2>
<blockquote>
<p><strong>on</strong> initialisation <strong>do</strong> <br />
\(\qquad t := 0\) ▻ each node has its own local variable t <br />
<strong>end on</strong></p>
<p><strong>on</strong> any event occurring at the local node <strong>do</strong> <br />
\(\qquad t := t + 1\) <br />
<strong>end on</strong></p>
<p><strong>on</strong> request to send message \(m\) <strong>do</strong> <br />
\(\qquad t := t + 1\); send \((t, m)\) via the underlying network link <br />
<strong>end on</strong></p>
<p><strong>on</strong> receiving \((t′, m)\) via the underlying network link <strong>do</strong> <br />
\(\qquad t := max(t, t′) + 1\) <br />
\(\qquad\)​deliver \(m\) to the application <br />
<strong>end on</strong></p>
</blockquote>
<h2 id="lamport-clocks-in-words">Lamport clocks in words</h2>
<figure>
    <img loading="lazy" src="/ox-hugo/lamport-example-simple.png"
         alt="Figure 1: lamport-example-simple"/> <figcaption>
            <p><span class="figure-number">Figure 1: </span>lamport-example-simple</p>
        </figcaption>
</figure>

<ul>
<li>每个节点都维护一个计数器 \(t\)，每一个当前节点事件 \(e\) 发生时，自增 1。</li>
<li>增长后的值设为 \(L(e)\)</li>
<li>发送消息时附带上当前的计数 \(t\)</li>
<li>消息接受者在消息中的时间戳和当前节点的时间戳之间取最大值后自增 1</li>
</ul>
<p>Properties of this scheme:</p>
<ul>
<li>if \(a \rightarrow b\) then \(L(e) &lt; L(b)\)</li>
<li>However, \(L(a) &lt; L(b)\) does not imply \(a \rightarrow b\)</li>
<li>Possible that \(L(a) = L(b)\) for \(a \ne b\)</li>
</ul>
<p>Lamport 时间戳本质上是一个整数，用来计算已发生事件的数量。因此，它与物理时间没有直接关系。在每个节点上，时间都会增加，因为每个事件的整数都会递增。该算法假设了一个 crash-stop 模型（如果时间戳被保持在稳定的存储中，即在磁盘上，则是 crash-recovery 模型）。</p>
<h2 id="lamport-clocks-example">Lamport clocks example</h2>
<figure>
    <img loading="lazy" src="/ox-hugo/lamport-example.png"
         alt="Figure 2: lamport-example"/> <figcaption>
            <p><span class="figure-number">Figure 2: </span>lamport-example</p>
        </figcaption>
</figure>

<p>Let \(N(e)\) be the node at which event \(e\) occurred.</p>
<p>Then the pair \((L(e), N(e))\) <strong>uniquely identiﬁes</strong> event \(e\).</p>
<p>Deﬁne a <strong>total order</strong> \(≺\) using Lamport timestamps:</p>
<p>\((a ≺ b) \iff (L(a) &lt; L(b) ∨ (L(a) = L(b) ∧ N(a) &lt; N(b)))\)<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup><sup>, </sup><sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup></p>
<p>This order is <strong>causal</strong>: \((a → b) \Longrightarrow (a ≺ b)\)</p>
<p>回顾之前的 happens-before relation 是局部顺序。利用 Lamport 时间戳可以将这种局部的顺序扩展到全局顺序。可以用（时间戳, 节点名称) 组合：首先比较时间戳，如果相同，则比较节点名称。</p>
<p>对于任何两个事件 \(a \ne b\)，那么既不是 \(a ≺ b\) 也不是 \(b ≺ a\)。只要 \(a → b\)，我们就有 \(a ≺ b\)，换句话说，\(≺\) 是局部顺序 \(\rightarrow\) 的线性扩展。然而，如果 \(a \rVert b\)，我们可以有 \(a ≺ b\) 或 \(b ≺ a\)，所以两个事件的顺序是由算法任意决定的。 比如 \((1, A)\) 和 \((1, C)\) 两个事件是平行的，按照 Lamport 的算法，\((1, A)\) 必然是在 \((1, C)\) 之前的，但实际情况可能是 \((1, C)\) 在前。</p>
<div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p>\(\iff\) is Logical biconditional，当且仅当的意思。&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2">
<p>\(∨\) is logical or, \(∧\) is logical and.&#160;<a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</div>
]]></content:encoded>
    </item>
    
    <item>
      <title>Causality and Happen-before relation</title>
      <link>https://sheerwill.live/posts/main/20220602202832-causality_and_happen_before_relation/</link>
      <pubDate>Wed, 29 Jun 2022 12:46:53 +0800</pubDate>
      
      <guid>https://sheerwill.live/posts/main/20220602202832-causality_and_happen_before_relation/</guid>
      <description>The Happens-before relation An event is something happening at one node (sending or receiving a message, or a local execution step). event a happens before event b, written a → b. 那么在分布式，有三种情况，满足其中一条，则 a 是发生在 b 之前： a 和 b 发生在相同节</description>
      <content:encoded><![CDATA[<h2 id="the-happens-before-relation">The Happens-before relation</h2>
<p>An <strong>event</strong> is something happening at one node (sending or receiving a message, or a local execution step).</p>
<p>event a <strong>happens before</strong> event b, written a → b.</p>
<p>那么在分布式，有三种情况，满足其中一条，则 a 是发生在 b 之前：</p>
<ul>
<li>
<p>a 和 b 发生在相同节点，并且按照本地节点的执行顺序，a 发生在 b 之前。</p>
</li>
<li>
<p>事件 a 是发送消息 m，事件 b 是接收相同的消息 m（假定发送的消息都是唯一的）。</p>
</li>
<li>
<p>有这么一个时间 c 满足，a → c 且 c → b。</p>
<p>happens-before relation 是局部的顺序：有可能存在既不满足 a → b 也不满足 b → a，这样 a 和 b 就是并行的，写作 a || b。</p>
</li>
</ul>
<h3 id="happen-before-relation-example">Happen-before relation example</h3>
<figure>
    <img loading="lazy" src="/ox-hugo/happens-before-example.png"
         alt="Figure 1: happens-before-example"/> <figcaption>
            <p><span class="figure-number">Figure 1: </span>happens-before-example</p>
        </figcaption>
</figure>

<ul>
<li>a → b, c → d, and e → f due to process order</li>
<li>b → c and d → f due to messages m1 and m2</li>
<li>a → c, a → d, a → f, b → d, b → f, and c → f due to transitivity</li>
<li>a || e, b || e, c || e, and d || e</li>
</ul>
<h2 id="causality">Causality</h2>
<p>Happens-before relation 和 Causality 在分布式系统中联系非常紧密</p>
<ul>
<li>当 a → b, 那么 a 可能是 b 的因。</li>
<li>当 a || b, a 和 b 之间不存在因果关系。</li>
</ul>
<figure>
    <img loading="lazy" src="/ox-hugo/causality.png"
         alt="Figure 2: causality"/> <figcaption>
            <p><span class="figure-number">Figure 2: </span>causality</p>
        </figcaption>
</figure>

<p>Let ≺ be a strict total order on events.</p>
<p>如果 (a → b) ⇒ (a ≺ b) 符号 ≺ 就是所谓的因果顺序。</p>
<p>因果关系的概念是从物理学中借鉴的，信息的传播速度不可能超过光速。因此如果事件 A 和事件 B 在空间上相距很远，但是在时间上相距很近，那么从事件 A 发出的信号不可能在事件 B 之前到达 B 的位置，反之亦然。因此 A 和 B 是肯定没有因果关系的。</p>
<p>一个在空间上离 A 很近，时间上距离 A 很远的事件 C，将在 A 的光锥内，也就是说 A 的信号有可能到达 C，因此 A 可能影响 C。在分布式系统中，网络上的消息虽然不同于光束，但原理非常相似。</p>
]]></content:encoded>
    </item>
    
    <item>
      <title>Network Time Protocol (NTP)</title>
      <link>https://sheerwill.live/posts/main/20220602202411-network_time_protocol_ntp/</link>
      <pubDate>Wed, 29 Jun 2022 12:45:01 +0800</pubDate>
      
      <guid>https://sheerwill.live/posts/main/20220602202411-network_time_protocol_ntp/</guid>
      <description>Network Time Protocol (NTP) is an internet protocol used to synchronize with computer clock time sources in a network. It belongs to and is one of the oldest parts of the TCP/IP suite. The term NTP applies to both the protocol and the client-server programs that run on computers. Mac 中可以在设置中找到 NTP 服务器的地址，比如下</description>
      <content:encoded><![CDATA[<p>Network Time Protocol (NTP) is an internet protocol used to synchronize with computer clock time sources in a network. It belongs to and is one of the oldest parts of the TCP/IP suite. The term NTP applies to both the protocol and the client-server programs that run on computers.</p>
<p>Mac 中可以在设置中找到 NTP 服务器的地址，比如下图中的地址就是 <code>time.apple.com</code> 。</p>
<figure>
    <img loading="lazy" src="/ox-hugo/ntp-in-mac.png"
         alt="Figure 1: NTP"/> <figcaption>
            <p><span class="figure-number">Figure 1: </span>NTP</p>
        </figcaption>
</figure>

<h2 id="estimating-time-over-a-network">Estimating time over a network</h2>
<figure>
    <img loading="lazy" src="/ox-hugo/NTP.png"
         alt="Figure 2: NTP"/> <figcaption>
            <p><span class="figure-number">Figure 2: </span>NTP</p>
        </figcaption>
</figure>

<ol>
<li>
<p>Round-trip network delay: \(\delta = (t_{4} - t_{1}) - (t_{3} - t_{2})\)</p>
</li>
<li>
<p>Estimated server time when client receives response: \(t_{3} + \frac{\delta}{2}\)（客户端收到响应时的服务器的时间）</p>
</li>
<li>
<p>Estimated clock skew: \(\theta = t_{3} + \frac{\delta}{2} - t_{4} = \frac{(t_{2} - t_{1} + t_{3} - t_{4})}{2}\)（计算预估的服务器时间和当前客户端时间的偏差）</p>
</li>
</ol>
<h2 id="correcting-clock-skew">Correcting clock skew</h2>
<p>Once the client has estimated the clock skew θ, it needs to apply that correction to its clock.</p>
<ul>
<li>
<p>if \(\theta &lt; 125 ms\), <strong>slew</strong> the clock:</p>
<p>slightly speed it up or slow it down by up to \(500 ppm\)<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup> (brings clocks in sync within ≈ 5 minutes)</p>
</li>
<li>
<p>if \(125 ms \le \theta &lt; 1000 s\), <strong>step</strong> the clock:</p>
<p>suddenly reset client clock to estimated server timestamp</p>
</li>
<li>
<p>if \(\theta \ge 1000 s\), <strong>panic</strong> and do nothing (leave the problem for a human operator to resolve)</p>
</li>
</ul>
<p>依靠时钟同步的系统需要监控时钟偏移。从最后一条可以看出，如果 NTP Client 和 NTP Server 偏差过大，则会拒绝同步 NTP 的时间，留给人工来处理，因此我们需要避免出现这种偏差过大的情况。</p>
<p>当初初学 Java 的时候，需要知晓某个函数或某段代码执行的时间，通常会用 <code>System.currentTimeMillis()</code> 来测量</p>
<p>原来 <code>System.currentTimeMillis()</code> 用来测量某个函数运行的时间是错误的，会受到 NTP 的影响（机率虽然很小）。应该用 <code>System.nanoTime()</code> 来测量，不会受到 NTP 很大的影响，最多影响「单调时间」步进的频率。</p>
<div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p>1 ppm = 1 microsecond/second = 86ms/day = 32s/year (ppm 是 part per million 的简称)&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</div>
]]></content:encoded>
    </item>
    
    <item>
      <title>Raft consensus algorithm</title>
      <link>https://sheerwill.live/posts/main/20220623152601-raft_consensus_algorithm/</link>
      <pubDate>Fri, 24 Jun 2022 14:41:06 +0800</pubDate>
      
      <guid>https://sheerwill.live/posts/main/20220623152601-raft_consensus_algorithm/</guid>
      <description>Figure 1: node-state-transitions-in-raft 一个节点有三种状态：leader，candidate 和 follower。当一个节点第一次运行，或者崩溃后恢复时，处于 follower 的状态并且等待其</description>
      <content:encoded><![CDATA[<figure>
    <img loading="lazy" src="/ox-hugo/node-state-transitions-in-raft.png"
         alt="Figure 1: node-state-transitions-in-raft"/> <figcaption>
            <p><span class="figure-number">Figure 1: </span>node-state-transitions-in-raft</p>
        </figcaption>
</figure>

<p>一个节点有三种状态：leader，candidate 和 follower。当一个节点第一次运行，或者崩溃后恢复时，处于 follower 的状态并且等待其他节点。如果一定时间内没有从 leader 或者 candidate 处收到消息，follower 会怀疑 leader 已经不可用了，并试图成为新的 leader。检测 leader 不可用是随机的，这样可以减少几个节点同时成为 candidate 争取票数成为 leader 的可能。</p>
<p>当一个节点怀疑 leader 不可用时，会转变自身状态为 candidate，递增 term，并在这个 term 中去争取其他节点的票数进行选举。在选举过程中，如果收到其他 candidate 或 leader 发出更高的 term，则会回归到 follower 的状态。如果从 quorum 数量的节点收到票数并选举成功，就会从 candidate 的状态变为 leader 状态。如果在一定时间内没有收到足够的票数，选举会过期，然后 candidate 递增 term 并开始新一轮选举。</p>
<p>一个节点除非崩溃、关闭或者收到其他 leader 或 candidate 处发来的更高的 term，否则会始终处在 leader 状态。当 leader 因为网络原因使得它无法与其他节点沟通时，其他节点就会进行选举，选举出新的 leader，这个时候更高的 term 就产生了。当收到更高的 term 时，之前的 leader 就会变为 follower 的状态。</p>
<h2 id="initialisation">Initialisation</h2>
<blockquote>
<p><strong>on</strong> initialisation <strong>do</strong> <br />
\(\qquad currentTerm\) := 0; \(votedFor\) := null <br />
\(\qquad log := \langle\rangle; commitLength\) := 0 <br />
\(\qquad currentRole\) := follower; \(curentLeader\) := null <br />
\(\qquad votesReceived := {}; sentLength := \langle\rangle; ackedLength := \langle\rangle\) <br />
<strong>end on</strong></p>
<p><strong>on</strong> recovery from crash <strong>do</strong> <br />
\(\qquad currentRole\) := follower; \(currentLeader\) := null <br />
\(\qquad votedReceived := {}; sentLength := \langle\rangle; ackedLength := \langle\rangle\) <br />
<strong>end on</strong></p>
<p><strong>on</strong> node \(nodeId\) suspects leader has failed, or on election timeout <strong>do</strong> <br />
\(\qquad currentTerm := currentTerm + 1; currentRole\) := candidate <br />
\(\qquad votedFor := nodeId; votesReceived := { nodeId } ; lastTerm := 0\) <br />
\(\qquad\)​<strong>if</strong> \(log\).length &gt; 0 <strong>then</strong> \(lastTerm\) := \(log[log\).length − 1].term; <strong>end if</strong> <br />
\(\qquad\qquad msg\) := (VoteRequest, \(nodeId\), \(currentTerm\), \(log\).length, \(lastTerm\)) <br />
\(\qquad\)​<strong>for each</strong> \(node \in nodes\): <strong>send</strong> \(msg\) to \(node\) <br />
\(\qquad\)​start election timer <br />
<strong>end on</strong></p>
</blockquote>
<p>根据上面的伪代码，在初始化块中定义的变量构成了一个节点的状态。四个变量（currentTerm, votedFor, log, and commitLength）需要维护稳定的存储内（比如硬盘），来保证崩溃的时候状态不能丢失。其他变量在崩溃后恢复时会重置，所以可以存在内存当中。系统中有一个全局变量 nodes，并且每个节点都有一个唯一的 ID。（这边讲的算法没有包含 reconfiguration，也就是从系统中添加或移除节点。）</p>
<p>log 是一个数组，每个条目有属性 msg 和 term。属性 msg 里面就是我们需要通过 total order broadcast 传递的消息，属性 term 包含了被广播的 term 编号。log 数组是以 0 作为下标开始，log 是以尾部 append 新的条目来增长的，Raft 算法在各节点复制 log。当一个日志条目（以及之前的条目）被复制到 quorum 数量节点时，就提交事务。当 log 条目（以及之前的条目）被提交时，就会把条目中的 msg 传递给 Application。在一个 log 条目被提交之前，它还可能发生变化，但 Raft 保证，一旦一个 log 条目被提交后它就是确定了，所有节点将提交相同的日志条目序列。因此，从已提交的 log 条目中按其 log 顺序传递消息，我们就实现了 FIFO-total order broadcast。</p>
<p>当一个节点怀疑 leader 不可用时，增加 currentTerm，将自己的角色设置为 candidate，并通过将 votedFor 和 votesReceived 设置为自己的节点 ID 来为自己投票。然后，它向其他每个节点发送一个 VoteRequest 消息，要求它们投票决定 candidate 是否可以成为新 leader。该消息包含 candidate 的 nodeId、它的 currentTerm（增量后）、它的日志中的条目数，以及它最新一条日志条目。</p>
<h2 id="voting-on-a-new-leader">Voting on a new leader</h2>
<blockquote>
<p><strong>on</strong> receiving (VoteRequest, \(cId\), \(cTerm\), \(cLogLength\), \(cLogTerm\)) at node \(nodeId\) <strong>do</strong> <br />
\(\qquad\)​<strong>if</strong> \(cTerm \gt currentTerm\) <strong>then</strong> <br />
\(\qquad\qquad currentTerm := cTerm; currentRole\) := follower <br />
\(\qquad\qquad votedFor\) := null <br />
\(\qquad\)​<strong>end if</strong> <br />
\(\qquad lastTerm\) := 0 <br />
\(\qquad\)​<strong>if</strong> \(log\).length &gt; 0 <strong>then</strong> \(lastTerm := log[log\).length - 1].term; <strong>end if</strong> <br />
\(\qquad logOk := (cLogTerm \gt lastTerm) \vee (cLogTerm = lastTerm \wedge cLogLength \ge log\).length)<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup> <br />
\(\qquad\)​<strong>if</strong> \(cTerm = currentTerm \wedge logOk \wedge votedFor \in\) {\(cId\), null} <strong>then</strong> <br />
\(\qquad\qquad votedFor := cId\) <br />
\(\qquad\qquad\)​<strong>send</strong> (VoteResponse, \(nodeId, currentTerm\), true) to node \(cId\) <br />
\(\qquad\)​<strong>else</strong> <br />
\(\qquad\qquad\)​<strong>send</strong> (VoteResponse, \(nodeId, currentTerm\), false) to node \(cId\) <br />
\(\qquad\)​<strong>end if</strong> <br />
<strong>end on</strong></p>
</blockquote>
<p>如果 candidate 的 term 是大于接收者的 term 时，接收者就会变为 follower（即便它在小的 term 里面是 leader）。然后，接收者会检查 candidate 的 log 至少和自己的 log 一样或者更新，防止 log 过期的 candidate 成为 leader，导致 log 丢失。candidate 的 log 最新条目的 term 要大于接收者 log 最新条目的 term；或者 term 相同，candidate 的 log 长度大于等于接收者的 log 长度。那么 candidate 的 log 就是可以接受的。在上面伪代码中的 logOk 可以看到这样的逻辑。</p>
<p>votedFor 变量记录了当前节点在 currentTerm 中给谁投了票，如果 currentTerm 就是 candidate 的 term，candidate 的 log 是最新的（也就是 logOk 为 true），并且在当前这个 term 中没有给其他节点投过票，那么就将 candidate 的 nodeId 记录在 votedFor 中，并发送包含 true 的 VoteResponse 的消息给 candidate。否则，则发送包含 false 的 VoteResponse。除了成功和失败的标识外，还会附带上当前节点的 ID 以及 当前的 term。</p>
<h2 id="collecting-votes">Collecting votes</h2>
<blockquote>
<p><strong>on</strong> receiving (VoteResponse, \(voterId, term, granted\)) at \(nodeId\) <strong>do</strong> <br />
\(\qquad\)​<strong>if</strong> \(currentRole\) = candidate \(\wedge term = currentTerm \wedge granted\) <strong>then</strong> <br />
\(\qquad\qquad votesReceived := votesReceived \cup {voterId}\) <br />
\(\qquad\qquad\)​<strong>if</strong> \(|votesReceived| \ge \left \lceil\frac{(|nodes|) + 1}{2}\right \rceil\) <strong>then</strong> <br />
\(\qquad\qquad\qquad currentRole\) := leader; \(curentLeader := nodeId\) <br />
\(\qquad\qquad\qquad\)​cancel election timer <br />
\(\qquad\qquad\qquad\)​<strong>for</strong> each \(follower \in nodes \ {nodeId}\) <strong>do</strong> <br />
\(\qquad\qquad\qquad\qquad sentLength[follower] := log\).length <br />
\(\qquad\qquad\qquad\qquad ackedLength[follower]\) := 0 <br />
\(\qquad\qquad\qquad\qquad \mathrm{R}\mathrm{\scriptsize EPLICATE}\mathrm{L}\mathrm{\scriptsize OG}(nodeId, follower)\) <br />
\(\qquad\qquad\qquad\) ​<strong>end for</strong> <br />
\(\qquad\qquad\)​<strong>end if</strong> <br />
\(\qquad\)​<strong>else if</strong> \(term \gt currentTerm\) <strong>Then</strong> <br />
\(\qquad\qquad currentTerm := term\) <br />
\(\qquad\qquad currentRole\) := follower <br />
\(\qquad\qquad votedFor\) := null <br />
\(\qquad\qquad\)​cancel election timer <br />
\(\qquad\)​<strong>end if</strong> <br />
<strong>end on</strong></p>
</blockquote>
<p>回到 candidate 这边，如果收到的消息中 term 高于 candidate 的 term，则会取消选举并过渡到 follower 状态；如果两者的 term 相等，则 candidate 就会讲投票者的 ID 加入到 votesReceived 集合中。</p>
<p>如果投票构成了 quorum，那么 candidate 会过渡到 leader 状态。作为领导者的第一个动作，就是更新 sendLength 和 ackedLength 变量（解释见下文），然后为每个 follower 调用 ReplicateLog （定义见（Raft (5/9): replicating from leader to followers）函数。这样做的目的是向每个 follower 发送一条消息，告知他们新的 leader 的情况。</p>
<p>sentLength 和 ackedLength 给每个节点 ID 映射了一个整数（非 leader 不需要这些变量）。对于每个 follower F，sentLength[F] 记录了从 log 开始有多少 log 条目发送给了 F；ackedLength[F] 记录了有多少 log 条目已经被 F 确认收到了。在成为 Leader 之前，节点会将 sentLength[F] 初始化为 log 的长度（这里是假设所有的 follower 都已经同步了所有的 log，这里的假设是有问题的，具体解决会在 Raft (8/9): leader receiving log acknowledgements），ackedLength 初始化为 0。</p>
<h2 id="broadcasting-messages">Broadcasting messages</h2>
<blockquote>
<p><strong>on</strong> request to broadcast \(msg\) at node \(nodeId\) <strong>do</strong> <br />
\(\qquad\)​<strong>if</strong> \(currentRole\) = leader <strong>then</strong> <br />
\(\qquad\qquad\)​append the record (msg: \(msg\), term: \(currentTerm\)) to \(log\) <br />
\(\qquad\qquad ackedLength[nodeId]\) := \(log\).length <br />
\(\qquad\qquad\)​<strong>for</strong> each \(follower \in nodes \ {nodeId}\) <strong>do</strong> <br />
\(\qquad\qquad\qquad \mathrm{R}\mathrm{\scriptsize EPLICATE}\mathrm{L}\mathrm{\scriptsize OG}(nodeId, follower)\) <br />
\(\qquad\qquad\)​<strong>end for</strong> <br />
\(\qquad\)​<strong>else</strong> <br />
\(\qquad\qquad\)​forward the request to \(currentLeader\) via a FIFO link <br />
\(\qquad\)​<strong>end if</strong><br />
<strong>end on</strong></p>
<p><strong>periodically</strong> at node \(nodeId\) <strong>do</strong> <br />
\(\qquad\)​<strong>if</strong> \(currentRole\) = leader <strong>then</strong> <br />
\(\qquad\qquad\)​<strong>for</strong> each \(follower \in nodes \ {nodeId}\) <strong>do</strong> <br />
\(\qquad\qquad\qquad \mathrm{R}\mathrm{\scriptsize EPLICATE}\mathrm{L}\mathrm{\scriptsize OG}(nodeId, follower)\) <br />
\(\qquad\qquad\)​<strong>end for</strong> <br />
\(\qquad\)​<strong>end if</strong> <br />
<strong>end do</strong></p>
</blockquote>
<p>以上伪代码中，当 Application 希望通过 total order broadcast 广播消息时，只需要简单的添加一个新的 log 条目进 log 当中，并更新 ackedLength 为最新 log 的长度，然后对于其他每个节点都调用 ReplicateLog。</p>
<p>leader 在即使没有新消息需要广播时，也会定期为其他每个节点调用 ReplicateLog，这样可以让其他 follower 知道 leader 一直处于可用状态以及让丢失的消息得到重传。</p>
<h2 id="replicating-from-leader-to-followers">Replicating from leader to followers</h2>
<blockquote>
<p><strong>function</strong> \(\mathrm{R}\mathrm{\scriptsize EPLICATE}\mathrm{L}\mathrm{\scriptsize OG}(leaderId, followerId)\) <br />
\(\qquad prefixLen := sentLength[followerId]\) <br />
\(\qquad suffix := \langle log[prefixLen], log[prefixLen + 1]\), &hellip;, \(log[log\).length − 1]\(\rangle\) <br />
\(\qquad prefixTerm\) := 0 <br />
\(\qquad\)​<strong>if</strong> \(prefixLen \gt\) 0 <strong>then</strong> <br />
\(\qquad\qquad prefixTerm := log[prefixLen − 1]\).term <br />
\(\qquad\)​<strong>end if</strong> <br />
\(\qquad\)​<strong>send</strong> (LogRequest, \(leaderId, currentTerm, prefixLen, prefixTerm, commitLength, suffix\)) to \(followerId\) <br />
<strong>end function</strong></p>
</blockquote>
<p>ReplicateLog 方法是从 leader 利用 followerId 发送任何新的 log 条目给 follower。prefixLen 是已经发送给 follower 消息的数量，suffix 就是还没有发送给 follower 的消息。所以当 sentLength[follower] = log.length 时，suffix 是一个空数组。</p>
<h2 id="followers-receiving-messages">Followers receiving messages</h2>
<blockquote>
<p><strong>on</strong> receiving (LogRequest, \(leaderId, term, prefixLen, prefixTerm, leaderCommit, suffix\)) at node \(nodeId\) <strong>do</strong> <br />
\(\qquad\)​<strong>if</strong> \(term \gt currentTerm\) <strong>then</strong> <br />
\(\qquad\qquad currentTerm := term; votedFor\) := null <br />
\(\qquad\qquad\)​cancel election timer <br />
\(\qquad\)​<strong>end if</strong> <br />
\(\qquad\)​<strong>if</strong> \(term = currentTerm\) <strong>then</strong> <br />
\(\qquad\qquad currentRole\) := follower; \(currentLeader := leaderId\) <br />
\(\qquad\)​<strong>end if</strong> <br />
\(\qquad logOk := (log\).length \(\ge prefixLen) \wedge (prefixLen = 0 \vee log[prefixLen - 1]\).term = \(prefixTerm\)) <br />
\(\qquad\)​<strong>if</strong> \(term = currentTerm \wedge logOk\) <strong>then</strong> <br />
\(\qquad\qquad \mathrm{A}\mathrm{\scriptsize PPEND}\mathrm{E}\mathrm{\scriptsize NTRIES}(prefixLen, leaderCommit, suffix)\) <br />
\(\qquad\qquad ack := prefixLen + suffix\).length <br />
\(\qquad\qquad\)​<strong>send</strong> (LogResponse, \(nodeId, currentTerm, ack\), true) to \(leaderId\) <br />
\(\qquad\)​<strong>else</strong> <br />
\(\qquad\qquad\)​<strong>send</strong> (LogResponse, \(nodeId, currentTerm\), 0, false) to \(leaderId\) <br />
\(\qquad\)​<strong>end if</strong>
<strong>end on</strong></p>
</blockquote>
<p>首先，如果消息的 term 比 follower 当前的 term 高，则更新当前的 term，并接受消息的发送者为 leader。相等的时候，也会和之前一样的逻辑，承认发送者为 leader。</p>
<p>prefixLen 为 suffix 包含 log 条目之前的条目数量，follower 要求自己当前的 log 长度要大于等于 prefixLen，并且 prefixLen 长度前的最后一个 log 条目中的 term 要与 leader 的 prefixTerm 相同<sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup>。Raft 算法保证两个节点相同下标对应的 log 条目中的 term 相同，那么在这之前的 log 都是相同。</p>
<p>以上条件满足就会调用 AppendEntries 将 suffix 添加到自己的 log 当中。</p>
<h2 id="updating-followers-logs">Updating followers&rsquo; logs</h2>
<blockquote>
<p><strong>function</strong> \(\mathrm{A}\mathrm{\scriptsize PPEND}\mathrm{E}\mathrm{\scriptsize NTRIES}(prefixLen, leaderCommit, suffix)\) <br />
\(\qquad\)​<strong>if</strong> \(suffix\).length \(\gt 0 \wedge log\).length \(\gt prefixLen\) <strong>then</strong> <br />
\(\qquad\qquad index\) := min(\(log\).length, \(prefixLen + suffix\).length) - 1 <br />
\(\qquad\qquad\)​<strong>if</strong> \(log[index]\).term \(\ne suffix[index - prefixLen]\).term <strong>then</strong> <br />
\(\qquad\qquad\qquad log := \langle log[0], log[1], &hellip;, log[prefixLen - 1]\rangle\) <br />
\(\qquad\qquad\)​<strong>end if</strong> <br />
\(\qquad\)​<strong>end if</strong> <br />
\(\qquad\)​<strong>if</strong> \(prefixLen + suffix\).length \(\gt log\).length <strong>then</strong> <br />
\(\qquad\qquad\)​<strong>for</strong> \(i := log\).length - \(prefixLen\) <strong>to</strong> \(suffix\).length - 1 <strong>do</strong> <br />
\(\qquad\qquad\qquad\)​append \(suffix[i]\) to \(log\) <br />
\(\qquad\qquad\)​<strong>end for</strong> <br />
\(\qquad\)​<strong>end if</strong> <br />
\(\qquad\)​<strong>if</strong> \(leaderCommit \gt commitLength\) <strong>then</strong> <br />
\(\qquad\qquad\)​<strong>for</strong> \(i := commitLength\) <strong>to</strong> \(leaderCommit\) - 1 <strong>do</strong> <br />
\(\qquad\qquad\qquad\)​deliver \(log[i]\).msg to the application <br />
\(\qquad\qquad\)​<strong>end for</strong> <br />
\(\qquad\qquad commitLength := leaderCommit\) <br />
\(\qquad\)​<strong>end if</strong> <br />
<strong>end function</strong></p>
</blockquote>
<p>follower 利用该函数讲从 leader 那里收到的条目扩充到 log 当中。如果节点本地的 log 长度大于 leader 发来消息中的 prefixLen，那么我们就要检查差异的这部份 log 条目是否与 suffix 中的条目一致。如果不一致，我们则需要舍弃这部份差异，只保留 prefixLen 长度的 log。这种情况发生在前一个 leader 发送的 log 已经被合并到节点本地 log 当中，而同时因为一些原因新的 leader 发送来新的 log。</p>
<p>然后，任何新的 log 都会被追加到 follower 本地的 log 当中，即便是消息重复的情况下，这个操作也是幂等的。follower 检查 leaderCommit 是否大于本地的 commitLength，满足条件则可以将 log 当中的 msg 传递给 application，并对本地 commitLength 更新。</p>
<h2 id="leader-receiving-log-acknowledgements">Leader receiving log acknowledgements</h2>
<blockquote>
<p><strong>on</strong> receiving (LogResponse, \(follower, term, ack, success\)) at \(nodeId\) <strong>do</strong> <br />
\(\qquad\)​<strong>if</strong> \(term = currentTerm \wedge currentRole\) = leader <strong>then</strong> <br />
\(\qquad\qquad\)​<strong>if</strong> \(success\) = true \(\wedge ack \ge ackedLength[follower]\) <strong>then</strong> <br />
\(\qquad\qquad\qquad sentLength[follower] := ack\) <br />
\(\qquad\qquad\qquad ackedLength[follower] := ack\) <br />
\(\qquad\qquad\qquad \mathrm{C}\mathrm{\scriptsize OMMIT}\mathrm{L}\mathrm{\scriptsize OG}\mathrm{E}\mathrm{\scriptsize NTRIES}()\) <br />
\(\qquad\qquad\)​<strong>else if</strong> \(sentLength[follower] \gt 0\) <strong>then</strong> <br />
\(\qquad\qquad\qquad sentLength[follower] := sentLength[follower] - 1\) <br />
\(\qquad\qquad\qquad \mathrm{R}\mathrm{\scriptsize EPLICATE}\mathrm{L}\mathrm{\scriptsize OG}(nodeId, follower)\) <br />
\(\qquad\qquad\)​<strong>end if</strong> <br />
\(\qquad\)​<strong>end if</strong> \(term \gt currentTerm\) <strong>then</strong> <br />
\(\qquad\qquad currentTerm := term\) <br />
\(\qquad\qquad currentRole\) := follower <br />
\(\qquad\qquad votedFor\) := null <br />
\(\qquad\qquad\)​cancel election timer <br />
\(\qquad\)​<strong>end if</strong> <br />
<strong>end on</strong></p>
</blockquote>
<p>这里回到 leader 这边。leader 会检查发送者的 term：如果发送者的 term 大于接收者的 term，那么意味着新 leader 选举已经开始，所以当前的 leader 会变为 follower 的状态。</p>
<p>如果 term 相同，并且详细中的 success 为 true，则更新 sendLength 和 ackedLength，记录 follower 确认过的 log 数量，然后调用 CommitLogEntries 函数。如果 success 为 false，则 follower 没有接收消息，这个时候 leader 会递减 sendLength，并嗲用 ReplicateLog 重新发送 LogRequest 消息<sup id="fnref:3"><a href="#fn:3" class="footnote-ref" role="doc-noteref">3</a></sup>。</p>
<h2 id="leader-committing-log-entries">Leader committing log entries</h2>
<blockquote>
<p><strong>define</strong> acks(\(length\)) = \(|{n \in nodes | ackedLength[n] \ge length}|\)</p>
<p><strong>function</strong> \(\mathrm{C}\mathrm{\scriptsize OMMIT}\mathrm{L}\mathrm{\scriptsize OG}\mathrm{E}\mathrm{\scriptsize NTRIES}\) <br />
\(\qquad minAcks := \left \lceil\frac{|nodes| + 1}{2} \right \rceil\) <br />
\(\qquad ready\) := {\(len \in\) {1, &hellip;, \(log\).length} | acks(\(len\)) \(\ge minAcks\)} <br />
\(\qquad\)​<strong>if</strong> \(ready \ne {} \wedge\) max(\(ready\)) \(\gt commitLength \wedge log\)[max(\(ready\)) - 1].term = \(currentTerm\) <strong>then</strong> <br />
\(\qquad\qquad\)​<strong>for</strong> \(i := commitLength\) <strong>to</strong> max(\(ready\)) - 1 <strong>do</strong> <br />
\(\qquad\qquad\qquad\)​deliver \(log[i]\).msg to the application <br />
\(\qquad\qquad\)​<strong>end for</strong> <br />
\(\qquad\qquad commitLength\) := max(\(ready\)) <br />
\(\qquad\)​<strong>end if</strong> <br />
<strong>end function</strong></p>
</blockquote>
<p>被 quorum 确认过的 log 条目就可以被 leader 提交，当 log 条目被提交，消息就被传递给 Application。</p>
<div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p>\(\vee\) is logical or, \(\wedge\) is logical and.&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2">
<p>参考上一个步骤中 prefixTerm 的来源&#160;<a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:3">
<p>这里算法是可以优化的，来减少重试次数。&#160;<a href="#fnref:3" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</div>
]]></content:encoded>
    </item>
    
    <item>
      <title>Latex</title>
      <link>https://sheerwill.live/posts/main/20220616162256-latex/</link>
      <pubDate>Thu, 23 Jun 2022 15:00:14 +0800</pubDate>
      
      <guid>https://sheerwill.live/posts/main/20220616162256-latex/</guid>
      <description>语法 效果 语法 效果 语法 效果 \bar{x} \(\bar{x}\) \acute{\eta} \(\acute{\eta}\) \check{\alpha} \(\check{\alpha}\) \grave{\eta} \(\grave{\eta}\) \breve{a} \(\breve{a}\) \ddot{y} \(\ddot{y}\) \dot{x} \(\dot{x}\) \hat{\alpha} \(\hat{\alpha}\) \tilde{\iota} \(\tilde{\iota}\) 语法 效果 语法 效果 语法 效果 \sin\theta \(\sin\!\theta\) \cos\theta \(\cos\theta\) \tan\theta \(\tan\theta\) \arcsin\frac{L}{r} \(\arcsin\frac{L}{r}\) \arccos\frac{T}{r} \(\arccos\frac{T}{r}\) \arctan\frac{L}{T} \(\arctan\frac{L}{T}\) \sinh g \(\sinh\ g\) \cosh h \(\cosh h\) \tanh i \(\tanh i\) \operatorname{sh}j \(\operatorname{sh}j\) \operatorname{argsh}k \(\operatorname{argsh}k\)</description>
      <content:encoded><![CDATA[<p><a id="table--声调"></a></p>
<table>
<thead>
<tr>
<th>语法</th>
<th>效果</th>
<th>语法</th>
<th>效果</th>
<th>语法</th>
<th>效果</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>\bar{x}</code></td>
<td>\(\bar{x}\)</td>
<td><code>\acute{\eta}</code></td>
<td>\(\acute{\eta}\)</td>
<td><code>\check{\alpha}</code></td>
<td>\(\check{\alpha}\)</td>
</tr>
<tr>
<td><code>\grave{\eta}</code></td>
<td>\(\grave{\eta}\)</td>
<td><code>\breve{a}</code></td>
<td>\(\breve{a}\)</td>
<td><code>\ddot{y}</code></td>
<td>\(\ddot{y}\)</td>
</tr>
<tr>
<td><code>\dot{x}</code></td>
<td>\(\dot{x}\)</td>
<td><code>\hat{\alpha}</code></td>
<td>\(\hat{\alpha}\)</td>
<td><code>\tilde{\iota}</code></td>
<td>\(\tilde{\iota}\)</td>
</tr>
</tbody>
</table>
<p><a id="table--函数"></a></p>
<table>
<thead>
<tr>
<th>语法</th>
<th>效果</th>
<th>语法</th>
<th>效果</th>
<th>语法</th>
<th>效果</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>\sin\theta</code></td>
<td>\(\sin\!\theta\)</td>
<td><code>\cos\theta</code></td>
<td>\(\cos\theta\)</td>
<td><code>\tan\theta</code></td>
<td>\(\tan\theta\)</td>
</tr>
<tr>
<td><code>\arcsin\frac{L}{r}</code></td>
<td>\(\arcsin\frac{L}{r}\)</td>
<td><code>\arccos\frac{T}{r}</code></td>
<td>\(\arccos\frac{T}{r}\)</td>
<td><code>\arctan\frac{L}{T}</code></td>
<td>\(\arctan\frac{L}{T}\)</td>
</tr>
<tr>
<td><code>\sinh g</code></td>
<td>\(\sinh\ g\)</td>
<td><code>\cosh h</code></td>
<td>\(\cosh h\)</td>
<td><code>\tanh i</code></td>
<td>\(\tanh i\)</td>
</tr>
<tr>
<td><code>\operatorname{sh}j</code></td>
<td>\(\operatorname{sh}j\)</td>
<td><code>\operatorname{argsh}k</code></td>
<td>\(\operatorname{argsh}k\)</td>
<td><code>\operatorname{ch}h</code></td>
<td>\(\operatorname{ch}h\)</td>
</tr>
<tr>
<td><code>\operatorname{argch}l</code></td>
<td>\(\operatorname{argch}l\)</td>
<td><code>\operatorname{th}i</code></td>
<td>\(\operatorname{th}i\)</td>
<td><code>\operatorname{argth}m</code></td>
<td>\(\operatorname{argth}m\)</td>
</tr>
<tr>
<td><code>k'(x)=\lim_{\Delta x\to 0}\frac{k(x)-k(x-\Delta x)}{\Deltax}</code></td>
<td>\(k&rsquo;(x)=\lim_{\Delta x\to0}\!\frac{k(x)-k(x-\Delta x)}{\Delta x}\)</td>
<td><code>\limsup S</code></td>
<td>\(\limsup S\)</td>
<td><code>\liminf I</code></td>
<td>\(\liminf I\)</td>
</tr>
<tr>
<td><code>\max H</code></td>
<td>\(\max\!H\)</td>
<td><code>\min L</code></td>
<td>\(\min L\)</td>
<td><code>\inf s</code></td>
<td>\(\inf s\)</td>
</tr>
<tr>
<td><code>\sup t</code></td>
<td>\(\sup t\)</td>
<td><code>\exp\!t</code></td>
<td>\(\exp\!t\)</td>
<td><code>\ln X</code></td>
<td>\(\ln\!X\)</td>
</tr>
<tr>
<td><code>\lg X</code></td>
<td>\(\lg\!X\)</td>
<td><code>\log X</code></td>
<td>\(\log X\)</td>
<td><code>\log_\alpha X</code></td>
<td>\(\log_\alpha X\)</td>
</tr>
<tr>
<td><code>\ker x</code></td>
<td>\(\ker x\)</td>
<td><code>\deg x</code></td>
<td>\(\deg x\)</td>
<td><code>\gcd(T,U,V,W,X)</code></td>
<td>\(\gcd(T,U,V,W,X)\)</td>
</tr>
<tr>
<td><code>\Pr x</code></td>
<td>$Pr x	$</td>
<td><code>\det x</code></td>
<td>\(\det x\)</td>
<td><code>\hom x</code></td>
<td>\(\hom x\)</td>
</tr>
<tr>
<td><code>\arg x</code></td>
<td>\(\arg x\)</td>
<td><code>\dim x</code></td>
<td>\(\dim x\)</td>
<td><code>\lim_{t\to n}T</code></td>
<td>\(\lim_{t\to n}T\)</td>
</tr>
<tr>
<td><code>\lceil\frac{n+1}{2}\rceil</code></td>
<td>\(\lceil\frac{n+1}{2}\rceil\)</td>
<td><code>\left \lceil\frac{n+1}{2}\right \rceil</code></td>
<td>\(\left \lceil\frac{n+1}{2}\right \rceil\)</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p><a id="table--同余"></a></p>
<table>
<thead>
<tr>
<th>语法</th>
<th>效果</th>
<th>语法</th>
<th>效果</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>\pmod{m}</code></td>
<td>\(\pmod{m}\)</td>
<td><code>a \bmod b</code></td>
<td>\(a \bmod b\)</td>
</tr>
</tbody>
</table>
<p><a id="table--微分"></a></p>
<table>
<thead>
<tr>
<th>语法</th>
<th>效果</th>
<th>语法</th>
<th>效果</th>
<th>语法</th>
<th>效果</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>\nabla</code></td>
<td>\(\nabla\)</td>
<td><code>\partial x</code></td>
<td>\(\partial x\)</td>
<td><code>\mathrm{d}x</code></td>
<td>\(\mathrm{d}x\)</td>
</tr>
<tr>
<td><code>\dot x</code></td>
<td>\(\dot x\)</td>
<td><code>\ddot y</code></td>
<td>\(\ddot y\)</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p><a id="table--集合"></a></p>
<table>
<thead>
<tr>
<th>语法</th>
<th>效果</th>
<th>语法</th>
<th>效果</th>
<th>语法</th>
<th>效果</th>
<th>语法</th>
<th>效果</th>
<th>语法</th>
<th>效果</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>\forall</code></td>
<td>\(\forall\)</td>
<td><code>\exists</code></td>
<td>\(\exists\)</td>
<td><code>\empty</code></td>
<td>∅</td>
<td><code>\emptyset</code></td>
<td>\(\emptyset\)</td>
<td><code>\varnothing</code></td>
<td>\(\varnothing\)</td>
</tr>
<tr>
<td><code>\in</code></td>
<td>\(\in\)</td>
<td><code>\ni</code></td>
<td>\(\ni\)</td>
<td><code>\not\in</code></td>
<td>\(\not\in\)</td>
<td><code>\notin</code></td>
<td>\(\notin\)</td>
<td><code>\subset</code></td>
<td>\(\subset\)</td>
</tr>
<tr>
<td><code>\subseteq</code></td>
<td>\(\subseteq\)</td>
<td><code>\supset</code></td>
<td>\(\supset\)</td>
<td><code>\supseteq</code></td>
<td>\(\supseteq\)</td>
<td><code>\cap</code></td>
<td>\(\cap\)</td>
<td><code>\bigcap</code></td>
<td>\(\bigcap\)</td>
</tr>
<tr>
<td><code>\cup</code></td>
<td>\(\cup\)</td>
<td><code>\bigcup</code></td>
<td>\(\bigcup\)</td>
<td><code>\biguplus</code></td>
<td>\(\biguplus\)</td>
<td><code>\sqsubset</code></td>
<td>\(\sqsubset\)</td>
<td><code>\sqsubseteq</code></td>
<td>\(\sqsubseteq\)</td>
</tr>
<tr>
<td><code>\sqsupset</code></td>
<td>\(\sqsupset\)</td>
<td><code>\sqsupseteq</code></td>
<td>\(\sqsupseteq\)</td>
<td><code>\sqcap</code></td>
<td>\(\sqcap\)</td>
<td><code>\sqcup</code></td>
<td>\(\sqcup\)</td>
<td><code>\bigsqcup</code></td>
<td>\(\bigsqcup\)</td>
</tr>
</tbody>
</table>
<p><a id="table--逻辑"></a></p>
<table>
<thead>
<tr>
<th>语法</th>
<th>效果</th>
<th>语法</th>
<th>效果</th>
<th>语法</th>
<th>效果</th>
<th>语法</th>
<th>效果</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>p</code></td>
<td>\(p\)</td>
<td><code>\land</code></td>
<td>\(\land\)</td>
<td><code>\wedge</code></td>
<td>\(\wedge\)</td>
<td><code>\bigwedge</code></td>
<td>\(\bigwedge\)</td>
</tr>
<tr>
<td><code>\bar{q} \to p</code></td>
<td>\(\bar{q} \to p\)</td>
<td><code>\lor</code></td>
<td>\(\lor\)</td>
<td><code>\vee</code></td>
<td>\(\vee\)</td>
<td><code>\bigvee</code></td>
<td>\(\bigvee\)</td>
</tr>
<tr>
<td><code>\lnot</code></td>
<td>\(\lnot\)</td>
<td><code>\neg q</code></td>
<td>\(\neg q\)</td>
<td><code>\setminus</code></td>
<td>\(\setminus\)</td>
<td><code>\smallsetminus</code></td>
<td>\(\smallsetminus\)</td>
</tr>
</tbody>
</table>
<p><a id="table--根号"></a></p>
<table>
<thead>
<tr>
<th>语法</th>
<th>效果</th>
<th>语法</th>
<th>效果</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>\sqrt{3}</code></td>
<td>\(\sqrt{3}\)</td>
<td><code>\sqrt[n]{3}</code></td>
<td>\(\sqrt[n]{3}\)</td>
</tr>
</tbody>
</table>
<p><a id="table--排版"></a></p>
<table>
<thead>
<tr>
<th>语法</th>
<th>效果</th>
<th>语法</th>
<th>效果</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>A \quad B</code></td>
<td>\(A \quad B\)</td>
<td><code>A \qquad B</code></td>
<td>\(A \qquad B\)</td>
</tr>
<tr>
<td><code>NORMAL-\mathrm{UPRIGHT}</code></td>
<td>\(NORMAL-\mathrm{UPRIGHT}\)</td>
<td><code>NORMAL-\mathrm{\small SAMLL}</code></td>
<td>\(NORMAL-\mathrm{\small SMALL}\)</td>
</tr>
<tr>
<td><code>NORMAL-\mathrm{\scriptsize SCRIPTSIZE}</code></td>
<td>\(NORMAL-\mathrm{\scriptsize SCRIPTSIZE}\)</td>
<td><code>NORMAL-\mathrm{\tiny TINY}</code></td>
<td>\(NORMAL-\mathrm{\tiny TINY}\)</td>
</tr>
</tbody>
</table>
]]></content:encoded>
    </item>
    
    <item>
      <title>FIFO broadcast</title>
      <link>https://sheerwill.live/posts/main/20220616105609-fifo_broadcast/</link>
      <pubDate>Wed, 22 Jun 2022 14:30:35 +0800</pubDate>
      
      <guid>https://sheerwill.live/posts/main/20220616105609-fifo_broadcast/</guid>
      <description>Definition 最弱的广播类型称为先进先出（FIFO）广播。在这个模型中，由同一节点发送的信息按照发送的顺序传递。例如下图中，\(m_{1}\) 必须在 \(m_{3}\) 之</description>
      <content:encoded><![CDATA[<h2 id="definition">Definition</h2>
<p>最弱的广播类型称为先进先出（FIFO）广播。在这个模型中，由同一节点发送的信息按照发送的顺序传递。例如下图中，\(m_{1}\) 必须在 \(m_{3}\) 之前被传递，因为它们都是由 \(A\) 发送的。然而，\(m_{2}\) 可以在 \(m_{1}\) 和 \(m_{3}\) 之前、之间或之后的任何时间被传递。</p>
<figure>
    <img loading="lazy" src="/ox-hugo/FIFO-broadcast.png"
         alt="Figure 1: FIFO-broadcast"/> <figcaption>
            <p><span class="figure-number">Figure 1: </span>FIFO-broadcast</p>
        </figcaption>
</figure>

<p>同一个节点发送的消息必须要按照发送的顺序传递，不同节点发送的消息可以是任意的顺序，比如 \((m_{2}, m_{1}, m_{3})\)，\((m_{1}, m_{2}, m_{3})\) 或者 \((m_{1}, m_{3}, m_{2})\)。</p>
<p>关于这些广播协议的另一个细节：我们假设每当一个节点广播一个消息时，它也会将该消息传递给自己（在上图中用回环箭头表示）。一个节点知道它自己广播了什么消息，所以传递给自己看似没有必要，但在 <a href="/posts/main/20220616135058-total_order_broadcast/">Total order broadcast</a> 中是需要这个步骤。</p>
<p>上图中的执行示例是有效的先进先出「广播」，但它违反了因果性：虽然 \(B\) 在接收了 \(m_{1}\) 之后才广播的 \(m_{2}\)，但节点 \(C\) 在 \(m_{1}\) 之前就传递了 \(m_{2}\)。<a href="/posts/main/20220616132407-causal_broadcast/">Causal broadcast</a> 提供了一个比 FIFO broadcast  更严格的排序属性。顾名思义，它确保信息按因果顺序传递：也就是说，如果一条信息的广播发生在另一条信息的广播之前，那么所有节点必须按这个顺序传递这两条信息。如果两个消息是同时广播的，一个节点可以按任何一个顺序传递它们。</p>
<h2 id="fifo-broadcast-algorithm">FIFO broadcast algorithm</h2>
<blockquote>
<p><strong>on</strong> initialisation <strong>do</strong> <br />
\(\qquad sendSeq := 0; delivered := \langle0, 0, &hellip;, 0\rangle; buﬀer := \{\}\) <br />
<strong>end on</strong></p>
<p><strong>on</strong> request to broadcast \(m\) at node \(N_{i}\) <strong>do</strong> <br />
\(\qquad\)​send \((i, sendSeq, m)\) via reliable broadcast <br />
\(\qquad sendSeq := sendSeq + 1\) <br />
<strong>end on</strong></p>
<p><strong>on</strong> receiving \(msg\)<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup> from reliable broadcast at node \(N_{i}\) <strong>do</strong> <br />
\(\qquad buﬀer := buﬀer ∪ {msg}\) <br />
\(\qquad\)​<strong>while</strong> \(∃sender, m. (sender, delivered[sender], m) ∈ buﬀer\) <strong>do</strong> <br />
\(\qquad\qquad\)​deliver \(m\) to the application <br />
\(\qquad\qquad delivered[sender] := delivered[sender] + 1\) <br />
\(\qquad\)​<strong>end while</strong> <br />
<strong>end on</strong></p>
</blockquote>
<p>节点 \(N_{i}\) 发送的每个 FIFO broadcast 消息都会附带发送节点编号 \(i\) 和一个序列号（该节点发送消息对应的序列号，第一条消息对应为 0，第二条消息对应为 1）。每个节点的本地状态由序列号 \(sendSeq\)（计算该节点广播的消息数量）、\(delivered\)（一个向量，每个节点有一个条目，统计了每个节点发送消息并传递到该节点的数量）和 \(buﬀer\)（一个缓存，用于保留消息直到它们准备好被传递给 Application，也就是 <a href="/posts/main/20220602202933-distribution_system/#receiving-versus-delivering">Receiving versus delivering</a> 中提到的 deliver 阶段）组成。该算法检查来自任何发送者的与预期的下一个序列号相匹配的消息，然后递增该序列号，确保来自每个特定发送者的消息按照序列号递增的顺序被传递。</p>
<h2 id="summary">Summary</h2>
<p>FIFO broadcast 的保持消息顺序的原理和 <a href="/posts/main/20220609201658-lamport_clocks/">Lamport clocks</a> 很相似，都是用递增的整数来确定同一个节点上的消息传递的顺序，\(deliver\) 是个存放着所有节点 \(sendSeq\) 的向量，存放于每个节点，配合 \(sendSeq\) 控制来自同一个节点的消息传递的顺序。</p>
<div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p>\(msg\) 就是 \((i, sendSeq, m)\)&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</div>
]]></content:encoded>
    </item>
    
    <item>
      <title>Total order broadcast</title>
      <link>https://sheerwill.live/posts/main/20220616135058-total_order_broadcast/</link>
      <pubDate>Mon, 20 Jun 2022 14:47:46 +0800</pubDate>
      
      <guid>https://sheerwill.live/posts/main/20220616135058-total_order_broadcast/</guid>
      <description>Definition 总秩序广播（total order broadcast），有时也被称为原子广播（atomic broadcast）。FIFO broadcast 和 Causal broadcast 允许不同的节点以不同</description>
      <content:encoded><![CDATA[<h2 id="definition">Definition</h2>
<p>总秩序广播（total order broadcast），有时也被称为原子广播（atomic broadcast）。<a href="/posts/main/20220616105609-fifo_broadcast/">FIFO broadcast</a> 和 <a href="/posts/main/20220616132407-causal_broadcast/">Causal broadcast</a> 允许不同的节点以不同的顺序传递信息，total order broadcast 在各节点之间强制执行一致性，确保所有节点以相同的顺序传递信息。精确的传递顺序没有规定，只要它在所有节点上都是一样的。</p>
<figure>
    <img loading="lazy" src="/ox-hugo/total-order-broadcast-1.png"
         alt="Figure 1: total-order-broadcast-1"/> <figcaption>
            <p><span class="figure-number">Figure 1: </span>total-order-broadcast-1</p>
        </figcaption>
</figure>

<p>所有三个节点都按照 \(m_{1}\), \(m_{2}\), \(m_{3}\) 的顺序传递消息</p>
<figure>
    <img loading="lazy" src="/ox-hugo/total-order-broadcast-2.png"
         alt="Figure 2: total-order-broadcast-2"/> <figcaption>
            <p><span class="figure-number">Figure 2: </span>total-order-broadcast-2</p>
        </figcaption>
</figure>

<p>所有三个节点都按照 \(m_{1}\), \(m_{3}\), \(m_{2}\) 的顺序传递信息。只要节点同意，这两种执行方式都是有效的。</p>
<p>与 <a href="/posts/main/20220616132407-causal_broadcast/">Causal broadcast</a> 一样，节点可能需要保留消息，等待其他需要首先传递的消息。例如，节点 \(C\) 可以按任一顺序接收消息 \(m_{2}\) 和 \(m_{3}\)。如果算法确定 \(m_{3}\) 应该在 \(m_{2}\) 之前传递，但如果节点 \(C\) 首先收到 \(m_{2}\)，那么 \(C\) 将需要保留 \(m_{2}\)，直到收到 \(m_{3}\) 之后。</p>
<p>在这些图上可以看到另一个重要的细节：在 <a href="/posts/main/20220616105609-fifo_broadcast/">FIFO broadcast</a> 和 <a href="/posts/main/20220616132407-causal_broadcast/">Causal broadcast</a> 的情况下，当一个节点广播一个消息时，它可以立即将该消息传递给自己，而不必等待与任何其他节点的通信。这在全序广播中不再是这样：例如，在 图<sub>total-order-broadcast-1</sub> 上，\(m_{2}\) 需要在 \(m_{3}\) 之前被传递，所以节点 \(A\) 向自己传递 \(m_{3}\) 必须等到 \(A\) 从 \(B\) 那里收到 \(m_{2}\) 之后。</p>
<p>最后，FIFO-total order broadcast 和 total order broadcast 很像，多了一个先进先出的要求，即同一节点广播的任何消息都按其发送的顺序交付。实际上图<sub>total-order-broadcast-1</sub> 和图<sub>total-order-broadcast-2</sub> 的例子就是有效的 FIFO-total order broadcast，因为 \(m_{1}\) 都是在 \(m_{3}\) 之前被传递的。</p>
<h2 id="total-order-broadcast-algorithms">Total order broadcast algorithms</h2>
<blockquote>
<p><strong>Single leader</strong> approach:</p>
<ul>
<li>指定一个节点为 leader</li>
<li>想要广播消息，将其发送给 leader，leader 再将其通过 <a href="/posts/main/20220616105609-fifo_broadcast/">FIFO broadcast</a> 广播给其他节点。</li>
<li>Problem: leader 崩溃 \(\Longrightarrow\) 没有消息被传递</li>
<li>安全地更换 leader 很困难</li>
</ul>
<p><a href="/posts/main/20220609201658-lamport_clocks/">Lamport clocks</a> approach:</p>
<ul>
<li>每条消息附带上 lamport 时间戳</li>
<li>按照时间戳的总顺序传递消息</li>
<li>Problem: 无法知道是否收到了所有时间戳小于 \(T\)<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup> 的消息，需要在缓存中缓存来自每个节点时间戳大于等于 \(T\) 的消息。</li>
</ul>
</blockquote>
<p>上述两个方法，都不具有容错性。单个节点崩溃以及 leader 节点崩溃都会使得其他节点无法传递消息。</p>
<div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p>当前节点的时间戳 \(T\)&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</div>
]]></content:encoded>
    </item>
    
    <item>
      <title>Converting callbacks to promises</title>
      <link>https://sheerwill.live/posts/main/20220506193545-converting_callbacks_to_promises/</link>
      <pubDate>Sat, 11 Jun 2022 11:49:29 +0800</pubDate>
      
      <guid>https://sheerwill.live/posts/main/20220506193545-converting_callbacks_to_promises/</guid>
      <description>这里用 setTimeout() 模仿异步请求。 const callbackFn = (firstName, callback) =&amp;gt; { setTimeout(() =&amp;gt; { if (!firstName) return callback(new Error(&amp;#34;no first name passed in!&amp;#34;)); // failed const fullName = `${firstName} Doe`; return callback(fullName); // succeed }, 2000); }; callbackFn(&amp;#34;John&amp;#34;, console.log); callbackFn(null, console.log); Promise 实现如下 const promiseFn = (firstName) =&amp;gt; { return new Promise((resolve, reject) =&amp;gt; { setTimeout(() =&amp;gt; { if (!firstName)</description>
      <content:encoded><![CDATA[<p>这里用 <code>setTimeout()</code> 模仿异步请求。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">callbackFn</span> <span class="o">=</span> <span class="p">(</span><span class="nx">firstName</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">setTimeout</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">firstName</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&#34;no first name passed in!&#34;</span><span class="p">));</span> <span class="c1">// failed
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">fullName</span> <span class="o">=</span> <span class="sb">`</span><span class="si">${</span><span class="nx">firstName</span><span class="si">}</span><span class="sb"> Doe`</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">fullName</span><span class="p">);</span> <span class="c1">// succeed
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">},</span> <span class="mi">2000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">callbackFn</span><span class="p">(</span><span class="s2">&#34;John&#34;</span><span class="p">,</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">callbackFn</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">);</span>
</span></span></code></pre></div><p>Promise 实现如下</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">promiseFn</span> <span class="o">=</span> <span class="p">(</span><span class="nx">firstName</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">setTimeout</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">firstName</span><span class="p">)</span> <span class="nx">reject</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&#34;no first name passed in!&#34;</span><span class="p">));</span> <span class="c1">// failed
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">fullName</span> <span class="o">=</span> <span class="sb">`</span><span class="si">${</span><span class="nx">firstName</span><span class="si">}</span><span class="sb"> Doe`</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="nx">resolve</span><span class="p">(</span><span class="nx">fullName</span><span class="p">);</span> <span class="c1">// succeed
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">},</span> <span class="mi">2000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">promiseFn</span><span class="p">(</span><span class="s2">&#34;Jane&#34;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">promiseFn</span><span class="p">().</span><span class="k">catch</span><span class="p">(</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">);</span>
</span></span></code></pre></div><p>这里是 Promise 一些需要注意的点</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">setDelay</span> <span class="o">=</span> <span class="p">(</span><span class="nx">millisecond</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">millisecond</span> <span class="o">!=</span> <span class="s2">&#34;number&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="nx">reject</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&#34;参数必须是number类型&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="nx">setTimeout</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">resolve</span><span class="p">(</span><span class="sb">`我延迟了</span><span class="si">${</span><span class="nx">millisecond</span><span class="si">}</span><span class="sb">毫秒后输出的`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span> <span class="nx">millisecond</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">setDelaySecond</span> <span class="o">=</span> <span class="p">(</span><span class="nx">seconds</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">seconds</span> <span class="o">!=</span> <span class="s2">&#34;number&#34;</span> <span class="o">||</span> <span class="nx">seconds</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="nx">reject</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&#34;参数必须是number类型，并且小于等于10&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="nx">setTimeout</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">resolve</span><span class="p">(</span><span class="sb">`我延迟了</span><span class="si">${</span><span class="nx">seconds</span><span class="si">}</span><span class="sb">秒后输出的，是第二个函数`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span> <span class="nx">seconds</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Promise chains
</span></span></span><span class="line"><span class="cl"><span class="c1">// then 式链式写法的本质其实是一直往下传递返回一个新的 Promise，也就是说 then 在下一步接收的是上一步返回的 Promise。
</span></span></span><span class="line"><span class="cl"><span class="c1">// 处理错误只需要在链式末尾 catch 进行处理就可以。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">setDelay</span><span class="p">(</span><span class="mi">2000</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">result</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;我进行到第一步的&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">setDelaySecond</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">})</span>
</span></span><span class="line"><span class="cl">  <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">result</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;我进行到第二步的&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">})</span>
</span></span><span class="line"><span class="cl">  <span class="p">.</span><span class="k">catch</span><span class="p">((</span><span class="nx">err</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="c1">// Promise 中间返回自定义的值只需要用 `retunPromise.resolve()` 处理就可以。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">setDelay</span><span class="p">(</span><span class="mi">2000</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">result</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;第一步完成了&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">message</span> <span class="o">=</span> <span class="s2">&#34;这是我自己想处理的值&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span> <span class="c1">// 这里返回我想在下一阶段处理的值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">})</span>
</span></span><span class="line"><span class="cl">  <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">result</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;第二步完成了&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span> <span class="c1">// 这里拿到上一阶段的返回值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//return Promise.resolve(&#39;这里可以继续返回&#39;)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">})</span>
</span></span><span class="line"><span class="cl">  <span class="p">.</span><span class="k">catch</span><span class="p">((</span><span class="nx">err</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span></code></pre></div>]]></content:encoded>
    </item>
    
    <item>
      <title>Refactoring Promise chains with async/await</title>
      <link>https://sheerwill.live/posts/main/20220506193624-refactoring_promise_chains_with_async_await/</link>
      <pubDate>Sat, 11 Jun 2022 11:49:15 +0800</pubDate>
      
      <guid>https://sheerwill.live/posts/main/20220506193624-refactoring_promise_chains_with_async_await/</guid>
      <description>const setDelay = (millisecond) =&amp;gt; { return new Promise((resolve, reject) =&amp;gt; { if (typeof millisecond != &amp;#34;number&amp;#34;) reject(new Error(&amp;#34;参数必须是number类型&amp;#34;)); setTimeout(() =&amp;gt; { resolve(`我延迟了${mi</description>
      <content:encoded><![CDATA[<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">setDelay</span> <span class="o">=</span> <span class="p">(</span><span class="nx">millisecond</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">millisecond</span> <span class="o">!=</span> <span class="s2">&#34;number&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="nx">reject</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&#34;参数必须是number类型&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="nx">setTimeout</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">resolve</span><span class="p">(</span><span class="sb">`我延迟了</span><span class="si">${</span><span class="nx">millisecond</span><span class="si">}</span><span class="sb">毫秒后输出的`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span> <span class="nx">millisecond</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">setDelaySecond</span> <span class="o">=</span> <span class="p">(</span><span class="nx">seconds</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">seconds</span> <span class="o">!=</span> <span class="s2">&#34;number&#34;</span> <span class="o">||</span> <span class="nx">seconds</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="nx">reject</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&#34;参数必须是number类型，并且小于等于10&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="nx">setTimeout</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">resolve</span><span class="p">(</span><span class="sb">`我延迟了</span><span class="si">${</span><span class="nx">seconds</span><span class="si">}</span><span class="sb">秒后输出的，注意单位是秒`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span> <span class="nx">seconds</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Promise chains
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">setDelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">result</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">setDelaySecond</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">})</span>
</span></span><span class="line"><span class="cl">  <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">result</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">setDelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">})</span>
</span></span><span class="line"><span class="cl">  <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">result</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;完成&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">})</span>
</span></span><span class="line"><span class="cl">  <span class="p">.</span><span class="k">catch</span><span class="p">((</span><span class="nx">err</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="c1">// async/await
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">(</span><span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">setDelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="kr">await</span> <span class="nx">setDelaySecond</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="kr">await</span> <span class="nx">setDelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;完成了&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">})();</span>
</span></span></code></pre></div><p><code>await</code> 是个运算符，用于组成表达式，~await~ 表达式的运算结果取决于它等的东西。</p>
<p>如果等到的不是个 <code>Promise</code> 对象，那么 <code>await</code> 表达式的运算结果就等于它等到的东西。</p>
<p>如果等到的是个 <code>Promise</code> 对象，那么 <code>await</code> 就会阻塞后面的代码，等着 <code>Promise</code> 对象的 <code>resolved</code> 状态，然后得到 <code>resolve</code> 的值，作为 <code>await</code> 表达式的运算结果。</p>
]]></content:encoded>
    </item>
    
    <item>
      <title>Refactoring Condition statements</title>
      <link>https://sheerwill.live/posts/main/20220506193520-refactoring_condition_statements/</link>
      <pubDate>Sat, 11 Jun 2022 11:48:48 +0800</pubDate>
      
      <guid>https://sheerwill.live/posts/main/20220506193520-refactoring_condition_statements/</guid>
      <description>前端网络请求回调中经常会根据后端返回的不同 code 进行不同的业务处理。 if (res.data.code === &amp;#34;0000&amp;#34;) { //do something } else if (res.data.code === &amp;#34;0001&amp;#34;) { //do something } else if (res.data.code === &amp;#34;0002&amp;#34;) { //do something } else { //do something } 简单应用 const statusCode =</description>
      <content:encoded><![CDATA[<p>前端网络请求回调中经常会根据后端返回的不同 code 进行不同的业务处理。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">code</span> <span class="o">===</span> <span class="s2">&#34;0000&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//do something
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">code</span> <span class="o">===</span> <span class="s2">&#34;0001&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//do something
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">code</span> <span class="o">===</span> <span class="s2">&#34;0002&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//do something
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//do something
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><p>简单应用</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">statusCode</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Map</span><span class="p">([</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="s2">&#34;0000&#34;</span><span class="p">,</span> <span class="s2">&#34;请求成功&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="s2">&#34;0001&#34;</span><span class="p">,</span> <span class="s2">&#34;未授权&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="s2">&#34;0002&#34;</span><span class="p">,</span> <span class="s2">&#34;拒绝访问&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl"><span class="p">]);</span>
</span></span><span class="line"><span class="cl"><span class="nx">statusCode</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="mi">0001</span><span class="p">);</span>
</span></span></code></pre></div><p>复杂业务函数处理</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">getRequest</span> <span class="o">=</span> <span class="p">(</span><span class="nx">params</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;请求打印&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">statusCode</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Map</span><span class="p">([</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;0000&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="kr">async</span> <span class="p">(</span><span class="nx">params</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">getRequest</span><span class="p">(</span><span class="nx">params</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;0001&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nx">params</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;未授权&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;0002&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nx">params</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;拒绝访问&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="cl"><span class="p">]);</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">{};</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">showMessage</span> <span class="o">=</span> <span class="p">(</span><span class="nx">code</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Map 对象转数组
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">[...</span><span class="nx">statusCode</span><span class="p">].</span><span class="nx">forEach</span><span class="p">(([</span><span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">])</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">key</span> <span class="o">===</span> <span class="nx">code</span> <span class="o">?</span> <span class="nx">value</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">params</span><span class="p">)</span> <span class="o">:</span> <span class="s2">&#34;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="nx">showMessage</span><span class="p">(</span><span class="s2">&#34;0000&#34;</span><span class="p">);</span> <span class="c1">// 未授权
</span></span></span></code></pre></div><p><code>forEach()</code> 和 <code>map()</code> 的区别：</p>
<ul>
<li><code>forEach()</code> 会修改原来的数组，而 <code>map()</code> 会得到一个新的数组并返回。所以需要生成新数组的时候，就用后者, 否则就用前者。</li>
</ul>
<p>Map vs Object</p>
<ul>
<li>
<p>According to MDN:</p>
<blockquote>
<p>A Map object can iterate its elements in insertion order - a for..of loop will return an array of [key, value] for each iteration.</p>
</blockquote>
<!--quoteend-->
<blockquote>
<p>Objects are similar to Maps in that both let you set keys to values, retrieve those values, delete keys, and detect whether something is stored at a key. Because of this, Objects have been used as Maps historically; however, there are important differences between Objects and Maps that make using a Map better.</p>
<p>An Object has a prototype, so there are default keys in the map. However, this can be bypassed using map = Object.create(null). The keys of an Object are Strings, where they can be any value for a Map. You can get the size of a Map easily while you have to manually keep track of size for an Object.</p>
</blockquote>
</li>
</ul>
]]></content:encoded>
    </item>
    
    <item>
      <title>How To Find Time Complexity Of An Algorithm</title>
      <link>https://sheerwill.live/posts/main/20220506193205-how_to_find_time_complexity_of_an_algorithm/</link>
      <pubDate>Sat, 11 Jun 2022 11:48:23 +0800</pubDate>
      
      <guid>https://sheerwill.live/posts/main/20220506193205-how_to_find_time_complexity_of_an_algorithm/</guid>
      <description>The most common metric for calculating time complexity is Big O notation. This removes all constant factors so that the running time can be estimated in relation to N as N approaches infinity. In general you can think of it like this:
statement; Is constant. The running time of the statement will not change in relation to N.
for (i = 0; i &amp;lt; N; i++) statement; Is linear. The running time of the loop is directly proportional to N.</description>
      <content:encoded><![CDATA[<p>The most common metric for calculating time complexity is Big O notation. This removes all constant factors so that the running time can be estimated in relation to N as N approaches infinity. In general you can think of it like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="nx">statement</span><span class="p">;</span>
</span></span></code></pre></div><p>Is constant. The running time of the statement will not change in relation to N.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">N</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="nx">statement</span><span class="p">;</span>
</span></span></code></pre></div><p>Is linear. The running time of the loop is directly proportional to N. When N doubles, so does the running time.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">N</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">N</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="nx">statement</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Is quadratic. The running time of the two loops is proportional to the square of N. When N doubles, the running time increases by N * N.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="k">while</span> <span class="p">(</span><span class="nx">low</span> <span class="o">&lt;=</span> <span class="nx">high</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">mid</span> <span class="o">=</span> <span class="p">(</span><span class="nx">low</span> <span class="o">+</span> <span class="nx">high</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nx">target</span> <span class="o">&lt;</span> <span class="nx">list</span><span class="p">[</span><span class="nx">mid</span><span class="p">])</span> <span class="nx">high</span> <span class="o">=</span> <span class="nx">mid</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">target</span> <span class="o">&gt;</span> <span class="nx">list</span><span class="p">[</span><span class="nx">mid</span><span class="p">])</span> <span class="nx">low</span> <span class="o">=</span> <span class="nx">mid</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span> <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Is logarithmic. The running time of the algorithm is proportional to the number of times N can be divided by 2. This is because the algorithm divides the working area in half with each iteration.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="k">void</span> <span class="nx">quicksort</span> <span class="p">(</span> <span class="kr">int</span> <span class="nx">list</span><span class="p">[],</span> <span class="kr">int</span> <span class="nx">left</span><span class="p">,</span> <span class="kr">int</span> <span class="nx">right</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">  <span class="kr">int</span> <span class="nx">pivot</span> <span class="o">=</span> <span class="nx">partition</span> <span class="p">(</span> <span class="nx">list</span><span class="p">,</span> <span class="nx">left</span><span class="p">,</span> <span class="nx">right</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nx">quicksort</span> <span class="p">(</span> <span class="nx">list</span><span class="p">,</span> <span class="nx">left</span><span class="p">,</span> <span class="nx">pivot</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nx">quicksort</span> <span class="p">(</span> <span class="nx">list</span><span class="p">,</span> <span class="nx">pivot</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">right</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Is N * log ( N ). The running time consists of N loops (iterative or recursive) that are logarithmic, thus the algorithm is a combination of linear and logarithmic.</p>
<p>In general, doing something with every item in one dimension is linear, doing something with every item in two dimensions is quadratic, and dividing the working area in half is logarithmic. There are other Big O measures such as cubic, exponential, and square root, but they&rsquo;re not nearly as common. Big O notation is described as O ( ) where is the measure. The quicksort algorithm would be described as O ( N * log ( N ) ).</p>
<p>Note that none of this has taken into account best, average, and worst case measures. Each would have its own Big O notation. Also note that this is a VERY simplistic explanation. Big O is the most common, but it&rsquo;s also more complex that I&rsquo;ve shown. There are also other notations such as big omega, little o, and big theta. You probably won&rsquo;t encounter them outside of an algorithm analysis course. ;)</p>
]]></content:encoded>
    </item>
    
    <item>
      <title>Sort Chinese text fields alphabetically by first letter</title>
      <link>https://sheerwill.live/posts/main/20220601104443-sort_chinese_text_fields_alphabetically_by_first_letter/</link>
      <pubDate>Sat, 11 Jun 2022 11:47:46 +0800</pubDate>
      
      <guid>https://sheerwill.live/posts/main/20220601104443-sort_chinese_text_fields_alphabetically_by_first_letter/</guid>
      <description>UTF8 default Proofing set is Utf8_general_ci, it is not in Chinese. You need to force MySQL to sort by Chinese. select * FROM MyTable ORDER by CONVERT (Chinesecolumnname USING GBK) COLLATE gbk_chinese_ci; 为了达到更快更效率的查询，需要另外再建立一个索引列，并在索引列中插入标签字第</description>
      <content:encoded><![CDATA[<p>UTF8 default Proofing set is <code>Utf8_general_ci</code>, it is not in Chinese. You need to force MySQL to sort by Chinese.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">MyTable</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="k">CONVERT</span><span class="w"> </span><span class="p">(</span><span class="n">Chinesecolumnname</span><span class="w"> </span><span class="k">USING</span><span class="w"> </span><span class="n">GBK</span><span class="p">)</span><span class="w"> </span><span class="k">COLLATE</span><span class="w"> </span><span class="n">gbk_chinese_ci</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>为了达到更快更效率的查询，需要另外再建立一个索引列，并在索引列中插入标签字第一个字母或者是拼音。</p>
]]></content:encoded>
    </item>
    
    <item>
      <title>Troubleshoot Issues in MySQL</title>
      <link>https://sheerwill.live/posts/main/20220530180443-troubleshoot_issues_in_mysql/</link>
      <pubDate>Sat, 11 Jun 2022 11:47:23 +0800</pubDate>
      
      <guid>https://sheerwill.live/posts/main/20220530180443-troubleshoot_issues_in_mysql/</guid>
      <description>Mysql 无法更新表 查询是否有锁表。 SHOW OPEN TABLES WHERE In_use &amp;gt; 0; 查询是否有正在执行的事务 SELECT * FROM INFORMATION_SCHEMA.INNODB_TRX;</description>
      <content:encoded><![CDATA[<h2 id="mysql-无法更新表">Mysql 无法更新表</h2>
<ol>
<li>
<p>查询是否有锁表。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w">    </span><span class="k">SHOW</span><span class="w"> </span><span class="k">OPEN</span><span class="w"> </span><span class="n">TABLES</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">In_use</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div></li>
<li>
<p>查询是否有正在执行的事务</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">INFORMATION_SCHEMA</span><span class="p">.</span><span class="n">INNODB_TRX</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div></li>
</ol>
]]></content:encoded>
    </item>
    
    <item>
      <title>Figma</title>
      <link>https://sheerwill.live/posts/main/20220503154744-figma/</link>
      <pubDate>Sat, 11 Jun 2022 11:41:35 +0800</pubDate>
      
      <guid>https://sheerwill.live/posts/main/20220503154744-figma/</guid>
      <description>Plugin Scale Scale any frame, it’s contents, and all effects to any defined width or height. Sankey Connect Sankey Diagram Connect. </description>
      <content:encoded><![CDATA[<h2 id="plugin">Plugin</h2>
<ul>
<li><a href="https://www.figma.com/community/plugin/836326694968364056/Scale">Scale</a> Scale any frame, it’s contents, and all effects to any defined width or height.</li>
<li><a href="https://www.figma.com/community/plugin/991975059967102509/Sankey-Connect">Sankey Connect</a> Sankey Diagram Connect.</li>
</ul>
]]></content:encoded>
    </item>
    
    <item>
      <title>Build Diagram</title>
      <link>https://sheerwill.live/posts/main/20220503145636-build_diagram/</link>
      <pubDate>Sat, 11 Jun 2022 11:41:12 +0800</pubDate>
      
      <guid>https://sheerwill.live/posts/main/20220503145636-build_diagram/</guid>
      <description>Sankey diagram 使用软件：Figma Plugin: Sankey Connect 展现数据流动的利器 案例：工作流描述 初始的思路是按照流程图来画，用 Excalidraw 插件画起来很快，但不够明晰。工作流也是处理数</description>
      <content:encoded><![CDATA[<h2 id="sankey-diagram">Sankey diagram</h2>
<ul>
<li>使用软件：<a href="/posts/main/20220503154744-figma/">Figma</a>
<ul>
<li>Plugin: Sankey Connect</li>
</ul>
</li>
<li>展现数据流动的利器</li>
<li>案例：工作流描述
<ul>
<li>
<p>初始的思路是按照流程图来画，用 Excalidraw 插件画起来很快，但不够明晰。工作流也是处理数据流动的过程，适合用 Sankey diagram 来展示。</p>
</li>
<li>
<p>对比</p>
<figure>
            <img loading="lazy" src="/ox-hugo/take-notes-draft.png"
                 alt="Figure 1: take-notes-draft"/> <figcaption>
                    <p><span class="figure-number">Figure 1: </span>take-notes-draft</p>
                </figcaption>
        </figure>

<figure>
            <img loading="lazy" src="/ox-hugo/take-notes-draft_1.png"
                 alt="Figure 2: take-notes-draft_1"/> <figcaption>
                    <p><span class="figure-number">Figure 2: </span>take-notes-draft_1</p>
                </figcaption>
        </figure>

<figure>
            <img loading="lazy" src="/ox-hugo/take-notes-sankey.png"
                 alt="Figure 3: take-notes-sankey"/> <figcaption>
                    <p><span class="figure-number">Figure 3: </span>take-notes-sankey</p>
                </figcaption>
        </figure>

</li>
<li>
<p>技巧</p>
<ul>
<li>Connect 的渐变色是将颜色从 Solid 改为 Linear，然后把两端的色块拖动到 Node 处并改为对应 Node 的颜色。</li>
<li>Connect 要尽量弧度舒缓，有美感；留白要均匀。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="heat-map">Heat Map</h2>
<ul>
<li>
<p>使用软件：Figma</p>
</li>
<li>
<p>展现过程中频次高低</p>
</li>
<li>
<p>案例：描述 GTD 和 Note-Taking 过程中思考频次高低。</p>
<figure>
        <img loading="lazy" src="/ox-hugo/gtd_note_taking_dark.png"
             alt="Figure 4: gtd_note_taking_dark"/> <figcaption>
                <p><span class="figure-number">Figure 4: </span>gtd_note_taking_dark</p>
            </figcaption>
    </figure>

<figure>
        <img loading="lazy" src="/ox-hugo/gtd_note_taking_light.png"
             alt="Figure 5: gtd_note_taking_light"/> <figcaption>
                <p><span class="figure-number">Figure 5: </span>gtd_note_taking_light</p>
            </figcaption>
    </figure>

</li>
</ul>
]]></content:encoded>
    </item>
    
    <item>
      <title>Implementation Intention GTD</title>
      <link>https://sheerwill.live/posts/article/20220503143427-gtd/</link>
      <pubDate>Sat, 11 Jun 2022 11:39:58 +0800</pubDate>
      
      <guid>https://sheerwill.live/posts/article/20220503143427-gtd/</guid>
      <description>Introduction 2013年时，第一次接触到 GTD 是因为 Omnifocus 的美观，为此我还花了 $9.99 买了 iOS 的客户端。但从那个时候起，我一直没有用好 GTD 这套理论和各种工具，例如 Omni</description>
      <content:encoded><![CDATA[<h2 id="introduction">Introduction</h2>
<p>2013年时，第一次接触到 GTD 是因为 Omnifocus 的美观，为此我还花了 $9.99 买了 iOS 的客户端。但从那个时候起，我一直没有用好 GTD 这套理论和各种工具，例如 Omnifocus、Things 等等。</p>
<p>一直不明白问题出在哪里，一天下来不管是 Today 还是 Inbox 当中的 To-Do 不仅没有变少，甚至更多了。自我怀疑、自我谴责让自己觉得是拖延症、懒造成了 To-Do 积压。</p>
<p>回顾过去几年中，除了 Things 以外，我还使用了 Due 和 Fantastical 这两款软件。前者是吃药的时候，循环提醒该吃药了；后者是今天或者未来某天必须要做的事情，为了不让我忘记这个事情，哪怕我不确定这个事情在当天的哪个时间段做，都会给它加一个提醒，这样即便是过了时间，只要没有 checked 就会一直在锁屏或者下拉通知内，这样我就可以*不断地被提醒，找到合适的时间段去完成这件事情*​。</p>
<p>至于 Things 时常被我厌恶，因为我有太多的 To-Do 积压在里面。每次打开它都有种翻开垃圾桶的感觉，没错，它就是垃圾桶。我再次捡起 Things 用的时候，基本都是我把“过期了的”、“没有意义的” To-Do 清空了才可以。这是一个循环往复的过程，过程中不断地伤害着我自己的自信心，并让我感到焦虑，永远做不完的事情，越积越多。</p>
<p>在这样的情况下我了解到了 <a href="https://en.wikipedia.org/wiki/Implementation_intention">Implementation Intention</a>。</p>
<h2 id="implementation-intention">Implementation Intention</h2>
<blockquote>
<p>执行意图由心理学家 Peter M.Gollitzer 提出，是个体为实现某一目标制定的一种计划，表现为“如果－那么”形式，例如“如果我遇到突发情况，那么我将保持冷静”。</p>
<p>普通人思考目标的时候，使用的是目标意图，即：我要做什么、我要成为什么。目标意图有个最大的缺点：建立目标容易，执行目标很难。而执行意图更多思考的是要怎么做的问
题。</p>
<p>执行意图明确了个体在何时何地，以什么方式来实现目标，从而让个体更加容易地提取具体情景线索的心理表征，并通过这些线索建立起与目标所指行为的联系。在建立起线索和目标行为的联系之后，个体在随后遇到线索所指向的情景时（如考场），便可以用一种自动化的方式执行事先形成的计划，达成预设的目标。重要的是，执行意图的这种过程是自动化进行的，并不需要个体有意识地进行控制。</p>
</blockquote>
<p>再结合成功实行 GTD 的案例「<a href="https://www.calnewport.com/blog/2013/12/21/deep-habits-the-importance-of-planning-every-minute-of-your-work-day/">Deep Habits: The Importance of Planning Every Minute of Your Work Day</a>」和「<a href="https://www.nirandfar.com/todo-vs-schedule-builder/">Be a Schedule Builder, Not a To-Do List Maker</a>」，发现他们都会去在前一天花费一些时间去细化第二天的任务列表，甚至精确到分钟，这其实就是上面提到的 Implementation Intention 的实际操作，When Where and How。</p>
<p>案例1当中是通过日历来安排一天的工作，细致到分钟。若发生变故需要变更，则在右侧重新记录变更后的安排。</p>
<figure>
    <img loading="lazy" src="/ox-hugo/gtd_dark.png"
         alt="Figure 1: gtd_dark"/> <figcaption>
            <p><span class="figure-number">Figure 1: </span>gtd_dark</p>
        </figcaption>
</figure>

<p>案例2中则从容很多，不仅仅是安排了工作的内容，休闲娱乐的内容也会排在日历当中。(下图来自于案例2)</p>
<figure>
    <img loading="lazy" src="/ox-hugo/gtd_schedule_builder.png"
         alt="Figure 2: gtd_schedule_builder"/> <figcaption>
            <p><span class="figure-number">Figure 2: </span>gtd_schedule_builder</p>
        </figcaption>
</figure>

<p>其实回顾到上面我提到使用 Due 和 Fantastical 的经历，当中已经包含了执行意图的概念，任务都非常明晰，是今天必须要做的，是今天有非常合适的情景去做的，只不过是我没有意识到。</p>
<h3 id="执行意图-会让人主动思考-避免囤积过多的任务">「执行意图」会让人主动思考，避免囤积过多的任务。</h3>
<p>举个例子，按照执行意图的方法。如果我买了一本书，那么我就要在最近的闲暇时间都去读它，并在读完后写读后感总结一下。那么当我买书或者安排任务的时候就会想到买书不仅仅是一个完结，后续意味着我要去读它，并写读后感等一大堆的操作，这样就不会去在自己当前书还没有读完的情况下，就去安排下一本书。</p>
<p>例子中的场景和平时从 Inbox 中安排任务很类似，造成任务完不成，积压，是因为没有安排好任务的情景关系，何时、何地、如何去做这件事情，仅仅就是目标意图，我要做这些事情。</p>
<p>没有对每个任务细致的思考前，无法把握任务的工作量，适合完成的场景，也就无法把控今天安排的任务是否都能完成。但刚刚开始接触这套方法的人，难免会因为对工作细节不熟悉导致工作量评估不准确的情况。</p>
<h3 id="执行意图-消除了在何时何地做某事的模糊性">「执行意图」消除了在何时何地做某事的模糊性。</h3>
<p>例如，询问选民如何前往投票站等简单的问题，已经被证明可以提高当天的投票率。</p>
<p>在这个例子当中，被问的选民其实受到了引导，增加去投票这件事情的确定性。我们也可以利用同样的方法，明确任务，顺着 <code>if...then...</code> 的顺序去完成任务。</p>
<h2 id="回顾">回顾</h2>
<p><a href="https://twitter.com/mikhails5v/status/1521406633548697603">@mikhails5v</a> 在 tweet thread 中提到了他在使用 Things 的 1.5 年中，对于没有完成的任务，在每晚回顾时，手动的去把今天的任务清空，已完成的任务会让他很有成就感；未完成的任务则在思考后移到后面适合的时候，或者重新放回 Inbox，甚至删掉它们。确保了每日的任务都是清空的状态，没有负罪感。即便是没有完成的任务，在每晚也会重新回顾，思考后续是否有合适的情景去完成它，或者干脆觉得没有执行的必要删除掉。</p>
<h2 id="阶段性思考">阶段性思考</h2>
<blockquote>
<p>note-taking and knowledge creation will always require large amounts of brain work. On the other hand, GTD makes task management a simple, effortless process.</p>
</blockquote>
<p>对比我在 <a href="/posts/article/20220505162419-how_i_take_notes/">How I Take Notes</a> 中写的笔记的工作流，To-Do 和 Note-Taking 确实存在区别。</p>
<p>GTD 中 Capture 是最不需要思考的，有什么东西直接记录到 Inbox 当中，清空当前的灵感，专注眼前的事情。例如，Things 中快速呼出 Inbox 的输入框；Org-roam 中写在 <code>.org</code> 文件中的 To-Do 都会集中在 Agenda 中；Logseq 中写在 Journals 中的 To-Do 也可以在 Pages 中按照自己的需求定制查询（复杂的查询有些门槛）。后续处理，按照执行意图的方法去评估 To-Do 适合的情景；较大的任务需要进行拆分成若干小任务，甚至形成一个专门的项目分为不同阶段去完成。</p>
<p>Note-Taking 相反，从阅读就开始思考，随后各种灵感迸发，记录下来进行整理，去芜存菁后继续扩展，定期回顾后形成自己的知识并输出，这个时候的写作反而是最不需要动脑的部分了。以下的 Heat Map 表示不同阶段思考的程度。</p>
<figure>
    <img loading="lazy" src="/ox-hugo/gtd_note_taking_dark.png"
         alt="Figure 3: gtd_note_taking_dark"/> <figcaption>
            <p><span class="figure-number">Figure 3: </span>gtd_note_taking_dark</p>
        </figcaption>
</figure>

<h2 id="to-do-是否需要独立管理">To-Do 是否需要独立管理</h2>
<p>至于 To-Do 和 Note-Taking 是否分开，我的看法是逻辑上分开，物理上并不一定分开。</p>
<p>一天 24 小时是由不同阶段组成的，工作、生活、娱乐等等，都会产生 To-Do。那么管理 To-Do 也可以分为不同的场景。</p>
<h3 id="工作">工作</h3>
<p>工作上做好日志记录，是个好习惯，可以方便查阅当时的想法，解决问题的思路，以及相关人员是谁，就跟航海日志一样。这个时候产生的 To-Do 就是与日志息息相关的，上下文联系紧密。加上 Capture 的原则是尽快记录，并且不打断现有的思路，最好的方法就是记录在笔记当中（比如Logseq 的 Journals）。</p>
<p>汇总的话就更加简单了，Logseq 通过 Clojure 的查询语句就可以完成汇总，不会这门语言也没有关系，Discord 中有专门的 Channel 可以提问或讨论。每天上班的第一件事情就是回顾汇总，结合工作进度安排今天的工作。</p>
<h3 id="生活">生活</h3>
<p>生活中琐事居多，场景也非常繁杂，这个时候完全可以用单独的 App 来进行管理。Things 来收集拆分任务，Fantastical 来进行一天时间的分配以及未来几天需要提醒的任务，Due 来提醒重复任务。</p>
<h2 id="conclusion">Conclusion</h2>
<p>警惕 All-In-One 的想法，并不是所有场景都有统一的解决方案。工作和生活分开管理 To-Do 还有个好处，休假的时候你完全可以屏蔽掉工作的内容。</p>
<p>另外不管工作和生活中，长期计划用甘特图来管理还是非常不错的，确立里程碑，控制进度，把握长期计划的走向。</p>
]]></content:encoded>
    </item>
    
  </channel>
</rss>
