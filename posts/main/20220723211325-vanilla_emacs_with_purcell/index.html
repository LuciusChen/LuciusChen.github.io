<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Vanilla Emacs with Purcell | Lucius | Braindump</title>
<meta name="keywords" content="">
<meta name="description" content="Introduction Emacs outshines all other editing software in approximately the same way that the noonday sun does the stars. It is not just bigger and brighter; it simply makes everything else vanish. – Neal Stephenson, In the Beginning was the Command Line (1998) Install Emacs-plus With Homebrew brew tap d12frosted/emacs-plus brew install emacs-plus --with-native-comp --with-modern-vscode-icon ln -s /usr/local/opt/emacs-plus@29/Emacs.app /Applications Build Emacs on UbuntuLucius&rsquo;s Workflow git clone git://git.sv.gnu.org/emacs.git sudo apt install">
<meta name="author" content="Lucius Chen">
<link rel="canonical" href="https://sheerwill.xyz/posts/main/20220723211325-vanilla_emacs_with_purcell/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.fc220c15db4aef0318bbf30adc45d33d4d7c88deff3238b23eb255afdc472ca6.css" integrity="sha256-/CIMFdtK7wMYu/MK3EXTPU18iN7/MjiyPrJVr9xHLKY=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://sheerwill.xyz/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://sheerwill.xyz/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://sheerwill.xyz/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://sheerwill.xyz/apple-touch-icon.png">
<link rel="mask-icon" href="https://sheerwill.xyz/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://sheerwill.xyz/posts/main/20220723211325-vanilla_emacs_with_purcell/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><style>
  #icons {
    display: flex;
    flex-wrap: wrap;
    margin-top: 2em;
  }
  #icons .item {
    width: 80px;
    height: 50px;
    margin: 10px;
  }
  #icons .item .name {
    font-size: 12px;
    user-select: all;
    text-align: center;
  }
  #icons .item .icon {
    display: flex;
    justify-content: center;
  }
  #icons .item svg {
    width: 30px;
    height: 30px;
  }
</style>


  
    
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-MEASUREMENT_ID"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-MEASUREMENT_ID');
        }
      </script>
    
  

<meta property="og:title" content="Vanilla Emacs with Purcell" />
<meta property="og:description" content="Introduction Emacs outshines all other editing software in approximately the same way that the noonday sun does the stars. It is not just bigger and brighter; it simply makes everything else vanish. – Neal Stephenson, In the Beginning was the Command Line (1998) Install Emacs-plus With Homebrew brew tap d12frosted/emacs-plus brew install emacs-plus --with-native-comp --with-modern-vscode-icon ln -s /usr/local/opt/emacs-plus@29/Emacs.app /Applications Build Emacs on UbuntuLucius&rsquo;s Workflow git clone git://git.sv.gnu.org/emacs.git sudo apt install" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://sheerwill.xyz/posts/main/20220723211325-vanilla_emacs_with_purcell/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-02-28T13:51:10+08:00" />
<meta property="article:modified_time" content="2023-02-28T13:51:10+08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Vanilla Emacs with Purcell"/>
<meta name="twitter:description" content="Introduction Emacs outshines all other editing software in approximately the same way that the noonday sun does the stars. It is not just bigger and brighter; it simply makes everything else vanish. – Neal Stephenson, In the Beginning was the Command Line (1998) Install Emacs-plus With Homebrew brew tap d12frosted/emacs-plus brew install emacs-plus --with-native-comp --with-modern-vscode-icon ln -s /usr/local/opt/emacs-plus@29/Emacs.app /Applications Build Emacs on UbuntuLucius&rsquo;s Workflow git clone git://git.sv.gnu.org/emacs.git sudo apt install"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://sheerwill.xyz/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Vanilla Emacs with Purcell",
      "item": "https://sheerwill.xyz/posts/main/20220723211325-vanilla_emacs_with_purcell/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Vanilla Emacs with Purcell",
  "name": "Vanilla Emacs with Purcell",
  "description": "Introduction Emacs outshines all other editing software in approximately the same way that the noonday sun does the stars. It is not just bigger and brighter; it simply makes everything else vanish. – Neal Stephenson, In the Beginning was the Command Line (1998) Install Emacs-plus With Homebrew brew tap d12frosted/emacs-plus brew install emacs-plus --with-native-comp --with-modern-vscode-icon ln -s /usr/local/opt/emacs-plus@29/Emacs.app /Applications Build Emacs on UbuntuLucius\u0026rsquo;s Workflow git clone git://git.sv.gnu.org/emacs.git sudo apt install",
  "keywords": [
    
  ],
  "articleBody": "Introduction Emacs outshines all other editing software in approximately the same way that the noonday sun does the stars. It is not just bigger and brighter; it simply makes everything else vanish.\n– Neal Stephenson, In the Beginning was the Command Line (1998)\nInstall Emacs-plus With Homebrew brew tap d12frosted/emacs-plus brew install emacs-plus --with-native-comp --with-modern-vscode-icon ln -s /usr/local/opt/emacs-plus@29/Emacs.app /Applications Build Emacs on UbuntuLucius’s Workflow git clone git://git.sv.gnu.org/emacs.git sudo apt install build-essential libgtk-3-dev libgnutls28-dev libtiff5-dev libgif-dev libjpeg-dev libpng-dev libxpm-dev libncurses-dev texinfo autoconf cd emacs ./autogen.sh ./configure make -j8 sudo make install telega 中需要 svg 和 webp 的支持\nsudo apt-get install -y librsvg2-dev sudo apt-get install webp Ubuntu 上的 Dropbox 参考 Install - Dropbox，目前的情况是只有命令行启动的客户端才可以同步成功。\ncd ~ \u0026\u0026 wget -O - \"https://www.dropbox.com/download?plat=lnx.x86_64\" | tar xzf - ~/.dropbox-dist/dropboxd 为了使用方便使用，进行了改键，通过下面的命令把 CAPS(66) 和 LCTRL(37) 互换。\nsudo gedit /us r/share/X11/xkb/keycodes/evdev 输入法安装 fcitx-rime，和 MacOS 上的配置通用，放在 ~/.config/fcitx/rime​。\nsudo apt-get install fcitx-rime Personal Settings 目前在 purcell 中就增加或修改了这些文件。\n. ├── lisp ├── ligature.el ├── init-org.el ├── init-sis.el ├── init-rime.el ├── init-font.el ├── init-meow.el ├── beancount.el ├── init-elpa.el ├── init-local.el ├── init-latex.el ├── init-corfu.el ├── init-bibtex.el ├── init-themes.el ├── init-elfeed.el ├── init-telega.el ├── init-translate.el ├── init-org-modern.el ├── init-quick-menus.el ├── init-tree-sitter.el ├── init-org-enhance.el ├── telega-bridge-bot.el └── init-org-transclusion.el ligature.el GitHub - mickeynp/ligature.el: Display typographical ligatures in Emacs，这里是将其中的 ligature.el 下载到 .emacs.d/lisp/ 目录下，加上下列代码。\n;; Enable the www ligature in every possible major mode (ligature-set-ligatures 't '(\"www\")) ;; Enable ligatures in programming modes (ligature-set-ligatures 'prog-mode '(\"www\" \"**\" \"***\" \"**/\" \"*\u003e\" \"*/\" \"\\\\\\\\\" \"\\\\\\\\\\\\\" \"{-\" \"::\" \":::\" \":=\" \"!!\" \"!=\" \"!==\" \"-}\" \"----\" \"--\u003e\" \"-\u003e\" \"-\u003e\u003e\" \"-\u003c\" \"-\u003c\u003c\" \"-~\" \"#{\" \"#[\" \"##\" \"###\" \"####\" \"#(\" \"#?\" \"#_\" \"#_(\" \".-\" \".=\" \"..\" \"..\u003c\" \"...\" \"?=\" \"??\" \";;\" \"/*\" \"/**\" \"/=\" \"/==\" \"/\u003e\" \"//\" \"///\" \"\u0026\u0026\" \"||\" \"||=\" \"|=\" \"|\u003e\" \"^=\" \"$\u003e\" \"++\" \"+++\" \"+\u003e\" \"=:=\" \"==\" \"===\" \"==\u003e\" \"=\u003e\" \"=\u003e\u003e\" \"\u003c=\" \"=\u003c\u003c\" \"=/=\" \"\u003e-\" \"\u003e=\" \"\u003e=\u003e\" \"\u003e\u003e\" \"\u003e\u003e-\" \"\u003e\u003e=\" \"\u003e\u003e\u003e\" \"\u003c*\" \"\u003c*\u003e\" \"\u003c|\" \"\u003c|\u003e\" \"\u003c$\" \"\u003c$\u003e\" \" (defun telega-buffer-face-mode-variable () (interactive) (make-face 'my-telega-face) ;; (set-face-attribute 'my-telega-face nil :font \"M+ 1m\") (set-face-attribute 'my-telega-face nil :font \"Sarasa Mono SC Nerd 13\") (setq buffer-face-mode-face 'my-telega-face) (buffer-face-mode)) (add-hook 'telega-root-mode-hook 'telega-buffer-face-mode-variable) (add-hook 'telega-webpage-mode-hook 'telega-buffer-face-mode-variable) (add-hook 'telega-chat-mode-hook 'telega-buffer-face-mode-variable) 使用 (setf (alist-get 2 telega-avatar-factors-alist) '(0.5 . 0.1)) 来使得本来两行显示的头像缩小至一行显示（头像显示几乎废了）。 在基础字号的基础上（这里是 14）调整特殊字符/字体的缩放就可以完美解决头像裂开的问题了，完整代码如下。 contrib telega 中有个 contrib 的子目录，当中有一些挺实用的功能。这里启用了三种，过滤广告、代码高亮以及短链。\n原生的加载子目录。\n(push (expand-file-name \"contrib\" (file-name-directory (locate-library \"telega\"))) load-path) 使用 straight 的话如下。\n:straight (:host github :repo \"zevlg/telega.el\" :files (:defaults \"contrib\")) Animated Stickers git clone https://github.com/zevlg/tgs2png.git git submodule init git submodule update mkdir build cd build cmake .. make copy tgs2png somewhere into $PATH 这里我编译完就已经是可用的了。\ndisplay-buffer-alist 每次打开 telega 都是占了 emacs 窗口的一半（emacs 我都是全屏使用），需要手动去调整 telega 的窗口。这里设置了一下 display-buffer-alist 之后就可以固定 telega 的窗口在右侧，并且占据窗口的 35% 的宽度。\n(add-hook 'telega-mode-hook (lambda () (display-buffer (current-buffer) '((display-buffer-in-side-window))))) (setq display-buffer-alist '((\"\\\\*Telega Root\\\\*\" . ((display-buffer-in-side-window) (window-width . 0.35) (side . right) (slot . 0) (dedicated . nil))))) 上述代码除了 dedicated 属性，都是由 ChatGPT Plus 生成。不设置该字段为 nil 会导致从 Telega 列表进入聊天 buffer 后重新打开新的 buffer，具体原因参照 dedicated 字段的解释参见 Displaying Buffers in Side Windows (GNU Emacs Lisp Reference Manual)。\n最后总的配置如下。\n;;; init-telega.el --- Custom configuration ;;; Commentary (require-package 'telega) (require-package 'all-the-icons) ;; If language-detection is available, ;; then laguage could be detected automatically ;; for code blocks without language explicitly specified. (require-package 'language-detection) ;; 加载子文件夹 contrib (push (expand-file-name \"contrib\" (file-name-directory (locate-library \"telega\"))) load-path) (require 'telega-mnz) (global-telega-mnz-mode 1) (setq telega-debug t) ;; 自动播放 gif (telega-autoplay-mode 1) (define-key global-map (kbd \"C-c t\") telega-prefix-map) ;; 去除昵称、回复行的背景高亮 (defun my-telega-chat-mode () ;; telega-msg-inline-reply ⊆ telega-msg-heading ;; telega-msg-inline-forward ⊆ telega-msg-heading (set-face-attribute 'telega-msg-heading nil :underline nil :inherit nil ;; Warning: setting attribute ‘:background’ of face ‘telega-msg-heading’: nil value is invalid, use ‘unspecified’ instead. :background 'unspecified) (set-face-attribute 'telega-msg-inline-reply nil :foreground \"#86C166\") ;; 苗 NAE (set-face-attribute 'telega-msg-inline-forward nil :foreground \"#FFB11B\") (set-face-attribute 'telega-entity-type-mention nil :underline '(:style line) :weight 'bold) (set-face-attribute 'telega-msg-self-title nil :foreground \"#E2943B\") ;; 朽葉 KUCHIBA (set-face-attribute 'telega-msg-user-title nil :weight 'bold) (set-face-attribute 'telega-button nil :foreground \"#986DB2\" :box '(:line-width (-2 . -2) :color \"#986DB2\" :style nil)) (set-face-attribute 'telega-button-active nil :foreground \"#ffffff\" :background \"#986DB2\") ;; (setq telega-chat-prompt-format \"🏄🏻〉 \") ;; 缩小 emoji 及特殊字符/字体显示，防止头像裂开。 ;; (add-to-list 'face-font-rescale-alist '(\"Apple Color Emoji\" . 0.8)) (add-to-list 'face-font-rescale-alist '(\"HanaMinA\" . 0.9)) (add-to-list 'face-font-rescale-alist '(\"Noto Sans Egyptian Hieroglyphs\" . 0.675)) (add-to-list 'face-font-rescale-alist '(\"STIXGeneral\" . 0.675)) (add-to-list 'face-font-rescale-alist '(\"Apple Symbols\" . 0.675)) (add-to-list 'face-font-rescale-alist '(\"Noto Sans Kannada\" . 0.675)) (add-to-list 'face-font-rescale-alist '(\"Academy Engraved LET\" . 0.675)) (add-to-list 'face-font-rescale-alist '(\"Kohinoor Devanagari\" . 0.675)) (add-to-list 'face-font-rescale-alist '(\"Geneva\" . 0.675)) (add-to-list 'face-font-rescale-alist '(\"Noto Sans Oriya\" . 0.675))) (add-hook 'telega-chat-mode-hook 'my-telega-chat-mode) ;; 未读提示 (set-face-attribute 'telega-unmuted-count nil :foreground \"#FFB11B\" :weight 'bold) (set-face-attribute 'telega-mention-count nil :foreground \"#FE6DB3\") (set-face-attribute 'telega-muted-count nil :foreground \"#86C166\" :weight 'bold) ;; 多加一条横线在输入和聊天页面之间 (setq telega-symbol-underline-bar (propertize \" \" 'face 'telega-webpage-strike-through)) ;; 聊天列表高亮 (defun lg-telega-root-mode () (hl-line-mode 1)) (defun lg-telega-chat-update (chat) (with-telega-root-buffer (hl-line-highlight))) (add-hook 'telega-chat-update-hook 'lg-telega-chat-update) (add-hook 'telega-root-mode-hook 'lg-telega-root-mode) ;; Linux settings (when *IS-LINUX* (setq telega-root-show-avatars nil) (setq telega-user-show-avatars nil) (setq telega-chat-show-avatars nil) (setq telega-proxies (list '(:server \"127.0.0.1\" :port 7890 :enable t :type (:@type \"proxyTypeSocks5\" :username \"\" :password \"\")) ))) ;; Opening files using external programs (if *IS-MAC* (setcdr (assq t org-file-apps-gnu) 'browse-url-default-macosx-browser) (setcdr (assq t org-file-apps-gnu) 'browse-url-xdg-open)) (setq telega-open-file-function 'org-open-file) ;; 固定 telega 窗口在右侧 (add-hook 'telega-mode-hook (lambda () (display-buffer (current-buffer) '((display-buffer-in-side-window))))) (setq display-buffer-alist '((\"\\\\*Telega Root\\\\*\" . ((display-buffer-in-side-window) (window-width . 0.35) (side . right) (slot . 0) (dedicated . nil))))) (provide 'init-telega) ;;; init-telega.el ends here init-translate.el ;;; init-translate.el --- Custom configuration ;;; Commentary (require-package 'go-translate) (use-package go-translate :bind ((\"C-c t g\" . gts-do-translate) (\"C-c t p\" . go-translate-at-point) (\"C-c t s\" . go-translate-save-kill-ring)) :config (setq gts-translate-list '((\"en\" \"zh\"))) (setq gts-default-translator (gts-translator :picker (gts-prompt-picker) :engines (list (gts-bing-engine) (gts-google-engine)) :render (gts-buffer-render))) ;; Pick directly and use Google RPC API to translate (defun go-translate-at-point () (interactive) (gts-translate (gts-translator :picker (gts-noprompt-picker) :engines (gts-google-rpc-engine) :render (gts-buffer-render)))) ;; Pick directly and add the results into kill-ring (defun go-translate-save-kill-ring () (interactive) (gts-translate (gts-translator :picker (gts-noprompt-picker) :engines (gts-google-engine :parser (gts-google-summary-parser)) :render (gts-kill-ring-render)))) (set-face-attribute 'gts-render-buffer-me-header-backgroud-face nil :background \"#7BA23F\")) (provide 'init-translate) ;;; init-translate.el ends here init-org-modern.el ;;; init-org-modern.el --- Custom configuration ;;; Commentary (require-package 'org-modern) (use-package org-modern :after org :hook (org-mode . org-modern-mode) :init (menu-bar-mode -1) (tool-bar-mode -1) (scroll-bar-mode -1) (setq org-modern-star [\"➫\" \"✦\" \"✜\" \"✲\" \"✸\" \"❅\"] org-hide-emphasis-markers t org-tags-column 0 org-catch-invisible-edits 'show-and-error org-special-ctrl-a/e t org-insert-heading-respect-content t org-modern-table-horizontal 0.2 org-modern-list '((43 . \"➤\") (45 . \"▻\") (42 . \"►\")) org-ellipsis \"[+]\")) (modify-all-frames-parameters '((right-divider-width . 5) (left-divider-width . 5) (internal-border-width . 5))) (dolist (face '(window-divider window-divider-first-pixel window-divider-last-pixel)) (face-spec-reset-face face) (set-face-foreground face (face-attribute 'default :background))) (set-face-background 'fringe (face-attribute 'default :background)) (custom-set-faces '(org-ellipsis ((t (:foreground \"#90B44B\"))))) ;; 鶸萌黄 (provide 'init-org-modern) ;;; init-org-modern.el ends here init-quick-menus.el Daily Log 是按照每天的日期生成，并不是固定的文件名，因此这里写了自定义方法去跳转到今天/昨天的 Daily Log，方便用来回顾。\n;;; init-quick-menus.el --- Custom configuration ;;; Commentary ;; org-starter (require-package 'org-starter) (setq org-refile-use-outline-path 'file) (use-package org-starter :config ;; (add-hook! 'after-init-hook 'org-starter-load-all-files-in-path) (org-starter-def \"~/Dropbox/org\" :files (\"agenda/inbox.org\" :agenda t :key \"i\" :refile (:maxlevel . 2)) (\"agenda/work.org\" :agenda t :key \"w\" :refile (:maxlevel . 2)) (\"agenda/tech-debt.org\" :agenda t :key \"d\" :refile (:maxlevel . 2)) (\"agenda/personal.org\" :agenda t :key \"p\" :refile (:maxlevel . 2)) (\"agenda/books.org\" :agenda t :key \"b\" :refile (:maxlevel . 2)) (\"agenda/someday.org\" :agenda t :key \"s\" :refile (:maxlevel . 2)) (\"agenda/agenda.org\" :agenda t :key \"a\" :refile (:maxlevel . 2)) (\"agenda/note.org\" :agenda t :key \"n\" :refile (:maxlevel . 2)) (\"daily/journal.org\" :agenda t :key \"j\" :refile (:maxlevel . 2)) (\"beancount/2022.beancount\" :agenda nil :key \"c\") (\"beancount/account.beancount\" :agenda nil :key \"m\") (\"beancount/credit.beancount\" :agenda nil :key \"e\") (\"beancount/insurance.beancount\" :agenda nil :key \"u\") (\"beancount/salary.beancount\" :agenda nil :key \"l\") (\"beancount/house.beancount\" :agenda nil :key \"h\") ) ;; hydra (require-package 'hydra) ;; 打开当前日期对应的 daily log 文件 (defun open-today-journal-file () \"Open journal file for today.\" (interactive) (let* ((file-name (format-time-string \"%Y-%m-%d.org\")) (file-path (concat \"~/Dropbox/org/daily/\" file-name))) (if (file-exists-p file-path) (find-file file-path) (message \"Journal file not found for today.\")))) (defun open-yesterday-journal-file () \"Open journal file for yesterday.\" (interactive) (let* ((yesterday-time (time-subtract (current-time) (days-to-time 1))) (file-name (format-time-string \"%Y-%m-%d.org\" yesterday-time)) (file-path (concat \"~/Dropbox/org/daily/\" file-name))) (if (file-exists-p file-path) (find-file file-path) (message \"Journal file not found for yesterday.\")))) (defhydra hydra-org-agenda-menu (:color blue) \" [--\u003e Org-agenda-menu \u003c--] ^^^^------------------------------------------------ _i_: inbox _w_: work _b_: books _d_: tech-debt _a_: agenda _p_: personal _n_: note _s_: someday _j_: journal _t_: today _y_: yesterday [--\u003e Beancount-menu \u003c--] ^^^^------------------------------------------------ _c_: 2022 _m_: account _e_: credit _u_: insurance _l_: salary _h_: house \" (\"i\" org-starter-find-file:inbox) (\"w\" org-starter-find-file:work) (\"d\" org-starter-find-file:tech-debt) (\"p\" org-starter-find-file:personal) (\"b\" org-starter-find-file:books) (\"n\" org-starter-find-file:note) (\"s\" org-starter-find-file:someday) (\"a\" org-starter-find-file:agenda) (\"j\" org-starter-find-file:journal) (\"t\" (open-today-journal-file)) (\"y\" (open-yesterday-journal-file)) (\"c\" org-starter-find-file:2022) (\"m\" org-starter-find-file:account) (\"e\" org-starter-find-file:credit) (\"u\" org-starter-find-file:insurance) (\"l\" org-starter-find-file:salary) (\"h\" org-starter-find-file:house) ):bind(\"C-c e\" . hydra-org-agenda-menu/body)) (provide 'init-quick-menus) ;;; init-quick-menus.el ends here init-tree-sitter.el 其中 elisp 官方还未支持，需要自己编译后放入 tree-sitter-langs 下面。\ngit clone https://github.com/Wilfred/tree-sitter-elisp gcc ./src/parser.c -fPIC -I./ --shared -o elisp.so cp ./elisp.so ~/.tree-sitter-langs/bin 这里第二步的时候报错了\n./src/parser.c:1:10: error: 'tree_sitter/parser.h' file not found with include; use \"quotes\" instead #include ^~~~~~~~~~~~~~~~~~~~~~ \"tree_sitter/parser.h\" 1 error generated. 这里需要将 src/parser.c 头部按照提示修改一下。\n- #include + #include \"tree_sitter/parser.h\" 第三步，由于我是通过 MELPA 安装，路径为 .emacs.d/elpa-29.0/tree-sitter-langs-version/bin​，其中 version 为具体的版本号。\n;;; init-tree-sitter.el --- Configure for tree sitter ;;; Commentary: (require-package 'tree-sitter) (require-package 'tree-sitter-langs) (require 'tree-sitter) (require 'tree-sitter-langs) ;;; Code: (global-tree-sitter-mode) (add-hook 'tree-sitter-after-on-hook #'tree-sitter-hl-mode) ;; Load the language definition for Rust, if it hasn't been loaded. ;; Return the language object. (tree-sitter-require 'rust) (tree-sitter-require 'python) (tree-sitter-require 'javascript) (provide 'init-tree-sitter) ;;; init-tree-sitter.el ends here init-org-enhance.el 一些增强 org 功能的函数，可以方便使用。\n;;; init-org-enhance.el --- Org-mode config -*- lexical-binding: t -*- ;;; Commentary: ;; ============================================================= ;; ============== Org-roam-backlinks-search ================== ;; ============================================================= ;; https://github.com/Vidianos-Giannitsis/Dotfiles/blob/master/emacs/.emacs.d/libs/zettelkasten.org#org-roam-backlinks-search (defcustom org-roam-backlinks-choices '(\"View Backlinks\" \"Go to Node\" \"Quit\") \"List of choices for `org-roam-backlinks-node-read'.\") (defun org-roam-backlinks-query* (NODE) \"Gets the backlinks of NODE with `org-roam-db-query'.\" (org-roam-db-query [:select [source dest] :from links :where (= dest $s1) :and (= type \"id\")] (org-roam-node-id NODE))) (defun org-roam-backlinks-p (SOURCE NODE) \"Predicate function that checks if NODE is a backlink of SOURCE.\" (let* ((source-id (org-roam-node-id SOURCE)) (backlinks (org-roam-backlinks-query* SOURCE)) (id (org-roam-node-id NODE)) (id-list (list id source-id))) (member id-list backlinks))) (defun org-roam-backlinks-poi-or-moc-p (NODE) \"Check if NODE has the tag POI or the tag MOC. Return t if it does.\" (or (string-equal (car (org-roam-node-tags NODE)) \"POI\") (string-equal (car (org-roam-node-tags NODE)) \"MOC\"))) (defun org-roam-backlinks--read-node-backlinks (source) \"Runs `org-roam-node-read' on the backlinks of SOURCE. The predicate used as `org-roam-node-read''s filter-fn is `org-roam-backlinks-p'.\" (org-roam-node-read nil (apply-partially #'org-roam-backlinks-p source))) (defun org-roam-backlinks-node-read (node) \"Read a NODE and run `org-roam-backlinks--read-node-backlinks'. Upon selecting a backlink, prompt the user for what to do with the backlink. The prompt is created with `completing-read' with valid options being everything in the list `org-roam-backlinks-choices'. If the user decides to view the selected node's backlinks, the function recursively runs itself with the selection as its argument. If they decide they want to go to the selected node, the function runs `find-file' and the file associated to that node. Lastly, if they choose to quit, the function exits silently.\" (let* ((backlink (org-roam-backlinks--read-node-backlinks node)) (choice (completing-read \"What to do with NODE: \" org-roam-backlinks-choices))) (cond ((string-equal choice (car org-roam-backlinks-choices)) (org-roam-backlinks-node-read backlink)) ((string-equal choice (cadr org-roam-backlinks-choices)) (find-file (org-roam-node-file backlink))) ((string-equal choice (caddr org-roam-backlinks-choices)))))) (defun org-roam-backlinks-search () \"Select an `org-roam-node' and recursively search its backlinks. This function is a starter function for `org-roam-backlinks-node-read' which gets the initial node selection from `org-roam-node-list'. For more information about this function, check `org-roam-backlinks-node-read'.\" (interactive) (let ((node (org-roam-node-read))) (org-roam-backlinks-node-read node))) (defun org-roam-backlinks-search-from-moc-or-poi () \"`org-roam-backlinks-search' with an initial selection filter. Since nodes tagged as \\\"MOC\\\" or \\\"POI\\\" are the entry points to my personal zettelkasten, I have this helper function which is identical to `org-roam-backlinks-search' but filters initial selection to only those notes. That way, they initial selection has a point as it will be on a node that has a decent amount of backlinks.\" (interactive) (let ((node (org-roam-node-read nil #'org-roam-backlinks-poi-or-moc-p))) (org-roam-backlinks-node-read node))) ;; ============================================================= ;; =========== Dynamic org-agenda with org-roam ============== ;; ============================================================= ;; https://gist.github.com/d12frosted/a60e8ccb9aceba031af243dff0d19b2e (defun vulpea-dynamic-p () \"Return non-nil if current buffer has any todo entry. TODO entries marked as done are ignored, meaning the this function returns nil if current buffer contains only completed tasks.\" (seq-find ; (3) (lambda (type) (eq type 'todo)) (org-element-map ; (2) (org-element-parse-buffer 'headline) ; (1) 'headline (lambda (h) (org-element-property :todo-type h))))) (defun vulpea-dynamic-update-tag () \"Update dynamic tag in the current buffer.\" (when (and (not (active-minibuffer-window)) (vulpea-buffer-p)) (save-excursion (goto-char (point-min)) (let* ((tags (vulpea-buffer-tags-get)) (original-tags tags)) (if (vulpea-dynamic-p) (setq tags (cons \"dynamic\" tags)) (setq tags (remove \"dynamic\" tags))) ;; cleanup duplicates (setq tags (seq-uniq tags)) ;; update tags if changed (when (or (seq-difference tags original-tags) (seq-difference original-tags tags)) (apply #'vulpea-buffer-tags-set tags)))))) (defun vulpea-buffer-p () \"Return non-nil if the currently visited buffer is a note.\" (and buffer-file-name (string-prefix-p (expand-file-name (file-name-as-directory org-roam-directory)) (file-name-directory buffer-file-name)))) (defun vulpea-dynamic-files () \"Return a list of note files containing 'dynamic' tag.\" ; (seq-uniq (seq-map #'car (org-roam-db-query [:select [nodes:file] :from tags :left-join nodes :on (= tags:node-id nodes:id) :where (like tag (quote \"%\\\"dynamic\\\"%\"))])))) (defun vulpea-agenda-files-update (\u0026rest _) \"Update the value of `org-agenda-files'.\" ;; (setq org-agenda-files (vulpea-dynamic-files))) (setq org-agenda-files (seq-uniq (append (vulpea-dynamic-files) (file-expand-wildcards \"~/Dropbox/org/agenda/*.org\"))))) (add-hook 'find-file-hook #'vulpea-dynamic-update-tag) (add-hook 'before-save-hook #'vulpea-dynamic-update-tag) (advice-add 'org-agenda :before #'vulpea-agenda-files-update) (advice-add 'org-todo-list :before #'vulpea-agenda-files-update) ;; functions borrowed from `vulpea' library ;; https://github.com/d12frosted/vulpea/blob/6a735c34f1f64e1f70da77989e9ce8da7864e5ff/vulpea-buffer.el (defun vulpea-buffer-tags-get () \"Return filetags value in current buffer.\" (vulpea-buffer-prop-get-list \"filetags\" \"[ :]\")) (defun vulpea-buffer-tags-set (\u0026rest tags) \"Set TAGS in current buffer. If filetags value is already set, replace it.\" (if tags (vulpea-buffer-prop-set \"filetags\" (concat \":\" (string-join tags \":\") \":\")) (vulpea-buffer-prop-remove \"filetags\"))) (defun vulpea-buffer-tags-add (tag) \"Add a TAG to filetags in current buffer.\" (let* ((tags (vulpea-buffer-tags-get)) (tags (append tags (list tag)))) (apply #'vulpea-buffer-tags-set tags))) (defun vulpea-buffer-tags-remove (tag) \"Remove a TAG from filetags in current buffer.\" (let* ((tags (vulpea-buffer-tags-get)) (tags (delete tag tags))) (apply #'vulpea-buffer-tags-set tags))) (defun vulpea-buffer-prop-set (name value) \"Set a file property called NAME to VALUE in buffer file. If the property is already set, replace its value.\" (setq name (downcase name)) (org-with-point-at 1 (let ((case-fold-search t)) (if (re-search-forward (concat \"^#\\\\+\" name \":\\\\(.*\\\\)\") (point-max) t) (replace-match (concat \"#+\" name \": \" value) 'fixedcase) (while (and (not (eobp)) (looking-at \"^[#:]\")) (if (save-excursion (end-of-line) (eobp)) (progn (end-of-line) (insert \"\\n\")) (forward-line) (beginning-of-line))) (insert \"#+\" name \": \" value \"\\n\"))))) (defun vulpea-buffer-prop-set-list (name values \u0026optional separators) \"Set a file property called NAME to VALUES in current buffer. VALUES are quoted and combined into single string using `combine-and-quote-strings'. If SEPARATORS is non-nil, it should be a regular expression matching text that separates, but is not part of, the substrings. If nil it defaults to `split-string-default-separators', normally \\\"[ \\f\\t\\n\\r\\v]+\\\", and OMIT-NULLS is forced to t. If the property is already set, replace its value.\" (vulpea-buffer-prop-set name (combine-and-quote-strings values separators))) (defun vulpea-buffer-prop-get (name) \"Get a buffer property called NAME as a string.\" (org-with-point-at 1 (when (re-search-forward (concat \"^#\\\\+\" name \": \\\\(.*\\\\)\") (point-max) t) (buffer-substring-no-properties (match-beginning 1) (match-end 1))))) (defun vulpea-buffer-prop-get-list (name \u0026optional separators) \"Get a buffer property NAME as a list using SEPARATORS. If SEPARATORS is non-nil, it should be a regular expression matching text that separates, but is not part of, the substrings. If nil it defaults to `split-string-default-separators', normally \\\"[ \\f\\t\\n\\r\\v]+\\\", and OMIT-NULLS is forced to t.\" (let ((value (vulpea-buffer-prop-get name))) (when (and value (not (string-empty-p value))) (split-string-and-unquote value separators)))) (defun vulpea-buffer-prop-remove (name) \"Remove a buffer property called NAME.\" (org-with-point-at 1 (when (re-search-forward (concat \"\\\\(^#\\\\+\" name \":.*\\n?\\\\)\") (point-max) t) (replace-match \"\")))) ;; ============================================================= ;; ====================== Archiving ========================== ;; ============================================================= ;; (setq org-archive-mark-done nil) ;; (setq org-archive-location \"%s_archive::* Archive\") ;; https://gist.github.com/kepi/2f4acc3cc93403c75fbba5684c5d852d ;; org-archive-subtree-hierarchical.el ;; ;; version 0.2 ;; modified from https://lists.gnu.org/archive/html/emacs-orgmode/2014-08/msg00109.html ;; modified from https://stackoverflow.com/a/35475878/259187 ;; In orgmode ;; * A ;; ** AA ;; *** AAA ;; ** AB ;; *** ABA ;; Archiving AA will remove the subtree from the original file and create ;; it like that in archive target: ;; * AA ;; ** AAA ;; And this give you ;; * A ;; ** AA ;; *** AAA ;; ;; Install file to your include path and include in your init file with: ;; ;; (require 'org-archive-subtree-hierarchical) ;; (setq org-archive-default-command 'org-archive-subtree-hierarchical) ;; (provide 'org-archive-subtree-hierarchical) (setq org-archive-default-command 'org-archive-subtree-hierarchical) (require 'org-archive) (defun org-archive-subtree-hierarchical--line-content-as-string () \"Returns the content of the current line as a string\" (save-excursion (beginning-of-line) (buffer-substring-no-properties (line-beginning-position) (line-end-position)))) (defun org-archive-subtree-hierarchical--org-child-list () \"This function returns all children of a heading as a list. \" (interactive) (save-excursion ;; this only works with org-version \u003e 8.0, since in previous ;; org-mode versions the function (org-outline-level) returns ;; gargabe when the point is not on a heading. (if (= (org-outline-level) 0) (outline-next-visible-heading 1) (org-goto-first-child)) (let ((child-list (list (org-archive-subtree-hierarchical--line-content-as-string)))) (while (org-goto-sibling) (setq child-list (cons (org-archive-subtree-hierarchical--line-content-as-string) child-list))) child-list))) (defun org-archive-subtree-hierarchical--org-struct-subtree () \"This function returns the tree structure in which a subtree belongs as a list.\" (interactive) (let ((archive-tree nil)) (save-excursion (while (org-up-heading-safe) (let ((heading (buffer-substring-no-properties (line-beginning-position) (line-end-position)))) (if (eq archive-tree nil) (setq archive-tree (list heading)) (setq archive-tree (cons heading archive-tree)))))) archive-tree)) (defun org-archive-subtree-hierarchical () \"This function archives a subtree hierarchical\" (interactive) (let ((org-tree (org-archive-subtree-hierarchical--org-struct-subtree)) (this-buffer (current-buffer)) (file (abbreviate-file-name (or (buffer-file-name (buffer-base-buffer)) (error \"No file associated to buffer\"))))) (save-excursion (setq location org-archive-location afile (car (org-archive--compute-location (or (org-entry-get nil \"ARCHIVE\" 'inherit) location))) ;; heading (org-extract-archive-heading location) infile-p (equal file (abbreviate-file-name (or afile \"\")))) (unless afile (error \"Invalid `org-archive-location'\")) (if (\u003e (length afile) 0) (setq newfile-p (not (file-exists-p afile)) visiting (find-buffer-visiting afile) buffer (or visiting (find-file-noselect afile))) (setq buffer (current-buffer))) (unless buffer (error \"Cannot access file \\\"%s\\\"\" afile)) (org-cut-subtree) (set-buffer buffer) (org-mode) (goto-char (point-min)) (while (not (equal org-tree nil)) (let ((child-list (org-archive-subtree-hierarchical--org-child-list))) (if (member (car org-tree) child-list) (progn (search-forward (car org-tree) nil t) (setq org-tree (cdr org-tree))) (progn (goto-char (point-max)) (newline) (org-insert-struct org-tree) (setq org-tree nil))))) (newline) (org-yank) (when (not (eq this-buffer buffer)) (save-buffer)) (message \"Subtree archived %s\" (concat \"in file: \" (abbreviate-file-name afile)))))) (defun org-insert-struct (struct) \"TODO\" (interactive) (when struct (insert (car struct)) (newline) (org-insert-struct (cdr struct)))) (defun org-archive-subtree () (org-archive-subtree-hierarchical) ) ;; ============================================================= ;; ============== Hierachy for title nodes =================== ;; ============================================================= ;; Codes blow are used to general a hierachy for title nodes that under a file (cl-defmethod org-roam-node-doom-filetitle ((node org-roam-node)) \"Return the value of \\\"#+title:\\\" (if any) from file that NODE resides in. If there's no file-level title in the file, return empty string.\" (or (if (= (org-roam-node-level node) 0) (org-roam-node-title node) (org-roam-get-keyword \"TITLE\" (org-roam-node-file node))) \"\")) (cl-defmethod org-roam-node-doom-hierarchy ((node org-roam-node)) \"Return hierarchy for NODE, constructed of its file title, OLP and direct title. If some elements are missing, they will be stripped out.\" (let ((title (org-roam-node-title node)) (olp (org-roam-node-olp node)) (level (org-roam-node-level node)) (filetitle (org-roam-node-doom-filetitle node)) (separator (propertize \" \u003e \" 'face 'shadow))) (cl-case level ;; node is a top-level file (0 filetitle) ;; node is a level 1 heading (1 (concat (propertize filetitle 'face '(shadow italic)) separator title)) ;; node is a heading with an arbitrary outline path (t (concat (propertize filetitle 'face '(shadow italic)) separator (propertize (string-join olp \" \u003e \") 'face '(shadow italic)) separator title))))) (setq org-roam-node-display-template (concat \"${type:10} ${doom-hierarchy:120} \" (propertize \"${tags:*}\" 'face 'org-tag))) ;; ============================================================= ;; ======================== iscroll ========================== ;; ============================================================= (require-package 'iscroll) (add-hook 'org-mode-hook (lambda () (iscroll-mode 1))) ;; ============================================================= ;; =================== dwim-shell-command ==================== ;; ============================================================= (require-package 'dwim-shell-command) (require 'dwim-shell-command) (defun dwim-shell-commands-macos-reveal-in-finder () \"Reveal selected files in macOS Finder.\" (interactive) (dwim-shell-command-on-marked-files \"Reveal in Finder\" \"import AppKit NSWorkspace.shared.activateFileViewerSelecting([\\\"\u003c\u003c*\u003e\u003e\\\"].map{URL(fileURLWithPath:$0)})\" :join-separator \", \" :silent-success t :shell-pipe \"swift -\")) (provide 'init-org-enhance) ;;; init-org-enhance.el ends here telega-bridge-bot.el 用来改善 Matrix 机器人在 TG 中转发的消息展示，包括头像、用户名等。具体源码参见 vendor/telega-bridge-bot.el · BlindingDark/BEmacs - Gitee.com。\ninit-org-transclusion.el 过滤的条件的具体细节见 Org-transclusion User Manual\n;;; init-org-transclusion.el --- Custom configuration ;;; Commentary (require-package 'org-transclusion) (use-package org-transclusion :after org :bind((\"C-c n t\" . org-transclusion-mode))) (defun trival/org-transclusion-select-source (beg end) \"Send transclusion information to kill-ring. See https://org-roam.discourse.group/t/alpha-org-transclusion/830/122\" (interactive \"r\") (let ((lbeg (line-number-at-pos beg)) (lend (line-number-at-pos end)) (filename (concat \"~/\"(string-remove-prefix (file-truename \"~/\") (buffer-file-name))))) (with-temp-buffer (progn (insert \"#+transclude: [[file:\") (insert filename) (insert (format \"]] :lines %d-%d\" lbeg lend)) (clipboard-kill-region (point-min) (point-max)))) (message \"A transcluded link has been sent to your kill-ring.\"))) (defun my/org-insert-link-transclusion (\u0026optional COMPLETE-FILE LINK-LOCATION DESCRIPTION) (interactive \"P\") (org-insert-link COMPLETE-FILE LINK-LOCATION DESCRIPTION) (org-transclusion-make-from-link)) (provide 'init-org-transclusion) ;;; init-org-transclusion.el ends here Export 对于只需要导出某个 header 下的内容的需求，只需要在 header 上加上 :export: 即可。\nMarkdown file brew install pandoc 这里用的是 ox-pandoc，需要先 M-x package-install ox-pandoc 进行安装，​M-x org-pandoc-export-as-gfm 算是我找到最符合 MarkDown 语法的转换了，Emacs 自己的转换会将 Table 转换成 HTML 标签的格式。\nHugo 在文件头部添加\n#+HUGO_BASE_DIR: ~/Dropbox/hugo/ #+HUGO_SECTION: posts/main #+HUGO_WEIGHT: auto #+HUGO_AUTO_SET_LASTMOD: t 需要导出为 时1\n#+begin_mark marked text #+end_mark 需要导出为块级 时，也就是前后的空格不进行 trim。\n#+header: :trim-pre nil :trim-post nil #+begin_mark marked text #+end_mark Latex Dependency 需要安装 texlive\nbrew install texlive Latex 语法 Latex 语法\nPDF 导出报错 Unicode character 考 (U+8003) not set up for use with LaTeX. 是因为 Latex 本身不支持中文。 中文 PDF 导出设置 使用 ElegantPaper，需要将 elegantpaper.cls 文件放在 org 目录下。 安装依赖 代码块需要用到 minted​，需要用到 pygments 作为依赖。\nbrew install pygments 导出文件头部增加 #+LATEX_COMPILER: xelatex #+LATEX_CLASS: elegantpaper #+OPTIONS: prop:t Org Special Blocks ↩︎ ↩︎\n",
  "wordCount" : "12640",
  "inLanguage": "en",
  "datePublished": "2023-02-28T13:51:10+08:00",
  "dateModified": "2023-02-28T13:51:10+08:00",
  "author":[{
    "@type": "Person",
    "name": "Lucius Chen"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://sheerwill.xyz/posts/main/20220723211325-vanilla_emacs_with_purcell/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Lucius | Braindump",
    "logo": {
      "@type": "ImageObject",
      "url": "https://sheerwill.xyz/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
 if (localStorage.getItem("pref-theme") === "dark") {
   document.body.classList.add('dark');
 } else if (localStorage.getItem("pref-theme") === "light") {
   document.body.classList.remove('dark')
 } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
   document.body.classList.add('dark');
 }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://sheerwill.xyz/" accesskey="h" title="Lucius | Braindump (Alt + H)">Lucius | Braindump</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://sheerwill.xyz/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="https://sheerwill.xyz/archives/" title="Archive">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="https://sheerwill.xyz/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      Vanilla Emacs with Purcell
    </h1>
    <div class="post-meta"><span title='2023-02-28 13:51:10 +0800 CST'>February 28, 2023</span>&nbsp;·&nbsp;26 min&nbsp;·&nbsp;12640 words&nbsp;·&nbsp;Lucius Chen

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#introduction" aria-label="Introduction">Introduction</a></li>
                <li>
                    <a href="#install-emacs-plus-with-homebrew" aria-label="Install Emacs-plus With Homebrew">Install Emacs-plus With Homebrew</a></li>
                <li>
                    <a href="#build-emacs-on-ubuntu-lucius-s-workflow--20221204112118-lucius-s-workflow-dot-md" aria-label="Build Emacs on UbuntuLucius&rsquo;s Workflow">Build Emacs on UbuntuLucius&rsquo;s Workflow</a></li>
                <li>
                    <a href="#personal-settings" aria-label="Personal Settings">Personal Settings</a><ul>
                        
                <li>
                    <a href="#ligature-dot-el" aria-label="ligature.el">ligature.el</a></li>
                <li>
                    <a href="#init-org-dot-el" aria-label="init-org.el">init-org.el</a><ul>
                        
                <li>
                    <a href="#org-babel" aria-label="Org-babel">Org-babel</a></li>
                <li>
                    <a href="#plantuml" aria-label="PlantUML">PlantUML</a></li></ul>
                </li>
                <li>
                    <a href="#init-sis-dot-el" aria-label="init-sis.el">init-sis.el</a></li>
                <li>
                    <a href="#init-font-dot-el" aria-label="init-font.el">init-font.el</a></li>
                <li>
                    <a href="#init-rime-dot-el" aria-label="init-rime.el">init-rime.el</a></li>
                <li>
                    <a href="#init-meow-dot-el" aria-label="init-meow.el">init-meow.el</a></li>
                <li>
                    <a href="#beancount-dot-el" aria-label="beancount.el">beancount.el</a></li>
                <li>
                    <a href="#init-epla-dot-el" aria-label="init-epla.el">init-epla.el</a></li>
                <li>
                    <a href="#init-local-dot-el" aria-label="init-local.el">init-local.el</a><ul>
                        
                <li>
                    <a href="#consult" aria-label="Consult">Consult</a></li>
                <li>
                    <a href="#deft" aria-label="Deft">Deft</a></li>
                <li>
                    <a href="#ox-hugo" aria-label="Ox-hugo">Ox-hugo</a></li></ul>
                </li>
                <li>
                    <a href="#init-latex-dot-el" aria-label="init-latex.el">init-latex.el</a><ul>
                        
                <li>
                    <a href="#%e5%af%bc%e5%87%ba" aria-label="导出">导出</a></li>
                <li>
                    <a href="#%e9%a2%84%e8%a7%88" aria-label="预览">预览</a></li></ul>
                </li>
                <li>
                    <a href="#init-corfu-dot-el" aria-label="init-corfu.el">init-corfu.el</a></li>
                <li>
                    <a href="#init-bibtex-dot-el" aria-label="init-bibtex.el">init-bibtex.el</a></li>
                <li>
                    <a href="#init-themes-dot-el" aria-label="init-themes.el">init-themes.el</a></li>
                <li>
                    <a href="#init-elfeed-dot-el" aria-label="init-elfeed.el">init-elfeed.el</a></li>
                <li>
                    <a href="#init-telega-dot-el" aria-label="init-telega.el">init-telega.el</a><ul>
                        
                <li>
                    <a href="#building-tdlib" aria-label="Building TDLib">Building TDLib</a></li>
                <li>
                    <a href="#running-telega-server-in-docker" aria-label="Running telega-server in docker">Running telega-server in docker</a></li>
                <li>
                    <a href="#contrib" aria-label="contrib">contrib</a></li>
                <li>
                    <a href="#animated-stickers" aria-label="Animated Stickers">Animated Stickers</a></li>
                <li>
                    <a href="#display-buffer-alist" aria-label="display-buffer-alist">display-buffer-alist</a></li></ul>
                </li>
                <li>
                    <a href="#init-translate-dot-el" aria-label="init-translate.el">init-translate.el</a></li>
                <li>
                    <a href="#init-org-modern-dot-el" aria-label="init-org-modern.el">init-org-modern.el</a></li>
                <li>
                    <a href="#init-quick-menus-dot-el" aria-label="init-quick-menus.el">init-quick-menus.el</a></li>
                <li>
                    <a href="#init-tree-sitter-dot-el" aria-label="init-tree-sitter.el">init-tree-sitter.el</a></li>
                <li>
                    <a href="#init-org-enhance-dot-el" aria-label="init-org-enhance.el">init-org-enhance.el</a></li>
                <li>
                    <a href="#telega-bridge-bot-dot-el" aria-label="telega-bridge-bot.el">telega-bridge-bot.el</a></li>
                <li>
                    <a href="#init-org-transclusion-dot-el" aria-label="init-org-transclusion.el">init-org-transclusion.el</a></li></ul>
                </li>
                <li>
                    <a href="#export" aria-label="Export">Export</a><ul>
                        
                <li>
                    <a href="#markdown-file" aria-label="Markdown file">Markdown file</a></li>
                <li>
                    <a href="#hugo" aria-label="Hugo">Hugo</a></li>
                <li>
                    <a href="#latex" aria-label="Latex">Latex</a><ul>
                        
                <li>
                    <a href="#dependency" aria-label="Dependency">Dependency</a></li>
                <li>
                    <a href="#latex-%e8%af%ad%e6%b3%95" aria-label="Latex 语法">Latex 语法</a></li>
                <li>
                    <a href="#pdf-%e5%af%bc%e5%87%ba%e6%8a%a5%e9%94%99" aria-label="PDF 导出报错">PDF 导出报错</a></li>
                <li>
                    <a href="#%e4%b8%ad%e6%96%87-pdf-%e5%af%bc%e5%87%ba%e8%ae%be%e7%bd%ae" aria-label="中文 PDF 导出设置">中文 PDF 导出设置</a>
                </li>
            </ul>
            </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h2 id="introduction">Introduction<a hidden class="anchor" aria-hidden="true" href="#introduction">#</a></h2>
<blockquote>
<p>Emacs outshines all other editing software in approximately the same way that the noonday sun does the stars. It is not just bigger and brighter; it simply makes everything else vanish.</p>
<p>– Neal Stephenson, In the Beginning was the Command Line (1998)</p>
</blockquote>
<h2 id="install-emacs-plus-with-homebrew">Install Emacs-plus With Homebrew<a hidden class="anchor" aria-hidden="true" href="#install-emacs-plus-with-homebrew">#</a></h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">brew tap d12frosted/emacs-plus
</span></span><span class="line"><span class="cl">brew install emacs-plus --with-native-comp --with-modern-vscode-icon
</span></span><span class="line"><span class="cl">ln -s /usr/local/opt/emacs-plus@29/Emacs.app /Applications
</span></span></code></pre></div><h2 id="build-emacs-on-ubuntu-lucius-s-workflow--20221204112118-lucius-s-workflow-dot-md">Build Emacs on Ubuntu<a href="/posts/main/20221204112118-lucius_s_workflow/">Lucius&rsquo;s Workflow</a><a hidden class="anchor" aria-hidden="true" href="#build-emacs-on-ubuntu-lucius-s-workflow--20221204112118-lucius-s-workflow-dot-md">#</a></h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">git clone git://git.sv.gnu.org/emacs.git
</span></span><span class="line"><span class="cl">sudo apt install build-essential libgtk-3-dev libgnutls28-dev libtiff5-dev libgif-dev libjpeg-dev libpng-dev libxpm-dev libncurses-dev texinfo autoconf
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> emacs
</span></span><span class="line"><span class="cl">./autogen.sh
</span></span><span class="line"><span class="cl">./configure
</span></span><span class="line"><span class="cl">make -j8
</span></span><span class="line"><span class="cl">sudo make install
</span></span></code></pre></div><p>telega 中需要 svg 和 webp 的支持</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">sudo apt-get install -y librsvg2-dev
</span></span><span class="line"><span class="cl">sudo apt-get install webp
</span></span></code></pre></div><p>Ubuntu 上的 Dropbox 参考 <a href="https://www.dropbox.com/install">Install - Dropbox</a>，目前的情况是只有命令行启动的客户端才可以同步成功。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="nb">cd</span> ~ <span class="o">&amp;&amp;</span> wget -O - <span class="s2">&#34;https://www.dropbox.com/download?plat=lnx.x86_64&#34;</span> <span class="p">|</span> tar xzf -
</span></span><span class="line"><span class="cl">~/.dropbox-dist/dropboxd
</span></span></code></pre></div><p>为了使用方便使用，进行了改键，通过下面的命令把 <code>CAPS(66)</code> 和 <code>LCTRL(37)</code> 互换。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">sudo gedit /us r/share/X11/xkb/keycodes/evdev
</span></span></code></pre></div><p>输入法安装 fcitx-rime，和 MacOS 上的配置通用，放在 <code>~/.config/fcitx/rime</code>​。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">sudo apt-get install fcitx-rime
</span></span></code></pre></div><h2 id="personal-settings">Personal Settings<a hidden class="anchor" aria-hidden="true" href="#personal-settings">#</a></h2>
<p>目前在 <a href="https://github.com/purcell/emacs.d">purcell</a> 中就增加或修改了这些文件。</p>
<pre tabindex="0"><code class="language-nil" data-lang="nil">.
├── lisp
    ├── ligature.el
    ├── init-org.el
    ├── init-sis.el
    ├── init-rime.el
    ├── init-font.el
    ├── init-meow.el
    ├── beancount.el
    ├── init-elpa.el
    ├── init-local.el
    ├── init-latex.el
    ├── init-corfu.el
    ├── init-bibtex.el
    ├── init-themes.el
    ├── init-elfeed.el
    ├── init-telega.el
    ├── init-translate.el
    ├── init-org-modern.el
    ├── init-quick-menus.el
    ├── init-tree-sitter.el
    ├── init-org-enhance.el
    ├── telega-bridge-bot.el
    └── init-org-transclusion.el
</code></pre><h3 id="ligature-dot-el">ligature.el<a hidden class="anchor" aria-hidden="true" href="#ligature-dot-el">#</a></h3>
<p><a href="https://github.com/mickeynp/ligature.el">GitHub - mickeynp/ligature.el: Display typographical ligatures in Emacs</a>，这里是将其中的 <code>ligature.el</code> 下载到 <code>.emacs.d/lisp/</code> 目录下，加上下列代码。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-elisp" data-lang="elisp"><span class="line"><span class="cl"><span class="c1">;; Enable the www ligature in every possible major mode</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">ligature-set-ligatures</span> <span class="ss">&#39;t</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;www&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;; Enable ligatures in programming modes</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">ligature-set-ligatures</span> <span class="ss">&#39;prog-mode</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;www&#34;</span> <span class="s">&#34;**&#34;</span> <span class="s">&#34;***&#34;</span> <span class="s">&#34;**/&#34;</span> <span class="s">&#34;*&gt;&#34;</span> <span class="s">&#34;*/&#34;</span> <span class="s">&#34;\\\\&#34;</span> <span class="s">&#34;\\\\\\&#34;</span> <span class="s">&#34;{-&#34;</span> <span class="s">&#34;::&#34;</span>
</span></span><span class="line"><span class="cl">                                     <span class="s">&#34;:::&#34;</span> <span class="s">&#34;:=&#34;</span> <span class="s">&#34;!!&#34;</span> <span class="s">&#34;!=&#34;</span> <span class="s">&#34;!==&#34;</span> <span class="s">&#34;-}&#34;</span> <span class="s">&#34;----&#34;</span> <span class="s">&#34;--&gt;&#34;</span> <span class="s">&#34;-&gt;&#34;</span> <span class="s">&#34;-&gt;&gt;&#34;</span>
</span></span><span class="line"><span class="cl">                                     <span class="s">&#34;-&lt;&#34;</span> <span class="s">&#34;-&lt;&lt;&#34;</span> <span class="s">&#34;-~&#34;</span> <span class="s">&#34;#{&#34;</span> <span class="s">&#34;#[&#34;</span> <span class="s">&#34;##&#34;</span> <span class="s">&#34;###&#34;</span> <span class="s">&#34;####&#34;</span> <span class="s">&#34;#(&#34;</span> <span class="s">&#34;#?&#34;</span> <span class="s">&#34;#_&#34;</span>
</span></span><span class="line"><span class="cl">                                     <span class="s">&#34;#_(&#34;</span> <span class="s">&#34;.-&#34;</span> <span class="s">&#34;.=&#34;</span> <span class="s">&#34;..&#34;</span> <span class="s">&#34;..&lt;&#34;</span> <span class="s">&#34;...&#34;</span> <span class="s">&#34;?=&#34;</span> <span class="s">&#34;??&#34;</span> <span class="s">&#34;;;&#34;</span> <span class="s">&#34;/*&#34;</span> <span class="s">&#34;/**&#34;</span>
</span></span><span class="line"><span class="cl">                                     <span class="s">&#34;/=&#34;</span> <span class="s">&#34;/==&#34;</span> <span class="s">&#34;/&gt;&#34;</span> <span class="s">&#34;//&#34;</span> <span class="s">&#34;///&#34;</span> <span class="s">&#34;&amp;&amp;&#34;</span> <span class="s">&#34;||&#34;</span> <span class="s">&#34;||=&#34;</span> <span class="s">&#34;|=&#34;</span> <span class="s">&#34;|&gt;&#34;</span> <span class="s">&#34;^=&#34;</span> <span class="s">&#34;$&gt;&#34;</span>
</span></span><span class="line"><span class="cl">                                     <span class="s">&#34;++&#34;</span> <span class="s">&#34;+++&#34;</span> <span class="s">&#34;+&gt;&#34;</span> <span class="s">&#34;=:=&#34;</span> <span class="s">&#34;==&#34;</span> <span class="s">&#34;===&#34;</span> <span class="s">&#34;==&gt;&#34;</span> <span class="s">&#34;=&gt;&#34;</span> <span class="s">&#34;=&gt;&gt;&#34;</span> <span class="s">&#34;&lt;=&#34;</span>
</span></span><span class="line"><span class="cl">                                     <span class="s">&#34;=&lt;&lt;&#34;</span> <span class="s">&#34;=/=&#34;</span> <span class="s">&#34;&gt;-&#34;</span> <span class="s">&#34;&gt;=&#34;</span> <span class="s">&#34;&gt;=&gt;&#34;</span> <span class="s">&#34;&gt;&gt;&#34;</span> <span class="s">&#34;&gt;&gt;-&#34;</span> <span class="s">&#34;&gt;&gt;=&#34;</span> <span class="s">&#34;&gt;&gt;&gt;&#34;</span> <span class="s">&#34;&lt;*&#34;</span>
</span></span><span class="line"><span class="cl">                                     <span class="s">&#34;&lt;*&gt;&#34;</span> <span class="s">&#34;&lt;|&#34;</span> <span class="s">&#34;&lt;|&gt;&#34;</span> <span class="s">&#34;&lt;$&#34;</span> <span class="s">&#34;&lt;$&gt;&#34;</span> <span class="s">&#34;&lt;!--&#34;</span> <span class="s">&#34;&lt;-&#34;</span> <span class="s">&#34;&lt;--&#34;</span> <span class="s">&#34;&lt;-&gt;&#34;</span> <span class="s">&#34;&lt;+&#34;</span>
</span></span><span class="line"><span class="cl">                                     <span class="s">&#34;&lt;+&gt;&#34;</span> <span class="s">&#34;&lt;=&#34;</span> <span class="s">&#34;&lt;==&#34;</span> <span class="s">&#34;&lt;=&gt;&#34;</span> <span class="s">&#34;&lt;=&lt;&#34;</span> <span class="s">&#34;&lt;&gt;&#34;</span> <span class="s">&#34;&lt;&lt;&#34;</span> <span class="s">&#34;&lt;&lt;-&#34;</span> <span class="s">&#34;&lt;&lt;=&#34;</span> <span class="s">&#34;&lt;&lt;&lt;&#34;</span>
</span></span><span class="line"><span class="cl">                                     <span class="s">&#34;&lt;~&#34;</span> <span class="s">&#34;&lt;~~&#34;</span> <span class="s">&#34;&lt;/&#34;</span> <span class="s">&#34;&lt;/&gt;&#34;</span> <span class="s">&#34;~@&#34;</span> <span class="s">&#34;~-&#34;</span> <span class="s">&#34;~&gt;&#34;</span> <span class="s">&#34;~~&#34;</span> <span class="s">&#34;~~&gt;&#34;</span> <span class="s">&#34;%%&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">global-ligature-mode</span> <span class="ss">&#39;t</span><span class="p">)</span>
</span></span></code></pre></div><h3 id="init-org-dot-el">init-org.el<a hidden class="anchor" aria-hidden="true" href="#init-org-dot-el">#</a></h3>
<p>org-roam 和 Emacs 自带的 agenda 可以很方便的将笔记和 GTD 结合起来。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-elisp" data-lang="elisp"><span class="line"><span class="cl"><span class="c1">;;; init-org.el --- Org-mode config -*- lexical-binding: t -*-</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;; Commentary:</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;; Among settings for many aspects of `org-mode&#39;, this code includes</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; an opinionated setup for the Getting Things Done (GTD) system based</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; around the Org Agenda.  I have an &#34;inbox.org&#34; file with a header</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; including</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;;     #+CATEGORY: Inbox</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;     #+FILETAGS: INBOX</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;; and then set this file as `org-default-notes-file&#39;.  Captured org</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; items will then go into this file with the file-level tag, and can</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; be refiled to other locations as necessary.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;; Those other locations are generally other org files, which should</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; be added to `org-agenda-files-list&#39; (along with &#34;inbox.org&#34; org).</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; With that done, there&#39;s then an agenda view, accessible via the</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; `org-agenda&#39; command, which gives a convenient overview.</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; `org-todo-keywords&#39; is customised here to provide corresponding</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; TODO states, which should make sense to GTD adherents.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;;; Code:</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; 都是方便插入超链接的</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">when</span> <span class="vg">*IS-MAC*</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">maybe-require-package</span> <span class="ss">&#39;grab-mac-link</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">maybe-require-package</span> <span class="ss">&#39;org-cliplink</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; 图片宽度</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">org-image-actual-width</span> <span class="no">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">add-hook</span> <span class="ss">&#39;org-mode-hook</span> <span class="ss">&#39;org-indent-mode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; 去除代码块内的缩进</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">org-edit-src-content-indentation</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">org-src-preserve-indentation</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nf">define-key</span> <span class="nv">global-map</span> <span class="p">(</span><span class="nv">kbd</span> <span class="s">&#34;C-c l&#34;</span><span class="p">)</span> <span class="ss">&#39;org-store-link</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nf">define-key</span> <span class="nv">global-map</span> <span class="p">(</span><span class="nv">kbd</span> <span class="s">&#34;C-c a&#34;</span><span class="p">)</span> <span class="ss">&#39;org-agenda</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defvar</span> <span class="nv">sanityinc/org-global-prefix-map</span> <span class="p">(</span><span class="nf">make-sparse-keymap</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;A keymap for handy global access to org helpers, particularly clocking.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nf">define-key</span> <span class="nv">sanityinc/org-global-prefix-map</span> <span class="p">(</span><span class="nv">kbd</span> <span class="s">&#34;j&#34;</span><span class="p">)</span> <span class="ss">&#39;org-clock-goto</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nf">define-key</span> <span class="nv">sanityinc/org-global-prefix-map</span> <span class="p">(</span><span class="nv">kbd</span> <span class="s">&#34;l&#34;</span><span class="p">)</span> <span class="ss">&#39;org-clock-in-last</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nf">define-key</span> <span class="nv">sanityinc/org-global-prefix-map</span> <span class="p">(</span><span class="nv">kbd</span> <span class="s">&#34;i&#34;</span><span class="p">)</span> <span class="ss">&#39;org-clock-in</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nf">define-key</span> <span class="nv">sanityinc/org-global-prefix-map</span> <span class="p">(</span><span class="nv">kbd</span> <span class="s">&#34;o&#34;</span><span class="p">)</span> <span class="ss">&#39;org-clock-out</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nf">define-key</span> <span class="nv">global-map</span> <span class="p">(</span><span class="nv">kbd</span> <span class="s">&#34;C-c o&#34;</span><span class="p">)</span> <span class="nv">sanityinc/org-global-prefix-map</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;; Various preferences</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">org-log-done</span> <span class="no">t</span>
</span></span><span class="line"><span class="cl">      <span class="nv">org-edit-timestamp-down-means-later</span> <span class="no">t</span>
</span></span><span class="line"><span class="cl">      <span class="nv">org-hide-emphasis-markers</span> <span class="no">t</span>
</span></span><span class="line"><span class="cl">      <span class="nv">org-catch-invisible-edits</span> <span class="ss">&#39;show</span>
</span></span><span class="line"><span class="cl">      <span class="nv">org-export-coding-system</span> <span class="ss">&#39;utf-8</span>
</span></span><span class="line"><span class="cl">      <span class="nv">org-fast-tag-selection-single-key</span> <span class="ss">&#39;expert</span>
</span></span><span class="line"><span class="cl">      <span class="nv">org-html-validation-link</span> <span class="no">nil</span>
</span></span><span class="line"><span class="cl">      <span class="nv">org-export-kill-product-buffer-when-displayed</span> <span class="no">t</span>
</span></span><span class="line"><span class="cl">      <span class="nv">org-tags-column</span> <span class="mi">80</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;; Lots of stuff from http://doc.norang.ca/org-mode.html</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;; Re-align tags when window shape changes</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">with-eval-after-load</span> <span class="ss">&#39;org-agenda</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">add-hook</span> <span class="ss">&#39;org-agenda-mode-hook</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="nb">lambda</span> <span class="p">()</span> <span class="p">(</span><span class="nv">add-hook</span> <span class="ss">&#39;window-configuration-change-hook</span> <span class="ss">&#39;org-agenda-align-tags</span> <span class="no">nil</span> <span class="no">t</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;;; Capturing</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">org-directory</span> <span class="s">&#34;~/Dropbox/org/&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">global-set-key</span> <span class="p">(</span><span class="nv">kbd</span> <span class="s">&#34;C-c c&#34;</span><span class="p">)</span> <span class="ss">&#39;org-capture</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">org-capture-templates</span>
</span></span><span class="line"><span class="cl">      <span class="o">`</span><span class="p">((</span><span class="s">&#34;i&#34;</span> <span class="s">&#34;inbox&#34;</span> <span class="nv">entry</span>  <span class="p">(</span><span class="nv">file</span> <span class="s">&#34;agenda/inbox.org&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="o">,</span><span class="p">(</span><span class="nf">concat</span> <span class="s">&#34;* TODO %?\n%U&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="s">&#34;n&#34;</span> <span class="s">&#34;note&#34;</span> <span class="nv">entry</span> <span class="p">(</span><span class="nv">file</span> <span class="s">&#34;agenda/note.org&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="s">&#34;* %? :NOTE:\n%U\n%a\n&#34;</span> <span class="nb">:clock-resume</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;;; Refiling</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">org-refile-use-cache</span> <span class="no">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;; Targets include this file and any file contributing to the agenda - up to 5 levels deep</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">org-refile-targets</span> <span class="o">&#39;</span><span class="p">((</span><span class="no">nil</span> <span class="nb">:maxlevel</span> <span class="o">.</span> <span class="mi">5</span><span class="p">)</span> <span class="p">(</span><span class="nv">org-agenda-files</span> <span class="nb">:maxlevel</span> <span class="o">.</span> <span class="mi">5</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">with-eval-after-load</span> <span class="ss">&#39;org-agenda</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">add-to-list</span> <span class="ss">&#39;org-agenda-after-show-hook</span> <span class="ss">&#39;org-show-entry</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">advice-add</span> <span class="ss">&#39;org-refile</span> <span class="nb">:after</span> <span class="p">(</span><span class="nb">lambda</span> <span class="p">(</span><span class="kp">&amp;rest</span> <span class="nv">_</span><span class="p">)</span> <span class="p">(</span><span class="nv">org-save-all-org-buffers</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;; Exclude DONE state tasks from refile targets</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">sanityinc/verify-refile-target</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;Exclude todo keywords with a done state from refile targets.&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">not</span> <span class="p">(</span><span class="nf">member</span> <span class="p">(</span><span class="nf">nth</span> <span class="mi">2</span> <span class="p">(</span><span class="nv">org-heading-components</span><span class="p">))</span> <span class="nv">org-done-keywords</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">org-refile-target-verify-function</span> <span class="ss">&#39;sanityinc/verify-refile-target</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">sanityinc/org-refile-anywhere</span> <span class="p">(</span><span class="kp">&amp;optional</span> <span class="nv">goto</span> <span class="nv">default-buffer</span> <span class="nv">rfloc</span> <span class="nv">msg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;A version of </span><span class="ss">`org-refile&#39;</span><span class="s"> which allows refiling to any subtree.&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">interactive</span> <span class="s">&#34;P&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">let</span> <span class="p">((</span><span class="nv">org-refile-target-verify-function</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nv">org-refile</span> <span class="nv">goto</span> <span class="nv">default-buffer</span> <span class="nv">rfloc</span> <span class="nv">msg</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">sanityinc/org-agenda-refile-anywhere</span> <span class="p">(</span><span class="kp">&amp;optional</span> <span class="nv">goto</span> <span class="nv">rfloc</span> <span class="nv">no-update</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;A version of </span><span class="ss">`org-agenda-refile&#39;</span><span class="s"> which allows refiling to any subtree.&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">interactive</span> <span class="s">&#34;P&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">let</span> <span class="p">((</span><span class="nv">org-refile-target-verify-function</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nv">org-agenda-refile</span> <span class="nv">goto</span> <span class="nv">rfloc</span> <span class="nv">no-update</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;; Targets start with the file name - allows creating level 1 tasks</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;(setq org-refile-use-outline-path (quote file))</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">org-refile-use-outline-path</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">org-outline-path-complete-in-steps</span> <span class="no">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;; Allow refile to create parent tasks with confirmation</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">org-refile-allow-creating-parent-nodes</span> <span class="ss">&#39;confirm</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;;; To-do settings</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; TODO</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; HOLD(h@)       ; 进入时添加笔记</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; HOLD(h/!)      ; 离开时添加变更信息</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; HOLD(h@/!)     ; 进入时添加笔记，离开时添加变更信息</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">org-todo-keywords</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nb">quote</span> <span class="p">((</span><span class="nv">sequence</span> <span class="s">&#34;TODO(t)&#34;</span> <span class="s">&#34;NEXT(n)&#34;</span> <span class="s">&#34;|&#34;</span> <span class="s">&#34;DONE(d!/!)&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">              <span class="p">(</span><span class="nv">sequence</span> <span class="s">&#34;PROJECT(p)&#34;</span> <span class="s">&#34;|&#34;</span> <span class="s">&#34;DONE(d!/!)&#34;</span> <span class="s">&#34;CANCELLED(c/!)&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">              <span class="p">(</span><span class="nv">sequence</span> <span class="s">&#34;WAITING(w/!)&#34;</span> <span class="s">&#34;DELEGATED(e!)&#34;</span> <span class="s">&#34;HOLD(h)&#34;</span> <span class="s">&#34;|&#34;</span> <span class="s">&#34;CANCELLED(c/!)&#34;</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">      <span class="nv">org-todo-repeat-to-state</span> <span class="s">&#34;NEXT&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">org-todo-keyword-faces</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nb">quote</span> <span class="p">((</span><span class="s">&#34;NEXT&#34;</span> <span class="nb">:inherit</span> <span class="nv">warning</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">              <span class="p">(</span><span class="s">&#34;PROJECT&#34;</span> <span class="nb">:inherit</span> <span class="nv">font-lock-string-face</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;;; Agenda views</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; 将没有时间标记的任务，放在上方显示。</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">org-agenda-sort-notime-is-late</span> <span class="no">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; 时间显示为两位数(9:30 -&gt; 09:30)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">org-agenda-time-leading-zero</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; 过滤掉部分 tags</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">org-agenda-hide-tags-regexp</span> <span class="p">(</span><span class="nv">regexp-opt</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;dynamic&#34;</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">org-agenda-files</span> <span class="p">(</span><span class="nv">file-expand-wildcards</span> <span class="s">&#34;~/Dropbox/org/agenda/*.org&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq-default</span> <span class="nv">org-agenda-clockreport-parameter-plist</span> <span class="o">&#39;</span><span class="p">(</span><span class="nb">:link</span> <span class="no">t</span> <span class="nb">:maxlevel</span> <span class="mi">3</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;; 计算待办事项创建至今的时间</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">org-todo-age</span> <span class="p">(</span><span class="kp">&amp;optional</span> <span class="nv">pos</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nv">if-let*</span> <span class="p">((</span><span class="nv">entry-age</span> <span class="p">(</span><span class="nv">org-todo-age-time</span> <span class="nv">pos</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">              <span class="p">(</span><span class="nv">days</span> <span class="p">(</span><span class="nv">time-to-number-of-days</span> <span class="nv">entry-age</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nb">cond</span>
</span></span><span class="line"><span class="cl">         <span class="p">((</span><span class="nf">&lt;</span> <span class="nv">days</span> <span class="mi">1</span><span class="p">)</span>   <span class="s">&#34;today&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="p">((</span><span class="nf">&lt;</span> <span class="nv">days</span> <span class="mi">7</span><span class="p">)</span>   <span class="p">(</span><span class="nf">format</span> <span class="s">&#34;%dd&#34;</span> <span class="nv">days</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">         <span class="p">((</span><span class="nf">&lt;</span> <span class="nv">days</span> <span class="mi">30</span><span class="p">)</span>  <span class="p">(</span><span class="nf">format</span> <span class="s">&#34;%.1fw&#34;</span> <span class="p">(</span><span class="nf">/</span> <span class="nv">days</span> <span class="mf">7.0</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">         <span class="p">((</span><span class="nf">&lt;</span> <span class="nv">days</span> <span class="mi">358</span><span class="p">)</span> <span class="p">(</span><span class="nf">format</span> <span class="s">&#34;%.1fM&#34;</span> <span class="p">(</span><span class="nf">/</span> <span class="nv">days</span> <span class="mf">30.0</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">         <span class="p">(</span><span class="no">t</span>            <span class="p">(</span><span class="nf">format</span> <span class="s">&#34;%.1fY&#34;</span> <span class="p">(</span><span class="nf">/</span> <span class="nv">days</span> <span class="mf">365.0</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">      <span class="s">&#34;&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">org-todo-age-time</span> <span class="p">(</span><span class="kp">&amp;optional</span> <span class="nv">pos</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">let</span> <span class="p">((</span><span class="nv">stamp</span> <span class="p">(</span><span class="nv">org-entry-get</span> <span class="p">(</span><span class="nb">or</span> <span class="nv">pos</span> <span class="p">(</span><span class="nf">point</span><span class="p">))</span> <span class="s">&#34;TIMESTAMP_IA&#34;</span> <span class="no">t</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">when</span> <span class="nv">stamp</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nf">time-subtract</span> <span class="p">(</span><span class="nf">current-time</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                     <span class="p">(</span><span class="nv">org-time-string-to-time</span> <span class="nv">stamp</span><span class="p">)))))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">setq</span> <span class="nv">org-agenda-compact-blocks</span> <span class="no">t</span>
</span></span><span class="line"><span class="cl">        <span class="nv">org-agenda-sticky</span> <span class="no">t</span>
</span></span><span class="line"><span class="cl">        <span class="nv">org-agenda-start-on-weekday</span> <span class="no">nil</span>
</span></span><span class="line"><span class="cl">        <span class="nv">org-agenda-span</span> <span class="ss">&#39;day</span>
</span></span><span class="line"><span class="cl">        <span class="nv">org-agenda-include-diary</span> <span class="no">nil</span>
</span></span><span class="line"><span class="cl">        <span class="nv">org-agenda-sorting-strategy</span>
</span></span><span class="line"><span class="cl">        <span class="o">&#39;</span><span class="p">((</span><span class="nv">agenda</span> <span class="nv">habit-down</span> <span class="nv">time-up</span> <span class="nv">user-defined-up</span> <span class="nv">effort-up</span> <span class="nv">category-keep</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span><span class="nv">todo</span> <span class="nv">category-up</span> <span class="nv">effort-up</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span><span class="nv">tags</span> <span class="nv">category-up</span> <span class="nv">effort-up</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span><span class="nv">search</span> <span class="nv">category-up</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="nv">org-agenda-window-setup</span> <span class="ss">&#39;current-window</span>
</span></span><span class="line"><span class="cl">        <span class="nv">org-agenda-custom-commands</span>
</span></span><span class="line"><span class="cl">        <span class="o">`</span><span class="p">((</span><span class="s">&#34;N&#34;</span> <span class="s">&#34;Notes&#34;</span> <span class="nv">tags</span> <span class="s">&#34;NOTE&#34;</span>
</span></span><span class="line"><span class="cl">           <span class="p">((</span><span class="nv">org-agenda-overriding-header</span> <span class="s">&#34;Notes&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="nv">org-tags-match-list-sublevels</span> <span class="no">t</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span><span class="s">&#34;g&#34;</span> <span class="s">&#34;GTD&#34;</span>
</span></span><span class="line"><span class="cl">           <span class="p">((</span><span class="nv">agenda</span> <span class="s">&#34;&#34;</span> <span class="no">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="nv">tags-todo</span> <span class="s">&#34;-inbox&#34;</span>
</span></span><span class="line"><span class="cl">                       <span class="p">((</span><span class="nv">org-agenda-overriding-header</span> <span class="s">&#34;Next Actions&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="p">(</span><span class="nv">org-agenda-tags-todo-honor-ignore-options</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="p">(</span><span class="nv">org-agenda-todo-ignore-scheduled</span> <span class="ss">&#39;future</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="p">(</span><span class="nv">org-agenda-skip-function</span>
</span></span><span class="line"><span class="cl">                         <span class="o">&#39;</span><span class="p">(</span><span class="nb">lambda</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">                            <span class="p">(</span><span class="nb">or</span> <span class="p">(</span><span class="nv">org-agenda-skip-subtree-if</span> <span class="ss">&#39;todo</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;HOLD&#34;</span> <span class="s">&#34;WAITING&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                                <span class="p">(</span><span class="nv">org-agenda-skip-entry-if</span> <span class="ss">&#39;nottodo</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;NEXT&#34;</span><span class="p">)))))</span>
</span></span><span class="line"><span class="cl">                        <span class="p">(</span><span class="nv">org-tags-match-list-sublevels</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="p">(</span><span class="nv">org-agenda-sorting-strategy</span>
</span></span><span class="line"><span class="cl">                         <span class="o">&#39;</span><span class="p">(</span><span class="nv">todo-state-down</span> <span class="nv">effort-up</span> <span class="nv">category-keep</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="nv">tags-todo</span> <span class="s">&#34;-reading&amp;-book/PROJECT&#34;</span>
</span></span><span class="line"><span class="cl">                       <span class="p">((</span><span class="nv">org-agenda-overriding-header</span> <span class="s">&#34;Project&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                       <span class="p">(</span><span class="nv">org-agenda-prefix-format</span> <span class="s">&#34;%-11c%5(org-todo-age) &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="p">(</span><span class="nv">org-tags-match-list-sublevels</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="p">(</span><span class="nv">org-agenda-sorting-strategy</span>
</span></span><span class="line"><span class="cl">                         <span class="o">&#39;</span><span class="p">(</span><span class="nv">category-keep</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="nv">tags-todo</span> <span class="s">&#34;+reading&amp;+book/PROJECT&#34;</span>
</span></span><span class="line"><span class="cl">                       <span class="p">((</span><span class="nv">org-agenda-overriding-header</span> <span class="s">&#34;Reading&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                       <span class="p">(</span><span class="nv">org-agenda-prefix-format</span> <span class="s">&#34;%-11c%5(org-todo-age) &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="p">(</span><span class="nv">org-tags-match-list-sublevels</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="p">(</span><span class="nv">org-agenda-sorting-strategy</span>
</span></span><span class="line"><span class="cl">                         <span class="o">&#39;</span><span class="p">(</span><span class="nv">category-keep</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="nv">tags-todo</span> <span class="s">&#34;/WAITING&#34;</span>
</span></span><span class="line"><span class="cl">                       <span class="p">((</span><span class="nv">org-agenda-overriding-header</span> <span class="s">&#34;Waiting&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="p">(</span><span class="nv">org-agenda-tags-todo-honor-ignore-options</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="p">(</span><span class="nv">org-agenda-todo-ignore-scheduled</span> <span class="ss">&#39;future</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="p">(</span><span class="nv">org-agenda-sorting-strategy</span>
</span></span><span class="line"><span class="cl">                         <span class="o">&#39;</span><span class="p">(</span><span class="nv">category-keep</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="nv">tags-todo</span> <span class="s">&#34;/DELEGATED&#34;</span>
</span></span><span class="line"><span class="cl">                       <span class="p">((</span><span class="nv">org-agenda-overriding-header</span> <span class="s">&#34;Delegated&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="p">(</span><span class="nv">org-agenda-tags-todo-honor-ignore-options</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="p">(</span><span class="nv">org-agenda-todo-ignore-scheduled</span> <span class="ss">&#39;future</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="p">(</span><span class="nv">org-agenda-sorting-strategy</span>
</span></span><span class="line"><span class="cl">                         <span class="o">&#39;</span><span class="p">(</span><span class="nv">category-keep</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="nv">tags-todo</span> <span class="s">&#34;-inbox&#34;</span>
</span></span><span class="line"><span class="cl">                       <span class="p">((</span><span class="nv">org-agenda-overriding-header</span> <span class="s">&#34;On Hold&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="p">(</span><span class="nv">org-agenda-skip-function</span>
</span></span><span class="line"><span class="cl">                         <span class="o">&#39;</span><span class="p">(</span><span class="nb">lambda</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">                            <span class="p">(</span><span class="nb">or</span> <span class="p">(</span><span class="nv">org-agenda-skip-subtree-if</span> <span class="ss">&#39;todo</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;WAITING&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                                <span class="p">(</span><span class="nv">org-agenda-skip-entry-if</span> <span class="ss">&#39;nottodo</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;HOLD&#34;</span><span class="p">)))))</span>
</span></span><span class="line"><span class="cl">                        <span class="p">(</span><span class="nv">org-tags-match-list-sublevels</span> <span class="no">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="p">(</span><span class="nv">org-agenda-sorting-strategy</span>
</span></span><span class="line"><span class="cl">                         <span class="o">&#39;</span><span class="p">(</span><span class="nv">category-keep</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">            <span class="p">))</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span><span class="s">&#34;v&#34;</span> <span class="s">&#34;Orphaned Tasks&#34;</span>
</span></span><span class="line"><span class="cl">           <span class="p">((</span><span class="nv">agenda</span> <span class="s">&#34;&#34;</span> <span class="no">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="nv">tags</span> <span class="s">&#34;inbox&#34;</span>
</span></span><span class="line"><span class="cl">                  <span class="p">((</span><span class="nv">org-agenda-overriding-header</span> <span class="s">&#34;Inbox&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                  <span class="p">(</span><span class="nv">org-agenda-prefix-format</span> <span class="s">&#34;%-11c%5(org-todo-age) &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                   <span class="p">(</span><span class="nv">org-tags-match-list-sublevels</span> <span class="no">nil</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">           <span class="p">(</span><span class="nv">tags-todo</span> <span class="s">&#34;+book&amp;-reading/PROJECT&#34;</span>
</span></span><span class="line"><span class="cl">                       <span class="p">((</span><span class="nv">org-agenda-overriding-header</span> <span class="s">&#34;Book Plan&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                       <span class="p">(</span><span class="nv">org-agenda-prefix-format</span> <span class="s">&#34;%-11c%5(org-todo-age) &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="p">(</span><span class="nv">org-tags-match-list-sublevels</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="p">(</span><span class="nv">org-agenda-sorting-strategy</span>
</span></span><span class="line"><span class="cl">                         <span class="o">&#39;</span><span class="p">(</span><span class="nv">category-keep</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="nv">tags-todo</span> <span class="s">&#34;-inbox/-NEXT&#34;</span>
</span></span><span class="line"><span class="cl">                       <span class="p">((</span><span class="nv">org-agenda-overriding-header</span> <span class="s">&#34;Orphaned Tasks&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="p">(</span><span class="nv">org-agenda-tags-todo-honor-ignore-options</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="p">(</span><span class="nv">org-agenda-prefix-format</span> <span class="s">&#34;%-11c%5(org-todo-age) &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="p">(</span><span class="nv">org-agenda-todo-ignore-scheduled</span> <span class="ss">&#39;future</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="p">(</span><span class="nv">org-agenda-skip-function</span>
</span></span><span class="line"><span class="cl">                         <span class="o">&#39;</span><span class="p">(</span><span class="nb">lambda</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">                            <span class="p">(</span><span class="nb">or</span> <span class="p">(</span><span class="nv">org-agenda-skip-subtree-if</span> <span class="ss">&#39;todo</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;PROJECT&#34;</span> <span class="s">&#34;HOLD&#34;</span> <span class="s">&#34;WAITING&#34;</span> <span class="s">&#34;DELEGATED&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                                <span class="p">(</span><span class="nv">org-agenda-skip-subtree-if</span> <span class="ss">&#39;nottododo</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;TODO&#34;</span><span class="p">)))))</span>
</span></span><span class="line"><span class="cl">                        <span class="p">(</span><span class="nv">org-tags-match-list-sublevels</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="p">(</span><span class="nv">org-agenda-sorting-strategy</span>
</span></span><span class="line"><span class="cl">                         <span class="o">&#39;</span><span class="p">(</span><span class="nv">category-keep</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">            <span class="p">))))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">add-hook</span> <span class="ss">&#39;org-agenda-mode-hook</span> <span class="ss">&#39;hl-line-mode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">advice-add</span> <span class="ss">&#39;org-refile</span> <span class="nb">:after</span> <span class="ss">&#39;org-save-all-org-buffers</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">advice-add</span> <span class="ss">&#39;org-archive</span> <span class="nb">:after</span> <span class="ss">&#39;org-save-all-org-buffers</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">add-hook</span> <span class="ss">&#39;org-capture-after-finalize-hook</span> <span class="ss">&#39;org-save-all-org-buffers</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">advice-add</span> <span class="ss">&#39;org-capture-refile</span> <span class="nb">:after</span> <span class="ss">&#39;org-save-all-org-buffers</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;;; Org clock</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;; Save the running clock and all clock history when exiting Emacs, load it on startup</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">with-eval-after-load</span> <span class="ss">&#39;org</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">org-clock-persistence-insinuate</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">org-clock-persist</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">org-clock-in-resume</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;; Save clock data and notes in the LOGBOOK drawer</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">org-clock-into-drawer</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; Save state changes in the LOGBOOK drawer</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">org-log-into-drawer</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; Removes clocked tasks with 0:00 duration</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">org-clock-out-remove-zero-time-clocks</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;; Show clock sums as hours and minutes, not &#34;n days&#34; etc.</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">org-time-clocksum-format</span>
</span></span><span class="line"><span class="cl">      <span class="o">&#39;</span><span class="p">(</span><span class="nb">:hours</span> <span class="s">&#34;%d&#34;</span> <span class="nb">:require-hours</span> <span class="no">t</span> <span class="nb">:minutes</span> <span class="s">&#34;:%02d&#34;</span> <span class="nb">:require-minutes</span> <span class="no">t</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;;; Show the clocked-in task - if any - in the header line</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">sanityinc/show-org-clock-in-header-line</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">setq-default</span> <span class="nv">header-line-format</span> <span class="o">&#39;</span><span class="p">((</span><span class="s">&#34; &#34;</span> <span class="nv">org-mode-line-string</span> <span class="s">&#34; &#34;</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">sanityinc/hide-org-clock-from-header-line</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">setq-default</span> <span class="nv">header-line-format</span> <span class="no">nil</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">add-hook</span> <span class="ss">&#39;org-clock-in-hook</span> <span class="ss">&#39;sanityinc/show-org-clock-in-header-line</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">add-hook</span> <span class="ss">&#39;org-clock-out-hook</span> <span class="ss">&#39;sanityinc/hide-org-clock-from-header-line</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">add-hook</span> <span class="ss">&#39;org-clock-cancel-hook</span> <span class="ss">&#39;sanityinc/hide-org-clock-from-header-line</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">with-eval-after-load</span> <span class="ss">&#39;org-clock</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nf">define-key</span> <span class="nv">org-clock-mode-line-map</span> <span class="p">[</span><span class="nv">header-line</span> <span class="nv">mouse-2</span><span class="p">]</span> <span class="ss">&#39;org-clock-goto</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nf">define-key</span> <span class="nv">org-clock-mode-line-map</span> <span class="p">[</span><span class="nv">header-line</span> <span class="nv">mouse-1</span><span class="p">]</span> <span class="ss">&#39;org-clock-menu</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;;; Archiving</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">org-archive-mark-done</span> <span class="no">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">org-archive-location</span> <span class="s">&#34;%s_archive::* Archive&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">with-eval-after-load</span> <span class="ss">&#39;org</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nf">define-key</span> <span class="nv">org-mode-map</span> <span class="p">(</span><span class="nv">kbd</span> <span class="s">&#34;C-M-&lt;up&gt;&#34;</span><span class="p">)</span> <span class="ss">&#39;org-up-element</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">when</span> <span class="vg">*IS-MAC*</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nf">define-key</span> <span class="nv">org-mode-map</span> <span class="p">(</span><span class="nv">kbd</span> <span class="s">&#34;M-h&#34;</span><span class="p">)</span> <span class="no">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nf">define-key</span> <span class="nv">org-mode-map</span> <span class="p">(</span><span class="nv">kbd</span> <span class="s">&#34;C-c g&#34;</span><span class="p">)</span> <span class="ss">&#39;grab-mac-link</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">with-eval-after-load</span> <span class="ss">&#39;org</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">org-babel-do-load-languages</span>
</span></span><span class="line"><span class="cl">   <span class="ss">&#39;org-babel-load-languages</span>
</span></span><span class="line"><span class="cl">   <span class="p">(</span><span class="nv">seq-filter</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">lambda</span> <span class="p">(</span><span class="nv">pair</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nv">locate-library</span> <span class="p">(</span><span class="nf">concat</span> <span class="s">&#34;ob-&#34;</span> <span class="p">(</span><span class="nf">symbol-name</span> <span class="p">(</span><span class="nf">car</span> <span class="nv">pair</span><span class="p">)))))</span>
</span></span><span class="line"><span class="cl">    <span class="o">&#39;</span><span class="p">((</span><span class="nv">R</span> <span class="o">.</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nv">ditaa</span> <span class="o">.</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nv">rust</span> <span class="o">.</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nv">dot</span> <span class="o">.</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nv">emacs-lisp</span> <span class="o">.</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nv">gnuplot</span> <span class="o">.</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nv">haskell</span> <span class="o">.</span> <span class="no">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nv">ledger</span> <span class="o">.</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nv">ocaml</span> <span class="o">.</span> <span class="no">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nv">octave</span> <span class="o">.</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nv">ruby</span> <span class="o">.</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nv">screen</span> <span class="o">.</span> <span class="no">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nv">sh</span> <span class="o">.</span> <span class="no">t</span><span class="p">)</span> <span class="c1">;; obsolete</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nv">shell</span> <span class="o">.</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nv">sql</span> <span class="o">.</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nv">sqlite</span> <span class="o">.</span> <span class="no">t</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">  <span class="c1">;; plantuml</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">org-babel-do-load-languages</span>
</span></span><span class="line"><span class="cl">   <span class="ss">&#39;org-babel-load-languages</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="c1">;; other Babel languages</span>
</span></span><span class="line"><span class="cl">     <span class="p">(</span><span class="nv">plantuml</span> <span class="o">.</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">     <span class="p">(</span><span class="nv">python</span> <span class="o">.</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">     <span class="p">(</span><span class="nv">latex</span> <span class="o">.</span> <span class="no">t</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">setq</span>  <span class="nv">org-plantuml-jar-path</span>
</span></span><span class="line"><span class="cl">         <span class="p">(</span><span class="nf">expand-file-name</span> <span class="s">&#34;~/Dropbox/org/plantuml/plantuml.jar&#34;</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; 这里应该就是 .zshrc 里面配置的 python3</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">org-babel-python-command</span> <span class="s">&#34;python3&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">require-package</span> <span class="ss">&#39;emacsql-sqlite-builtin</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">require</span> <span class="ss">&#39;emacsql-sqlite-builtin</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">use-package</span> <span class="nv">org-roam</span>
</span></span><span class="line"><span class="cl">  <span class="nb">:ensure</span> <span class="no">t</span>
</span></span><span class="line"><span class="cl">  <span class="nb">:demand</span> <span class="no">t</span> <span class="c1">;; ensure org-roam is loaded by default</span>
</span></span><span class="line"><span class="cl">  <span class="nb">:init</span>
</span></span><span class="line"><span class="cl">  <span class="nb">:custom</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">org-roam-directory</span> <span class="p">(</span><span class="nv">file-truename</span> <span class="s">&#34;~/Dropbox/org/&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="c1">;; 需要 emacs-plus@29 版本</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">org-roam-database-connector</span> <span class="ss">&#39;sqlite-builtin</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">org-roam-db-location</span> <span class="s">&#34;~/Dropbox/org/org.db&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">org-roam-db-gc-threshold</span> <span class="nv">most-positive-fixnum</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">org-roam-completion-everywhere</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">org-roam-capture-templates</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">     <span class="c1">;; #+OPTIONS: toc:nil 为了导出 .md 的格式更加符合使用</span>
</span></span><span class="line"><span class="cl">     <span class="p">(</span><span class="s">&#34;d&#34;</span> <span class="s">&#34;default&#34;</span> <span class="nv">plain</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nv">file</span> <span class="s">&#34;~/Dropbox/org/templates/default.org&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="nb">:if-new</span> <span class="p">(</span><span class="nv">file</span> <span class="s">&#34;main/%&lt;%Y%m%d%H%M%S&gt;-${slug}.org&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="nb">:unnarrowed</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">     <span class="p">(</span><span class="s">&#34;p&#34;</span> <span class="s">&#34;private&#34;</span> <span class="nv">plain</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nv">file</span> <span class="s">&#34;~/Dropbox/org/templates/private.org&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="nb">:if-new</span> <span class="p">(</span><span class="nv">file</span> <span class="s">&#34;private/%&lt;%Y%m%d%H%M%S&gt;-${slug}.org&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="nb">:unnarrowed</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">     <span class="p">(</span><span class="s">&#34;a&#34;</span> <span class="s">&#34;article&#34;</span> <span class="nv">plain</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nv">file</span> <span class="s">&#34;~/Dropbox/org/templates/article.org&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="nb">:if-new</span> <span class="p">(</span><span class="nv">file</span> <span class="s">&#34;main/%&lt;%Y%m%d%H%M%S&gt;-${slug}.org&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="nb">:unnarrowed</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">     <span class="p">(</span><span class="s">&#34;n&#34;</span> <span class="s">&#34;article-network&#34;</span> <span class="nv">plain</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nv">file</span> <span class="s">&#34;~/Dropbox/org/templates/article-network.org&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="nb">:if-new</span> <span class="p">(</span><span class="nv">file</span> <span class="s">&#34;main/%&lt;%Y%m%d%H%M%S&gt;-${slug}.org&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="nb">:unnarrowed</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">     <span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">org-roam-dailies-capture-templates</span>
</span></span><span class="line"><span class="cl">   <span class="c1">;; %&lt;%H:%M&gt; 为24小时制，%&lt;%I:%M %p&gt; 为12小时制</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">     <span class="p">(</span><span class="s">&#34;d&#34;</span> <span class="s">&#34;default&#34;</span> <span class="nv">entry</span> <span class="s">&#34;** %&lt;%H:%M&gt; %?&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="nb">:if-new</span> <span class="p">(</span><span class="nv">file+head+olp</span> <span class="s">&#34;%&lt;%Y-%m-%d&gt;.org&#34;</span> <span class="s">&#34;#+title: %&lt;%Y-%m-%d&gt;\n#+ARCHIVE: journal.org::\n&#34;</span> <span class="p">(</span><span class="s">&#34;%&lt;%Y-%m-%d&gt;&#34;</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">     <span class="p">(</span><span class="s">&#34;r&#34;</span> <span class="s">&#34;read&#34;</span> <span class="nv">entry</span> <span class="s">&#34;*** %?&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="nb">:if-new</span> <span class="p">(</span><span class="nv">file+head+olp</span> <span class="s">&#34;%&lt;%Y-%m-%d&gt;.org&#34;</span> <span class="s">&#34;#+title: %&lt;%Y-%m-%d&gt;\n#+ARCHIVE: journal.org::\n&#34;</span> <span class="p">(</span><span class="s">&#34;%&lt;%Y-%m-%d&gt;&#34;</span> <span class="s">&#34;What I read? :read:&#34;</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">     <span class="p">(</span><span class="s">&#34;t&#34;</span> <span class="s">&#34;tasks&#34;</span> <span class="nv">entry</span> <span class="s">&#34;*** %?&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="nb">:if-new</span> <span class="p">(</span><span class="nv">file+head+olp</span> <span class="s">&#34;%&lt;%Y-%m-%d&gt;.org&#34;</span> <span class="s">&#34;#+title: %&lt;%Y-%m-%d&gt;\n#+ARCHIVE: journal.org::\n&#34;</span> <span class="p">(</span><span class="s">&#34;%&lt;%Y-%m-%d&gt;&#34;</span> <span class="s">&#34;Tasks :task:&#34;</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">     <span class="p">(</span><span class="s">&#34;n&#34;</span> <span class="s">&#34;notes&#34;</span> <span class="nv">entry</span> <span class="s">&#34;*** %?&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="nb">:if-new</span> <span class="p">(</span><span class="nv">file+head+olp</span> <span class="s">&#34;%&lt;%Y-%m-%d&gt;.org&#34;</span> <span class="s">&#34;#+title: %&lt;%Y-%m-%d&gt;\n#+ARCHIVE: journal.org::\n&#34;</span> <span class="p">(</span><span class="s">&#34;%&lt;%Y-%m-%d&gt;&#34;</span> <span class="s">&#34;Notes :note:&#34;</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">     <span class="p">(</span><span class="s">&#34;o&#34;</span> <span class="s">&#34;online&#34;</span> <span class="nv">entry</span> <span class="s">&#34;** %&lt;%H:%M&gt; %? :online:&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="nb">:if-new</span> <span class="p">(</span><span class="nv">file+head+olp</span> <span class="s">&#34;%&lt;%Y-%m-%d&gt;.org&#34;</span> <span class="s">&#34;#+title: %&lt;%Y-%m-%d&gt;\n#+ARCHIVE: journal.org::\n&#34;</span> <span class="p">(</span><span class="s">&#34;%&lt;%Y-%m-%d&gt;&#34;</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">     <span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="nb">:bind</span> <span class="p">((</span><span class="s">&#34;C-c n l&#34;</span> <span class="o">.</span> <span class="nv">org-roam-buffer-toggle</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="p">(</span><span class="s">&#34;C-c n f&#34;</span> <span class="o">.</span> <span class="nv">org-roam-node-find</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="p">(</span><span class="s">&#34;C-c n i&#34;</span> <span class="o">.</span> <span class="nv">org-roam-node-insert</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="p">(</span><span class="s">&#34;C-c n j&#34;</span> <span class="o">.</span> <span class="nv">org-roam-dailies-capture-today</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="p">(</span><span class="s">&#34;C-c n I&#34;</span> <span class="o">.</span> <span class="nv">org-roam-node-insert-immediate</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="p">(</span><span class="s">&#34;C-c n m&#34;</span> <span class="o">.</span> <span class="nv">dired-copy-images-links</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="nb">:map</span> <span class="nv">org-mode-map</span>
</span></span><span class="line"><span class="cl">         <span class="c1">;; Ctrl-Alt-i</span>
</span></span><span class="line"><span class="cl">         <span class="p">(</span><span class="s">&#34;C-M-i&#34;</span> <span class="o">.</span> <span class="nv">completion-at-point</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="nb">:config</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">unless</span> <span class="p">(</span><span class="nf">file-exists-p</span> <span class="nv">org-roam-directory</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nv">make-directory</span> <span class="nv">org-roam-directory</span> <span class="no">t</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">org-roam-db-autosync-enable</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="c1">;;使用侧边栏而不是完整buffer</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">add-to-list</span> <span class="ss">&#39;display-buffer-alist</span>
</span></span><span class="line"><span class="cl">               <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;\\*org-roam\\*&#34;</span>
</span></span><span class="line"><span class="cl">                 <span class="p">(</span><span class="nv">display-buffer-in-direction</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                 <span class="p">(</span><span class="nv">direction</span> <span class="o">.</span> <span class="nv">right</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                 <span class="p">(</span><span class="nv">window-width</span> <span class="o">.</span> <span class="mf">0.33</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                 <span class="p">(</span><span class="nv">window-height</span> <span class="o">.</span> <span class="nv">fit-window-to-buffer</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">setq</span> <span class="nv">org-export-backends</span> <span class="p">(</span><span class="nb">quote</span> <span class="p">(</span><span class="nv">ascii</span> <span class="nv">html</span> <span class="nv">icalendar</span> <span class="nv">latex</span> <span class="nv">md</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">  <span class="c1">;; code hightlight</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">setq</span> <span class="nv">org-src-fontify-natively</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="c1">;; If using org-roam-protocol</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">require</span> <span class="ss">&#39;org-roam-protocol</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">require</span> <span class="ss">&#39;org-roam-export</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">require</span> <span class="ss">&#39;org-tempo</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="c1">;; Copy Done To-Dos to Today</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">defun</span> <span class="nv">org-roam-copy-todo-to-today</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">interactive</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">let</span> <span class="p">((</span><span class="nv">org-refile-keep</span> <span class="no">t</span><span class="p">)</span> <span class="c1">;; Set this to nil to delete the original!</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span><span class="nv">org-after-refile-insert-hook</span> <span class="nf">#&#39;</span><span class="nv">save-buffer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="nv">today-file</span>
</span></span><span class="line"><span class="cl">          <span class="nv">pos</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nb">save-window-excursion</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nv">org-roam-dailies-capture-today</span> <span class="no">t</span> <span class="s">&#34;t&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nb">setq</span> <span class="nv">today-file</span> <span class="p">(</span><span class="nf">buffer-file-name</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nb">setq</span> <span class="nv">pos</span> <span class="p">(</span><span class="nf">point</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">;; Only refile if the target file is different than the current file</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nb">unless</span> <span class="p">(</span><span class="nf">equal</span> <span class="p">(</span><span class="nv">file-truename</span> <span class="nv">today-file</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                     <span class="p">(</span><span class="nv">file-truename</span> <span class="p">(</span><span class="nf">buffer-file-name</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nv">org-refile</span> <span class="no">nil</span> <span class="no">nil</span> <span class="p">(</span><span class="nf">list</span> <span class="s">&#34;Tasks&#34;</span> <span class="nv">today-file</span> <span class="no">nil</span> <span class="nv">pos</span><span class="p">)))))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">add-to-list</span> <span class="ss">&#39;org-after-todo-state-change-hook</span>
</span></span><span class="line"><span class="cl">               <span class="p">(</span><span class="nb">lambda</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">                 <span class="c1">;; DONE 和 CANCELLED 的 To-Dos 自动复制到今日</span>
</span></span><span class="line"><span class="cl">                 <span class="c1">;; 同时过滤掉 habit 的 To-Dos</span>
</span></span><span class="line"><span class="cl">                 <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nb">and</span> <span class="p">(</span><span class="nb">or</span> <span class="p">(</span><span class="nf">equal</span> <span class="nv">org-state</span> <span class="s">&#34;DONE&#34;</span><span class="p">)</span> <span class="p">(</span><span class="nf">equal</span> <span class="nv">org-state</span> <span class="s">&#34;CANCELLED&#34;</span><span class="p">))</span> <span class="p">(</span><span class="nv">not</span> <span class="p">(</span><span class="nv">org-find-property</span> <span class="s">&#34;STYLE&#34;</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">                   <span class="p">(</span><span class="nv">org-roam-copy-todo-to-today</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">  <span class="c1">;; node-find 的时候展示文件夹</span>
</span></span><span class="line"><span class="cl">  <span class="c1">;; org-roam-node-type</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">cl-defmethod</span> <span class="nv">org-roam-node-type</span> <span class="p">((</span><span class="nv">node</span> <span class="nv">org-roam-node</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;Return the TYPE of NODE.&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">condition-case</span> <span class="no">nil</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nf">file-name-nondirectory</span>
</span></span><span class="line"><span class="cl">         <span class="p">(</span><span class="nf">directory-file-name</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span><span class="nf">file-name-directory</span>
</span></span><span class="line"><span class="cl">           <span class="p">(</span><span class="nv">file-relative-name</span> <span class="p">(</span><span class="nv">org-roam-node-file</span> <span class="nv">node</span><span class="p">)</span> <span class="nv">org-roam-directory</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="ne">error</span> <span class="s">&#34;&#34;</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">  <span class="c1">;; I encountered the following message when attempting</span>
</span></span><span class="line"><span class="cl">  <span class="c1">;; to export data:</span>
</span></span><span class="line"><span class="cl">  <span class="c1">;;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">;; &#34;org-export-data: Unable to resolve link: FILE-ID&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">defun</span> <span class="nv">force-org-rebuild-cache</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;Rebuild the </span><span class="ss">`org-mode&#39;</span><span class="s"> and </span><span class="ss">`org-roam&#39;</span><span class="s"> cache.&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">interactive</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nv">org-id-update-id-locations</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">;; Note: you may need `org-roam-db-clear-all&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">;; followed by `org-roam-db-sync&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nv">org-roam-db-sync</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nv">org-roam-update-org-id-locations</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="c1">;; org-roam 作者提供的解决办法</span>
</span></span><span class="line"><span class="cl">  <span class="c1">;; (setq org-id-track-globally t)</span>
</span></span><span class="line"><span class="cl">  <span class="c1">;; M-x org-id-update-id-locations</span>
</span></span><span class="line"><span class="cl">  <span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; 解决 org-roam-node-find 时，内容局限于 buffer 宽度。</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; https://github.com/org-roam/org-roam/issues/2066</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">my/org-roam-node-read--to-candidate</span> <span class="p">(</span><span class="nv">node</span> <span class="nv">template</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;Return a minibuffer completion candidate given NODE.
</span></span></span><span class="line"><span class="cl"><span class="s">TEMPLATE is the processed template used to format the entry.&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">let</span> <span class="p">((</span><span class="nv">candidate-main</span> <span class="p">(</span><span class="nv">org-roam-node--format-entry</span>
</span></span><span class="line"><span class="cl">                         <span class="nv">template</span>
</span></span><span class="line"><span class="cl">                         <span class="nv">node</span>
</span></span><span class="line"><span class="cl">                         <span class="p">(</span><span class="nf">1-</span> <span class="p">(</span><span class="nb">if</span> <span class="p">(</span><span class="nf">minibufferp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                 <span class="p">(</span><span class="nv">window-width</span><span class="p">)</span> <span class="p">(</span><span class="nv">frame-width</span><span class="p">))))))</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nf">cons</span> <span class="p">(</span><span class="nf">propertize</span> <span class="nv">candidate-main</span> <span class="ss">&#39;node</span> <span class="nv">node</span><span class="p">)</span> <span class="nv">node</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">advice-add</span> <span class="ss">&#39;org-roam-node-read--to-candidate</span> <span class="nb">:override</span> <span class="nf">#&#39;</span><span class="nv">my/org-roam-node-read--to-candidate</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; 在记录的时候创建新的 node 时不退出当前状态，保存新建的 node。</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">org-roam-node-insert-immediate</span> <span class="p">(</span><span class="nv">arg</span> <span class="kp">&amp;rest</span> <span class="nv">args</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">interactive</span> <span class="s">&#34;P&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">let</span> <span class="p">((</span><span class="nv">args</span> <span class="p">(</span><span class="nb">push</span> <span class="nv">arg</span> <span class="nv">args</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nv">org-roam-capture-templates</span> <span class="p">(</span><span class="nf">list</span> <span class="p">(</span><span class="nf">append</span> <span class="p">(</span><span class="nf">car</span> <span class="nv">org-roam-capture-templates</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                                  <span class="o">&#39;</span><span class="p">(</span><span class="nb">:immediate-finish</span> <span class="no">t</span><span class="p">)))))</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nf">apply</span> <span class="nf">#&#39;</span><span class="nv">org-roam-node-insert</span> <span class="nv">args</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;; C-x d 进入 dired 模式，m 来标记对应需要复制链接的图片，C-c n m 即可复制到需要的图片插入文本。</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; source: https://org-roam.discourse.group/t/is-there-a-solution-for-images-organization-in-org-roam/925</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">dired-copy-images-links</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;Works only in dired-mode, put in kill-ring,
</span></span></span><span class="line"><span class="cl"><span class="s">  ready to be yanked in some other org-mode file,
</span></span></span><span class="line"><span class="cl"><span class="s">  the links of marked image files using file-name-base as #+CAPTION.
</span></span></span><span class="line"><span class="cl"><span class="s">  If no file marked then do it on all images files of directory.
</span></span></span><span class="line"><span class="cl"><span class="s">  No file is moved nor copied anywhere.
</span></span></span><span class="line"><span class="cl"><span class="s">  This is intended to be used with org-redisplay-inline-images.&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">interactive</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">if</span> <span class="p">(</span><span class="nv">derived-mode-p</span> <span class="ss">&#39;dired-mode</span><span class="p">)</span>                           <span class="c1">; if we are in dired-mode</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nb">let*</span> <span class="p">((</span><span class="nv">marked-files</span> <span class="p">(</span><span class="nv">dired-get-marked-files</span><span class="p">))</span>         <span class="c1">; get marked file list</span>
</span></span><span class="line"><span class="cl">             <span class="p">(</span><span class="nv">number-marked-files</span>                            <span class="c1">; store number of marked files</span>
</span></span><span class="line"><span class="cl">              <span class="p">(</span><span class="nf">string-to-number</span>                              <span class="c1">; as a number</span>
</span></span><span class="line"><span class="cl">               <span class="p">(</span><span class="nv">dired-number-of-marked-files</span><span class="p">))))</span>             <span class="c1">; for later reference</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nf">=</span> <span class="nv">number-marked-files</span> <span class="mi">0</span><span class="p">)</span>                      <span class="c1">; if none marked then</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span><span class="nv">dired-toggle-marks</span><span class="p">)</span>                               <span class="c1">; mark all files</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span><span class="nb">setq</span> <span class="nv">marked-files</span> <span class="p">(</span><span class="nv">dired-get-marked-files</span><span class="p">)))</span>      <span class="c1">; get marked file list</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nf">message</span> <span class="s">&#34;Files marked for copy&#34;</span><span class="p">)</span>                    <span class="c1">; info message</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nv">dired-number-of-marked-files</span><span class="p">)</span>                       <span class="c1">; marked files info</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nv">kill-new</span> <span class="s">&#34;\n&#34;</span><span class="p">)</span>                                      <span class="c1">; start with a newline</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nb">dolist</span> <span class="p">(</span><span class="nv">marked-file</span> <span class="nv">marked-files</span><span class="p">)</span>                   <span class="c1">; walk the marked files list</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nv">org-file-image-p</span> <span class="nv">marked-file</span><span class="p">)</span>               <span class="c1">; only on image files</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="nv">kill-append</span>                                     <span class="c1">; append image to kill-ring</span>
</span></span><span class="line"><span class="cl">             <span class="p">(</span><span class="nf">concat</span> <span class="s">&#34;#+CAPTION: &#34;</span>                           <span class="c1">; as caption,</span>
</span></span><span class="line"><span class="cl">                     <span class="p">(</span><span class="nv">file-name-base</span> <span class="nv">marked-file</span><span class="p">)</span>            <span class="c1">; use file-name-base</span>
</span></span><span class="line"><span class="cl">                     <span class="s">&#34;\n#+ATTR_ORG: :width 800&#34;</span>              <span class="c1">; img width</span>
</span></span><span class="line"><span class="cl">                     <span class="s">&#34;\n[[file:&#34;</span> <span class="nv">marked-file</span> <span class="s">&#34;]]\n\n&#34;</span><span class="p">)</span> <span class="no">nil</span><span class="p">)))</span><span class="c1">; link to marked-file</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nf">=</span> <span class="nv">number-marked-files</span> <span class="mi">0</span><span class="p">)</span>                      <span class="c1">; if none were marked then</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span><span class="nv">dired-toggle-marks</span><span class="p">)))</span>                             <span class="c1">; unmark all</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nf">message</span> <span class="s">&#34;Error: Does not work outside dired-mode&#34;</span><span class="p">)</span>      <span class="c1">; can&#39;t work not in dired-mode</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nf">ding</span><span class="p">)))</span>                                                 <span class="c1">; error sound</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;; Save the corresponding buffers</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">gtd-save-org-buffers</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;Save </span><span class="ss">`org-agenda-files&#39;</span><span class="s"> buffers without user confirmation.
</span></span></span><span class="line"><span class="cl"><span class="s">See also </span><span class="ss">`org-save-all-org-buffers&#39;</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">interactive</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nf">message</span> <span class="s">&#34;Saving org-agenda-files buffers...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">save-some-buffers</span> <span class="no">t</span> <span class="p">(</span><span class="nb">lambda</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">             <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nf">member</span> <span class="p">(</span><span class="nf">buffer-file-name</span><span class="p">)</span> <span class="nv">org-agenda-files</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">               <span class="no">t</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nf">message</span> <span class="s">&#34;Saving org-agenda-files buffers... done&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; Add it after refile</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">advice-add</span> <span class="ss">&#39;org-refile</span> <span class="nb">:after</span> <span class="p">(</span><span class="nb">lambda</span> <span class="p">(</span><span class="kp">&amp;rest</span> <span class="nv">_</span><span class="p">)</span> <span class="p">(</span><span class="nv">gtd-save-org-buffers</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">log-todo-next-creation-date</span> <span class="p">(</span><span class="kp">&amp;rest</span> <span class="nv">ignore</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;Log NEXT creation time in the property drawer under the key &#39;ACTIVATED&#39;&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nb">and</span> <span class="p">(</span><span class="nv">string=</span> <span class="p">(</span><span class="nv">org-get-todo-state</span><span class="p">)</span> <span class="s">&#34;NEXT&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">             <span class="p">(</span><span class="nv">not</span> <span class="p">(</span><span class="nv">org-entry-get</span> <span class="no">nil</span> <span class="s">&#34;ACTIVATED&#34;</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nv">org-entry-put</span> <span class="no">nil</span> <span class="s">&#34;ACTIVATED&#34;</span> <span class="p">(</span><span class="nf">format-time-string</span> <span class="s">&#34;[%Y-%m-%d]&#34;</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">add-hook</span> <span class="ss">&#39;org-after-todo-state-change-hook</span> <span class="nf">#&#39;</span><span class="nv">log-todo-next-creation-date</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;; Put the text property afterwards with an advice</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">my-org-agenda-override-header</span> <span class="p">(</span><span class="nv">orig-fun</span> <span class="kp">&amp;rest</span> <span class="nv">args</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;Change the face of the overriden header string if needed.
</span></span></span><span class="line"><span class="cl"><span class="s">The propertized header text is taken from </span><span class="ss">`org-agenda-overriding-header&#39;</span><span class="s">.
</span></span></span><span class="line"><span class="cl"><span class="s">The face is only changed if the overriding header is propertized with a face.&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">let</span> <span class="p">((</span><span class="nv">pt</span> <span class="p">(</span><span class="nf">point</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nv">header</span> <span class="nv">org-agenda-overriding-header</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nf">apply</span> <span class="nv">orig-fun</span> <span class="nv">args</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">;; Only replace if there is an overriding header and not an empty string.</span>
</span></span><span class="line"><span class="cl">    <span class="c1">;; And only if the header text has a face property.</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nb">and</span> <span class="nv">header</span> <span class="p">(</span><span class="nf">&gt;</span> <span class="p">(</span><span class="nf">length</span> <span class="nv">header</span><span class="p">)</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">               <span class="p">(</span><span class="nf">get-text-property</span> <span class="mi">0</span> <span class="ss">&#39;face</span> <span class="nv">header</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nb">save-excursion</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nf">goto-char</span> <span class="nv">pt</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1">;; Search for the header text.</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nf">search-forward</span> <span class="nv">header</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nb">unwind-protect</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="nb">progn</span>
</span></span><span class="line"><span class="cl">              <span class="p">(</span><span class="nv">read-only-mode</span> <span class="mi">-1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">              <span class="c1">;; Replace it with the propertized text.</span>
</span></span><span class="line"><span class="cl">              <span class="p">(</span><span class="nf">replace-match</span> <span class="nv">header</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span><span class="nv">read-only-mode</span> <span class="mi">1</span><span class="p">))))))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">my-org-agenda-override-header-add-advices</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;Add advices to make changing work in all agenda commands.&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">interactive</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">dolist</span> <span class="p">(</span><span class="nv">fun</span> <span class="o">&#39;</span><span class="p">(</span><span class="nv">org-agenda-list</span> <span class="nv">org-todo-list</span> <span class="nv">org-search-view</span> <span class="nv">org-tags-view</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nv">advice-add</span> <span class="nv">fun</span> <span class="nb">:around</span> <span class="nf">#&#39;</span><span class="nv">my-org-agenda-override-header</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">my-org-agenda-override-header-add-advices</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; 只显示 outline 下第一个 TODO</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">my-org-agenda-skip-all-siblings-but-first</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;Skip all but the first non-done entry.&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">let</span> <span class="p">(</span><span class="nv">should-skip-entry</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">unless</span> <span class="p">(</span><span class="nv">org-current-is-todo</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nb">setq</span> <span class="nv">should-skip-entry</span> <span class="no">t</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">save-excursion</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nb">while</span> <span class="p">(</span><span class="nb">and</span> <span class="p">(</span><span class="nv">not</span> <span class="nv">should-skip-entry</span><span class="p">)</span> <span class="p">(</span><span class="nv">org-goto-sibling</span> <span class="no">t</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nv">org-current-is-todo</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span><span class="nb">setq</span> <span class="nv">should-skip-entry</span> <span class="no">t</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">when</span> <span class="nv">should-skip-entry</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nb">or</span> <span class="p">(</span><span class="nv">outline-next-heading</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span><span class="nf">goto-char</span> <span class="p">(</span><span class="nf">point-max</span><span class="p">))))))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">org-current-is-todo</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">string=</span> <span class="s">&#34;TODO&#34;</span> <span class="p">(</span><span class="nv">org-get-todo-state</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; 导出特定文件夹下所有内容到 hugo</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">ox-hugo/export-all</span> <span class="p">(</span><span class="kp">&amp;optional</span> <span class="nv">org-files-root-dir</span> <span class="nv">dont-recurse</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;Export all Org files (including nested) under ORG-FILES-ROOT-DIR.
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s">  All valid post subtrees in all Org files are exported using
</span></span></span><span class="line"><span class="cl"><span class="s">  </span><span class="ss">`org-hugo-export-wim-to-md&#39;</span><span class="s">.
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s">  If optional arg ORG-FILES-ROOT-DIR is nil, all Org files in
</span></span></span><span class="line"><span class="cl"><span class="s">  current buffer&#39;s directory are exported.
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s">  If optional arg DONT-RECURSE is nil, all Org files in
</span></span></span><span class="line"><span class="cl"><span class="s">  ORG-FILES-ROOT-DIR in all subdirectories are exported. Else, only
</span></span></span><span class="line"><span class="cl"><span class="s">  the Org files directly present in the current directory are
</span></span></span><span class="line"><span class="cl"><span class="s">  exported.  If this function is called interactively with
</span></span></span><span class="line"><span class="cl"><span class="s">  \\[universal-argument] prefix, DONT-RECURSE is set to non-nil.
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s">  Example usage in Emacs Lisp: (ox-hugo/export-all \&#34;~/org\&#34;).&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">interactive</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">org-transclusion-mode</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">let*</span> <span class="p">((</span><span class="nv">org-files-root-dir</span> <span class="p">(</span><span class="nb">or</span> <span class="nv">org-files-root-dir</span> <span class="nv">default-directory</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">         <span class="p">(</span><span class="nv">dont-recurse</span> <span class="p">(</span><span class="nb">or</span> <span class="nv">dont-recurse</span> <span class="p">(</span><span class="nb">and</span> <span class="nv">current-prefix-arg</span> <span class="no">t</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">         <span class="p">(</span><span class="nv">search-path</span> <span class="p">(</span><span class="nf">file-name-as-directory</span> <span class="p">(</span><span class="nf">expand-file-name</span> <span class="nv">org-files-root-dir</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">         <span class="p">(</span><span class="nv">org-files</span> <span class="p">(</span><span class="nb">if</span> <span class="nv">dont-recurse</span>
</span></span><span class="line"><span class="cl">                        <span class="p">(</span><span class="nf">directory-files</span> <span class="nv">search-path</span> <span class="nb">:full</span> <span class="s">&#34;\.org$&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                      <span class="p">(</span><span class="nv">directory-files-recursively</span> <span class="nv">search-path</span> <span class="s">&#34;\.org$&#34;</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">         <span class="p">(</span><span class="nv">num-files</span> <span class="p">(</span><span class="nf">length</span> <span class="nv">org-files</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">         <span class="p">(</span><span class="nv">cnt</span> <span class="mi">1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">if</span> <span class="p">(</span><span class="nf">=</span> <span class="mi">0</span> <span class="nv">num-files</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nf">message</span> <span class="p">(</span><span class="nf">format</span> <span class="s">&#34;No Org files found in %s&#34;</span> <span class="nv">search-path</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nb">progn</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nf">message</span> <span class="p">(</span><span class="nf">format</span> <span class="p">(</span><span class="nb">if</span> <span class="nv">dont-recurse</span>
</span></span><span class="line"><span class="cl">                             <span class="s">&#34;[ox-hugo/export-all] Exporting %d files from %S ..&#34;</span>
</span></span><span class="line"><span class="cl">                           <span class="s">&#34;[ox-hugo/export-all] Exporting %d files recursively from %S ..&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                         <span class="nv">num-files</span> <span class="nv">search-path</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nb">dolist</span> <span class="p">(</span><span class="nv">org-file</span> <span class="nv">org-files</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span><span class="nb">with-current-buffer</span> <span class="p">(</span><span class="nv">find-file-noselect</span> <span class="nv">org-file</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="nf">message</span> <span class="p">(</span><span class="nf">format</span> <span class="s">&#34;[ox-hugo/export-all file %d/%d] Exporting %s&#34;</span> <span class="nv">cnt</span> <span class="nv">num-files</span> <span class="nv">org-file</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="nv">org-hugo-export-wim-to-md</span> <span class="nb">:all-subtrees</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="nb">setq</span> <span class="nv">cnt</span> <span class="p">(</span><span class="nf">1+</span> <span class="nv">cnt</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nv">org-transclusion-mode</span> <span class="mi">-1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nf">message</span> <span class="s">&#34;Done!&#34;</span><span class="p">)))))</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">provide</span> <span class="ss">&#39;init-org</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;; init-org.el ends here</span>
</span></span></code></pre></div><h4 id="org-babel">Org-babel<a hidden class="anchor" aria-hidden="true" href="#org-babel">#</a></h4>
<p>输出 <code>:results</code> 有不同的选项，其中 <code>silent</code> 是指：Do not insert results in the Org mode buffer, but echo them in the minibuffer. Usage example: ‘:results output silent’.</p>
<p>Rust 运行代码块，需要安装 <a href="https://github.com/brotzeit/rustic">GitHub - brotzeit/rustic: Rust development environment for Emacs</a>，具体执行的时候会提示需要安装 <code>lsp-mode</code>​，确定即可。</p>
<h4 id="plantuml">PlantUML<a hidden class="anchor" aria-hidden="true" href="#plantuml">#</a></h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">brew install graphviz
</span></span></code></pre></div><table>
<thead>
<tr>
<th>Type</th>
<th>Symbol</th>
</tr>
</thead>
<tbody>
<tr>
<td>Zero or One</td>
<td>o|&ndash;</td>
</tr>
<tr>
<td>Exactly One</td>
<td>||&ndash;</td>
</tr>
<tr>
<td>Zero or Many</td>
<td>}o&ndash;</td>
</tr>
<tr>
<td>One or Many</td>
<td>}|&ndash;</td>
</tr>
</tbody>
</table>
<pre tabindex="0"><code class="language-nil" data-lang="nil">@startumlg
scale 2
Entity01 }|..|| Entity02
Entity03 }o..o| Entity04
Entity05 ||--o{ Entity06
Entity07 |o--|| Entity08
@enduml
</code></pre><p>PlantUML 默认的样式比较古老，可以用更加现代一些的样式：<a href="https://github.com/xuanye/plantuml-style-c4">GitHub - xuanye/plantuml-style-c4: 自定义的plantuml 样式</a>，不过好久没更新了，前面的颜色也是参考的这个：<a href="https://github.com/plantuml-stdlib/C4-PlantUML">GitHub - plantuml-stdlib/C4-PlantUML: C4-PlantUML combines the benefits of Pl&hellip;</a>。</p>
<figure>
    <img loading="lazy" src="/ox-hugo/ERD-example.jpg"/> 
</figure>

<h3 id="init-sis-dot-el">init-sis.el<a hidden class="anchor" aria-hidden="true" href="#init-sis-dot-el">#</a></h3>
<p>根据 meow 的 <code>insert mode</code> 切换，同时根据上下文来判断切换输入法；另外在特定 <code>mode</code> 下也切换输入法，使用更加顺滑。</p>
<p>需要安装 <code>macism</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">brew tap laishulu/macism
</span></span><span class="line"><span class="cl">brew install macism
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-elisp" data-lang="elisp"><span class="line"><span class="cl"><span class="c1">;;; init-sis.el  --- Custom configuration</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;; Commentary</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">require-package</span> <span class="ss">&#39;sis</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; meow insert mode switch</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defvar</span> <span class="nv">meow-leaving-insert-mode-hook</span> <span class="no">nil</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;Hook to run when leaving meow insert mode.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defvar</span> <span class="nv">meow-entering-insert-mode-hook</span> <span class="no">nil</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;Hook to run when entering meow insert mode.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">add-hook</span> <span class="ss">&#39;meow-insert-mode-hook</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">lambda</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nb">if</span> <span class="nv">meow-insert-mode</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="nf">run-hooks</span> <span class="ss">&#39;meow-entering-insert-mode-hook</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span><span class="nf">run-hooks</span> <span class="ss">&#39;meow-leaving-insert-mode-hook</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">use-package</span> <span class="nv">sis</span>
</span></span><span class="line"><span class="cl">  <span class="nb">:config</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">setq</span> <span class="nv">sis-english-source</span> <span class="s">&#34;com.apple.keylayout.ABC&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">if</span> <span class="vg">*IS-MAC*</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nv">sis-ism-lazyman-config</span>
</span></span><span class="line"><span class="cl">       <span class="s">&#34;com.apple.keylayout.ABC&#34;</span>
</span></span><span class="line"><span class="cl">       <span class="s">&#34;im.rime.inputmethod.Squirrel.Hans&#34;</span> <span class="ss">&#39;macism</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nv">sis-ism-lazyman-config</span> <span class="s">&#34;1&#34;</span> <span class="s">&#34;2&#34;</span> <span class="ss">&#39;fcitx</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="c1">;; enable the /cursor color/ mode</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">sis-global-cursor-color-mode</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="c1">;; enable the /respect/ mode</span>
</span></span><span class="line"><span class="cl">  <span class="c1">;; 打开会影响 meow-reverse，因为 meow 下退出模式编辑后都是默认英文，这里也无需开启。</span>
</span></span><span class="line"><span class="cl">  <span class="c1">;; (sis-global-respect-mode t)</span>
</span></span><span class="line"><span class="cl">  <span class="c1">;; enable the /context/ mode for all buffers</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">sis-global-context-mode</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="c1">;; enable the /inline english/ mode for all buffers</span>
</span></span><span class="line"><span class="cl">  <span class="c1">;; (sis-global-inline-mode t)</span>
</span></span><span class="line"><span class="cl">  <span class="c1">;; not delete the head spaces</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">setq</span> <span class="nv">sis-inline-tighten-head-rule</span> <span class="no">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">setq</span> <span class="nv">sis-default-cursor-color</span> <span class="s">&#34;#FE6DB3&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">setq</span> <span class="nv">sis-other-cursor-color</span> <span class="s">&#34;orange&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">setq</span> <span class="nv">sis-prefix-override-keys</span> <span class="p">(</span><span class="nf">list</span> <span class="s">&#34;C-c&#34;</span> <span class="s">&#34;C-x&#34;</span> <span class="s">&#34;C-h&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">add-hook</span> <span class="ss">&#39;meow-leaving-insert-mode-hook</span> <span class="nf">#&#39;</span><span class="nv">sis-set-english</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">add-to-list</span> <span class="ss">&#39;sis-context-hooks</span> <span class="ss">&#39;meow-entering-insert-mode-hook</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="c1">;; org title 处切换 Rime，telega 聊天时切换 Rime。</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">add-to-list</span> <span class="ss">&#39;sis-context-detectors</span>
</span></span><span class="line"><span class="cl">               <span class="p">(</span><span class="nb">lambda</span> <span class="p">(</span><span class="kp">&amp;rest</span> <span class="nv">_</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                 <span class="c1">;; (when (or (and (eq major-mode &#39;org-mode) (org-at-heading-p))</span>
</span></span><span class="line"><span class="cl">                 <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nb">or</span> <span class="p">(</span><span class="nf">eq</span> <span class="nv">major-mode</span> <span class="ss">&#39;org-mode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                           <span class="p">(</span><span class="nf">eq</span> <span class="nv">major-mode</span> <span class="ss">&#39;telega-chat-mode</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                   <span class="ss">&#39;other</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">advice-add</span> <span class="ss">&#39;org-agenda-todo</span> <span class="nb">:before</span> <span class="nf">#&#39;</span><span class="nv">sis-set-english</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">advice-add</span> <span class="ss">&#39;hydra-org-agenda-menu/body</span> <span class="nb">:after</span> <span class="nf">#&#39;</span><span class="nv">sis-set-english</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="nb">:ensure</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; MacOS 上防止进入 insert mode 覆盖要切换的中文状态</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">sis--respect-focus-in-handler</span> <span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">provide</span> <span class="ss">&#39;init-sis</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;; init-sis.el ends here</span>
</span></span></code></pre></div><p>注：从其他 App 切回 Emacs 后进入 <code>insert mode</code> 之后切换到中文后立刻切换到英文，解决办法如下。（问题 <code>emacs -Q</code> 记录视频 <a href="https://imgur.com/a/TKaD3So">Imgur: The magic of the Internet</a>）</p>
<blockquote>
<p>是这样的，
你是从其它应用切回 emacs 后，
立刻就 i 进入 insert mode？</p>
<p>如果稍微延迟一下再 i 进入 insert mode，
是不是就没这个问题了？</p>
<p>emacs 处理窗口焦点的切换（focus in事件）是有一个延迟的，
这样操作就导致：</p>
<p>focus in 之后恢复当前 buffer 的 input source（因为离开前为 normal 状态，所以为 english）
你进入 insert mode 切换 input source（为 rime）
这二者抢占了。</p>
<p>比较 dirty 但是直接的办法是，
你把下面这个函数在自己的配置文件中重新定义一下，让 sis 不要切换。</p>
<p><a href="https://github.com/laishulu/emacs-smart-input-source/blob/02777a46a4b7c18c2cd588e6e2f11e83ba2378e4/sis.el#L811">emacs-smart-input-source/sis.el at 02777a46a4b7c18c2cd588e6e2f11e83ba2378e4 ·&hellip;</a></p>
<p>但是这块也不算是 sis 的 bug，
sis 对于焦点切换也只能做到这一步。
包治百病的用法就是切回emacs稍微等一下。</p>
<p>不过我又想到一点，
macos 可以系统配置“自动切换到文稿的输入法”，
你如果配置了这个，
在使用 GUI Emacs 时，应该是不需要 sis 自己去恢复当前 buffer 的输入法的。
那就可以用空函数去覆盖上面那个函数了。
但是！！！
macos 也会帮你主动地切输入法，就是不知道会不会也有延迟，导致同样的问题</p>
<p>不过 sis 针对的是一般情况：非 MacOS 系统，或没系统设置“自动切换到文稿的输入法”，或用的是 Terminal Emacs 等等。</p>
</blockquote>
<h3 id="init-font-dot-el">init-font.el<a hidden class="anchor" aria-hidden="true" href="#init-font-dot-el">#</a></h3>
<p>使用的是 <code>Iosevka</code> 和大多数中文字体配合，按照 1:1 缩放，偶数字号就可以做到等高等宽。这是选择 <code>LXGW WenKai Screen</code> 而不是 <code>LXGW WenKai Mono</code> 是因为后者的粗体非常不明显，作为文档文字不好区分。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-elisp" data-lang="elisp"><span class="line"><span class="cl"><span class="c1">;;; init-font.el --- Dired customisations -*- lexical-binding: t -*-</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;; Commentary:</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;; Code:</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;; base on https://gist.github.com/coldnew/7398835</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">qiang-font-existsp</span> <span class="p">(</span><span class="nv">font</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">if</span> <span class="p">(</span><span class="nf">null</span> <span class="p">(</span><span class="nf">x-list-fonts</span> <span class="nv">font</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">      <span class="no">nil</span>
</span></span><span class="line"><span class="cl">    <span class="no">t</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; LXGW WenKai Mono 配合 Iosevka 按照 1:1 缩放，偶数字号就可以做到等高等宽。</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defvar</span> <span class="nv">zh-font-list</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;LXGW WenKai Screen&#34;</span> <span class="s">&#34;FZSongKeBenXiuKai-R-GBK&#34;</span> <span class="s">&#34;HanaMinB&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defvar</span> <span class="nv">en-font-list</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;Iosevka&#34;</span> <span class="s">&#34;Latin Modern Mono&#34;</span> <span class="s">&#34;Fira Code&#34;</span> <span class="s">&#34;IBM Plex Mono&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">qiang-make-font-string</span> <span class="p">(</span><span class="nv">font-name</span> <span class="nv">font-size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">if</span> <span class="p">(</span><span class="nb">and</span> <span class="p">(</span><span class="nf">stringp</span> <span class="nv">font-size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">           <span class="p">(</span><span class="nf">equal</span> <span class="s">&#34;:&#34;</span> <span class="p">(</span><span class="nf">string</span> <span class="p">(</span><span class="nf">elt</span> <span class="nv">font-size</span> <span class="mi">0</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nf">format</span> <span class="s">&#34;%s%s&#34;</span> <span class="nv">font-name</span> <span class="nv">font-size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nf">format</span> <span class="s">&#34;%s %s&#34;</span> <span class="nv">font-name</span> <span class="nv">font-size</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">qiang-set-font</span> <span class="p">(</span><span class="nv">english-fonts</span>
</span></span><span class="line"><span class="cl">                       <span class="nv">english-font-size</span>
</span></span><span class="line"><span class="cl">                       <span class="nv">chinese-fonts</span>
</span></span><span class="line"><span class="cl">                       <span class="kp">&amp;optional</span> <span class="nv">chinese-font-scale</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">setq</span> <span class="nv">chinese-font-scale</span> <span class="p">(</span><span class="nb">or</span> <span class="nv">chinese-font-scale</span> <span class="mi">1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">setq</span> <span class="nv">face-font-rescale-alist</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nb">cl-loop</span> <span class="nv">for</span> <span class="nv">x</span> <span class="nv">in</span> <span class="nv">zh-font-list</span>
</span></span><span class="line"><span class="cl">              <span class="nv">collect</span> <span class="p">(</span><span class="nf">cons</span> <span class="nv">x</span> <span class="nv">chinese-font-scale</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="s">&#34;english-font-size could be set to \&#34;:pixelsize=18\&#34; or a integer.
</span></span></span><span class="line"><span class="cl"><span class="s">If set/leave chinese-font-scale to nil, it will follow english-font-size&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">let</span> <span class="p">((</span><span class="nv">en-font</span> <span class="p">(</span><span class="nv">qiang-make-font-string</span>
</span></span><span class="line"><span class="cl">                  <span class="p">(</span><span class="nv">cl-find-if</span> <span class="nf">#&#39;</span><span class="nv">qiang-font-existsp</span> <span class="nv">english-fonts</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                  <span class="nv">english-font-size</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nv">zh-font</span> <span class="p">(</span><span class="nf">font-spec</span> <span class="nb">:family</span> <span class="p">(</span><span class="nv">cl-find-if</span> <span class="nf">#&#39;</span><span class="nv">qiang-font-existsp</span> <span class="nv">chinese-fonts</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">;; Set the default English font</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nf">message</span> <span class="s">&#34;Set English Font to %s&#34;</span> <span class="nv">en-font</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nv">set-face-attribute</span> <span class="ss">&#39;default</span> <span class="no">nil</span> <span class="nb">:font</span> <span class="nv">en-font</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">;; Set Chinese font</span>
</span></span><span class="line"><span class="cl">    <span class="c1">;; Do not use &#39;unicode charset, it will cause the English font setting invalid</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nf">message</span> <span class="s">&#34;Set Chinese Font to %s&#34;</span> <span class="nv">zh-font</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">dolist</span> <span class="p">(</span><span class="nv">charset</span> <span class="o">&#39;</span><span class="p">(</span><span class="nv">kana</span> <span class="nv">han</span> <span class="nv">symbol</span> <span class="nv">cjk-misc</span> <span class="nv">bopomofo</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nf">set-fontset-font</span> <span class="p">(</span><span class="nf">frame-parameter</span> <span class="no">nil</span> <span class="ss">&#39;font</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="nv">charset</span> <span class="nv">zh-font</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">qiang-set-font</span> <span class="nv">en-font-list</span> <span class="mi">14</span> <span class="nv">zh-font-list</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">add-to-list</span> <span class="ss">&#39;face-font-rescale-alist</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;Apple Color Emoji&#34;</span> <span class="o">.</span> <span class="mf">0.8</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">provide</span> <span class="ss">&#39;init-font</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;; init-font.el ends here</span>
</span></span></code></pre></div><h3 id="init-rime-dot-el">init-rime.el<a hidden class="anchor" aria-hidden="true" href="#init-rime-dot-el">#</a></h3>
<p>需要安装 Squirrel 并下载与之对应版本的 librime。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">curl -L -O https://github.com/rime/librime/releases/download/1.7.3/rime-1.7.3-osx.zip
</span></span><span class="line"><span class="cl">unzip rime-1.7.3-osx.zip -d ~/.emacs.d/librime
</span></span><span class="line"><span class="cl">rm -rf rime-1.7.3-osx.zip
</span></span></code></pre></div><p>使用拼音输入法需要维护两份配置，但是备份位置可以是同一个地址，这样就达到了同步配置的目的。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">cp -rf ~/Library/Rime ~/.emacs.d/
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-elisp" data-lang="elisp"><span class="line"><span class="cl"><span class="c1">;;; init-rime.el  --- Custom configuration</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;; Commentary</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">require-package</span> <span class="ss">&#39;rime</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">use-package</span> <span class="nv">rime</span>
</span></span><span class="line"><span class="cl">  <span class="nb">:custom</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">default-input-method</span> <span class="s">&#34;rime&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">rime-librime-root</span> <span class="s">&#34;~/.emacs.d/librime/dist&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">rime-emacs-module-header-root</span> <span class="s">&#34;/usr/local/Cellar/emacs-plus@29/29.0.50/include&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="nb">:config</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nf">define-key</span> <span class="nv">rime-mode-map</span> <span class="p">(</span><span class="nv">kbd</span> <span class="s">&#34;C-i&#34;</span><span class="p">)</span> <span class="ss">&#39;rime-force-enable</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="c1">;; 方案切换选择</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nf">define-key</span> <span class="nv">rime-mode-map</span> <span class="p">(</span><span class="nv">kbd</span> <span class="s">&#34;C-`&#34;</span><span class="p">)</span> <span class="ss">&#39;rime-send-keybinding</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">setq</span> <span class="nv">rime-disable-predicates</span>
</span></span><span class="line"><span class="cl">        <span class="o">&#39;</span><span class="p">(</span><span class="nv">meow-normal-mode-p</span>
</span></span><span class="line"><span class="cl">                                  <span class="nv">meow-motion-mode-p</span>
</span></span><span class="line"><span class="cl">                                  <span class="nv">meow-keypad-mode-p</span>
</span></span><span class="line"><span class="cl">          <span class="c1">;; If cursor is in code.</span>
</span></span><span class="line"><span class="cl">          <span class="nv">rime-predicate-prog-in-code-p</span>
</span></span><span class="line"><span class="cl">          <span class="c1">;; If the cursor is after a alphabet character.</span>
</span></span><span class="line"><span class="cl">          <span class="nv">rime-predicate-after-alphabet-char-p</span>
</span></span><span class="line"><span class="cl">          <span class="c1">;; If input a punctuation after</span>
</span></span><span class="line"><span class="cl">          <span class="c1">;; a Chinese charactor with whitespace.</span>
</span></span><span class="line"><span class="cl">          <span class="nv">rime-predicate-punctuation-after-space-cc-p</span>
</span></span><span class="line"><span class="cl">          <span class="nv">rime-predicate-special-ascii-line-begin-p</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">setq</span> <span class="nv">rime-inline-predicates</span>
</span></span><span class="line"><span class="cl">        <span class="c1">;; If cursor is after a whitespace</span>
</span></span><span class="line"><span class="cl">        <span class="c1">;; which follow a non-ascii character.</span>
</span></span><span class="line"><span class="cl">        <span class="o">&#39;</span><span class="p">(</span><span class="nv">rime-predicate-space-after-cc-p</span>
</span></span><span class="line"><span class="cl">          <span class="c1">;; If the current charactor entered is a uppercase letter.</span>
</span></span><span class="line"><span class="cl">          <span class="nv">rime-predicate-current-uppercase-letter-p</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="c1">;;; support shift-l, shift-r, control-l, control-r</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">setq</span> <span class="nv">rime-inline-ascii-trigger</span> <span class="ss">&#39;shift-r</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="c1">;; meow 进入 insert-mode，且是 org-mode 或</span>
</span></span><span class="line"><span class="cl">  <span class="c1">;; telega-chat-mode 时，切换到 Rime。</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">add-hook</span> <span class="ss">&#39;meow-insert-enter-hook</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="nb">lambda</span><span class="p">()</span> <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nv">derived-mode-p</span> <span class="ss">&#39;org-mode</span> <span class="ss">&#39;telega-chat-mode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="p">(</span><span class="nv">set-input-method</span> <span class="s">&#34;rime&#34;</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">  <span class="c1">;; 退出 insert mode 时，恢复英文。</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">add-hook</span> <span class="ss">&#39;meow-insert-exit-hook</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="nb">lambda</span><span class="p">()</span> <span class="p">(</span><span class="nv">set-input-method</span> <span class="no">nil</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">setq</span> <span class="nv">rime-user-data-dir</span> <span class="s">&#34;~/.emacs.d/Rime&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">rime-predicate-special-ascii-line-begin-p</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;If &#39;/&#39; or &#39;#&#39; at the beginning of the line.&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">and</span> <span class="p">(</span><span class="nf">&gt;</span> <span class="p">(</span><span class="nf">point</span><span class="p">)</span> <span class="p">(</span><span class="nb">save-excursion</span> <span class="p">(</span><span class="nv">back-to-indentation</span><span class="p">)</span> <span class="p">(</span><span class="nf">point</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">       <span class="p">(</span><span class="nb">let</span> <span class="p">((</span><span class="nf">string</span> <span class="p">(</span><span class="nf">buffer-substring</span> <span class="p">(</span><span class="nf">point</span><span class="p">)</span> <span class="p">(</span><span class="nf">max</span> <span class="p">(</span><span class="nf">line-beginning-position</span><span class="p">)</span> <span class="p">(</span><span class="nf">-</span> <span class="p">(</span><span class="nf">point</span><span class="p">)</span> <span class="mi">80</span><span class="p">)))))</span>
</span></span><span class="line"><span class="cl">         <span class="p">(</span><span class="nv">string-match-p</span> <span class="s">&#34;^[\/#]&#34;</span> <span class="nf">string</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">provide</span> <span class="ss">&#39;init-rime</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;; init-rime.el ends here</span>
</span></span></code></pre></div><p>其中 <code>(setq rime-inline-ascii-trigger 'shift-r)</code> 需要配合 Rime 中 <code>default.custom.yaml</code> 配置中的 <code>Shift_R: inline_ascii</code> 才可生效。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">patch</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># commit_code 上屏输出 code 并切换成英文</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># commit_text 上屏输出内容并切换成英文</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># clear 清除内容并切换成英文</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ascii_composer/good_old_caps_lock</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ascii_composer/switch_key</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">Caps_Lock</span><span class="p">:</span><span class="w"> </span><span class="l">commit_code</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">Control_L</span><span class="p">:</span><span class="w"> </span><span class="l">noop</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">Control_R</span><span class="p">:</span><span class="w"> </span><span class="l">noop</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">Shift_L</span><span class="p">:</span><span class="w"> </span><span class="l">commit_code</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">Shift_R</span><span class="p">:</span><span class="w"> </span><span class="l">inline_ascii</span><span class="w">
</span></span></span></code></pre></div><p>最终实现的效果是。</p>
<ul>
<li>进入 meow 的 insert-mode 自动启用 Rime，退出 insert-mode 后关闭 Rime。</li>
<li>在编程界面，Rime 开启时，代码中自动切换英文，注释中自动切换中文。</li>
<li>字母及英文字符紧跟后面输入自动切换英文。（遇到以英文在半句或者整句后的情况下，英文后要输入逗号或者句号等中文符号，可以使用 <code>rime-force-enable</code> 来强制中文模式，这样就可以在前面描述的情况下强制输入中文符号。）</li>
<li>以 <code>#</code> 或 <code>/</code> 开头，则切换英文。</li>
<li>中文后空格自动切换 inline 模式，输入大写字母自动切换 inline 模式。</li>
</ul>
<p>其中在 <code>Isearch</code> 中使用，切换为 Rime 后需要再按一次 <code>M-e</code> 才可以正常使用。</p>
<h3 id="init-meow-dot-el">init-meow.el<a hidden class="anchor" aria-hidden="true" href="#init-meow-dot-el">#</a></h3>
<table>
<thead>
<tr>
<th>快捷键</th>
<th>功能</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>M-S-&lt;</code></td>
<td>移动光标到顶部</td>
<td><code>cmd-shift-&lt;</code></td>
</tr>
</tbody>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-elisp" data-lang="elisp"><span class="line"><span class="cl"><span class="c1">;;; init-meow.el  --- Custom configuration</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;; Commentary</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">require-package</span> <span class="ss">&#39;meow</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">require</span> <span class="ss">&#39;meow</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">meow-setup</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">setq</span> <span class="nv">meow-cheatsheet-layout</span> <span class="nv">meow-cheatsheet-layout-qwerty</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">meow-motion-overwrite-define-key</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;j&#34;</span> <span class="o">.</span> <span class="nv">meow-next</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;k&#34;</span> <span class="o">.</span> <span class="nv">meow-prev</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;&lt;escape&gt;&#34;</span> <span class="o">.</span> <span class="nv">ignore</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">meow-leader-define-key</span>
</span></span><span class="line"><span class="cl">   <span class="c1">;; SPC j/k will run the original command in MOTION state.</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;j&#34;</span> <span class="o">.</span> <span class="s">&#34;H-j&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;k&#34;</span> <span class="o">.</span> <span class="s">&#34;H-k&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="c1">;; Use SPC (0-9) for digit arguments.</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;1&#34;</span> <span class="o">.</span> <span class="nv">meow-digit-argument</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;2&#34;</span> <span class="o">.</span> <span class="nv">meow-digit-argument</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;3&#34;</span> <span class="o">.</span> <span class="nv">meow-digit-argument</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;4&#34;</span> <span class="o">.</span> <span class="nv">meow-digit-argument</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;5&#34;</span> <span class="o">.</span> <span class="nv">meow-digit-argument</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;6&#34;</span> <span class="o">.</span> <span class="nv">meow-digit-argument</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;7&#34;</span> <span class="o">.</span> <span class="nv">meow-digit-argument</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;8&#34;</span> <span class="o">.</span> <span class="nv">meow-digit-argument</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;9&#34;</span> <span class="o">.</span> <span class="nv">meow-digit-argument</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;0&#34;</span> <span class="o">.</span> <span class="nv">meow-digit-argument</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;/&#34;</span> <span class="o">.</span> <span class="nv">meow-keypad-describe-key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;?&#34;</span> <span class="o">.</span> <span class="nv">meow-cheatsheet</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">meow-normal-define-key</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;0&#34;</span> <span class="o">.</span> <span class="nv">meow-expand-0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;9&#34;</span> <span class="o">.</span> <span class="nv">meow-expand-9</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;8&#34;</span> <span class="o">.</span> <span class="nv">meow-expand-8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;7&#34;</span> <span class="o">.</span> <span class="nv">meow-expand-7</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;6&#34;</span> <span class="o">.</span> <span class="nv">meow-expand-6</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;5&#34;</span> <span class="o">.</span> <span class="nv">meow-expand-5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;4&#34;</span> <span class="o">.</span> <span class="nv">meow-expand-4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;3&#34;</span> <span class="o">.</span> <span class="nv">meow-expand-3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;2&#34;</span> <span class="o">.</span> <span class="nv">meow-expand-2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;1&#34;</span> <span class="o">.</span> <span class="nv">meow-expand-1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;-&#34;</span> <span class="o">.</span> <span class="nv">negative-argument</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;;&#34;</span> <span class="o">.</span> <span class="nv">meow-reverse</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;,&#34;</span> <span class="o">.</span> <span class="nv">meow-inner-of-thing</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;.&#34;</span> <span class="o">.</span> <span class="nv">meow-bounds-of-thing</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;[&#34;</span> <span class="o">.</span> <span class="nv">meow-beginning-of-thing</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;]&#34;</span> <span class="o">.</span> <span class="nv">meow-end-of-thing</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;a&#34;</span> <span class="o">.</span> <span class="nv">meow-append</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;A&#34;</span> <span class="o">.</span> <span class="nv">meow-open-below</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;b&#34;</span> <span class="o">.</span> <span class="nv">meow-back-word</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;B&#34;</span> <span class="o">.</span> <span class="nv">meow-back-symbol</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;c&#34;</span> <span class="o">.</span> <span class="nv">meow-change</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;d&#34;</span> <span class="o">.</span> <span class="nv">meow-delete</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;D&#34;</span> <span class="o">.</span> <span class="nv">meow-backward-delete</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;e&#34;</span> <span class="o">.</span> <span class="nv">meow-next-word</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;E&#34;</span> <span class="o">.</span> <span class="nv">meow-next-symbol</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;f&#34;</span> <span class="o">.</span> <span class="nv">meow-find</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;g&#34;</span> <span class="o">.</span> <span class="nv">meow-cancel-selection</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;G&#34;</span> <span class="o">.</span> <span class="nv">meow-grab</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;h&#34;</span> <span class="o">.</span> <span class="nv">meow-left</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;H&#34;</span> <span class="o">.</span> <span class="nv">meow-left-expand</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;i&#34;</span> <span class="o">.</span> <span class="nv">meow-insert</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;I&#34;</span> <span class="o">.</span> <span class="nv">meow-open-above</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;j&#34;</span> <span class="o">.</span> <span class="nv">meow-next</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;J&#34;</span> <span class="o">.</span> <span class="nv">meow-next-expand</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;k&#34;</span> <span class="o">.</span> <span class="nv">meow-prev</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;K&#34;</span> <span class="o">.</span> <span class="nv">meow-prev-expand</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;l&#34;</span> <span class="o">.</span> <span class="nv">meow-right</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;L&#34;</span> <span class="o">.</span> <span class="nv">meow-right-expand</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;m&#34;</span> <span class="o">.</span> <span class="nv">meow-join</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;n&#34;</span> <span class="o">.</span> <span class="nv">meow-search</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;o&#34;</span> <span class="o">.</span> <span class="nv">meow-block</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;O&#34;</span> <span class="o">.</span> <span class="nv">meow-to-block</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;p&#34;</span> <span class="o">.</span> <span class="nv">meow-yank</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;q&#34;</span> <span class="o">.</span> <span class="nv">meow-quit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;Q&#34;</span> <span class="o">.</span> <span class="nv">meow-goto-line</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;r&#34;</span> <span class="o">.</span> <span class="nv">meow-replace</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;R&#34;</span> <span class="o">.</span> <span class="nv">meow-swap-grab</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;s&#34;</span> <span class="o">.</span> <span class="nv">meow-kill</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;t&#34;</span> <span class="o">.</span> <span class="nv">meow-till</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;u&#34;</span> <span class="o">.</span> <span class="nv">meow-undo</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;U&#34;</span> <span class="o">.</span> <span class="nv">meow-undo-in-selection</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;v&#34;</span> <span class="o">.</span> <span class="nv">meow-visit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;w&#34;</span> <span class="o">.</span> <span class="nv">meow-mark-word</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;W&#34;</span> <span class="o">.</span> <span class="nv">meow-mark-symbol</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;x&#34;</span> <span class="o">.</span> <span class="nv">meow-line</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;X&#34;</span> <span class="o">.</span> <span class="nv">meow-goto-line</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;y&#34;</span> <span class="o">.</span> <span class="nv">meow-save</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;Y&#34;</span> <span class="o">.</span> <span class="nv">meow-sync-grab</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;z&#34;</span> <span class="o">.</span> <span class="nv">meow-pop-selection</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;&#39;&#34;</span> <span class="o">.</span> <span class="nv">repeat</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;&lt;escape&gt;&#34;</span> <span class="o">.</span> <span class="nv">ignore</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">meow-setup</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">meow-global-mode</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; 失去焦点时，退出 insert mode。</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">add-hook</span> <span class="ss">&#39;focus-out-hook</span> <span class="ss">&#39;meow-insert-exit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; 延长数字显示时间</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">meow-expand-hint-remove-delay</span> <span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">provide</span> <span class="ss">&#39;init-meow</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;; init-meow.el ends here</span>
</span></span></code></pre></div><h3 id="beancount-dot-el">beancount.el<a hidden class="anchor" aria-hidden="true" href="#beancount-dot-el">#</a></h3>
<p><a href="https://github.com/beancount/beancount-mode">GitHub - beancount/beancount-mode: Emacs major-mode to work with Beancount le&hellip;</a>，这里是将其中的 <code>beancount.el</code> 下载到 <code>.emacs.d/lisp/</code> 目录下，加上下列代码。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-elisp" data-lang="elisp"><span class="line"><span class="cl"><span class="p">(</span><span class="nv">add-to-list</span> <span class="ss">&#39;auto-mode-alist</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;\\.beancount\\&#39;&#34;</span> <span class="o">.</span> <span class="nv">beancount-mode</span><span class="p">))</span>
</span></span></code></pre></div><h3 id="init-epla-dot-el">init-epla.el<a hidden class="anchor" aria-hidden="true" href="#init-epla-dot-el">#</a></h3>
<p>增加 <code>use-package</code> 和 <code>straight</code> 的支持</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-elisp" data-lang="elisp"><span class="line"><span class="cl"><span class="c1">;;; init-elpa.el --- Settings and helpers for package.el -*- lexical-binding: t -*-</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;; Commentary:</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;; Code:</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">require</span> <span class="ss">&#39;package</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">require</span> <span class="ss">&#39;cl-lib</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;;; Install into separate package dirs for each Emacs version, to prevent bytecode incompatibility</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">package-user-dir</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nf">expand-file-name</span> <span class="p">(</span><span class="nf">format</span> <span class="s">&#34;elpa-%s.%s&#34;</span> <span class="nv">emacs-major-version</span> <span class="nv">emacs-minor-version</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="nv">user-emacs-directory</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;;; Standard package repositories</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">add-to-list</span> <span class="ss">&#39;package-archives</span> <span class="o">&#39;</span><span class="p">(</span> <span class="s">&#34;melpa&#34;</span> <span class="o">.</span> <span class="s">&#34;https://melpa.org/packages/&#34;</span><span class="p">)</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; Official MELPA Mirror, in case necessary.</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;(add-to-list &#39;package-archives (cons &#34;melpa-mirror&#34; (concat proto &#34;://www.mirrorservice.org/sites/melpa.org/packages/&#34;)) t)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;; Work-around for https://debbugs.gnu.org/cgi/bugreport.cgi?bug=34341</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nb">and</span> <span class="p">(</span><span class="nv">version&lt;</span> <span class="nv">emacs-version</span> <span class="s">&#34;26.3&#34;</span><span class="p">)</span> <span class="p">(</span><span class="nf">boundp</span> <span class="ss">&#39;libgnutls-version</span><span class="p">)</span> <span class="p">(</span><span class="nf">&gt;=</span> <span class="nv">libgnutls-version</span> <span class="mi">30604</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">setq</span> <span class="nv">gnutls-algorithm-priority</span> <span class="s">&#34;NORMAL:-VERS-TLS1.3&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;;; On-demand installation of packages</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">require-package</span> <span class="p">(</span><span class="nv">package</span> <span class="kp">&amp;optional</span> <span class="nv">min-version</span> <span class="nv">no-refresh</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;Install given PACKAGE, optionally requiring MIN-VERSION.
</span></span></span><span class="line"><span class="cl"><span class="s">If NO-REFRESH is non-nil, the available package lists will not be
</span></span></span><span class="line"><span class="cl"><span class="s">re-downloaded in order to locate PACKAGE.&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nf">stringp</span> <span class="nv">min-version</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">setq</span> <span class="nv">min-version</span> <span class="p">(</span><span class="nv">version-to-list</span> <span class="nv">min-version</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">or</span> <span class="p">(</span><span class="nv">package-installed-p</span> <span class="nv">package</span> <span class="nv">min-version</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nb">let*</span> <span class="p">((</span><span class="nv">known</span> <span class="p">(</span><span class="nf">cdr</span> <span class="p">(</span><span class="nf">assoc</span> <span class="nv">package</span> <span class="nv">package-archive-contents</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">             <span class="p">(</span><span class="nv">best</span> <span class="p">(</span><span class="nf">car</span> <span class="p">(</span><span class="nf">sort</span> <span class="nv">known</span> <span class="p">(</span><span class="nb">lambda</span> <span class="p">(</span><span class="nv">a</span> <span class="nv">b</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                      <span class="p">(</span><span class="nv">version-list-&lt;=</span> <span class="p">(</span><span class="nv">package-desc-version</span> <span class="nv">b</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                                       <span class="p">(</span><span class="nv">package-desc-version</span> <span class="nv">a</span><span class="p">)))))))</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nb">if</span> <span class="p">(</span><span class="nb">and</span> <span class="nv">best</span> <span class="p">(</span><span class="nv">version-list-&lt;=</span> <span class="nv">min-version</span> <span class="p">(</span><span class="nv">package-desc-version</span> <span class="nv">best</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="nv">package-install</span> <span class="nv">best</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span><span class="nb">if</span> <span class="nv">no-refresh</span>
</span></span><span class="line"><span class="cl">              <span class="p">(</span><span class="ne">error</span> <span class="s">&#34;No version of %s &gt;= %S is available&#34;</span> <span class="nv">package</span> <span class="nv">min-version</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="nv">package-refresh-contents</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="nv">require-package</span> <span class="nv">package</span> <span class="nv">min-version</span> <span class="no">t</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nv">package-installed-p</span> <span class="nv">package</span> <span class="nv">min-version</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">maybe-require-package</span> <span class="p">(</span><span class="nv">package</span> <span class="kp">&amp;optional</span> <span class="nv">min-version</span> <span class="nv">no-refresh</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;Try to install PACKAGE, and return non-nil if successful.
</span></span></span><span class="line"><span class="cl"><span class="s">In the event of failure, return nil and print a warning message.
</span></span></span><span class="line"><span class="cl"><span class="s">Optionally require MIN-VERSION.  If NO-REFRESH is non-nil, the
</span></span></span><span class="line"><span class="cl"><span class="s">available package lists will not be re-downloaded in order to
</span></span></span><span class="line"><span class="cl"><span class="s">locate PACKAGE.&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">condition-case</span> <span class="nv">err</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nv">require-package</span> <span class="nv">package</span> <span class="nv">min-version</span> <span class="nv">no-refresh</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="ne">error</span>
</span></span><span class="line"><span class="cl">     <span class="p">(</span><span class="nf">message</span> <span class="s">&#34;Couldn&#39;t install optional package </span><span class="ss">`%s&#39;</span><span class="s">: %S&#34;</span> <span class="nv">package</span> <span class="nv">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">     <span class="no">nil</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;;; Fire up package.el</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">package-enable-at-startup</span> <span class="no">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">package-initialize</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;; package.el updates the saved version of package-selected-packages correctly only</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; after custom-file has been loaded, which is a bug. We work around this by adding</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; the required packages to package-selected-packages after startup is complete.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defvar</span> <span class="nv">sanityinc/required-packages</span> <span class="no">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">sanityinc/note-selected-package</span> <span class="p">(</span><span class="nv">oldfun</span> <span class="nv">package</span> <span class="kp">&amp;rest</span> <span class="nv">args</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;If OLDFUN reports PACKAGE was successfully installed, note that fact.
</span></span></span><span class="line"><span class="cl"><span class="s">The package name is noted by adding it to
</span></span></span><span class="line"><span class="cl"><span class="s"></span><span class="ss">`sanityinc/required-packages&#39;</span><span class="s">.  This function is used as an
</span></span></span><span class="line"><span class="cl"><span class="s">advice for </span><span class="ss">`require-package&#39;</span><span class="s">, to which ARGS are passed.&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">let</span> <span class="p">((</span><span class="nv">available</span> <span class="p">(</span><span class="nf">apply</span> <span class="nv">oldfun</span> <span class="nv">package</span> <span class="nv">args</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">prog1</span>
</span></span><span class="line"><span class="cl">        <span class="nv">available</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nb">when</span> <span class="nv">available</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nv">add-to-list</span> <span class="ss">&#39;sanityinc/required-packages</span> <span class="nv">package</span><span class="p">)))))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">advice-add</span> <span class="ss">&#39;require-package</span> <span class="nb">:around</span> <span class="ss">&#39;sanityinc/note-selected-package</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nf">fboundp</span> <span class="ss">&#39;package--save-selected-packages</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">require-package</span> <span class="ss">&#39;seq</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">add-hook</span> <span class="ss">&#39;after-init-hook</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="nb">lambda</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">              <span class="p">(</span><span class="nv">package--save-selected-packages</span>
</span></span><span class="line"><span class="cl">               <span class="p">(</span><span class="nv">seq-uniq</span> <span class="p">(</span><span class="nf">append</span> <span class="nv">sanityinc/required-packages</span> <span class="nv">package-selected-packages</span><span class="p">))))))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">require-package</span> <span class="ss">&#39;fullframe</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">fullframe</span> <span class="nv">list-packages</span> <span class="nv">quit-window</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">let</span> <span class="p">((</span><span class="nv">package-check-signature</span> <span class="no">nil</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">require-package</span> <span class="ss">&#39;gnu-elpa-keyring-update</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">sanityinc/set-tabulated-list-column-width</span> <span class="p">(</span><span class="nv">col-name</span> <span class="nv">width</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;Set any column with name COL-NAME to the given WIDTH.&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nf">&gt;</span> <span class="nv">width</span> <span class="p">(</span><span class="nf">length</span> <span class="nv">col-name</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">cl-loop</span> <span class="nv">for</span> <span class="nv">column</span> <span class="nv">across</span> <span class="nv">tabulated-list-format</span>
</span></span><span class="line"><span class="cl">             <span class="nb">when</span> <span class="p">(</span><span class="nv">string=</span> <span class="nv">col-name</span> <span class="p">(</span><span class="nf">car</span> <span class="nv">column</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">             <span class="nb">do</span> <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nf">elt</span> <span class="nv">column</span> <span class="mi">1</span><span class="p">)</span> <span class="nv">width</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">sanityinc/maybe-widen-package-menu-columns</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;Widen some columns of the package menu table to avoid truncation.&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nf">boundp</span> <span class="ss">&#39;tabulated-list-format</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nv">sanityinc/set-tabulated-list-column-width</span> <span class="s">&#34;Version&#34;</span> <span class="mi">13</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">let</span> <span class="p">((</span><span class="nv">longest-archive-name</span> <span class="p">(</span><span class="nf">apply</span> <span class="ss">&#39;max</span> <span class="p">(</span><span class="nf">mapcar</span> <span class="ss">&#39;length</span> <span class="p">(</span><span class="nf">mapcar</span> <span class="ss">&#39;car</span> <span class="nv">package-archives</span><span class="p">)))))</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nv">sanityinc/set-tabulated-list-column-width</span> <span class="s">&#34;Archive&#34;</span> <span class="nv">longest-archive-name</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">add-hook</span> <span class="ss">&#39;package-menu-mode-hook</span> <span class="ss">&#39;sanityinc/maybe-widen-package-menu-columns</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;; Bootstrap `use-package&#39;</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nv">version&lt;</span> <span class="nv">emacs-version</span> <span class="s">&#34;29.0&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">unless</span> <span class="p">(</span><span class="nv">package-installed-p</span> <span class="ss">&#39;use-package</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nv">package-refresh-contents</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nv">package-install</span> <span class="ss">&#39;use-package</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">eval-and-compile</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">setq</span> <span class="nv">use-package-always-ensure</span> <span class="no">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">setq</span> <span class="nv">use-package-always-defer</span> <span class="no">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">setq</span> <span class="nv">use-package-always-demand</span> <span class="no">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">setq</span> <span class="nv">use-package-expand-minimally</span> <span class="no">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">setq</span> <span class="nv">use-package-enable-imenu-support</span> <span class="no">t</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">eval-when-compile</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">require</span> <span class="ss">&#39;use-package</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;; Install straight.el</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defvar</span> <span class="nv">bootstrap-version</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">let</span> <span class="p">((</span><span class="nv">bootstrap-file</span>
</span></span><span class="line"><span class="cl">       <span class="p">(</span><span class="nf">expand-file-name</span> <span class="s">&#34;straight/repos/straight.el/bootstrap.el&#34;</span> <span class="nv">user-emacs-directory</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nv">bootstrap-version</span> <span class="mi">5</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">unless</span> <span class="p">(</span><span class="nf">file-exists-p</span> <span class="nv">bootstrap-file</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">with-current-buffer</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nv">url-retrieve-synchronously</span>
</span></span><span class="line"><span class="cl">         <span class="s">&#34;https://raw.githubusercontent.com/raxod502/straight.el/develop/install.el&#34;</span>
</span></span><span class="line"><span class="cl">         <span class="ss">&#39;silent</span> <span class="ss">&#39;inhibit-cookies</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nf">goto-char</span> <span class="p">(</span><span class="nf">point-max</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nv">eval-print-last-sexp</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nf">load</span> <span class="nv">bootstrap-file</span> <span class="no">nil</span> <span class="ss">&#39;nomessage</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">provide</span> <span class="ss">&#39;init-elpa</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;; init-elpa.el ends here</span>
</span></span></code></pre></div><h3 id="init-local-dot-el">init-local.el<a hidden class="anchor" aria-hidden="true" href="#init-local-dot-el">#</a></h3>
<p>在 <code>init.el</code> 中有如下代码。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-elisp" data-lang="elisp"><span class="line"><span class="cl"><span class="c1">;; Allow users to provide an optional &#34;init-local&#34; containing personal settings</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">require</span> <span class="ss">&#39;init-local</span> <span class="no">nil</span> <span class="no">t</span><span class="p">)</span>
</span></span></code></pre></div><p>默认没有 <code>init-local.org</code> 这个文件，创建一个，就可以往里面塞自己的配置了。</p>
<h4 id="consult">Consult<a hidden class="anchor" aria-hidden="true" href="#consult">#</a></h4>
<p>Purcell 中已经包含了这个 package，也有 <code>consult-ripgrep</code> 这个方法。需要安装 <code>ripgrep</code>​。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">brew install ripgrep
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-elisp" data-lang="elisp"><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">bms/org-roam-rg-search</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;Search org-roam directory using consult-ripgrep. With live-preview.&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">interactive</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">let</span> <span class="p">((</span><span class="nv">consult-ripgrep-command</span> <span class="s">&#34;rg --null --ignore-case --type org --line-buffered --color=always --max-columns=500 --no-heading --line-number . -e ARG OPTS&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nv">consult-ripgrep</span> <span class="nv">org-roam-directory</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">global-set-key</span> <span class="p">(</span><span class="nv">kbd</span> <span class="s">&#34;C-c rr&#34;</span><span class="p">)</span> <span class="ss">&#39;bms/org-roam-rg-search</span><span class="p">)</span>
</span></span></code></pre></div><p>搜索 <code>org-roam-directory</code> 下的内容。</p>
<h4 id="deft">Deft<a hidden class="anchor" aria-hidden="true" href="#deft">#</a></h4>
<p>用作一些不想放在 <code>org-roam</code> 中的一些笔记的操作。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-elisp" data-lang="elisp"><span class="line"><span class="cl"><span class="p">(</span><span class="nv">require-package</span> <span class="ss">&#39;deft</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">deft-extensions</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;md&#34;</span> <span class="s">&#34;tex&#34;</span> <span class="s">&#34;org&#34;</span> <span class="s">&#34;mw&#34;</span> <span class="s">&#34;conf&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">deft-directory</span> <span class="s">&#34;~/Dropbox/org/&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">deft-recursive</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">advice-add</span> <span class="ss">&#39;deft-parse-title</span> <span class="nb">:override</span> <span class="nf">#&#39;</span><span class="nv">cm/deft-parse-title</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">deft-strip-summary-regexp</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nf">concat</span> <span class="s">&#34;\\(&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;[\n\t]&#34;</span> <span class="c1">;; blank</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;\\|^#\\+[[:alpha:]_]+:.*$&#34;</span> <span class="c1">;; org-mode metadata</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;\\|^#\s[-]*$&#34;</span> <span class="c1">;; org-mode metadata</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;\\|^:PROPERTIES:\n\\(.+\n\\)+:END:\n&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;\\)&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">global-set-key</span> <span class="p">[</span><span class="nv">f7</span><span class="p">]</span> <span class="ss">&#39;deft</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">global-set-key</span> <span class="p">(</span><span class="nv">kbd</span> <span class="s">&#34;C-x C-g&#34;</span><span class="p">)</span> <span class="ss">&#39;deft-find-file</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;; deft parse title</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">cm/deft-parse-title</span> <span class="p">(</span><span class="nv">file</span> <span class="nv">contents</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;Parse the given FILE and CONTENTS and determine the title.
</span></span></span><span class="line"><span class="cl"><span class="s">If </span><span class="ss">`deft-use-filename-as-title&#39;</span><span class="s"> is nil, the title is taken to
</span></span></span><span class="line"><span class="cl"><span class="s">be the first non-empty line of the FILE.  Else the base name of the FILE is
</span></span></span><span class="line"><span class="cl"><span class="s">used as title.&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">let</span> <span class="p">((</span><span class="nv">begin</span> <span class="p">(</span><span class="nf">string-match</span> <span class="s">&#34;^#\\+[tT][iI][tT][lL][eE]: .*$&#34;</span> <span class="nv">contents</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">if</span> <span class="nv">begin</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nv">string-trim</span> <span class="p">(</span><span class="nf">substring</span> <span class="nv">contents</span> <span class="nv">begin</span> <span class="p">(</span><span class="nf">match-end</span> <span class="mi">0</span><span class="p">))</span> <span class="s">&#34;#\\+[tT][iI][tT][lL][eE]: *&#34;</span> <span class="s">&#34;[\n\t ]+&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nv">deft-base-filename</span> <span class="nv">file</span><span class="p">))))</span>
</span></span></code></pre></div><h4 id="ox-hugo">Ox-hugo<a hidden class="anchor" aria-hidden="true" href="#ox-hugo">#</a></h4>
<p>导出到 Hugo，方便与他人分享内容。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-elisp" data-lang="elisp"><span class="line"><span class="cl"><span class="p">(</span><span class="nv">require-package</span> <span class="ss">&#39;ox-hugo</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">with-eval-after-load</span> <span class="ss">&#39;ox</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">require</span> <span class="ss">&#39;ox-hugo</span><span class="p">))</span>
</span></span></code></pre></div><p>导出到 Hugo 还需要在文件头部添加</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-org" data-lang="org"><span class="line"><span class="cl"><span class="cs">#+HUGO_BASE_DIR</span><span class="c">: ~/Dropbox/hugo/</span>
</span></span><span class="line"><span class="cl"><span class="cs">#+HUGO_SECTION</span><span class="c">: posts/main</span>
</span></span><span class="line"><span class="cl"><span class="cs">#+HUGO_WEIGHT</span><span class="c">: auto</span>
</span></span><span class="line"><span class="cl"><span class="cs">#+HUGO_AUTO_SET_LASTMOD</span><span class="c">: t</span>
</span></span></code></pre></div><p>需要到处为 <code>&lt;mark&gt;&lt;/mark&gt;</code> 时<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-org" data-lang="org"><span class="line"><span class="cl"><span class="cs">#+header</span><span class="c">: :trim-pre nil :trim-post nil</span>
</span></span><span class="line"><span class="cl"><span class="c">#+begin_mark</span>
</span></span><span class="line"><span class="cl">marked text
</span></span><span class="line"><span class="cl"><span class="c">#+end_mark</span>
</span></span></code></pre></div><h3 id="init-latex-dot-el">init-latex.el<a hidden class="anchor" aria-hidden="true" href="#init-latex-dot-el">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-elisp" data-lang="elisp"><span class="line"><span class="cl"><span class="c1">;;; init-latex.el  --- Custom configuration</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;; Commentary</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">require-package</span> <span class="ss">&#39;auctex</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">require-package</span> <span class="ss">&#39;cdlatex</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">require-package</span> <span class="ss">&#39;cdlatex</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">add-hook</span> <span class="ss">&#39;LaTeX-mode-hook</span> <span class="ss">&#39;turn-on-cdlatex</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; 导出中文 PDF</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; 需要将 elegantpaper.cls 文件放在 org 目录下</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; 需要安装依赖 brew install pygments</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; org 文件头部增加</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; #+LATEX_COMPILER: xelatex</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; #+LATEX_CLASS: elegantpaper</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; #+OPTIONS: prop:t</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">with-eval-after-load</span> <span class="ss">&#39;ox-latex</span>
</span></span><span class="line"><span class="cl">  <span class="c1">;; http://orgmode.org/worg/org-faq.html#using-xelatex-for-pdf-export</span>
</span></span><span class="line"><span class="cl">  <span class="c1">;; latexmk runs pdflatex/xelatex (whatever is specified) multiple times</span>
</span></span><span class="line"><span class="cl">  <span class="c1">;; automatically to resolve the cross-references.</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">setq</span> <span class="nv">org-latex-pdf-process</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;latexmk -xelatex -quiet -shell-escape -f %f&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">add-to-list</span> <span class="ss">&#39;org-latex-classes</span>
</span></span><span class="line"><span class="cl">               <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;elegantpaper&#34;</span>
</span></span><span class="line"><span class="cl">                 <span class="s">&#34;\\documentclass[lang=cn]{elegantpaper}
</span></span></span><span class="line"><span class="cl"><span class="s">                 [NO-DEFAULT-PACKAGES]
</span></span></span><span class="line"><span class="cl"><span class="s">                 [PACKAGES]
</span></span></span><span class="line"><span class="cl"><span class="s">                 [EXTRA]&#34;</span>
</span></span><span class="line"><span class="cl">                 <span class="p">(</span><span class="s">&#34;\\section{%s}&#34;</span> <span class="o">.</span> <span class="s">&#34;\\section*{%s}&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                 <span class="p">(</span><span class="s">&#34;\\subsection{%s}&#34;</span> <span class="o">.</span> <span class="s">&#34;\\subsection*{%s}&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                 <span class="p">(</span><span class="s">&#34;\\subsubsection{%s}&#34;</span> <span class="o">.</span> <span class="s">&#34;\\subsubsection*{%s}&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                 <span class="p">(</span><span class="s">&#34;\\paragraph{%s}&#34;</span> <span class="o">.</span> <span class="s">&#34;\\paragraph*{%s}&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                 <span class="p">(</span><span class="s">&#34;\\subparagraph{%s}&#34;</span> <span class="o">.</span> <span class="s">&#34;\\subparagraph*{%s}&#34;</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">setq</span> <span class="nv">org-latex-listings</span> <span class="ss">&#39;minted</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">add-to-list</span> <span class="ss">&#39;org-latex-packages-alist</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;cache=false&#34;</span> <span class="s">&#34;minted&#34;</span> <span class="no">t</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">org-preview-latex-default-process</span> <span class="ss">&#39;dvisvgm</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; xenops</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">require-package</span> <span class="ss">&#39;xenops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">add-hook</span> <span class="ss">&#39;LaTeX-mode-hook</span> <span class="nf">#&#39;</span><span class="nv">xenops-mode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">with-eval-after-load</span> <span class="ss">&#39;xenops</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">setq</span> <span class="nv">xenops-math-image-scale-factor</span> <span class="mf">1.3</span>
</span></span><span class="line"><span class="cl">        <span class="nv">xenops-image-try-write-clipboard-image-to-file</span> <span class="no">nil</span>
</span></span><span class="line"><span class="cl">        <span class="nv">xenops-reveal-on-entry</span> <span class="no">nil</span>
</span></span><span class="line"><span class="cl">        <span class="nv">xenops-math-image-margin</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="nv">xenops-math-latex-max-tasks-in-flight</span> <span class="mi">16</span>
</span></span><span class="line"><span class="cl">        <span class="nv">xenops-auctex-electric-insert-commands</span> <span class="no">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">defun</span> <span class="nv">eli/change-xenops-latex-header</span> <span class="p">(</span><span class="nv">orig</span> <span class="kp">&amp;rest</span> <span class="nv">args</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">let</span> <span class="p">((</span><span class="nv">org-format-latex-header</span> <span class="s">&#34;\\documentclass[dvisvgm,preview]{standalone}\n\\usepackage{arev}\n\\usepackage{color}\n[PACKAGES]\n[DEFAULT-PACKAGES]&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nf">apply</span> <span class="nv">orig</span> <span class="nv">args</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">advice-add</span> <span class="ss">&#39;xenops-math-latex-make-latex-document</span> <span class="nb">:around</span> <span class="nf">#&#39;</span><span class="nv">eli/change-xenops-latex-header</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">advice-add</span> <span class="ss">&#39;xenops-math-file-name-static-hash-data</span> <span class="nb">:around</span> <span class="nf">#&#39;</span><span class="nv">eli/change-xenops-latex-header</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">defun</span> <span class="nv">eli/delete-region</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">if</span> <span class="p">(</span><span class="nv">use-region-p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nf">delete-region</span> <span class="p">(</span><span class="nf">region-beginning</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                       <span class="p">(</span><span class="nf">region-end</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">advice-add</span> <span class="ss">&#39;xenops-handle-paste-default</span>
</span></span><span class="line"><span class="cl">              <span class="nb">:before</span> <span class="nf">#&#39;</span><span class="nv">eli/delete-region</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">defun</span> <span class="nv">eli/xenops-math-add-cursor-sensor-property</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nv">-when-let*</span> <span class="p">((</span><span class="nv">element</span> <span class="p">(</span><span class="nv">xenops-math-parse-element-at-point</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nb">let</span> <span class="p">((</span><span class="nv">beg</span> <span class="p">(</span><span class="nf">plist-get</span> <span class="nv">element</span> <span class="nb">:begin</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="nv">end</span> <span class="p">(</span><span class="nf">plist-get</span> <span class="nv">element</span> <span class="nb">:end</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="nv">props</span> <span class="o">&#39;</span><span class="p">(</span><span class="nv">cursor-sensor-functions</span> <span class="p">(</span><span class="nv">xenops-math-handle-element-transgression</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nf">add-text-properties</span> <span class="nv">beg</span> <span class="nv">end</span> <span class="nv">props</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nf">add-text-properties</span> <span class="p">(</span><span class="nf">1-</span> <span class="nv">end</span><span class="p">)</span> <span class="nv">end</span> <span class="o">&#39;</span><span class="p">(</span><span class="nv">rear-nonsticky</span> <span class="p">(</span><span class="nv">cursor-sensor-functions</span><span class="p">))))))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">advice-add</span> <span class="ss">&#39;xenops-math-add-cursor-sensor-property</span> <span class="nb">:override</span> <span class="nf">#&#39;</span><span class="nv">eli/xenops-math-add-cursor-sensor-property</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">;; Vertically align LaTeX preview in org mode</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">setq</span> <span class="nv">xenops-math-latex-process-alist</span>
</span></span><span class="line"><span class="cl">        <span class="o">&#39;</span><span class="p">((</span><span class="nv">dvisvgm</span> <span class="nb">:programs</span>
</span></span><span class="line"><span class="cl">                   <span class="p">(</span><span class="s">&#34;latex&#34;</span> <span class="s">&#34;dvisvgm&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                   <span class="nb">:description</span> <span class="s">&#34;dvi &gt; svg&#34;</span> <span class="nb">:message</span> <span class="s">&#34;you need to install the programs: latex and dvisvgm.&#34;</span> <span class="nb">:image-input-type</span> <span class="s">&#34;dvi&#34;</span> <span class="nb">:image-output-type</span> <span class="s">&#34;svg&#34;</span> <span class="nb">:image-size-adjust</span>
</span></span><span class="line"><span class="cl">                   <span class="p">(</span><span class="mf">1.7</span> <span class="o">.</span> <span class="mf">1.5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                   <span class="nb">:latex-compiler</span>
</span></span><span class="line"><span class="cl">                   <span class="p">(</span><span class="s">&#34;latex -interaction nonstopmode -shell-escape -output-format dvi -output-directory %o %f&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                   <span class="nb">:image-converter</span>
</span></span><span class="line"><span class="cl">                   <span class="p">(</span><span class="s">&#34;dvisvgm %f -n -e -b 1 -c %S -o %O&#34;</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">;; from https://list.orgmode.org/874k9oxy48.fsf@gmail.com/#Z32lisp:org.el</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">defun</span> <span class="nv">eli/org--match-text-baseline-ascent</span> <span class="p">(</span><span class="nv">imagefile</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;Set `:ascent&#39; to match the text baseline of an image to the surrounding text.
</span></span></span><span class="line"><span class="cl"><span class="s">Compute </span><span class="ss">`ascent&#39;</span><span class="s"> with the data collected in IMAGEFILE.&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">let*</span> <span class="p">((</span><span class="nv">viewbox</span> <span class="p">(</span><span class="nv">split-string</span>
</span></span><span class="line"><span class="cl">                     <span class="p">(</span><span class="nv">xml-get-attribute</span> <span class="p">(</span><span class="nf">car</span> <span class="p">(</span><span class="nv">xml-parse-file</span> <span class="nv">imagefile</span><span class="p">))</span> <span class="ss">&#39;viewBox</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">           <span class="p">(</span><span class="nv">min-y</span> <span class="p">(</span><span class="nf">string-to-number</span> <span class="p">(</span><span class="nf">nth</span> <span class="mi">1</span> <span class="nv">viewbox</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">           <span class="p">(</span><span class="nv">height</span> <span class="p">(</span><span class="nf">string-to-number</span> <span class="p">(</span><span class="nf">nth</span> <span class="mi">3</span> <span class="nv">viewbox</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">           <span class="p">(</span><span class="nv">ascent</span> <span class="p">(</span><span class="nf">round</span> <span class="p">(</span><span class="nf">*</span> <span class="mi">-100</span> <span class="p">(</span><span class="nf">/</span> <span class="nv">min-y</span> <span class="nv">height</span><span class="p">)))))</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nb">if</span> <span class="p">(</span><span class="nb">or</span> <span class="p">(</span><span class="nf">&lt;</span> <span class="nv">ascent</span> <span class="mi">0</span><span class="p">)</span> <span class="p">(</span><span class="nf">&gt;</span> <span class="nv">ascent</span> <span class="mi">100</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">          <span class="ss">&#39;center</span>
</span></span><span class="line"><span class="cl">        <span class="nv">ascent</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">defun</span> <span class="nv">eli/xenops-preview-align-baseline</span> <span class="p">(</span><span class="nv">element</span> <span class="kp">&amp;rest</span> <span class="nv">_args</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;Redisplay SVG image resulting from successful LaTeX compilation of ELEMENT.
</span></span></span><span class="line"><span class="cl"><span class="s">Use the data in log file (e.g. \&#34;! Preview: Snippet 1 ended.(368640+1505299x1347810).\&#34;)
</span></span></span><span class="line"><span class="cl"><span class="s">to calculate the decent value of `:ascent&#39;. &#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">let*</span> <span class="p">((</span><span class="nv">inline-p</span> <span class="p">(</span><span class="nf">eq</span> <span class="ss">&#39;inline-math</span> <span class="p">(</span><span class="nf">plist-get</span> <span class="nv">element</span> <span class="nb">:type</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">           <span class="p">(</span><span class="nv">ov-beg</span> <span class="p">(</span><span class="nf">plist-get</span> <span class="nv">element</span> <span class="nb">:begin</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">           <span class="p">(</span><span class="nv">ov-end</span> <span class="p">(</span><span class="nf">plist-get</span> <span class="nv">element</span> <span class="nb">:end</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">           <span class="p">(</span><span class="nv">cache-file</span> <span class="p">(</span><span class="nf">car</span> <span class="p">(</span><span class="nv">last</span> <span class="nv">_args</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">           <span class="p">(</span><span class="nv">ov</span> <span class="p">(</span><span class="nf">car</span> <span class="p">(</span><span class="nf">overlays-at</span> <span class="p">(</span><span class="nf">/</span> <span class="p">(</span><span class="nf">+</span> <span class="nv">ov-beg</span> <span class="nv">ov-end</span><span class="p">)</span> <span class="mi">2</span><span class="p">)</span> <span class="no">t</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">           <span class="nv">img</span> <span class="nv">new-img</span> <span class="nv">ascent</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nb">and</span> <span class="nv">ov</span> <span class="nv">inline-p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nb">setq</span> <span class="nv">ascent</span> <span class="p">(</span><span class="nf">+</span> <span class="mi">1</span> <span class="p">(</span><span class="nv">eli/org--match-text-baseline-ascent</span> <span class="nv">cache-file</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nb">setq</span> <span class="nv">img</span> <span class="p">(</span><span class="nf">cdr</span> <span class="p">(</span><span class="nf">overlay-get</span> <span class="nv">ov</span> <span class="ss">&#39;display</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nb">setq</span> <span class="nv">new-img</span> <span class="p">(</span><span class="nf">plist-put</span> <span class="nv">img</span> <span class="nb">:ascent</span> <span class="nv">ascent</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nf">overlay-put</span> <span class="nv">ov</span> <span class="ss">&#39;display</span> <span class="p">(</span><span class="nf">cons</span> <span class="ss">&#39;image</span> <span class="nv">new-img</span><span class="p">)))))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">advice-add</span> <span class="ss">&#39;xenops-math-display-image</span> <span class="nb">:after</span>
</span></span><span class="line"><span class="cl">              <span class="nf">#&#39;</span><span class="nv">eli/xenops-preview-align-baseline</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">;; from: https://kitchingroup.cheme.cmu.edu/blog/2016/11/06/</span>
</span></span><span class="line"><span class="cl">  <span class="c1">;; Justifying-LaTeX-preview-fragments-in-org-mode/</span>
</span></span><span class="line"><span class="cl">  <span class="c1">;; specify the justification you want</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nf">plist-put</span> <span class="nv">org-format-latex-options</span> <span class="nb">:justify</span> <span class="ss">&#39;right</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">defun</span> <span class="nv">eli/xenops-justify-fragment-overlay</span> <span class="p">(</span><span class="nv">element</span> <span class="kp">&amp;rest</span> <span class="nv">_args</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">let*</span> <span class="p">((</span><span class="nv">ov-beg</span> <span class="p">(</span><span class="nf">plist-get</span> <span class="nv">element</span> <span class="nb">:begin</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">           <span class="p">(</span><span class="nv">ov-end</span> <span class="p">(</span><span class="nf">plist-get</span> <span class="nv">element</span> <span class="nb">:end</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">           <span class="p">(</span><span class="nv">ov</span> <span class="p">(</span><span class="nf">car</span> <span class="p">(</span><span class="nf">overlays-at</span> <span class="p">(</span><span class="nf">/</span> <span class="p">(</span><span class="nf">+</span> <span class="nv">ov-beg</span> <span class="nv">ov-end</span><span class="p">)</span> <span class="mi">2</span><span class="p">)</span> <span class="no">t</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">           <span class="p">(</span><span class="nv">position</span> <span class="p">(</span><span class="nf">plist-get</span> <span class="nv">org-format-latex-options</span> <span class="nb">:justify</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">           <span class="p">(</span><span class="nv">inline-p</span> <span class="p">(</span><span class="nf">eq</span> <span class="ss">&#39;inline-math</span> <span class="p">(</span><span class="nf">plist-get</span> <span class="nv">element</span> <span class="nb">:type</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">           <span class="nv">width</span> <span class="nv">offset</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nb">and</span> <span class="nv">ov</span>
</span></span><span class="line"><span class="cl">                 <span class="p">(</span><span class="nf">imagep</span> <span class="p">(</span><span class="nf">overlay-get</span> <span class="nv">ov</span> <span class="ss">&#39;display</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nb">setq</span> <span class="nv">width</span> <span class="p">(</span><span class="nf">car</span> <span class="p">(</span><span class="nv">image-display-size</span> <span class="p">(</span><span class="nf">overlay-get</span> <span class="nv">ov</span> <span class="ss">&#39;display</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nb">cond</span>
</span></span><span class="line"><span class="cl">         <span class="p">((</span><span class="nb">and</span> <span class="p">(</span><span class="nf">eq</span> <span class="ss">&#39;right</span> <span class="nv">position</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">               <span class="p">(</span><span class="nv">not</span> <span class="nv">inline-p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">               <span class="p">(</span><span class="nf">&gt;</span> <span class="nv">width</span> <span class="mi">50</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span><span class="nb">setq</span> <span class="nv">offset</span> <span class="p">(</span><span class="nf">floor</span> <span class="p">(</span><span class="nf">-</span> <span class="nv">fill-column</span>
</span></span><span class="line"><span class="cl">                                 <span class="nv">width</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span><span class="nb">if</span> <span class="p">(</span><span class="nf">&lt;</span> <span class="nv">offset</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">              <span class="p">(</span><span class="nb">setq</span> <span class="nv">offset</span> <span class="mi">0</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span><span class="nf">overlay-put</span> <span class="nv">ov</span> <span class="ss">&#39;before-string</span> <span class="p">(</span><span class="nf">make-string</span> <span class="nv">offset</span> <span class="sc">? </span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">         <span class="p">((</span><span class="nb">and</span> <span class="p">(</span><span class="nf">eq</span> <span class="ss">&#39;right</span> <span class="nv">position</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">               <span class="p">(</span><span class="nv">not</span> <span class="nv">inline-p</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span><span class="nb">setq</span> <span class="nv">offset</span> <span class="p">(</span><span class="nf">floor</span> <span class="p">(</span><span class="nf">-</span> <span class="p">(</span><span class="nf">/</span> <span class="nv">fill-column</span> <span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                 <span class="p">(</span><span class="nf">/</span> <span class="nv">width</span> <span class="mi">2</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span><span class="nb">if</span> <span class="p">(</span><span class="nf">&lt;</span> <span class="nv">offset</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">              <span class="p">(</span><span class="nb">setq</span> <span class="nv">offset</span> <span class="mi">0</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span><span class="nf">overlay-put</span> <span class="nv">ov</span> <span class="ss">&#39;before-string</span> <span class="p">(</span><span class="nf">make-string</span> <span class="nv">offset</span> <span class="sc">? </span><span class="p">)))))))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">advice-add</span> <span class="ss">&#39;xenops-math-display-image</span> <span class="nb">:after</span>
</span></span><span class="line"><span class="cl">              <span class="nf">#&#39;</span><span class="nv">eli/xenops-justify-fragment-overlay</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">;; from: https://kitchingroup.cheme.cmu.edu/blog/2016/11/07/</span>
</span></span><span class="line"><span class="cl">  <span class="c1">;; Better-equation-numbering-in-LaTeX-fragments-in-org-mode/</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">defun</span> <span class="nv">eli/xenops-renumber-environment</span> <span class="p">(</span><span class="nv">orig-func</span> <span class="nv">element</span> <span class="nv">latex</span> <span class="nv">colors</span>
</span></span><span class="line"><span class="cl">                                                    <span class="nv">cache-file</span> <span class="nv">display-image</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">let</span> <span class="p">((</span><span class="nv">results</span> <span class="o">&#39;</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span><span class="nv">counter</span> <span class="mi">-1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span><span class="nf">numberp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span><span class="nv">outline-regexp</span> <span class="nv">org-outline-regexp</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nb">setq</span> <span class="nv">results</span> <span class="p">(</span><span class="nb">cl-loop</span> <span class="nv">for</span> <span class="p">(</span><span class="nv">begin</span> <span class="o">.</span>  <span class="nv">env</span><span class="p">)</span> <span class="nv">in</span>
</span></span><span class="line"><span class="cl">                             <span class="p">(</span><span class="nv">org-element-map</span> <span class="p">(</span><span class="nv">org-element-parse-buffer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                 <span class="ss">&#39;latex-environment</span>
</span></span><span class="line"><span class="cl">                               <span class="p">(</span><span class="nb">lambda</span> <span class="p">(</span><span class="nv">env</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                 <span class="p">(</span><span class="nf">cons</span>
</span></span><span class="line"><span class="cl">                                  <span class="p">(</span><span class="nv">org-element-property</span> <span class="nb">:begin</span> <span class="nv">env</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                  <span class="p">(</span><span class="nv">org-element-property</span> <span class="nb">:value</span> <span class="nv">env</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">                             <span class="nv">collect</span>
</span></span><span class="line"><span class="cl">                             <span class="p">(</span><span class="nb">cond</span>
</span></span><span class="line"><span class="cl">                              <span class="p">((</span><span class="nb">and</span> <span class="p">(</span><span class="nf">string-match</span> <span class="s">&#34;\\\\begin{equation}&#34;</span> <span class="nv">env</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                    <span class="p">(</span><span class="nv">not</span> <span class="p">(</span><span class="nf">string-match</span> <span class="s">&#34;\\\\tag{&#34;</span> <span class="nv">env</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">                               <span class="p">(</span><span class="nb">cl-incf</span> <span class="nv">counter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                               <span class="p">(</span><span class="nf">cons</span> <span class="nv">begin</span> <span class="nv">counter</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                              <span class="p">((</span><span class="nb">and</span> <span class="p">(</span><span class="nf">string-match</span> <span class="s">&#34;\\\\begin{align}&#34;</span> <span class="nv">env</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                    <span class="p">(</span><span class="nf">string-match</span> <span class="s">&#34;\\\\notag&#34;</span> <span class="nv">env</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                               <span class="p">(</span><span class="nb">cl-incf</span> <span class="nv">counter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                               <span class="p">(</span><span class="nf">cons</span> <span class="nv">begin</span> <span class="nv">counter</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                              <span class="p">((</span><span class="nf">string-match</span> <span class="s">&#34;\\\\begin{align}&#34;</span> <span class="nv">env</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                               <span class="p">(</span><span class="nb">prog2</span>
</span></span><span class="line"><span class="cl">                                   <span class="p">(</span><span class="nb">cl-incf</span> <span class="nv">counter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                   <span class="p">(</span><span class="nf">cons</span> <span class="nv">begin</span> <span class="nv">counter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                 <span class="p">(</span><span class="nb">with-temp-buffer</span>
</span></span><span class="line"><span class="cl">                                   <span class="p">(</span><span class="nf">insert</span> <span class="nv">env</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                   <span class="p">(</span><span class="nf">goto-char</span> <span class="p">(</span><span class="nf">point-min</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                                   <span class="c1">;; \\ is used for a new line. Each one leads</span>
</span></span><span class="line"><span class="cl">                                   <span class="c1">;; to a number</span>
</span></span><span class="line"><span class="cl">                                   <span class="p">(</span><span class="nb">cl-incf</span> <span class="nv">counter</span> <span class="p">(</span><span class="nv">count-matches</span> <span class="s">&#34;\\\\$&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                                   <span class="c1">;; unless there are nonumbers.</span>
</span></span><span class="line"><span class="cl">                                   <span class="p">(</span><span class="nf">goto-char</span> <span class="p">(</span><span class="nf">point-min</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                                   <span class="p">(</span><span class="nb">cl-decf</span> <span class="nv">counter</span>
</span></span><span class="line"><span class="cl">                                            <span class="p">(</span><span class="nv">count-matches</span> <span class="s">&#34;\\nonumber&#34;</span><span class="p">)))))</span>
</span></span><span class="line"><span class="cl">                              <span class="p">(</span><span class="no">t</span>
</span></span><span class="line"><span class="cl">                               <span class="p">(</span><span class="nf">cons</span> <span class="nv">begin</span> <span class="no">nil</span><span class="p">)))))</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nb">setq</span> <span class="nf">numberp</span> <span class="p">(</span><span class="nf">cdr</span> <span class="p">(</span><span class="nf">assoc</span> <span class="p">(</span><span class="nf">plist-get</span> <span class="nv">element</span> <span class="nb">:begin</span><span class="p">)</span> <span class="nv">results</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nb">setq</span> <span class="nv">latex</span>
</span></span><span class="line"><span class="cl">              <span class="p">(</span><span class="nf">concat</span>
</span></span><span class="line"><span class="cl">               <span class="p">(</span><span class="nf">format</span> <span class="s">&#34;\\setcounter{equation}{%s}\n&#34;</span> <span class="nf">numberp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">               <span class="nv">latex</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nf">funcall</span> <span class="nv">orig-func</span> <span class="nv">element</span> <span class="nv">latex</span> <span class="nv">colors</span> <span class="nv">cache-file</span> <span class="nv">display-image</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">advice-add</span> <span class="ss">&#39;xenops-math-latex-create-image</span>
</span></span><span class="line"><span class="cl">              <span class="nb">:around</span> <span class="nf">#&#39;</span><span class="nv">eli/xenops-renumber-environment</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nf">autoload</span> <span class="nf">#&#39;</span><span class="nv">mathpix-screenshot</span> <span class="s">&#34;mathpix&#34;</span> <span class="no">nil</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">with-eval-after-load</span> <span class="ss">&#39;mathpix</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">let</span> <span class="p">((</span><span class="nv">n</span> <span class="p">(</span><span class="nf">random</span> <span class="mi">4</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">setq</span> <span class="nv">mathpix-app-id</span> <span class="p">(</span><span class="nb">with-temp-buffer</span>
</span></span><span class="line"><span class="cl">                           <span class="p">(</span><span class="nf">insert-file-contents</span>
</span></span><span class="line"><span class="cl">                            <span class="s">&#34;~/.emacs.d/private/mathpix-app-id&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                           <span class="p">(</span><span class="nf">nth</span> <span class="nv">n</span> <span class="p">(</span><span class="nv">split-string</span> <span class="p">(</span><span class="nf">buffer-string</span><span class="p">)</span> <span class="s">&#34;\n&#34;</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">          <span class="nv">mathpix-app-key</span> <span class="p">(</span><span class="nb">with-temp-buffer</span>
</span></span><span class="line"><span class="cl">                            <span class="p">(</span><span class="nf">insert-file-contents</span>
</span></span><span class="line"><span class="cl">                             <span class="s">&#34;~/.emacs.d/private/mathpix-app-key&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                            <span class="p">(</span><span class="nf">nth</span> <span class="nv">n</span> <span class="p">(</span><span class="nv">split-string</span> <span class="p">(</span><span class="nf">buffer-string</span><span class="p">)</span> <span class="s">&#34;\n&#34;</span><span class="p">)))))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">setq</span> <span class="nv">mathpix-screenshot-method</span> <span class="s">&#34;flameshot gui --raw &gt; %s&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">provide</span> <span class="ss">&#39;init-latex</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;; init-latex.el ends here</span>
</span></span></code></pre></div><p>离线分享的时候最大程度的保持原貌的方法就是 PDF。</p>
<p>需要安装 <code>texlive</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">brew install texlive
</span></span></code></pre></div><p>Latex 语法可以参考：<a href="/posts/main/20220616162256-latex/">Latex</a></p>
<h4 id="导出">导出<a hidden class="anchor" aria-hidden="true" href="#导出">#</a></h4>
<p>导出含有中文时是需要配置 CJK，<a href="https://github.com/ElegantLaTeX/ElegantPaper/blob/master/elegantpaper.cls">ElegantPaper</a> 可以跨过这一步设置，只需要将 <code>elegantpaper.cls</code> 放到需要导出 PDF 的目录下，同时安装依赖。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">brew install pygments
</span></span></code></pre></div><p>在导出文件头部增加</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-org" data-lang="org"><span class="line"><span class="cl"><span class="cs">#+LATEX_COMPILER</span><span class="c">: xelatex</span>
</span></span><span class="line"><span class="cl"><span class="cs">#+LATEX_CLASS</span><span class="c">: elegantpaper</span>
</span></span><span class="line"><span class="cl"><span class="cs">#+OPTIONS</span><span class="c">: prop:t</span>
</span></span></code></pre></div><h4 id="预览">预览<a hidden class="anchor" aria-hidden="true" href="#预览">#</a></h4>
<p>预览需要安装 <a href="https://github.com/firamath/firamath">firamath</a> 字体，可以有更好的展示效果。另外 <code>dvisvgm</code> 应该在 <code>texlive</code> 中已经包含才对，但是依旧找不到。这里我重新从<a href="https://github.com/mgieseki/dvisvgm">源码</a>编译了一份。</p>
<h3 id="init-corfu-dot-el">init-corfu.el<a hidden class="anchor" aria-hidden="true" href="#init-corfu-dot-el">#</a></h3>
<p>增加了 <code>kind-icon</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-elisp" data-lang="elisp"><span class="line"><span class="cl"><span class="c1">;;; init-corfu.el --- Interactive completion in buffers -*- lexical-binding: t -*-</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;; Commentary:</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;; Code:</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;; WAITING: haskell-mode sets tags-table-list globally, breaks tags-completion-at-point-function</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; TODO Default sort order should place [a-z] before punctuation</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">tab-always-indent</span> <span class="ss">&#39;complete</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nv">maybe-require-package</span> <span class="ss">&#39;orderless</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">with-eval-after-load</span> <span class="ss">&#39;vertico</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">require</span> <span class="ss">&#39;orderless</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">setq</span> <span class="nv">completion-styles</span> <span class="o">&#39;</span><span class="p">(</span><span class="nv">orderless</span> <span class="nv">basic</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">completion-category-defaults</span> <span class="no">nil</span>
</span></span><span class="line"><span class="cl">      <span class="nv">completion-category-overrides</span> <span class="no">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">completion-cycle-threshold</span> <span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nv">maybe-require-package</span> <span class="ss">&#39;corfu</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">setq-default</span> <span class="nv">corfu-auto</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">with-eval-after-load</span> <span class="ss">&#39;eshell</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nv">add-hook</span> <span class="ss">&#39;eshell-mode-hook</span> <span class="p">(</span><span class="nb">lambda</span> <span class="p">()</span> <span class="p">(</span><span class="nb">setq-local</span> <span class="nv">corfu-auto</span> <span class="no">nil</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">setq-default</span> <span class="nv">corfu-quit-no-match</span> <span class="ss">&#39;separator</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">add-hook</span> <span class="ss">&#39;after-init-hook</span> <span class="ss">&#39;global-corfu-mode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nb">featurep</span> <span class="ss">&#39;corfu-popupinfo</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">with-eval-after-load</span> <span class="ss">&#39;corfu</span> <span class="p">(</span><span class="nv">corfu-popupinfo-mode</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nv">maybe-require-package</span> <span class="ss">&#39;kind-icon</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">; Enable `kind-icon&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">with-eval-after-load</span> <span class="ss">&#39;corfu</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nv">add-to-list</span> <span class="ss">&#39;corfu-margin-formatters</span> <span class="nf">#&#39;</span><span class="nv">kind-icon-margin-formatter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">provide</span> <span class="ss">&#39;init-corfu</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;; init-corfu.el ends here</span>
</span></span></code></pre></div><p>在切换主题的时候，​<code>kind-icon</code> 会有残留，可以执行 <code>M-x kind-icon-reset-cache</code> 清除 cache 即可。</p>
<h3 id="init-bibtex-dot-el">init-bibtex.el<a hidden class="anchor" aria-hidden="true" href="#init-bibtex-dot-el">#</a></h3>
<p>管理 Bibtex 可以方便在文章中引用，以及新增读书笔记，结合 agenda 更好的管理读书条目以及进度。</p>
<p>其中自定义了笔记模板和读书列表模板，前者是增加了 citation key 作为 roam ref，org ID 的生成以及时间戳；后者则是将默认的 <code>TODO</code> 关键字换成了 <code>PROJECT</code> 关键字，并将 active timestamps 改为 inactive timestamps，方便计算每个 <code>PROJECT</code> 创建了多长时间展示在 agenda 当中。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-elisp" data-lang="elisp"><span class="line"><span class="cl"><span class="c1">;;; init-ebib.el  --- Custom configuration</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;; Commentary</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">use-package</span> <span class="nv">bibtex</span>
</span></span><span class="line"><span class="cl">  <span class="nb">:defer</span> <span class="no">t</span>
</span></span><span class="line"><span class="cl">  <span class="nb">:config</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">setq</span> <span class="nv">bibtex-file-path</span> <span class="s">&#34;~/Dropbox/org/bib/&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">bibtex-files</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;bibtex.bib&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nv">bibtex-notes-path</span> <span class="s">&#34;~/Dropbox/org/main/&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nv">bibtex-align-at-equal-sign</span> <span class="no">t</span>
</span></span><span class="line"><span class="cl">        <span class="nv">bibtex-autokey-titleword-separator</span> <span class="s">&#34;-&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">bibtex-autokey-year-title-separator</span> <span class="s">&#34;-&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">bibtex-autokey-name-year-separator</span> <span class="s">&#34;-&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">bibtex-dialect</span> <span class="ss">&#39;biblatex</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">use-package</span> <span class="nv">ebib</span>
</span></span><span class="line"><span class="cl">  <span class="nb">:straight</span> <span class="no">t</span>
</span></span><span class="line"><span class="cl">  <span class="nb">:commands</span> <span class="nv">ebib-zotero-protocol-handler</span>
</span></span><span class="line"><span class="cl">  <span class="nb">:init</span>
</span></span><span class="line"><span class="cl">  <span class="nb">:config</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">setq</span> <span class="nv">ebib-default-directory</span> <span class="nv">bibtex-file-path</span>
</span></span><span class="line"><span class="cl">        <span class="nv">ebib-bib-search-dirs</span> <span class="o">`</span><span class="p">(</span><span class="o">,</span><span class="nv">bibtex-file-path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nv">ebib-file-search-dirs</span> <span class="o">`</span><span class="p">(</span><span class="o">,</span><span class="p">(</span><span class="nf">concat</span> <span class="nv">bibtex-file-path</span> <span class="s">&#34;files/&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="nv">ebib-notes-directory</span> <span class="nv">bibtex-notes-path</span>
</span></span><span class="line"><span class="cl">        <span class="nv">ebib-reading-list-file</span> <span class="s">&#34;~/Dropbox/org/agenda/books.org&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nv">ebib-bibtex-dialect</span> <span class="nv">bibtex-dialect</span>
</span></span><span class="line"><span class="cl">        <span class="nv">ebib-file-associations</span> <span class="o">&#39;</span><span class="p">((</span><span class="s">&#34;pdf&#34;</span> <span class="o">.</span> <span class="s">&#34;open&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="nv">ebib-index-default-sort</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;timestamp&#34;</span> <span class="o">.</span> <span class="nv">descend</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1">;; 笔记模板</span>
</span></span><span class="line"><span class="cl">        <span class="nv">ebib-notes-template</span> <span class="s">&#34;:PROPERTIES:\n:ID: %i\n:ROAM_REFS: @%k\n:END:\n#+title: %t\n#+description: %d\n#+date: %s\n%%?\n&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">ebib-notes-template-specifiers</span> <span class="o">&#39;</span><span class="p">((</span><span class="sc">?k</span> <span class="o">.</span> <span class="nv">ebib-create-key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                         <span class="p">(</span><span class="sc">?i</span> <span class="o">.</span> <span class="nv">ebib-create-id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                         <span class="p">(</span><span class="sc">?t</span> <span class="o">.</span> <span class="nv">ebib-create-org-title</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                         <span class="p">(</span><span class="sc">?d</span> <span class="o">.</span> <span class="nv">ebib-create-org-description</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                         <span class="p">(</span><span class="sc">?l</span> <span class="o">.</span> <span class="nv">ebib-create-org-link</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                         <span class="p">(</span><span class="sc">?s</span> <span class="o">.</span> <span class="nv">ebib-create-org-time-stamp</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="c1">;; 读书列表模板</span>
</span></span><span class="line"><span class="cl">        <span class="nv">ebib-reading-list-template</span> <span class="s">&#34;* %M %T\n:PROPERTIES:\n%K\n:END:\n%F\n%S\n&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">ebib-reading-list-template-specifiers</span> <span class="o">&#39;</span><span class="p">((</span><span class="sc">?M</span> <span class="o">.</span> <span class="nv">ebib-reading-list-project-marker</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                                <span class="p">(</span><span class="sc">?T</span> <span class="o">.</span> <span class="nv">ebib-create-org-title</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                                <span class="p">(</span><span class="sc">?K</span> <span class="o">.</span> <span class="nv">ebib-reading-list-create-org-identifier</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                                <span class="p">(</span><span class="sc">?F</span> <span class="o">.</span> <span class="nv">ebib-create-org-file-link</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                                <span class="p">(</span><span class="sc">?S</span> <span class="o">.</span> <span class="nv">ebib-create-org-stamp-inactive</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="nv">ebib-preload-bib-files</span> <span class="nv">bibtex-files</span>
</span></span><span class="line"><span class="cl">        <span class="nv">ebib-use-timestamp</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">defun</span> <span class="nv">ebib-create-key</span> <span class="p">(</span><span class="nv">key</span> <span class="nv">_db</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;Return the KEY in DB for the Org mode note.&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nf">format</span> <span class="s">&#34;%s&#34;</span> <span class="nv">key</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">defun</span> <span class="nv">ebib-create-id</span> <span class="p">(</span><span class="nv">_key</span> <span class="nv">_db</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;Create an ID for the Org mode note.&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nv">org-id-new</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">defun</span> <span class="nv">ebib-create-org-time-stamp</span> <span class="p">(</span><span class="nv">_key</span> <span class="nv">_db</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;Create timestamp for the Org mode note.&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nf">format</span> <span class="s">&#34;%s&#34;</span> <span class="p">(</span><span class="nb">with-temp-buffer</span> <span class="p">(</span><span class="nv">org-insert-time-stamp</span> <span class="no">nil</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">;; 替换官方的 ebib-reading-list-todo-marker</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">defcustom</span> <span class="nv">ebib-reading-list-project-marker</span> <span class="s">&#34;PROJECT&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;Marker for reading list items that are still open.&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">:group</span> <span class="ss">&#39;ebib-reading-list</span>
</span></span><span class="line"><span class="cl">    <span class="nb">:type</span> <span class="o">&#39;</span><span class="p">(</span><span class="nf">string</span> <span class="nb">:tag</span> <span class="s">&#34;Project marker&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="c1">;; 获取 [%Y-%m-%d %a %H:%M] 格式的时间戳</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">defun</span> <span class="nv">ebib-create-org-stamp-inactive</span> <span class="p">(</span><span class="nv">_key</span> <span class="nv">_db</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;Create inactive timestamp for the Org mode note.&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">let</span> <span class="p">((</span><span class="nv">org-time-stamp-custom-formats</span> <span class="nv">org-time-stamp-custom-formats</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nf">format</span> <span class="s">&#34;%s&#34;</span> <span class="p">(</span><span class="nb">with-temp-buffer</span> <span class="p">(</span><span class="nv">org-time-stamp-inactive</span> <span class="no">nil</span><span class="p">))))))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">require-package</span> <span class="ss">&#39;citar</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">use-package</span> <span class="nv">citar</span>
</span></span><span class="line"><span class="cl">  <span class="nb">:no-require</span>
</span></span><span class="line"><span class="cl">  <span class="nb">:custom</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">org-cite-global-bibliography</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;~/Dropbox/org/bib/bibtex.bib&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">citar-notes-paths</span> <span class="p">(</span><span class="nf">list</span> <span class="s">&#34;~/Dropbox/org/main&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">citar-library-paths</span> <span class="p">(</span><span class="nf">list</span> <span class="s">&#34;~/Dropbox/org/bib/files&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">org-cite-insert-processor</span> <span class="ss">&#39;citar</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">org-cite-follow-processor</span> <span class="ss">&#39;citar</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">org-cite-activate-processor</span> <span class="ss">&#39;citar</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">citar-bibliography</span> <span class="nv">org-cite-global-bibliography</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="c1">;; optional: org-cite-insert is also bound to C-c C-x C-@</span>
</span></span><span class="line"><span class="cl">  <span class="nb">:bind</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">:map</span> <span class="nv">org-mode-map</span> <span class="nb">:package</span> <span class="nv">org</span> <span class="p">(</span><span class="s">&#34;C-c b&#34;</span> <span class="o">.</span> <span class="nf">#&#39;</span><span class="nv">org-cite-insert</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">provide</span> <span class="ss">&#39;init-bibtex</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;; init-bibtex.el ends here</span>
</span></span></code></pre></div><p>搜索条目可以用 <code>&amp;</code> 来搜索，参考 <a href="https://joostkremers.github.io/ebib/ebib-manual.html#filters">Ebib Manual</a>。</p>
<h3 id="init-themes-dot-el">init-themes.el<a hidden class="anchor" aria-hidden="true" href="#init-themes-dot-el">#</a></h3>
<p>用的 <a href="https://protesilaos.com/emacs/ef-themes-pictures">Screen shots of the Ef themes for GNU Emacs | Protesilaos Stavrou</a>，​<code>ef-spring</code> 作为非编码时的主题，​<code>ef-night</code> 作为编码时的主题。另外设置背景透明以及光标所在代码块按照括号高亮的函数也在放在这里。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-elisp" data-lang="elisp"><span class="line"><span class="cl"><span class="c1">;;; init-themes.el --- Defaults for themes -*- lexical-binding: t -*-</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;; Commentary:</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;; Code:</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">require-package</span> <span class="ss">&#39;ef-themes</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">require-package</span> <span class="ss">&#39;gruvbox-theme</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;; Don&#39;t prompt to confirm theme safety. This avoids problems with</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; first-time startup on Emacs &gt; 26.3.</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">custom-safe-themes</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;; If you don&#39;t customize it, this is the theme you get.</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq-default</span> <span class="nv">custom-enabled-themes</span> <span class="o">&#39;</span><span class="p">(</span><span class="nv">ef-spring</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;; Ensure that themes will be applied even if they have not been customized</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">reapply-themes</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;Forcibly load the themes listed in </span><span class="ss">`custom-enabled-themes&#39;</span><span class="s">.&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">dolist</span> <span class="p">(</span><span class="nv">theme</span> <span class="nv">custom-enabled-themes</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">unless</span> <span class="p">(</span><span class="nv">custom-theme-p</span> <span class="nv">theme</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nv">load-theme</span> <span class="nv">theme</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">custom-set-variables</span> <span class="o">`</span><span class="p">(</span><span class="nv">custom-enabled-themes</span> <span class="p">(</span><span class="nb">quote</span> <span class="o">,</span><span class="nv">custom-enabled-themes</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">add-hook</span> <span class="ss">&#39;after-init-hook</span> <span class="ss">&#39;reapply-themes</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;; Toggle between light and dark</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">light</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;Activate a light color theme.&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">interactive</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">disable-theme</span> <span class="p">(</span><span class="nf">car</span> <span class="nv">custom-enabled-themes</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">setq</span> <span class="nv">custom-enabled-themes</span> <span class="o">&#39;</span><span class="p">(</span><span class="nv">ef-spring</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">reapply-themes</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">dark</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;Activate a dark color theme.&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">interactive</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">disable-theme</span> <span class="p">(</span><span class="nf">car</span> <span class="nv">custom-enabled-themes</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">setq</span> <span class="nv">custom-enabled-themes</span> <span class="o">&#39;</span><span class="p">(</span><span class="nv">gruvbox</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">reapply-themes</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nv">maybe-require-package</span> <span class="ss">&#39;dimmer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">setq-default</span> <span class="nv">dimmer-fraction</span> <span class="mf">0.15</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">add-hook</span> <span class="ss">&#39;after-init-hook</span> <span class="ss">&#39;dimmer-mode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">with-eval-after-load</span> <span class="ss">&#39;dimmer</span>
</span></span><span class="line"><span class="cl">    <span class="c1">;; TODO: file upstream as a PR</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nv">advice-add</span> <span class="ss">&#39;frame-set-background-mode</span> <span class="nb">:after</span> <span class="p">(</span><span class="nb">lambda</span> <span class="p">(</span><span class="kp">&amp;rest</span> <span class="nv">args</span><span class="p">)</span> <span class="p">(</span><span class="nv">dimmer-process-all</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">with-eval-after-load</span> <span class="ss">&#39;dimmer</span>
</span></span><span class="line"><span class="cl">    <span class="c1">;; Don&#39;t dim in terminal windows. Even with 256 colours it can</span>
</span></span><span class="line"><span class="cl">    <span class="c1">;; lead to poor contrast.  Better would be to vary dimmer-fraction</span>
</span></span><span class="line"><span class="cl">    <span class="c1">;; according to frame type.</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">defun</span> <span class="nv">sanityinc/display-non-graphic-p</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nv">not</span> <span class="p">(</span><span class="nv">display-graphic-p</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nv">add-to-list</span> <span class="ss">&#39;dimmer-exclusion-predicates</span> <span class="ss">&#39;sanityinc/display-non-graphic-p</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;; fake transparency</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">user/change-background-opacity</span> <span class="p">(</span><span class="nv">alpha</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">interactive</span> <span class="s">&#34;nOpacity: &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">if</span> <span class="p">(</span><span class="nb">and</span> <span class="p">(</span><span class="nf">&gt;=</span> <span class="nv">alpha</span> <span class="mi">0</span><span class="p">)</span> <span class="p">(</span><span class="nf">&lt;=</span> <span class="nv">alpha</span> <span class="mi">100</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nv">user/set-background-opacity</span> <span class="nv">alpha</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nv">format-message</span> <span class="s">&#34;Opacity has to be between 0 and 100 but is %d.&#34;</span> <span class="nv">alpha</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">user/set-background-opacity</span> <span class="p">(</span><span class="nv">alpha</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">set-frame-parameter</span> <span class="p">(</span><span class="nf">selected-frame</span><span class="p">)</span> <span class="ss">&#39;alpha</span> <span class="nv">alpha</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">add-to-list</span> <span class="ss">&#39;default-frame-alist</span> <span class="p">(</span><span class="nf">cons</span> <span class="ss">&#39;alpha</span> <span class="nv">alpha</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;; (user/set-background-opacity 90)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;; true transparency</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; (defun kb/toggle-window-transparency ()</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;   &#34;Toggle transparency.&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;   (interactive)</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;   (let ((alpha-transparency 75))</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;     (pcase (frame-parameter nil &#39;alpha-background)</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;       (alpha-transparency (set-frame-parameter nil &#39;alpha-background 100))</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;       (t (set-frame-parameter nil &#39;alpha-background alpha-transparency)))))</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; (kb/toggle-window-transparency)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">provide</span> <span class="ss">&#39;init-themes</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;; init-themes.el ends here</span>
</span></span></code></pre></div><h3 id="init-elfeed-dot-el">init-elfeed.el<a hidden class="anchor" aria-hidden="true" href="#init-elfeed-dot-el">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-elisp" data-lang="elisp"><span class="line"><span class="cl"><span class="c1">;;; init-elfeed.el  --- Custom configuration</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;; Commentary</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">require-package</span> <span class="ss">&#39;elfeed</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">global-set-key</span> <span class="p">(</span><span class="nv">kbd</span> <span class="s">&#34;C-x w&#34;</span><span class="p">)</span> <span class="ss">&#39;elfeed</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">use-package</span> <span class="nv">elfeed-org</span>
</span></span><span class="line"><span class="cl">  <span class="nb">:ensure</span> <span class="no">t</span>
</span></span><span class="line"><span class="cl">  <span class="nb">:config</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">elfeed-org</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">setq</span> <span class="nv">rmh-elfeed-org-files</span> <span class="p">(</span><span class="nf">list</span> <span class="s">&#34;~/Dropbox/org/elfeed.org&#34;</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">concatenate-authors</span> <span class="p">(</span><span class="nv">authors-list</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;Given AUTHORS-LIST, list of plists; return string of all authors
</span></span></span><span class="line"><span class="cl"><span class="s">concatenated.&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nf">mapconcat</span>
</span></span><span class="line"><span class="cl">   <span class="p">(</span><span class="nb">lambda</span> <span class="p">(</span><span class="nv">author</span><span class="p">)</span> <span class="p">(</span><span class="nf">plist-get</span> <span class="nv">author</span> <span class="nb">:name</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">   <span class="nv">authors-list</span> <span class="s">&#34;, &#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">my-search-print-fn</span> <span class="p">(</span><span class="nv">entry</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;Print ENTRY to the buffer.&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">let*</span> <span class="p">((</span><span class="nv">date</span> <span class="p">(</span><span class="nv">elfeed-search-format-date</span> <span class="p">(</span><span class="nv">elfeed-entry-date</span> <span class="nv">entry</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">         <span class="p">(</span><span class="nv">title</span> <span class="p">(</span><span class="nb">or</span> <span class="p">(</span><span class="nv">elfeed-meta</span> <span class="nv">entry</span> <span class="nb">:title</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="p">(</span><span class="nv">elfeed-entry-title</span> <span class="nv">entry</span><span class="p">)</span> <span class="s">&#34;&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">         <span class="p">(</span><span class="nv">title-faces</span> <span class="p">(</span><span class="nv">elfeed-search--faces</span> <span class="p">(</span><span class="nv">elfeed-entry-tags</span> <span class="nv">entry</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">         <span class="p">(</span><span class="nv">feed</span> <span class="p">(</span><span class="nv">elfeed-entry-feed</span> <span class="nv">entry</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">         <span class="p">(</span><span class="nv">feed-title</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span><span class="nb">when</span> <span class="nv">feed</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="nb">or</span> <span class="p">(</span><span class="nv">elfeed-meta</span> <span class="nv">feed</span> <span class="nb">:title</span><span class="p">)</span> <span class="p">(</span><span class="nv">elfeed-feed-title</span> <span class="nv">feed</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">         <span class="p">(</span><span class="nv">entry-authors</span> <span class="p">(</span><span class="nv">concatenate-authors</span>
</span></span><span class="line"><span class="cl">                         <span class="p">(</span><span class="nv">elfeed-meta</span> <span class="nv">entry</span> <span class="nb">:authors</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">         <span class="p">(</span><span class="nv">tags</span> <span class="p">(</span><span class="nf">mapcar</span> <span class="nf">#&#39;symbol-name</span> <span class="p">(</span><span class="nv">elfeed-entry-tags</span> <span class="nv">entry</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">         <span class="p">(</span><span class="nv">tags-str</span> <span class="p">(</span><span class="nf">mapconcat</span>
</span></span><span class="line"><span class="cl">                    <span class="p">(</span><span class="nb">lambda</span> <span class="p">(</span><span class="nv">s</span><span class="p">)</span> <span class="p">(</span><span class="nf">propertize</span> <span class="nv">s</span> <span class="ss">&#39;face</span>
</span></span><span class="line"><span class="cl">                                            <span class="ss">&#39;elfeed-search-tag-face</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                    <span class="nv">tags</span> <span class="s">&#34;,&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">         <span class="p">(</span><span class="nv">title-width</span> <span class="p">(</span><span class="nf">-</span> <span class="p">(</span><span class="nv">window-width</span><span class="p">)</span> <span class="mi">10</span>
</span></span><span class="line"><span class="cl">                         <span class="nv">elfeed-search-trailing-width</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">         <span class="p">(</span><span class="nv">title-column</span> <span class="p">(</span><span class="nv">elfeed-format-column</span>
</span></span><span class="line"><span class="cl">                        <span class="nv">title</span> <span class="p">(</span><span class="nv">elfeed-clamp</span>
</span></span><span class="line"><span class="cl">                               <span class="nv">elfeed-search-title-min-width</span>
</span></span><span class="line"><span class="cl">                               <span class="nv">title-width</span>
</span></span><span class="line"><span class="cl">                               <span class="nv">elfeed-search-title-max-width</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="nb">:left</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">         <span class="p">(</span><span class="nv">authors-width</span> <span class="mi">135</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="p">(</span><span class="nv">authors-column</span> <span class="p">(</span><span class="nv">elfeed-format-column</span>
</span></span><span class="line"><span class="cl">                        <span class="nv">entry-authors</span> <span class="p">(</span><span class="nv">elfeed-clamp</span>
</span></span><span class="line"><span class="cl">                               <span class="nv">elfeed-search-title-min-width</span>
</span></span><span class="line"><span class="cl">                               <span class="nv">authors-width</span>
</span></span><span class="line"><span class="cl">                               <span class="mi">131</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="nb">:left</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nf">insert</span> <span class="p">(</span><span class="nf">propertize</span> <span class="nv">date</span> <span class="ss">&#39;face</span> <span class="ss">&#39;elfeed-search-date-face</span><span class="p">)</span> <span class="s">&#34; &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nf">insert</span> <span class="p">(</span><span class="nf">propertize</span> <span class="nv">title-column</span>
</span></span><span class="line"><span class="cl">                        <span class="ss">&#39;face</span> <span class="nv">title-faces</span> <span class="ss">&#39;kbd-help</span> <span class="nv">title</span><span class="p">)</span> <span class="s">&#34; &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nf">insert</span> <span class="p">(</span><span class="nf">propertize</span> <span class="nv">authors-column</span>
</span></span><span class="line"><span class="cl">                        <span class="ss">&#39;face</span> <span class="ss">&#39;elfeed-search-date-face</span>
</span></span><span class="line"><span class="cl">                        <span class="ss">&#39;kbd-help</span> <span class="nv">entry-authors</span><span class="p">)</span> <span class="s">&#34; &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">;; (when feed-title</span>
</span></span><span class="line"><span class="cl">    <span class="c1">;;   (insert (propertize entry-authors</span>
</span></span><span class="line"><span class="cl">    <span class="c1">;; &#39;face &#39;elfeed-search-feed-face) &#34; &#34;))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">when</span> <span class="nv">entry-authors</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nf">insert</span> <span class="p">(</span><span class="nf">propertize</span> <span class="nv">feed-title</span>
</span></span><span class="line"><span class="cl">                          <span class="ss">&#39;face</span> <span class="ss">&#39;elfeed-search-feed-face</span><span class="p">)</span> <span class="s">&#34; &#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">;; (when tags</span>
</span></span><span class="line"><span class="cl">    <span class="c1">;;   (insert &#34;(&#34; tags-str &#34;)&#34;))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">elfeed-search-print-entry-function</span> <span class="nf">#&#39;</span><span class="nv">my-search-print-fn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">provide</span> <span class="ss">&#39;init-elfeed</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;; init-elfeed.el ends here</span>
</span></span></code></pre></div><h3 id="init-telega-dot-el">init-telega.el<a hidden class="anchor" aria-hidden="true" href="#init-telega-dot-el">#</a></h3>
<h4 id="building-tdlib">Building TDLib<a hidden class="anchor" aria-hidden="true" href="#building-tdlib">#</a></h4>
<p><code>brew install tdlib</code> 的版本过低，需要自行编译，参考 <a href="https://tdlib.github.io/td/build.html?language=Swift">TDLib build instructions</a> 。这个之后需要 <code>M-x telega-server-build</code> 重新加载 telega-server。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">xcode-select --install
</span></span><span class="line"><span class="cl">/bin/bash -c <span class="s2">&#34;</span><span class="k">$(</span>curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh<span class="k">)</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">brew install gperf cmake openssl
</span></span><span class="line"><span class="cl">git clone https://github.com/tdlib/td.git
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> td
</span></span><span class="line"><span class="cl">rm -rf build
</span></span><span class="line"><span class="cl">mkdir build
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> build
</span></span><span class="line"><span class="cl">cmake -DCMAKE_BUILD_TYPE<span class="o">=</span>Release -DOPENSSL_ROOT_DIR<span class="o">=</span>/usr/local/opt/openssl/ -DCMAKE_INSTALL_PREFIX:PATH<span class="o">=</span>/usr/local ..
</span></span><span class="line"><span class="cl">cmake --build . --target install
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> ..
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> ..
</span></span><span class="line"><span class="cl">ls -l /usr/local
</span></span></code></pre></div><p>如果报错 <code>&quot;user-error: TDLib is not installed into &quot;/usr/local&quot;. Set ‘telega-server-libs-prefix’ to the TDLib installion path&quot;</code>​，则可以通过 <code>M-: (setq telega-server-libs-prefix “/path/to/tdlib/install/path”) RET</code> 然后 <code>M-x telega-server-build RET</code> 重新构建。</p>
<h4 id="running-telega-server-in-docker">Running telega-server in docker<a hidden class="anchor" aria-hidden="true" href="#running-telega-server-in-docker">#</a></h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">brew install --cask docker
</span></span><span class="line"><span class="cl">brew install ffmpeg
</span></span><span class="line"><span class="cl">docker pull zevlg/telega-server:latest
</span></span></code></pre></div><p>在配置中加上下面代码即可。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-elisp" data-lang="elisp"><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">telega-use-docker</span> <span class="no">t</span><span class="p">)</span>
</span></span></code></pre></div><table>
<thead>
<tr>
<th>快捷键</th>
<th>功能</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>C-c C-v</code></td>
<td>发送图片</td>
<td><code>brew install pngpaste</code></td>
</tr>
<tr>
<td><code>!</code></td>
<td>点赞</td>
<td></td>
</tr>
<tr>
<td><code>C-c C-a</code></td>
<td>Attachment type</td>
<td>其中 markup 可以发送 md 等格式</td>
</tr>
<tr>
<td><code>C-c C-c</code></td>
<td>光标移到消息后，按快捷键取消搜索。</td>
<td></td>
</tr>
<tr>
<td><code>M-g r</code></td>
<td>跳转到最新消息</td>
<td>或者 <code>M-g &gt;</code></td>
</tr>
</tbody>
</table>
<p><strong>头像裂开的问题</strong>​：是由于字体高度问题导致的，安装 <code>init-font.el</code> 中的设置，​<code>Iosevka</code> 大多数中文字体配合，并设置 <code>(add-to-list 'face-font-rescale-alist '(&quot;Apple Color Emoji&quot; . 0.8))</code> 可以实现头像不裂开。但由于 Emoji 以及各种昵称中的特殊字符，比如 Noto Sans Egyptian Hieroglyphs 这种古埃及象形文字，以及 Noto Sans Kannada 和 STIXGeneral 等字体，出现在昵称以及 Reply 行中，都会导致头像裂开。</p>
<p>有几种解决的方案。</p>
<ol>
<li>使用更纱黑体（字体太丑且并不能兼容那些使用第三点当中提到的特殊字体的情况）。</li>
</ol>
<!--listend-->
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-elisp" data-lang="elisp"><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">telega-buffer-face-mode-variable</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">interactive</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">make-face</span> <span class="ss">&#39;my-telega-face</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="c1">;; (set-face-attribute &#39;my-telega-face nil :font &#34;M+ 1m&#34;)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">set-face-attribute</span> <span class="ss">&#39;my-telega-face</span> <span class="no">nil</span> <span class="nb">:font</span> <span class="s">&#34;Sarasa Mono SC Nerd 13&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">setq</span> <span class="nv">buffer-face-mode-face</span> <span class="ss">&#39;my-telega-face</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">buffer-face-mode</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">add-hook</span> <span class="ss">&#39;telega-root-mode-hook</span> <span class="ss">&#39;telega-buffer-face-mode-variable</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">add-hook</span> <span class="ss">&#39;telega-webpage-mode-hook</span> <span class="ss">&#39;telega-buffer-face-mode-variable</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">add-hook</span> <span class="ss">&#39;telega-chat-mode-hook</span> <span class="ss">&#39;telega-buffer-face-mode-variable</span><span class="p">)</span>
</span></span></code></pre></div><ol>
<li>使用 <code>(setf (alist-get 2 telega-avatar-factors-alist) '(0.5 . 0.1))</code> 来使得本来两行显示的头像缩小至一行显示（头像显示几乎废了）。</li>
<li>在基础字号的基础上（这里是 14）调整特殊字符/字体的缩放就可以完美解决头像裂开的问题了，完整代码如下。</li>
</ol>
<h4 id="contrib">contrib<a hidden class="anchor" aria-hidden="true" href="#contrib">#</a></h4>
<p><code>telega</code> 中有个 <code>contrib</code> 的子目录，当中有一些挺实用的功能。这里启用了三种，过滤广告、代码高亮以及短链。</p>
<p>原生的加载子目录。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-elisp" data-lang="elisp"><span class="line"><span class="cl"><span class="p">(</span><span class="nb">push</span> <span class="p">(</span><span class="nf">expand-file-name</span> <span class="s">&#34;contrib&#34;</span> <span class="p">(</span><span class="nf">file-name-directory</span> <span class="p">(</span><span class="nv">locate-library</span> <span class="s">&#34;telega&#34;</span><span class="p">)))</span> <span class="nv">load-path</span><span class="p">)</span>
</span></span></code></pre></div><p>使用 <code>straight</code> 的话如下。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-elisp" data-lang="elisp"><span class="line"><span class="cl"><span class="nb">:straight</span> <span class="p">(</span><span class="nb">:host</span> <span class="nv">github</span> <span class="nb">:repo</span> <span class="s">&#34;zevlg/telega.el&#34;</span>
</span></span><span class="line"><span class="cl">           <span class="nb">:files</span> <span class="p">(</span><span class="nb">:defaults</span> <span class="s">&#34;contrib&#34;</span><span class="p">))</span>
</span></span></code></pre></div><h4 id="animated-stickers">Animated Stickers<a hidden class="anchor" aria-hidden="true" href="#animated-stickers">#</a></h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">git clone https://github.com/zevlg/tgs2png.git
</span></span><span class="line"><span class="cl">git submodule init
</span></span><span class="line"><span class="cl">git submodule update
</span></span><span class="line"><span class="cl">mkdir build
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> build
</span></span><span class="line"><span class="cl">cmake ..
</span></span><span class="line"><span class="cl">make
</span></span><span class="line"><span class="cl">copy tgs2png somewhere into <span class="nv">$PATH</span>
</span></span></code></pre></div><p>这里我编译完就已经是可用的了。</p>
<h4 id="display-buffer-alist">display-buffer-alist<a hidden class="anchor" aria-hidden="true" href="#display-buffer-alist">#</a></h4>
<p>每次打开 telega 都是占了 emacs 窗口的一半（emacs 我都是全屏使用），需要手动去调整 telega 的窗口。这里设置了一下 <code>display-buffer-alist</code> 之后就可以固定 telega 的窗口在右侧，并且占据窗口的 35% 的宽度。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-elisp" data-lang="elisp"><span class="line"><span class="cl"><span class="p">(</span><span class="nv">add-hook</span> <span class="ss">&#39;telega-mode-hook</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span><span class="nb">lambda</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="nv">display-buffer</span> <span class="p">(</span><span class="nf">current-buffer</span><span class="p">)</span> <span class="o">&#39;</span><span class="p">((</span><span class="nv">display-buffer-in-side-window</span><span class="p">)))))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">display-buffer-alist</span>
</span></span><span class="line"><span class="cl">      <span class="o">&#39;</span><span class="p">((</span><span class="s">&#34;\\*Telega Root\\*&#34;</span> <span class="o">.</span> <span class="p">((</span><span class="nv">display-buffer-in-side-window</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                               <span class="p">(</span><span class="nv">window-width</span> <span class="o">.</span> <span class="mf">0.35</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                               <span class="p">(</span><span class="nv">side</span> <span class="o">.</span> <span class="nv">right</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                               <span class="p">(</span><span class="nv">slot</span> <span class="o">.</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                               <span class="p">(</span><span class="nv">dedicated</span> <span class="o">.</span> <span class="no">nil</span><span class="p">)))))</span>
</span></span></code></pre></div><p>上述代码除了 <code>dedicated</code> 属性，都是由 ChatGPT Plus 生成。不设置该字段为 <code>nil</code> 会导致从 Telega 列表进入聊天 buffer 后重新打开新的 buffer，具体原因参照 <code>dedicated</code> 字段的解释参见 <a href="https://www.gnu.org/software/emacs/manual/html_node/elisp/Displaying-Buffers-in-Side-Windows.html">Displaying Buffers in Side Windows (GNU Emacs Lisp Reference Manual)</a>。</p>
<p>最后总的配置如下。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-elisp" data-lang="elisp"><span class="line"><span class="cl"><span class="c1">;;; init-telega.el  --- Custom configuration</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;; Commentary</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">require-package</span> <span class="ss">&#39;telega</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">require-package</span> <span class="ss">&#39;all-the-icons</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; If language-detection is available,</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; then laguage could be detected automatically</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; for code blocks without language explicitly specified.</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">require-package</span> <span class="ss">&#39;language-detection</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; 加载子文件夹 contrib</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">push</span> <span class="p">(</span><span class="nf">expand-file-name</span> <span class="s">&#34;contrib&#34;</span> <span class="p">(</span><span class="nf">file-name-directory</span> <span class="p">(</span><span class="nv">locate-library</span> <span class="s">&#34;telega&#34;</span><span class="p">)))</span> <span class="nv">load-path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">require</span> <span class="ss">&#39;telega-mnz</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">global-telega-mnz-mode</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">telega-debug</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; 自动播放 gif</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">telega-autoplay-mode</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nf">define-key</span> <span class="nv">global-map</span> <span class="p">(</span><span class="nv">kbd</span> <span class="s">&#34;C-c t&#34;</span><span class="p">)</span> <span class="nv">telega-prefix-map</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;; 去除昵称、回复行的背景高亮</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">my-telega-chat-mode</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="c1">;; telega-msg-inline-reply   ⊆ telega-msg-heading</span>
</span></span><span class="line"><span class="cl">  <span class="c1">;; telega-msg-inline-forward ⊆ telega-msg-heading</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">set-face-attribute</span> <span class="ss">&#39;telega-msg-heading</span> <span class="no">nil</span>
</span></span><span class="line"><span class="cl">                      <span class="nb">:underline</span> <span class="no">nil</span>
</span></span><span class="line"><span class="cl">                      <span class="nb">:inherit</span> <span class="no">nil</span>
</span></span><span class="line"><span class="cl">  <span class="c1">;; Warning: setting attribute ‘:background’ of face ‘telega-msg-heading’: nil value is invalid, use ‘unspecified’ instead.</span>
</span></span><span class="line"><span class="cl">                      <span class="nb">:background</span> <span class="ss">&#39;unspecified</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">set-face-attribute</span> <span class="ss">&#39;telega-msg-inline-reply</span> <span class="no">nil</span>
</span></span><span class="line"><span class="cl">                      <span class="nb">:foreground</span> <span class="s">&#34;#86C166&#34;</span><span class="p">)</span> <span class="c1">;; 苗 NAE</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">set-face-attribute</span> <span class="ss">&#39;telega-msg-inline-forward</span> <span class="no">nil</span>
</span></span><span class="line"><span class="cl">                      <span class="nb">:foreground</span> <span class="s">&#34;#FFB11B&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">set-face-attribute</span> <span class="ss">&#39;telega-entity-type-mention</span> <span class="no">nil</span>
</span></span><span class="line"><span class="cl">                      <span class="nb">:underline</span> <span class="o">&#39;</span><span class="p">(</span><span class="nb">:style</span> <span class="nv">line</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                      <span class="nb">:weight</span> <span class="ss">&#39;bold</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">set-face-attribute</span> <span class="ss">&#39;telega-msg-self-title</span> <span class="no">nil</span>
</span></span><span class="line"><span class="cl">                     <span class="nb">:foreground</span> <span class="s">&#34;#E2943B&#34;</span><span class="p">)</span> <span class="c1">;; 朽葉 KUCHIBA</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">set-face-attribute</span> <span class="ss">&#39;telega-msg-user-title</span> <span class="no">nil</span>
</span></span><span class="line"><span class="cl">                      <span class="nb">:weight</span> <span class="ss">&#39;bold</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">set-face-attribute</span> <span class="ss">&#39;telega-button</span> <span class="no">nil</span>
</span></span><span class="line"><span class="cl">                      <span class="nb">:foreground</span> <span class="s">&#34;#986DB2&#34;</span>
</span></span><span class="line"><span class="cl">                      <span class="nb">:box</span> <span class="o">&#39;</span><span class="p">(</span><span class="nb">:line-width</span> <span class="p">(</span><span class="mi">-2</span> <span class="o">.</span> <span class="mi">-2</span><span class="p">)</span> <span class="nb">:color</span> <span class="s">&#34;#986DB2&#34;</span> <span class="nb">:style</span> <span class="no">nil</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">set-face-attribute</span> <span class="ss">&#39;telega-button-active</span> <span class="no">nil</span>
</span></span><span class="line"><span class="cl">                      <span class="nb">:foreground</span> <span class="s">&#34;#ffffff&#34;</span>
</span></span><span class="line"><span class="cl">                      <span class="nb">:background</span> <span class="s">&#34;#986DB2&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="c1">;; (setq telega-chat-prompt-format &#34;🏄🏻〉 &#34;)</span>
</span></span><span class="line"><span class="cl">  <span class="c1">;; 缩小 emoji 及特殊字符/字体显示，防止头像裂开。</span>
</span></span><span class="line"><span class="cl">  <span class="c1">;; (add-to-list &#39;face-font-rescale-alist &#39;(&#34;Apple Color Emoji&#34; . 0.8))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">add-to-list</span> <span class="ss">&#39;face-font-rescale-alist</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;HanaMinA&#34;</span> <span class="o">.</span> <span class="mf">0.9</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">add-to-list</span> <span class="ss">&#39;face-font-rescale-alist</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;Noto Sans Egyptian Hieroglyphs&#34;</span> <span class="o">.</span> <span class="mf">0.675</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">add-to-list</span> <span class="ss">&#39;face-font-rescale-alist</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;STIXGeneral&#34;</span> <span class="o">.</span> <span class="mf">0.675</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">add-to-list</span> <span class="ss">&#39;face-font-rescale-alist</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;Apple Symbols&#34;</span> <span class="o">.</span> <span class="mf">0.675</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">add-to-list</span> <span class="ss">&#39;face-font-rescale-alist</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;Noto Sans Kannada&#34;</span> <span class="o">.</span> <span class="mf">0.675</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">add-to-list</span> <span class="ss">&#39;face-font-rescale-alist</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;Academy Engraved LET&#34;</span> <span class="o">.</span> <span class="mf">0.675</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">add-to-list</span> <span class="ss">&#39;face-font-rescale-alist</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;Kohinoor Devanagari&#34;</span> <span class="o">.</span> <span class="mf">0.675</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">add-to-list</span> <span class="ss">&#39;face-font-rescale-alist</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;Geneva&#34;</span> <span class="o">.</span> <span class="mf">0.675</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">add-to-list</span> <span class="ss">&#39;face-font-rescale-alist</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;Noto Sans Oriya&#34;</span> <span class="o">.</span> <span class="mf">0.675</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">add-hook</span> <span class="ss">&#39;telega-chat-mode-hook</span> <span class="ss">&#39;my-telega-chat-mode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; 未读提示</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">set-face-attribute</span> <span class="ss">&#39;telega-unmuted-count</span> <span class="no">nil</span>
</span></span><span class="line"><span class="cl">                    <span class="nb">:foreground</span> <span class="s">&#34;#FFB11B&#34;</span>
</span></span><span class="line"><span class="cl">                    <span class="nb">:weight</span> <span class="ss">&#39;bold</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">set-face-attribute</span> <span class="ss">&#39;telega-mention-count</span> <span class="no">nil</span>
</span></span><span class="line"><span class="cl">                    <span class="nb">:foreground</span> <span class="s">&#34;#FE6DB3&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">set-face-attribute</span> <span class="ss">&#39;telega-muted-count</span> <span class="no">nil</span>
</span></span><span class="line"><span class="cl">                    <span class="nb">:foreground</span> <span class="s">&#34;#86C166&#34;</span>
</span></span><span class="line"><span class="cl">                    <span class="nb">:weight</span> <span class="ss">&#39;bold</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; 多加一条横线在输入和聊天页面之间</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">telega-symbol-underline-bar</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nf">propertize</span> <span class="s">&#34; &#34;</span> <span class="ss">&#39;face</span> <span class="ss">&#39;telega-webpage-strike-through</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; 聊天列表高亮</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">lg-telega-root-mode</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">hl-line-mode</span> <span class="mi">1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">lg-telega-chat-update</span> <span class="p">(</span><span class="nv">chat</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">with-telega-root-buffer</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nv">hl-line-highlight</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">add-hook</span> <span class="ss">&#39;telega-chat-update-hook</span> <span class="ss">&#39;lg-telega-chat-update</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">add-hook</span> <span class="ss">&#39;telega-root-mode-hook</span> <span class="ss">&#39;lg-telega-root-mode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; Linux settings</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">when</span> <span class="vg">*IS-LINUX*</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">setq</span> <span class="nv">telega-root-show-avatars</span> <span class="no">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">setq</span> <span class="nv">telega-user-show-avatars</span> <span class="no">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">setq</span> <span class="nv">telega-chat-show-avatars</span> <span class="no">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">setq</span> <span class="nv">telega-proxies</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nf">list</span> <span class="o">&#39;</span><span class="p">(</span><span class="nb">:server</span> <span class="s">&#34;127.0.0.1&#34;</span> <span class="nb">:port</span> <span class="mi">7890</span> <span class="nb">:enable</span> <span class="no">t</span>
</span></span><span class="line"><span class="cl">                        <span class="nb">:type</span> <span class="p">(</span><span class="nb">:@type</span> <span class="s">&#34;proxyTypeSocks5&#34;</span>
</span></span><span class="line"><span class="cl">                                      <span class="nb">:username</span> <span class="s">&#34;&#34;</span> <span class="nb">:password</span> <span class="s">&#34;&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">              <span class="p">)))</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; Opening files using external programs</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">if</span> <span class="vg">*IS-MAC*</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nf">setcdr</span> <span class="p">(</span><span class="nf">assq</span> <span class="no">t</span> <span class="nv">org-file-apps-gnu</span><span class="p">)</span> <span class="ss">&#39;browse-url-default-macosx-browser</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nf">setcdr</span> <span class="p">(</span><span class="nf">assq</span> <span class="no">t</span> <span class="nv">org-file-apps-gnu</span><span class="p">)</span> <span class="ss">&#39;browse-url-xdg-open</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">telega-open-file-function</span> <span class="ss">&#39;org-open-file</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; 固定 telega 窗口在右侧</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">add-hook</span> <span class="ss">&#39;telega-mode-hook</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span><span class="nb">lambda</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="nv">display-buffer</span> <span class="p">(</span><span class="nf">current-buffer</span><span class="p">)</span> <span class="o">&#39;</span><span class="p">((</span><span class="nv">display-buffer-in-side-window</span><span class="p">)))))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">display-buffer-alist</span>
</span></span><span class="line"><span class="cl">      <span class="o">&#39;</span><span class="p">((</span><span class="s">&#34;\\*Telega Root\\*&#34;</span> <span class="o">.</span> <span class="p">((</span><span class="nv">display-buffer-in-side-window</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                               <span class="p">(</span><span class="nv">window-width</span> <span class="o">.</span> <span class="mf">0.35</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                               <span class="p">(</span><span class="nv">side</span> <span class="o">.</span> <span class="nv">right</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                               <span class="p">(</span><span class="nv">slot</span> <span class="o">.</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                               <span class="p">(</span><span class="nv">dedicated</span> <span class="o">.</span> <span class="no">nil</span><span class="p">)))))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">provide</span> <span class="ss">&#39;init-telega</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;; init-telega.el ends here</span>
</span></span></code></pre></div><h3 id="init-translate-dot-el">init-translate.el<a hidden class="anchor" aria-hidden="true" href="#init-translate-dot-el">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-elisp" data-lang="elisp"><span class="line"><span class="cl"><span class="c1">;;; init-translate.el  --- Custom configuration</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;; Commentary</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">require-package</span> <span class="ss">&#39;go-translate</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">use-package</span> <span class="nv">go-translate</span>
</span></span><span class="line"><span class="cl">  <span class="nb">:bind</span> <span class="p">((</span><span class="s">&#34;C-c t g&#34;</span> <span class="o">.</span> <span class="nv">gts-do-translate</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="p">(</span><span class="s">&#34;C-c t p&#34;</span> <span class="o">.</span> <span class="nv">go-translate-at-point</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="p">(</span><span class="s">&#34;C-c t s&#34;</span> <span class="o">.</span> <span class="nv">go-translate-save-kill-ring</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="nb">:config</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">setq</span> <span class="nv">gts-translate-list</span> <span class="o">&#39;</span><span class="p">((</span><span class="s">&#34;en&#34;</span> <span class="s">&#34;zh&#34;</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">setq</span> <span class="nv">gts-default-translator</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nv">gts-translator</span>
</span></span><span class="line"><span class="cl">         <span class="nb">:picker</span> <span class="p">(</span><span class="nv">gts-prompt-picker</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="nb">:engines</span> <span class="p">(</span><span class="nf">list</span> <span class="p">(</span><span class="nv">gts-bing-engine</span><span class="p">)</span> <span class="p">(</span><span class="nv">gts-google-engine</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">         <span class="nb">:render</span> <span class="p">(</span><span class="nv">gts-buffer-render</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">;; Pick directly and use Google RPC API to translate</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">defun</span> <span class="nv">go-translate-at-point</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">interactive</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nv">gts-translate</span> <span class="p">(</span><span class="nv">gts-translator</span>
</span></span><span class="line"><span class="cl">                    <span class="nb">:picker</span> <span class="p">(</span><span class="nv">gts-noprompt-picker</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="nb">:engines</span> <span class="p">(</span><span class="nv">gts-google-rpc-engine</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="nb">:render</span> <span class="p">(</span><span class="nv">gts-buffer-render</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">;; Pick directly and add the results into kill-ring</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">defun</span> <span class="nv">go-translate-save-kill-ring</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">interactive</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nv">gts-translate</span> <span class="p">(</span><span class="nv">gts-translator</span>
</span></span><span class="line"><span class="cl">                    <span class="nb">:picker</span> <span class="p">(</span><span class="nv">gts-noprompt-picker</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="nb">:engines</span> <span class="p">(</span><span class="nv">gts-google-engine</span>
</span></span><span class="line"><span class="cl">                              <span class="nb">:parser</span> <span class="p">(</span><span class="nv">gts-google-summary-parser</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                    <span class="nb">:render</span> <span class="p">(</span><span class="nv">gts-kill-ring-render</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">set-face-attribute</span> <span class="ss">&#39;gts-render-buffer-me-header-backgroud-face</span> <span class="no">nil</span> <span class="nb">:background</span> <span class="s">&#34;#7BA23F&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">provide</span> <span class="ss">&#39;init-translate</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;; init-translate.el ends here</span>
</span></span></code></pre></div><h3 id="init-org-modern-dot-el">init-org-modern.el<a hidden class="anchor" aria-hidden="true" href="#init-org-modern-dot-el">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-elisp" data-lang="elisp"><span class="line"><span class="cl"><span class="c1">;;; init-org-modern.el  --- Custom configuration</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;; Commentary</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">require-package</span> <span class="ss">&#39;org-modern</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">use-package</span> <span class="nv">org-modern</span>
</span></span><span class="line"><span class="cl">  <span class="nb">:after</span> <span class="nv">org</span>
</span></span><span class="line"><span class="cl">  <span class="nb">:hook</span> <span class="p">(</span><span class="nv">org-mode</span> <span class="o">.</span> <span class="nv">org-modern-mode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="nb">:init</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">menu-bar-mode</span> <span class="mi">-1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">tool-bar-mode</span> <span class="mi">-1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">scroll-bar-mode</span> <span class="mi">-1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">setq</span> <span class="nv">org-modern-star</span> <span class="p">[</span><span class="s">&#34;➫&#34;</span> <span class="s">&#34;✦&#34;</span> <span class="s">&#34;✜&#34;</span> <span class="s">&#34;✲&#34;</span> <span class="s">&#34;✸&#34;</span> <span class="s">&#34;❅&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="nv">org-hide-emphasis-markers</span> <span class="no">t</span>
</span></span><span class="line"><span class="cl">        <span class="nv">org-tags-column</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="nv">org-catch-invisible-edits</span> <span class="ss">&#39;show-and-error</span>
</span></span><span class="line"><span class="cl">        <span class="nv">org-special-ctrl-a/e</span> <span class="no">t</span>
</span></span><span class="line"><span class="cl">        <span class="nv">org-insert-heading-respect-content</span> <span class="no">t</span>
</span></span><span class="line"><span class="cl">        <span class="nv">org-modern-table-horizontal</span> <span class="mf">0.2</span>
</span></span><span class="line"><span class="cl">        <span class="nv">org-modern-list</span> <span class="o">&#39;</span><span class="p">((</span><span class="mi">43</span> <span class="o">.</span> <span class="s">&#34;➤&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                          <span class="p">(</span><span class="mi">45</span> <span class="o">.</span> <span class="s">&#34;▻&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                          <span class="p">(</span><span class="mi">42</span> <span class="o">.</span> <span class="s">&#34;►&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="nv">org-ellipsis</span> <span class="s">&#34;[+]&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">modify-all-frames-parameters</span>
</span></span><span class="line"><span class="cl">   <span class="o">&#39;</span><span class="p">((</span><span class="nv">right-divider-width</span> <span class="o">.</span> <span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">     <span class="p">(</span><span class="nv">left-divider-width</span> <span class="o">.</span> <span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">     <span class="p">(</span><span class="nv">internal-border-width</span> <span class="o">.</span> <span class="mi">5</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">dolist</span> <span class="p">(</span><span class="nv">face</span> <span class="o">&#39;</span><span class="p">(</span><span class="nv">window-divider</span>
</span></span><span class="line"><span class="cl">                  <span class="nv">window-divider-first-pixel</span>
</span></span><span class="line"><span class="cl">                  <span class="nv">window-divider-last-pixel</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nv">face-spec-reset-face</span> <span class="nv">face</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nv">set-face-foreground</span> <span class="nv">face</span> <span class="p">(</span><span class="nv">face-attribute</span> <span class="ss">&#39;default</span> <span class="nb">:background</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">set-face-background</span> <span class="ss">&#39;fringe</span> <span class="p">(</span><span class="nv">face-attribute</span> <span class="ss">&#39;default</span> <span class="nb">:background</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">custom-set-faces</span>
</span></span><span class="line"><span class="cl"> <span class="o">&#39;</span><span class="p">(</span><span class="nv">org-ellipsis</span> <span class="p">((</span><span class="no">t</span> <span class="p">(</span><span class="nb">:foreground</span> <span class="s">&#34;#90B44B&#34;</span><span class="p">)))))</span> <span class="c1">;; 鶸萌黄</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">provide</span> <span class="ss">&#39;init-org-modern</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;; init-org-modern.el ends here</span>
</span></span></code></pre></div><h3 id="init-quick-menus-dot-el">init-quick-menus.el<a hidden class="anchor" aria-hidden="true" href="#init-quick-menus-dot-el">#</a></h3>
<p>Daily Log 是按照每天的日期生成，并不是固定的文件名，因此这里写了自定义方法去跳转到今天/昨天的 Daily Log，方便用来回顾。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-elisp" data-lang="elisp"><span class="line"><span class="cl"><span class="c1">;;; init-quick-menus.el  --- Custom configuration</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;; Commentary</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; org-starter</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">require-package</span> <span class="ss">&#39;org-starter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">org-refile-use-outline-path</span> <span class="ss">&#39;file</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">use-package</span> <span class="nv">org-starter</span>
</span></span><span class="line"><span class="cl">  <span class="nb">:config</span>
</span></span><span class="line"><span class="cl">  <span class="c1">;; (add-hook! &#39;after-init-hook &#39;org-starter-load-all-files-in-path)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">org-starter-def</span> <span class="s">&#34;~/Dropbox/org&#34;</span>
</span></span><span class="line"><span class="cl">                   <span class="nb">:files</span>
</span></span><span class="line"><span class="cl">                   <span class="p">(</span><span class="s">&#34;agenda/inbox.org&#34;</span>                <span class="nb">:agenda</span> <span class="no">t</span>   <span class="nb">:key</span> <span class="s">&#34;i&#34;</span> <span class="nb">:refile</span> <span class="p">(</span><span class="nb">:maxlevel</span> <span class="o">.</span> <span class="mi">2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                   <span class="p">(</span><span class="s">&#34;agenda/work.org&#34;</span>                 <span class="nb">:agenda</span> <span class="no">t</span>   <span class="nb">:key</span> <span class="s">&#34;w&#34;</span> <span class="nb">:refile</span> <span class="p">(</span><span class="nb">:maxlevel</span> <span class="o">.</span> <span class="mi">2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                   <span class="p">(</span><span class="s">&#34;agenda/tech-debt.org&#34;</span>            <span class="nb">:agenda</span> <span class="no">t</span>   <span class="nb">:key</span> <span class="s">&#34;d&#34;</span> <span class="nb">:refile</span> <span class="p">(</span><span class="nb">:maxlevel</span> <span class="o">.</span> <span class="mi">2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                   <span class="p">(</span><span class="s">&#34;agenda/personal.org&#34;</span>             <span class="nb">:agenda</span> <span class="no">t</span>   <span class="nb">:key</span> <span class="s">&#34;p&#34;</span> <span class="nb">:refile</span> <span class="p">(</span><span class="nb">:maxlevel</span> <span class="o">.</span> <span class="mi">2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                   <span class="p">(</span><span class="s">&#34;agenda/books.org&#34;</span>                <span class="nb">:agenda</span> <span class="no">t</span>   <span class="nb">:key</span> <span class="s">&#34;b&#34;</span> <span class="nb">:refile</span> <span class="p">(</span><span class="nb">:maxlevel</span> <span class="o">.</span> <span class="mi">2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                   <span class="p">(</span><span class="s">&#34;agenda/someday.org&#34;</span>              <span class="nb">:agenda</span> <span class="no">t</span>   <span class="nb">:key</span> <span class="s">&#34;s&#34;</span> <span class="nb">:refile</span> <span class="p">(</span><span class="nb">:maxlevel</span> <span class="o">.</span> <span class="mi">2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                   <span class="p">(</span><span class="s">&#34;agenda/agenda.org&#34;</span>               <span class="nb">:agenda</span> <span class="no">t</span>   <span class="nb">:key</span> <span class="s">&#34;a&#34;</span> <span class="nb">:refile</span> <span class="p">(</span><span class="nb">:maxlevel</span> <span class="o">.</span> <span class="mi">2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                   <span class="p">(</span><span class="s">&#34;agenda/note.org&#34;</span>                 <span class="nb">:agenda</span> <span class="no">t</span>   <span class="nb">:key</span> <span class="s">&#34;n&#34;</span> <span class="nb">:refile</span> <span class="p">(</span><span class="nb">:maxlevel</span> <span class="o">.</span> <span class="mi">2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                   <span class="p">(</span><span class="s">&#34;daily/journal.org&#34;</span>               <span class="nb">:agenda</span> <span class="no">t</span>   <span class="nb">:key</span> <span class="s">&#34;j&#34;</span> <span class="nb">:refile</span> <span class="p">(</span><span class="nb">:maxlevel</span> <span class="o">.</span> <span class="mi">2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                   <span class="p">(</span><span class="s">&#34;beancount/2022.beancount&#34;</span>        <span class="nb">:agenda</span> <span class="no">nil</span> <span class="nb">:key</span> <span class="s">&#34;c&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                   <span class="p">(</span><span class="s">&#34;beancount/account.beancount&#34;</span>     <span class="nb">:agenda</span> <span class="no">nil</span> <span class="nb">:key</span> <span class="s">&#34;m&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                   <span class="p">(</span><span class="s">&#34;beancount/credit.beancount&#34;</span>      <span class="nb">:agenda</span> <span class="no">nil</span> <span class="nb">:key</span> <span class="s">&#34;e&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                   <span class="p">(</span><span class="s">&#34;beancount/insurance.beancount&#34;</span>   <span class="nb">:agenda</span> <span class="no">nil</span> <span class="nb">:key</span> <span class="s">&#34;u&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                   <span class="p">(</span><span class="s">&#34;beancount/salary.beancount&#34;</span>      <span class="nb">:agenda</span> <span class="no">nil</span> <span class="nb">:key</span> <span class="s">&#34;l&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                   <span class="p">(</span><span class="s">&#34;beancount/house.beancount&#34;</span>       <span class="nb">:agenda</span> <span class="no">nil</span> <span class="nb">:key</span> <span class="s">&#34;h&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                   <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="c1">;; hydra</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">require-package</span> <span class="ss">&#39;hydra</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="c1">;; 打开当前日期对应的 daily log 文件</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">defun</span> <span class="nv">open-today-journal-file</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;Open journal file for today.&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">interactive</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">let*</span> <span class="p">((</span><span class="nv">file-name</span> <span class="p">(</span><span class="nf">format-time-string</span> <span class="s">&#34;%Y-%m-%d.org&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">           <span class="p">(</span><span class="nv">file-path</span> <span class="p">(</span><span class="nf">concat</span> <span class="s">&#34;~/Dropbox/org/daily/&#34;</span> <span class="nv">file-name</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nb">if</span> <span class="p">(</span><span class="nf">file-exists-p</span> <span class="nv">file-path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span><span class="nv">find-file</span> <span class="nv">file-path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nf">message</span> <span class="s">&#34;Journal file not found for today.&#34;</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">defun</span> <span class="nv">open-yesterday-journal-file</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;Open journal file for yesterday.&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">interactive</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">let*</span> <span class="p">((</span><span class="nv">yesterday-time</span> <span class="p">(</span><span class="nf">time-subtract</span> <span class="p">(</span><span class="nf">current-time</span><span class="p">)</span> <span class="p">(</span><span class="nv">days-to-time</span> <span class="mi">1</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">         <span class="p">(</span><span class="nv">file-name</span> <span class="p">(</span><span class="nf">format-time-string</span> <span class="s">&#34;%Y-%m-%d.org&#34;</span> <span class="nv">yesterday-time</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">         <span class="p">(</span><span class="nv">file-path</span> <span class="p">(</span><span class="nf">concat</span> <span class="s">&#34;~/Dropbox/org/daily/&#34;</span> <span class="nv">file-name</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">if</span> <span class="p">(</span><span class="nf">file-exists-p</span> <span class="nv">file-path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nv">find-file</span> <span class="nv">file-path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nf">message</span> <span class="s">&#34;Journal file not found for yesterday.&#34;</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">defhydra</span> <span class="nv">hydra-org-agenda-menu</span> <span class="p">(</span><span class="nb">:color</span> <span class="nv">blue</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">  [--&gt; Org-agenda-menu &lt;--]
</span></span></span><span class="line"><span class="cl"><span class="s">  ^^^^------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="s">  _i_: inbox     _w_: work       _b_: books     _d_: tech-debt     _a_: agenda     _p_: personal
</span></span></span><span class="line"><span class="cl"><span class="s">  _n_: note      _s_: someday    _j_: journal   _t_: today         _y_: yesterday
</span></span></span><span class="line"><span class="cl"><span class="s">  [--&gt; Beancount-menu &lt;--]
</span></span></span><span class="line"><span class="cl"><span class="s">  ^^^^------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="s">  _c_: 2022     _m_: account     _e_: credit     _u_: insurance     _l_: salary     _h_: house
</span></span></span><span class="line"><span class="cl"><span class="s">  &#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="s">&#34;i&#34;</span> <span class="nv">org-starter-find-file:inbox</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="s">&#34;w&#34;</span> <span class="nv">org-starter-find-file:work</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="s">&#34;d&#34;</span> <span class="nv">org-starter-find-file:tech-debt</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="s">&#34;p&#34;</span> <span class="nv">org-starter-find-file:personal</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="s">&#34;b&#34;</span> <span class="nv">org-starter-find-file:books</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="s">&#34;n&#34;</span> <span class="nv">org-starter-find-file:note</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="s">&#34;s&#34;</span> <span class="nv">org-starter-find-file:someday</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="s">&#34;a&#34;</span> <span class="nv">org-starter-find-file:agenda</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="s">&#34;j&#34;</span> <span class="nv">org-starter-find-file:journal</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="s">&#34;t&#34;</span> <span class="p">(</span><span class="nv">open-today-journal-file</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="s">&#34;y&#34;</span> <span class="p">(</span><span class="nv">open-yesterday-journal-file</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="s">&#34;c&#34;</span> <span class="nv">org-starter-find-file:2022</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="s">&#34;m&#34;</span> <span class="nv">org-starter-find-file:account</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="s">&#34;e&#34;</span> <span class="nv">org-starter-find-file:credit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="s">&#34;u&#34;</span> <span class="nv">org-starter-find-file:insurance</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="s">&#34;l&#34;</span> <span class="nv">org-starter-find-file:salary</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="s">&#34;h&#34;</span> <span class="nv">org-starter-find-file:house</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span><span class="nb">:bind</span><span class="p">(</span><span class="s">&#34;C-c e&#34;</span> <span class="o">.</span> <span class="nv">hydra-org-agenda-menu/body</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">provide</span> <span class="ss">&#39;init-quick-menus</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;; init-quick-menus.el ends here</span>
</span></span></code></pre></div><h3 id="init-tree-sitter-dot-el">init-tree-sitter.el<a hidden class="anchor" aria-hidden="true" href="#init-tree-sitter-dot-el">#</a></h3>
<p>其中 <code>elisp</code> 官方还未支持，需要自己编译后放入 <code>tree-sitter-langs</code> 下面。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">git clone https://github.com/Wilfred/tree-sitter-elisp
</span></span><span class="line"><span class="cl">gcc ./src/parser.c -fPIC -I./ --shared -o elisp.so
</span></span><span class="line"><span class="cl">cp ./elisp.so ~/.tree-sitter-langs/bin
</span></span></code></pre></div><p>这里第二步的时候报错了</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">./src/parser.c:1:10: error: <span class="s1">&#39;tree_sitter/parser.h&#39;</span> file not found with &lt;angled&gt; include<span class="p">;</span> use <span class="s2">&#34;quotes&#34;</span> instead
</span></span><span class="line"><span class="cl"><span class="c1">#include &lt;tree_sitter/parser.h&gt;</span>
</span></span><span class="line"><span class="cl">         ^~~~~~~~~~~~~~~~~~~~~~
</span></span><span class="line"><span class="cl">         <span class="s2">&#34;tree_sitter/parser.h&#34;</span>
</span></span><span class="line"><span class="cl"><span class="m">1</span> error generated.
</span></span></code></pre></div><p>这里需要将 <code>src/parser.c</code> 头部按照提示修改一下。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-diff" data-lang="diff"><span class="line"><span class="cl"><span class="gd">- #include &lt;tree_sitter/parser.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="gd"></span><span class="gi">+ #include &#34;tree_sitter/parser.h&#34;
</span></span></span></code></pre></div><p>第三步，由于我是通过 MELPA 安装，路径为 <code>.emacs.d/elpa-29.0/tree-sitter-langs-version/bin</code>​，其中 <code>version</code> 为具体的版本号。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-elisp" data-lang="elisp"><span class="line"><span class="cl"><span class="c1">;;; init-tree-sitter.el --- Configure for tree sitter</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;; Commentary:</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">require-package</span> <span class="ss">&#39;tree-sitter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">require-package</span> <span class="ss">&#39;tree-sitter-langs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">require</span> <span class="ss">&#39;tree-sitter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">require</span> <span class="ss">&#39;tree-sitter-langs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;;; Code:</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">global-tree-sitter-mode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">add-hook</span> <span class="ss">&#39;tree-sitter-after-on-hook</span> <span class="nf">#&#39;</span><span class="nv">tree-sitter-hl-mode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;; Load the language definition for Rust, if it hasn&#39;t been loaded.</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; Return the language object.</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">tree-sitter-require</span> <span class="ss">&#39;rust</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">tree-sitter-require</span> <span class="ss">&#39;python</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">tree-sitter-require</span> <span class="ss">&#39;javascript</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">provide</span> <span class="ss">&#39;init-tree-sitter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;; init-tree-sitter.el ends here</span>
</span></span></code></pre></div><h3 id="init-org-enhance-dot-el">init-org-enhance.el<a hidden class="anchor" aria-hidden="true" href="#init-org-enhance-dot-el">#</a></h3>
<p>一些增强 org 功能的函数，可以方便使用。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-elisp" data-lang="elisp"><span class="line"><span class="cl"><span class="c1">;;; init-org-enhance.el --- Org-mode config -*- lexical-binding: t -*-</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;; Commentary:</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; =============================================================</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; ==============  Org-roam-backlinks-search  ==================</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; =============================================================</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; https://github.com/Vidianos-Giannitsis/Dotfiles/blob/master/emacs/.emacs.d/libs/zettelkasten.org#org-roam-backlinks-search</span>
</span></span><span class="line"><span class="cl"> <span class="p">(</span><span class="nb">defcustom</span> <span class="nv">org-roam-backlinks-choices</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&#34;View Backlinks&#34;</span> <span class="s">&#34;Go to Node&#34;</span> <span class="s">&#34;Quit&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="s">&#34;List of choices for </span><span class="ss">`org-roam-backlinks-node-read&#39;</span><span class="s">.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="p">(</span><span class="nb">defun</span> <span class="nv">org-roam-backlinks-query*</span> <span class="p">(</span><span class="nv">NODE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="s">&#34;Gets the backlinks of NODE with </span><span class="ss">`org-roam-db-query&#39;</span><span class="s">.&#34;</span>
</span></span><span class="line"><span class="cl">   <span class="p">(</span><span class="nv">org-roam-db-query</span>
</span></span><span class="line"><span class="cl">          <span class="p">[</span><span class="nb">:select</span> <span class="p">[</span><span class="nv">source</span> <span class="nv">dest</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                   <span class="nb">:from</span> <span class="nv">links</span>
</span></span><span class="line"><span class="cl">                   <span class="nb">:where</span> <span class="p">(</span><span class="nf">=</span> <span class="nv">dest</span> <span class="nv">$s1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                   <span class="nb">:and</span> <span class="p">(</span><span class="nf">=</span> <span class="nv">type</span> <span class="s">&#34;id&#34;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span><span class="nv">org-roam-node-id</span> <span class="nv">NODE</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="p">(</span><span class="nb">defun</span> <span class="nv">org-roam-backlinks-p</span> <span class="p">(</span><span class="nv">SOURCE</span> <span class="nv">NODE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="s">&#34;Predicate function that checks if NODE is a backlink of SOURCE.&#34;</span>
</span></span><span class="line"><span class="cl">   <span class="p">(</span><span class="nb">let*</span> <span class="p">((</span><span class="nv">source-id</span> <span class="p">(</span><span class="nv">org-roam-node-id</span> <span class="nv">SOURCE</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">           <span class="p">(</span><span class="nv">backlinks</span> <span class="p">(</span><span class="nv">org-roam-backlinks-query*</span> <span class="nv">SOURCE</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">           <span class="p">(</span><span class="nv">id</span> <span class="p">(</span><span class="nv">org-roam-node-id</span> <span class="nv">NODE</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">           <span class="p">(</span><span class="nv">id-list</span> <span class="p">(</span><span class="nf">list</span> <span class="nv">id</span> <span class="nv">source-id</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">     <span class="p">(</span><span class="nf">member</span> <span class="nv">id-list</span> <span class="nv">backlinks</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="p">(</span><span class="nb">defun</span> <span class="nv">org-roam-backlinks-poi-or-moc-p</span> <span class="p">(</span><span class="nv">NODE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="s">&#34;Check if NODE has the tag POI or the tag MOC.  Return t if it does.&#34;</span>
</span></span><span class="line"><span class="cl">   <span class="p">(</span><span class="nb">or</span> <span class="p">(</span><span class="nf">string-equal</span> <span class="p">(</span><span class="nf">car</span> <span class="p">(</span><span class="nv">org-roam-node-tags</span> <span class="nv">NODE</span><span class="p">))</span> <span class="s">&#34;POI&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nf">string-equal</span> <span class="p">(</span><span class="nf">car</span> <span class="p">(</span><span class="nv">org-roam-node-tags</span> <span class="nv">NODE</span><span class="p">))</span> <span class="s">&#34;MOC&#34;</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="p">(</span><span class="nb">defun</span> <span class="nv">org-roam-backlinks--read-node-backlinks</span> <span class="p">(</span><span class="nv">source</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="s">&#34;Runs </span><span class="ss">`org-roam-node-read&#39;</span><span class="s"> on the backlinks of SOURCE.
</span></span></span><span class="line"><span class="cl"><span class="s"> The predicate used as </span><span class="ss">`org-roam-node-read&#39;</span><span class="s">&#39;s filter-fn is
</span></span></span><span class="line"><span class="cl"><span class="s"> </span><span class="ss">`org-roam-backlinks-p&#39;</span><span class="s">.&#34;</span>
</span></span><span class="line"><span class="cl">   <span class="p">(</span><span class="nv">org-roam-node-read</span> <span class="no">nil</span> <span class="p">(</span><span class="nv">apply-partially</span> <span class="nf">#&#39;</span><span class="nv">org-roam-backlinks-p</span> <span class="nv">source</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="p">(</span><span class="nb">defun</span> <span class="nv">org-roam-backlinks-node-read</span> <span class="p">(</span><span class="nv">node</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="s">&#34;Read a NODE and run </span><span class="ss">`org-roam-backlinks--read-node-backlinks&#39;</span><span class="s">.
</span></span></span><span class="line"><span class="cl"><span class="s"> Upon selecting a backlink, prompt the user for what to do with
</span></span></span><span class="line"><span class="cl"><span class="s"> the backlink. The prompt is created with </span><span class="ss">`completing-read&#39;</span><span class="s"> with
</span></span></span><span class="line"><span class="cl"><span class="s"> valid options being everything in the list
</span></span></span><span class="line"><span class="cl"><span class="s"> </span><span class="ss">`org-roam-backlinks-choices&#39;</span><span class="s">.
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s"> If the user decides to view the selected node&#39;s backlinks, the
</span></span></span><span class="line"><span class="cl"><span class="s"> function recursively runs itself with the selection as its
</span></span></span><span class="line"><span class="cl"><span class="s"> argument. If they decide they want to go to the selected node,
</span></span></span><span class="line"><span class="cl"><span class="s"> the function runs </span><span class="ss">`find-file&#39;</span><span class="s"> and the file associated to that
</span></span></span><span class="line"><span class="cl"><span class="s"> node. Lastly, if they choose to quit, the function exits
</span></span></span><span class="line"><span class="cl"><span class="s"> silently.&#34;</span>
</span></span><span class="line"><span class="cl">   <span class="p">(</span><span class="nb">let*</span> <span class="p">((</span><span class="nv">backlink</span> <span class="p">(</span><span class="nv">org-roam-backlinks--read-node-backlinks</span> <span class="nv">node</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">           <span class="p">(</span><span class="nv">choice</span> <span class="p">(</span><span class="nf">completing-read</span> <span class="s">&#34;What to do with NODE: &#34;</span>
</span></span><span class="line"><span class="cl">                                    <span class="nv">org-roam-backlinks-choices</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">     <span class="p">(</span><span class="nb">cond</span>
</span></span><span class="line"><span class="cl">      <span class="p">((</span><span class="nf">string-equal</span>
</span></span><span class="line"><span class="cl">         <span class="nv">choice</span>
</span></span><span class="line"><span class="cl">         <span class="p">(</span><span class="nf">car</span> <span class="nv">org-roam-backlinks-choices</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nv">org-roam-backlinks-node-read</span> <span class="nv">backlink</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">      <span class="p">((</span><span class="nf">string-equal</span>
</span></span><span class="line"><span class="cl">         <span class="nv">choice</span>
</span></span><span class="line"><span class="cl">         <span class="p">(</span><span class="nv">cadr</span> <span class="nv">org-roam-backlinks-choices</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nv">find-file</span> <span class="p">(</span><span class="nv">org-roam-node-file</span> <span class="nv">backlink</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">      <span class="p">((</span><span class="nf">string-equal</span>
</span></span><span class="line"><span class="cl">         <span class="nv">choice</span>
</span></span><span class="line"><span class="cl">         <span class="p">(</span><span class="nv">caddr</span> <span class="nv">org-roam-backlinks-choices</span><span class="p">))))))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="p">(</span><span class="nb">defun</span> <span class="nv">org-roam-backlinks-search</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">   <span class="s">&#34;Select an </span><span class="ss">`org-roam-node&#39;</span><span class="s"> and recursively search its backlinks.
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s"> This function is a starter function for
</span></span></span><span class="line"><span class="cl"><span class="s"> </span><span class="ss">`org-roam-backlinks-node-read&#39;</span><span class="s"> which gets the initial node
</span></span></span><span class="line"><span class="cl"><span class="s"> selection from </span><span class="ss">`org-roam-node-list&#39;</span><span class="s">. For more information about
</span></span></span><span class="line"><span class="cl"><span class="s"> this function, check </span><span class="ss">`org-roam-backlinks-node-read&#39;</span><span class="s">.&#34;</span>
</span></span><span class="line"><span class="cl">   <span class="p">(</span><span class="nb">interactive</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="p">(</span><span class="nb">let</span> <span class="p">((</span><span class="nv">node</span> <span class="p">(</span><span class="nv">org-roam-node-read</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">     <span class="p">(</span><span class="nv">org-roam-backlinks-node-read</span> <span class="nv">node</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="p">(</span><span class="nb">defun</span> <span class="nv">org-roam-backlinks-search-from-moc-or-poi</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">   <span class="s">&#34;</span><span class="ss">`org-roam-backlinks-search&#39;</span><span class="s"> with an initial selection filter.
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s"> Since nodes tagged as \&#34;MOC\&#34; or \&#34;POI\&#34; are the entry points to
</span></span></span><span class="line"><span class="cl"><span class="s"> my personal zettelkasten, I have this helper function which is
</span></span></span><span class="line"><span class="cl"><span class="s"> identical to </span><span class="ss">`org-roam-backlinks-search&#39;</span><span class="s"> but filters initial
</span></span></span><span class="line"><span class="cl"><span class="s"> selection to only those notes. That way, they initial selection
</span></span></span><span class="line"><span class="cl"><span class="s"> has a point as it will be on a node that has a decent amount of
</span></span></span><span class="line"><span class="cl"><span class="s"> backlinks.&#34;</span>
</span></span><span class="line"><span class="cl">   <span class="p">(</span><span class="nb">interactive</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="p">(</span><span class="nb">let</span> <span class="p">((</span><span class="nv">node</span> <span class="p">(</span><span class="nv">org-roam-node-read</span> <span class="no">nil</span> <span class="nf">#&#39;</span><span class="nv">org-roam-backlinks-poi-or-moc-p</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">     <span class="p">(</span><span class="nv">org-roam-backlinks-node-read</span> <span class="nv">node</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;; =============================================================</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; ===========  Dynamic org-agenda with org-roam  ==============</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; =============================================================</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; https://gist.github.com/d12frosted/a60e8ccb9aceba031af243dff0d19b2e</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">vulpea-dynamic-p</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;Return non-nil if current buffer has any todo entry.
</span></span></span><span class="line"><span class="cl"><span class="s">TODO entries marked as done are ignored, meaning the this
</span></span></span><span class="line"><span class="cl"><span class="s">function returns nil if current buffer contains only completed
</span></span></span><span class="line"><span class="cl"><span class="s">tasks.&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">seq-find</span>                                 <span class="c1">; (3)</span>
</span></span><span class="line"><span class="cl">   <span class="p">(</span><span class="nb">lambda</span> <span class="p">(</span><span class="nv">type</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">     <span class="p">(</span><span class="nf">eq</span> <span class="nv">type</span> <span class="ss">&#39;todo</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">   <span class="p">(</span><span class="nv">org-element-map</span>                         <span class="c1">; (2)</span>
</span></span><span class="line"><span class="cl">       <span class="p">(</span><span class="nv">org-element-parse-buffer</span> <span class="ss">&#39;headline</span><span class="p">)</span> <span class="c1">; (1)</span>
</span></span><span class="line"><span class="cl">       <span class="ss">&#39;headline</span>
</span></span><span class="line"><span class="cl">     <span class="p">(</span><span class="nb">lambda</span> <span class="p">(</span><span class="nv">h</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="p">(</span><span class="nv">org-element-property</span> <span class="nb">:todo-type</span> <span class="nv">h</span><span class="p">)))))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">vulpea-dynamic-update-tag</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;Update dynamic tag in the current buffer.&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nb">and</span> <span class="p">(</span><span class="nv">not</span> <span class="p">(</span><span class="nf">active-minibuffer-window</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">               <span class="p">(</span><span class="nv">vulpea-buffer-p</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nb">save-excursion</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nf">goto-char</span> <span class="p">(</span><span class="nf">point-min</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nb">let*</span> <span class="p">((</span><span class="nv">tags</span> <span class="p">(</span><span class="nv">vulpea-buffer-tags-get</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">               <span class="p">(</span><span class="nv">original-tags</span> <span class="nv">tags</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span><span class="nb">if</span> <span class="p">(</span><span class="nv">vulpea-dynamic-p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">              <span class="p">(</span><span class="nb">setq</span> <span class="nv">tags</span> <span class="p">(</span><span class="nf">cons</span> <span class="s">&#34;dynamic&#34;</span> <span class="nv">tags</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="nb">setq</span> <span class="nv">tags</span> <span class="p">(</span><span class="nv">remove</span> <span class="s">&#34;dynamic&#34;</span> <span class="nv">tags</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">          <span class="c1">;; cleanup duplicates</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span><span class="nb">setq</span> <span class="nv">tags</span> <span class="p">(</span><span class="nv">seq-uniq</span> <span class="nv">tags</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">          <span class="c1">;; update tags if changed</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nb">or</span> <span class="p">(</span><span class="nv">seq-difference</span> <span class="nv">tags</span> <span class="nv">original-tags</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="p">(</span><span class="nv">seq-difference</span> <span class="nv">original-tags</span> <span class="nv">tags</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="nf">apply</span> <span class="nf">#&#39;</span><span class="nv">vulpea-buffer-tags-set</span> <span class="nv">tags</span><span class="p">))))))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">vulpea-buffer-p</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;Return non-nil if the currently visited buffer is a note.&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">and</span> <span class="nf">buffer-file-name</span>
</span></span><span class="line"><span class="cl">       <span class="p">(</span><span class="nv">string-prefix-p</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nf">expand-file-name</span> <span class="p">(</span><span class="nf">file-name-as-directory</span> <span class="nv">org-roam-directory</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nf">file-name-directory</span> <span class="nf">buffer-file-name</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">vulpea-dynamic-files</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;Return a list of note files containing &#39;dynamic&#39; tag.&#34;</span> <span class="c1">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nv">seq-uniq</span>
</span></span><span class="line"><span class="cl">     <span class="p">(</span><span class="nv">seq-map</span>
</span></span><span class="line"><span class="cl">      <span class="nf">#&#39;car</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nv">org-roam-db-query</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span><span class="nb">:select</span> <span class="p">[</span><span class="nv">nodes:file</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="nb">:from</span> <span class="nv">tags</span>
</span></span><span class="line"><span class="cl">        <span class="nb">:left-join</span> <span class="nv">nodes</span>
</span></span><span class="line"><span class="cl">        <span class="nb">:on</span> <span class="p">(</span><span class="nf">=</span> <span class="nv">tags:node-id</span> <span class="nv">nodes:id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">:where</span> <span class="p">(</span><span class="nv">like</span> <span class="nv">tag</span> <span class="p">(</span><span class="nb">quote</span> <span class="s">&#34;%\&#34;dynamic\&#34;%&#34;</span><span class="p">))]))))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">vulpea-agenda-files-update</span> <span class="p">(</span><span class="kp">&amp;rest</span> <span class="nv">_</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;Update the value of </span><span class="ss">`org-agenda-files&#39;</span><span class="s">.&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">;; (setq org-agenda-files (vulpea-dynamic-files)))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">setq</span> <span class="nv">org-agenda-files</span> <span class="p">(</span><span class="nv">seq-uniq</span>
</span></span><span class="line"><span class="cl">                          <span class="p">(</span><span class="nf">append</span>
</span></span><span class="line"><span class="cl">                           <span class="p">(</span><span class="nv">vulpea-dynamic-files</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                           <span class="p">(</span><span class="nv">file-expand-wildcards</span> <span class="s">&#34;~/Dropbox/org/agenda/*.org&#34;</span><span class="p">)))))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">add-hook</span> <span class="ss">&#39;find-file-hook</span> <span class="nf">#&#39;</span><span class="nv">vulpea-dynamic-update-tag</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">add-hook</span> <span class="ss">&#39;before-save-hook</span> <span class="nf">#&#39;</span><span class="nv">vulpea-dynamic-update-tag</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">advice-add</span> <span class="ss">&#39;org-agenda</span> <span class="nb">:before</span> <span class="nf">#&#39;</span><span class="nv">vulpea-agenda-files-update</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">advice-add</span> <span class="ss">&#39;org-todo-list</span> <span class="nb">:before</span> <span class="nf">#&#39;</span><span class="nv">vulpea-agenda-files-update</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;; functions borrowed from `vulpea&#39; library</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; https://github.com/d12frosted/vulpea/blob/6a735c34f1f64e1f70da77989e9ce8da7864e5ff/vulpea-buffer.el</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">vulpea-buffer-tags-get</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;Return filetags value in current buffer.&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">vulpea-buffer-prop-get-list</span> <span class="s">&#34;filetags&#34;</span> <span class="s">&#34;[ :]&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">vulpea-buffer-tags-set</span> <span class="p">(</span><span class="kp">&amp;rest</span> <span class="nv">tags</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;Set TAGS in current buffer.
</span></span></span><span class="line"><span class="cl"><span class="s">If filetags value is already set, replace it.&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">if</span> <span class="nv">tags</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nv">vulpea-buffer-prop-set</span>
</span></span><span class="line"><span class="cl">       <span class="s">&#34;filetags&#34;</span> <span class="p">(</span><span class="nf">concat</span> <span class="s">&#34;:&#34;</span> <span class="p">(</span><span class="nv">string-join</span> <span class="nv">tags</span> <span class="s">&#34;:&#34;</span><span class="p">)</span> <span class="s">&#34;:&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nv">vulpea-buffer-prop-remove</span> <span class="s">&#34;filetags&#34;</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">vulpea-buffer-tags-add</span> <span class="p">(</span><span class="nv">tag</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;Add a TAG to filetags in current buffer.&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">let*</span> <span class="p">((</span><span class="nv">tags</span> <span class="p">(</span><span class="nv">vulpea-buffer-tags-get</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">         <span class="p">(</span><span class="nv">tags</span> <span class="p">(</span><span class="nf">append</span> <span class="nv">tags</span> <span class="p">(</span><span class="nf">list</span> <span class="nv">tag</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nf">apply</span> <span class="nf">#&#39;</span><span class="nv">vulpea-buffer-tags-set</span> <span class="nv">tags</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">vulpea-buffer-tags-remove</span> <span class="p">(</span><span class="nv">tag</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;Remove a TAG from filetags in current buffer.&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">let*</span> <span class="p">((</span><span class="nv">tags</span> <span class="p">(</span><span class="nv">vulpea-buffer-tags-get</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">         <span class="p">(</span><span class="nv">tags</span> <span class="p">(</span><span class="nf">delete</span> <span class="nv">tag</span> <span class="nv">tags</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nf">apply</span> <span class="nf">#&#39;</span><span class="nv">vulpea-buffer-tags-set</span> <span class="nv">tags</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">vulpea-buffer-prop-set</span> <span class="p">(</span><span class="nv">name</span> <span class="nv">value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;Set a file property called NAME to VALUE in buffer file.
</span></span></span><span class="line"><span class="cl"><span class="s">If the property is already set, replace its value.&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">setq</span> <span class="nv">name</span> <span class="p">(</span><span class="nf">downcase</span> <span class="nv">name</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">org-with-point-at</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">let</span> <span class="p">((</span><span class="nv">case-fold-search</span> <span class="no">t</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nb">if</span> <span class="p">(</span><span class="nf">re-search-forward</span> <span class="p">(</span><span class="nf">concat</span> <span class="s">&#34;^#\\+&#34;</span> <span class="nv">name</span> <span class="s">&#34;:\\(.*\\)&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                             <span class="p">(</span><span class="nf">point-max</span><span class="p">)</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span><span class="nf">replace-match</span> <span class="p">(</span><span class="nf">concat</span> <span class="s">&#34;#+&#34;</span> <span class="nv">name</span> <span class="s">&#34;: &#34;</span> <span class="nv">value</span><span class="p">)</span> <span class="ss">&#39;fixedcase</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nb">while</span> <span class="p">(</span><span class="nb">and</span> <span class="p">(</span><span class="nv">not</span> <span class="p">(</span><span class="nf">eobp</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                    <span class="p">(</span><span class="nf">looking-at</span> <span class="s">&#34;^[#:]&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span><span class="nb">if</span> <span class="p">(</span><span class="nb">save-excursion</span> <span class="p">(</span><span class="nf">end-of-line</span><span class="p">)</span> <span class="p">(</span><span class="nf">eobp</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">              <span class="p">(</span><span class="nb">progn</span>
</span></span><span class="line"><span class="cl">                <span class="p">(</span><span class="nf">end-of-line</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="p">(</span><span class="nf">insert</span> <span class="s">&#34;\n&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="nf">forward-line</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="nf">beginning-of-line</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nf">insert</span> <span class="s">&#34;#+&#34;</span> <span class="nv">name</span> <span class="s">&#34;: &#34;</span> <span class="nv">value</span> <span class="s">&#34;\n&#34;</span><span class="p">)))))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">vulpea-buffer-prop-set-list</span> <span class="p">(</span><span class="nv">name</span> <span class="nv">values</span> <span class="kp">&amp;optional</span> <span class="nv">separators</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;Set a file property called NAME to VALUES in current buffer.
</span></span></span><span class="line"><span class="cl"><span class="s">VALUES are quoted and combined into single string using
</span></span></span><span class="line"><span class="cl"><span class="s"></span><span class="ss">`combine-and-quote-strings&#39;</span><span class="s">.
</span></span></span><span class="line"><span class="cl"><span class="s">If SEPARATORS is non-nil, it should be a regular expression
</span></span></span><span class="line"><span class="cl"><span class="s">matching text that separates, but is not part of, the substrings.
</span></span></span><span class="line"><span class="cl"><span class="s">If nil it defaults to </span><span class="ss">`split-string-default-separators&#39;</span><span class="s">, normally
</span></span></span><span class="line"><span class="cl"><span class="s">\&#34;[ \f\t\n\r\v]+\&#34;, and OMIT-NULLS is forced to t.
</span></span></span><span class="line"><span class="cl"><span class="s">If the property is already set, replace its value.&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">vulpea-buffer-prop-set</span>
</span></span><span class="line"><span class="cl">   <span class="nv">name</span> <span class="p">(</span><span class="nv">combine-and-quote-strings</span> <span class="nv">values</span> <span class="nv">separators</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">vulpea-buffer-prop-get</span> <span class="p">(</span><span class="nv">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;Get a buffer property called NAME as a string.&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">org-with-point-at</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nf">re-search-forward</span> <span class="p">(</span><span class="nf">concat</span> <span class="s">&#34;^#\\+&#34;</span> <span class="nv">name</span> <span class="s">&#34;: \\(.*\\)&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                             <span class="p">(</span><span class="nf">point-max</span><span class="p">)</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nf">buffer-substring-no-properties</span>
</span></span><span class="line"><span class="cl">       <span class="p">(</span><span class="nf">match-beginning</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="p">(</span><span class="nf">match-end</span> <span class="mi">1</span><span class="p">)))))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">vulpea-buffer-prop-get-list</span> <span class="p">(</span><span class="nv">name</span> <span class="kp">&amp;optional</span> <span class="nv">separators</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;Get a buffer property NAME as a list using SEPARATORS.
</span></span></span><span class="line"><span class="cl"><span class="s">If SEPARATORS is non-nil, it should be a regular expression
</span></span></span><span class="line"><span class="cl"><span class="s">matching text that separates, but is not part of, the substrings.
</span></span></span><span class="line"><span class="cl"><span class="s">If nil it defaults to </span><span class="ss">`split-string-default-separators&#39;</span><span class="s">, normally
</span></span></span><span class="line"><span class="cl"><span class="s">\&#34;[ \f\t\n\r\v]+\&#34;, and OMIT-NULLS is forced to t.&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">let</span> <span class="p">((</span><span class="nv">value</span> <span class="p">(</span><span class="nv">vulpea-buffer-prop-get</span> <span class="nv">name</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nb">and</span> <span class="nv">value</span> <span class="p">(</span><span class="nv">not</span> <span class="p">(</span><span class="nv">string-empty-p</span> <span class="nv">value</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nv">split-string-and-unquote</span> <span class="nv">value</span> <span class="nv">separators</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">vulpea-buffer-prop-remove</span> <span class="p">(</span><span class="nv">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;Remove a buffer property called NAME.&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">org-with-point-at</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nf">re-search-forward</span> <span class="p">(</span><span class="nf">concat</span> <span class="s">&#34;\\(^#\\+&#34;</span> <span class="nv">name</span> <span class="s">&#34;:.*\n?\\)&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                             <span class="p">(</span><span class="nf">point-max</span><span class="p">)</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nf">replace-match</span> <span class="s">&#34;&#34;</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;; =============================================================</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; ======================  Archiving  ==========================</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; =============================================================</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;; (setq org-archive-mark-done nil)</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; (setq org-archive-location &#34;%s_archive::* Archive&#34;)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;; https://gist.github.com/kepi/2f4acc3cc93403c75fbba5684c5d852d</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; org-archive-subtree-hierarchical.el</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; version 0.2</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; modified from https://lists.gnu.org/archive/html/emacs-orgmode/2014-08/msg00109.html</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; modified from https://stackoverflow.com/a/35475878/259187</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;; In orgmode</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; * A</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; ** AA</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; *** AAA</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; ** AB</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; *** ABA</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; Archiving AA will remove the subtree from the original file and create</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; it like that in archive target:</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;; * AA</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; ** AAA</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;; And this give you</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; * A</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; ** AA</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; *** AAA</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; Install file to your include path and include in your init file with:</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;  (require &#39;org-archive-subtree-hierarchical)</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;  (setq org-archive-default-command &#39;org-archive-subtree-hierarchical)</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">provide</span> <span class="ss">&#39;org-archive-subtree-hierarchical</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">org-archive-default-command</span> <span class="ss">&#39;org-archive-subtree-hierarchical</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">require</span> <span class="ss">&#39;org-archive</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">org-archive-subtree-hierarchical--line-content-as-string</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;Returns the content of the current line as a string&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">save-excursion</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nf">beginning-of-line</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nf">buffer-substring-no-properties</span>
</span></span><span class="line"><span class="cl">     <span class="p">(</span><span class="nf">line-beginning-position</span><span class="p">)</span> <span class="p">(</span><span class="nf">line-end-position</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">org-archive-subtree-hierarchical--org-child-list</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;This function returns all children of a heading as a list. &#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">interactive</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">save-excursion</span>
</span></span><span class="line"><span class="cl">    <span class="c1">;; this only works with org-version &gt; 8.0, since in previous</span>
</span></span><span class="line"><span class="cl">    <span class="c1">;; org-mode versions the function (org-outline-level) returns</span>
</span></span><span class="line"><span class="cl">    <span class="c1">;; gargabe when the point is not on a heading.</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">if</span> <span class="p">(</span><span class="nf">=</span> <span class="p">(</span><span class="nv">org-outline-level</span><span class="p">)</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nv">outline-next-visible-heading</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nv">org-goto-first-child</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">let</span> <span class="p">((</span><span class="nv">child-list</span> <span class="p">(</span><span class="nf">list</span> <span class="p">(</span><span class="nv">org-archive-subtree-hierarchical--line-content-as-string</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nb">while</span> <span class="p">(</span><span class="nv">org-goto-sibling</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nb">setq</span> <span class="nv">child-list</span> <span class="p">(</span><span class="nf">cons</span> <span class="p">(</span><span class="nv">org-archive-subtree-hierarchical--line-content-as-string</span><span class="p">)</span> <span class="nv">child-list</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">      <span class="nv">child-list</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">org-archive-subtree-hierarchical--org-struct-subtree</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;This function returns the tree structure in which a subtree
</span></span></span><span class="line"><span class="cl"><span class="s">belongs as a list.&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">interactive</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">let</span> <span class="p">((</span><span class="nv">archive-tree</span> <span class="no">nil</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">save-excursion</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nb">while</span> <span class="p">(</span><span class="nv">org-up-heading-safe</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nb">let</span> <span class="p">((</span><span class="nv">heading</span>
</span></span><span class="line"><span class="cl">               <span class="p">(</span><span class="nf">buffer-substring-no-properties</span>
</span></span><span class="line"><span class="cl">                <span class="p">(</span><span class="nf">line-beginning-position</span><span class="p">)</span> <span class="p">(</span><span class="nf">line-end-position</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span><span class="nb">if</span> <span class="p">(</span><span class="nf">eq</span> <span class="nv">archive-tree</span> <span class="no">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">              <span class="p">(</span><span class="nb">setq</span> <span class="nv">archive-tree</span> <span class="p">(</span><span class="nf">list</span> <span class="nv">heading</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="nb">setq</span> <span class="nv">archive-tree</span> <span class="p">(</span><span class="nf">cons</span> <span class="nv">heading</span> <span class="nv">archive-tree</span><span class="p">))))))</span>
</span></span><span class="line"><span class="cl">    <span class="nv">archive-tree</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">org-archive-subtree-hierarchical</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;This function archives a subtree hierarchical&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">interactive</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">let</span> <span class="p">((</span><span class="nv">org-tree</span> <span class="p">(</span><span class="nv">org-archive-subtree-hierarchical--org-struct-subtree</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nv">this-buffer</span> <span class="p">(</span><span class="nf">current-buffer</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nv">file</span> <span class="p">(</span><span class="nv">abbreviate-file-name</span>
</span></span><span class="line"><span class="cl">               <span class="p">(</span><span class="nb">or</span> <span class="p">(</span><span class="nf">buffer-file-name</span> <span class="p">(</span><span class="nf">buffer-base-buffer</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                   <span class="p">(</span><span class="ne">error</span> <span class="s">&#34;No file associated to buffer&#34;</span><span class="p">)))))</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">save-excursion</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nb">setq</span> <span class="nv">location</span> <span class="nv">org-archive-location</span>
</span></span><span class="line"><span class="cl">            <span class="nv">afile</span> <span class="p">(</span><span class="nf">car</span> <span class="p">(</span><span class="nv">org-archive--compute-location</span>
</span></span><span class="line"><span class="cl">                                   <span class="p">(</span><span class="nb">or</span> <span class="p">(</span><span class="nv">org-entry-get</span> <span class="no">nil</span> <span class="s">&#34;ARCHIVE&#34;</span> <span class="ss">&#39;inherit</span><span class="p">)</span> <span class="nv">location</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">            <span class="c1">;; heading (org-extract-archive-heading location)</span>
</span></span><span class="line"><span class="cl">            <span class="nv">infile-p</span> <span class="p">(</span><span class="nf">equal</span> <span class="nv">file</span> <span class="p">(</span><span class="nv">abbreviate-file-name</span> <span class="p">(</span><span class="nb">or</span> <span class="nv">afile</span> <span class="s">&#34;&#34;</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nb">unless</span> <span class="nv">afile</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="ne">error</span> <span class="s">&#34;Invalid </span><span class="ss">`org-archive-location&#39;</span><span class="s">&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nb">if</span> <span class="p">(</span><span class="nf">&gt;</span> <span class="p">(</span><span class="nf">length</span> <span class="nv">afile</span><span class="p">)</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span><span class="nb">setq</span> <span class="nv">newfile-p</span> <span class="p">(</span><span class="nv">not</span> <span class="p">(</span><span class="nf">file-exists-p</span> <span class="nv">afile</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="nv">visiting</span> <span class="p">(</span><span class="nv">find-buffer-visiting</span> <span class="nv">afile</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="nv">buffer</span> <span class="p">(</span><span class="nb">or</span> <span class="nv">visiting</span> <span class="p">(</span><span class="nv">find-file-noselect</span> <span class="nv">afile</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nb">setq</span> <span class="nv">buffer</span> <span class="p">(</span><span class="nf">current-buffer</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nb">unless</span> <span class="nv">buffer</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="ne">error</span> <span class="s">&#34;Cannot access file \&#34;%s\&#34;&#34;</span> <span class="nv">afile</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nv">org-cut-subtree</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nf">set-buffer</span> <span class="nv">buffer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nv">org-mode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nf">goto-char</span> <span class="p">(</span><span class="nf">point-min</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nb">while</span> <span class="p">(</span><span class="nv">not</span> <span class="p">(</span><span class="nf">equal</span> <span class="nv">org-tree</span> <span class="no">nil</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nb">let</span> <span class="p">((</span><span class="nv">child-list</span> <span class="p">(</span><span class="nv">org-archive-subtree-hierarchical--org-child-list</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span><span class="nb">if</span> <span class="p">(</span><span class="nf">member</span> <span class="p">(</span><span class="nf">car</span> <span class="nv">org-tree</span><span class="p">)</span> <span class="nv">child-list</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">              <span class="p">(</span><span class="nb">progn</span>
</span></span><span class="line"><span class="cl">                <span class="p">(</span><span class="nf">search-forward</span> <span class="p">(</span><span class="nf">car</span> <span class="nv">org-tree</span><span class="p">)</span> <span class="no">nil</span> <span class="no">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="p">(</span><span class="nb">setq</span> <span class="nv">org-tree</span> <span class="p">(</span><span class="nf">cdr</span> <span class="nv">org-tree</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="nb">progn</span>
</span></span><span class="line"><span class="cl">              <span class="p">(</span><span class="nf">goto-char</span> <span class="p">(</span><span class="nf">point-max</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">              <span class="p">(</span><span class="nv">newline</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">              <span class="p">(</span><span class="nv">org-insert-struct</span> <span class="nv">org-tree</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">              <span class="p">(</span><span class="nb">setq</span> <span class="nv">org-tree</span> <span class="no">nil</span><span class="p">)))))</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nv">newline</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nv">org-yank</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nv">not</span> <span class="p">(</span><span class="nf">eq</span> <span class="nv">this-buffer</span> <span class="nv">buffer</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nv">save-buffer</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nf">message</span> <span class="s">&#34;Subtree archived %s&#34;</span>
</span></span><span class="line"><span class="cl">               <span class="p">(</span><span class="nf">concat</span> <span class="s">&#34;in file: &#34;</span> <span class="p">(</span><span class="nv">abbreviate-file-name</span> <span class="nv">afile</span><span class="p">))))))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">org-insert-struct</span> <span class="p">(</span><span class="nv">struct</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;TODO&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">interactive</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">when</span> <span class="nv">struct</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nf">insert</span> <span class="p">(</span><span class="nf">car</span> <span class="nv">struct</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nv">newline</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nv">org-insert-struct</span> <span class="p">(</span><span class="nf">cdr</span> <span class="nv">struct</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">org-archive-subtree</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">org-archive-subtree-hierarchical</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">;; =============================================================</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; ==============  Hierachy for title nodes  ===================</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; =============================================================</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; Codes blow are used to general a hierachy for title nodes that under a file</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">cl-defmethod</span> <span class="nv">org-roam-node-doom-filetitle</span> <span class="p">((</span><span class="nv">node</span> <span class="nv">org-roam-node</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;Return the value of \&#34;#+title:\&#34; (if any) from file that NODE resides in.
</span></span></span><span class="line"><span class="cl"><span class="s">If there&#39;s no file-level title in the file, return empty string.&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">or</span> <span class="p">(</span><span class="nb">if</span> <span class="p">(</span><span class="nf">=</span> <span class="p">(</span><span class="nv">org-roam-node-level</span> <span class="nv">node</span><span class="p">)</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span><span class="nv">org-roam-node-title</span> <span class="nv">node</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nv">org-roam-get-keyword</span> <span class="s">&#34;TITLE&#34;</span> <span class="p">(</span><span class="nv">org-roam-node-file</span> <span class="nv">node</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">      <span class="s">&#34;&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">cl-defmethod</span> <span class="nv">org-roam-node-doom-hierarchy</span> <span class="p">((</span><span class="nv">node</span> <span class="nv">org-roam-node</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;Return hierarchy for NODE, constructed of its file title, OLP and direct title.
</span></span></span><span class="line"><span class="cl"><span class="s">  If some elements are missing, they will be stripped out.&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">let</span> <span class="p">((</span><span class="nv">title</span>     <span class="p">(</span><span class="nv">org-roam-node-title</span> <span class="nv">node</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nv">olp</span>       <span class="p">(</span><span class="nv">org-roam-node-olp</span>   <span class="nv">node</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nv">level</span>     <span class="p">(</span><span class="nv">org-roam-node-level</span> <span class="nv">node</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nv">filetitle</span> <span class="p">(</span><span class="nv">org-roam-node-doom-filetitle</span> <span class="nv">node</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nv">separator</span> <span class="p">(</span><span class="nf">propertize</span> <span class="s">&#34; &gt; &#34;</span> <span class="ss">&#39;face</span> <span class="ss">&#39;shadow</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">cl-case</span> <span class="nv">level</span>
</span></span><span class="line"><span class="cl">      <span class="c1">;; node is a top-level file</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="mi">0</span> <span class="nv">filetitle</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="c1">;; node is a level 1 heading</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="mi">1</span> <span class="p">(</span><span class="nf">concat</span> <span class="p">(</span><span class="nf">propertize</span> <span class="nv">filetitle</span> <span class="ss">&#39;face</span> <span class="o">&#39;</span><span class="p">(</span><span class="nv">shadow</span> <span class="nv">italic</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                 <span class="nv">separator</span> <span class="nv">title</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">      <span class="c1">;; node is a heading with an arbitrary outline path</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="no">t</span> <span class="p">(</span><span class="nf">concat</span> <span class="p">(</span><span class="nf">propertize</span> <span class="nv">filetitle</span> <span class="ss">&#39;face</span> <span class="o">&#39;</span><span class="p">(</span><span class="nv">shadow</span> <span class="nv">italic</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                 <span class="nv">separator</span> <span class="p">(</span><span class="nf">propertize</span> <span class="p">(</span><span class="nv">string-join</span> <span class="nv">olp</span> <span class="s">&#34; &gt; &#34;</span><span class="p">)</span> <span class="ss">&#39;face</span> <span class="o">&#39;</span><span class="p">(</span><span class="nv">shadow</span> <span class="nv">italic</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                 <span class="nv">separator</span> <span class="nv">title</span><span class="p">)))))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">setq</span> <span class="nv">org-roam-node-display-template</span> <span class="p">(</span><span class="nf">concat</span> <span class="s">&#34;${type:10} ${doom-hierarchy:120} &#34;</span> <span class="p">(</span><span class="nf">propertize</span> <span class="s">&#34;${tags:*}&#34;</span> <span class="ss">&#39;face</span> <span class="ss">&#39;org-tag</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; =============================================================</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; ========================  iscroll  ==========================</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; =============================================================</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">require-package</span> <span class="ss">&#39;iscroll</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">add-hook</span> <span class="ss">&#39;org-mode-hook</span> <span class="p">(</span><span class="nb">lambda</span> <span class="p">()</span> <span class="p">(</span><span class="nv">iscroll-mode</span> <span class="mi">1</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; =============================================================</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; ===================  dwim-shell-command  ====================</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; =============================================================</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">require-package</span> <span class="ss">&#39;dwim-shell-command</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">require</span> <span class="ss">&#39;dwim-shell-command</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">dwim-shell-commands-macos-reveal-in-finder</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;Reveal selected files in macOS Finder.&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">interactive</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">dwim-shell-command-on-marked-files</span>
</span></span><span class="line"><span class="cl">   <span class="s">&#34;Reveal in Finder&#34;</span>
</span></span><span class="line"><span class="cl">   <span class="s">&#34;import AppKit
</span></span></span><span class="line"><span class="cl"><span class="s">    NSWorkspace.shared.activateFileViewerSelecting([\&#34;&lt;&lt;*&gt;&gt;\&#34;].map{URL(fileURLWithPath:$0)})&#34;</span>
</span></span><span class="line"><span class="cl">   <span class="nb">:join-separator</span> <span class="s">&#34;, &#34;</span>
</span></span><span class="line"><span class="cl">   <span class="nb">:silent-success</span> <span class="no">t</span>
</span></span><span class="line"><span class="cl">   <span class="nb">:shell-pipe</span> <span class="s">&#34;swift -&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">provide</span> <span class="ss">&#39;init-org-enhance</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;; init-org-enhance.el ends here</span>
</span></span></code></pre></div><h3 id="telega-bridge-bot-dot-el">telega-bridge-bot.el<a hidden class="anchor" aria-hidden="true" href="#telega-bridge-bot-dot-el">#</a></h3>
<p>用来改善 Matrix 机器人在 TG 中转发的消息展示，包括头像、用户名等。具体源码参见 <a href="https://gitee.com/blindingdark/BEmacs/blob/master/vendor/telega-bridge-bot.el">vendor/telega-bridge-bot.el · BlindingDark/BEmacs - Gitee.com</a>。</p>
<h3 id="init-org-transclusion-dot-el">init-org-transclusion.el<a hidden class="anchor" aria-hidden="true" href="#init-org-transclusion-dot-el">#</a></h3>
<p>过滤的条件的具体细节见 <a href="https://nobiot.github.io/org-transclusion/#Usage">Org-transclusion User Manual</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-elisp" data-lang="elisp"><span class="line"><span class="cl"><span class="c1">;;; init-org-transclusion.el  --- Custom configuration</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;; Commentary</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nv">require-package</span> <span class="ss">&#39;org-transclusion</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">use-package</span> <span class="nv">org-transclusion</span>
</span></span><span class="line"><span class="cl">              <span class="nb">:after</span> <span class="nv">org</span>
</span></span><span class="line"><span class="cl">              <span class="nb">:bind</span><span class="p">((</span><span class="s">&#34;C-c n t&#34;</span> <span class="o">.</span> <span class="nv">org-transclusion-mode</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">trival/org-transclusion-select-source</span> <span class="p">(</span><span class="nv">beg</span> <span class="nv">end</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;Send transclusion information to kill-ring. See
</span></span></span><span class="line"><span class="cl"><span class="s">    https://org-roam.discourse.group/t/alpha-org-transclusion/830/122&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">interactive</span> <span class="s">&#34;r&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">let</span> <span class="p">((</span><span class="nv">lbeg</span> <span class="p">(</span><span class="nv">line-number-at-pos</span> <span class="nv">beg</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nv">lend</span> <span class="p">(</span><span class="nv">line-number-at-pos</span> <span class="nv">end</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nv">filename</span> <span class="p">(</span><span class="nf">concat</span> <span class="s">&#34;~/&#34;</span><span class="p">(</span><span class="nv">string-remove-prefix</span> <span class="p">(</span><span class="nv">file-truename</span> <span class="s">&#34;~/&#34;</span><span class="p">)</span> <span class="p">(</span><span class="nf">buffer-file-name</span><span class="p">)))))</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">with-temp-buffer</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nb">progn</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span><span class="nf">insert</span> <span class="s">&#34;#+transclude: [[file:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span><span class="nf">insert</span> <span class="nv">filename</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span><span class="nf">insert</span> <span class="p">(</span><span class="nf">format</span> <span class="s">&#34;]] :lines %d-%d&#34;</span> <span class="nv">lbeg</span> <span class="nv">lend</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span><span class="nv">clipboard-kill-region</span> <span class="p">(</span><span class="nf">point-min</span><span class="p">)</span> <span class="p">(</span><span class="nf">point-max</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nf">message</span> <span class="s">&#34;A transcluded link has been sent to your kill-ring.&#34;</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">my/org-insert-link-transclusion</span> <span class="p">(</span><span class="kp">&amp;optional</span> <span class="nv">COMPLETE-FILE</span> <span class="nv">LINK-LOCATION</span> <span class="nv">DESCRIPTION</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">interactive</span> <span class="s">&#34;P&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">org-insert-link</span> <span class="nv">COMPLETE-FILE</span> <span class="nv">LINK-LOCATION</span> <span class="nv">DESCRIPTION</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">org-transclusion-make-from-link</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nb">provide</span> <span class="ss">&#39;init-org-transclusion</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;; init-org-transclusion.el ends here</span>
</span></span></code></pre></div><h2 id="export">Export<a hidden class="anchor" aria-hidden="true" href="#export">#</a></h2>
<p>对于只需要导出某个 header 下的内容的需求，只需要在 header 上加上 <code>:export:</code> 即可。</p>
<h3 id="markdown-file">Markdown file<a hidden class="anchor" aria-hidden="true" href="#markdown-file">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">brew install pandoc
</span></span></code></pre></div><p>这里用的是 <a href="https://github.com/kawabata/ox-pandoc">ox-pandoc</a>，需要先 <code>M-x package-install &lt;RET&gt; ox-pandoc &lt;RET&gt;</code> 进行安装，​<code>M-x org-pandoc-export-as-gfm</code> 算是我找到最符合 MarkDown 语法的转换了，Emacs 自己的转换会将 Table 转换成 HTML 标签的格式。</p>
<h3 id="hugo">Hugo<a hidden class="anchor" aria-hidden="true" href="#hugo">#</a></h3>
<p>在文件头部添加</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">#+HUGO_BASE_DIR: ~/Dropbox/hugo/
</span></span><span class="line"><span class="cl">#+HUGO_SECTION: posts/main
</span></span><span class="line"><span class="cl">#+HUGO_WEIGHT: auto
</span></span><span class="line"><span class="cl">#+HUGO_AUTO_SET_LASTMOD: t
</span></span></code></pre></div><p>需要导出为 <code>&lt;mark&gt;&lt;/mark&gt;</code> 时<sup id="fnref1:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-org" data-lang="org"><span class="line"><span class="cl"><span class="c">#+begin_mark</span>
</span></span><span class="line"><span class="cl">marked text
</span></span><span class="line"><span class="cl"><span class="c">#+end_mark</span>
</span></span></code></pre></div><p>需要导出为块级 <code>&lt;mark&gt;&lt;/mark&gt;</code> 时，也就是前后的空格不进行 trim。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-org" data-lang="org"><span class="line"><span class="cl"><span class="cs">#+header</span><span class="c">: :trim-pre nil :trim-post nil</span>
</span></span><span class="line"><span class="cl"><span class="c">#+begin_mark</span>
</span></span><span class="line"><span class="cl">marked text
</span></span><span class="line"><span class="cl"><span class="c">#+end_mark</span>
</span></span></code></pre></div><h3 id="latex">Latex<a hidden class="anchor" aria-hidden="true" href="#latex">#</a></h3>
<h4 id="dependency">Dependency<a hidden class="anchor" aria-hidden="true" href="#dependency">#</a></h4>
<p>需要安装 texlive</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">brew install texlive
</span></span></code></pre></div><h4 id="latex-语法">Latex 语法<a hidden class="anchor" aria-hidden="true" href="#latex-语法">#</a></h4>
<p><a href="/posts/main/20220616162256-latex/">Latex 语法</a></p>
<h4 id="pdf-导出报错">PDF 导出报错<a hidden class="anchor" aria-hidden="true" href="#pdf-导出报错">#</a></h4>
<ul>
<li><code>Unicode character 考 (U+8003) not set up for use with LaTeX.</code> 是因为 Latex 本身不支持中文。</li>
</ul>
<h4 id="中文-pdf-导出设置">中文 PDF 导出设置<a hidden class="anchor" aria-hidden="true" href="#中文-pdf-导出设置">#</a></h4>
<ol>
<li>使用 <a href="https://github.com/ElegantLaTeX/ElegantPaper">ElegantPaper</a>，需要将 elegantpaper.cls 文件放在 org 目录下。</li>
<li>安装依赖</li>
</ol>
<p>代码块需要用到 <code>minted</code>​，需要用到 <code>pygments</code> 作为依赖。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">brew install pygments
</span></span></code></pre></div><ol>
<li>导出文件头部增加</li>
</ol>
<!--listend-->
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-org" data-lang="org"><span class="line"><span class="cl"><span class="cs">#+LATEX_COMPILER</span><span class="c">: xelatex</span>
</span></span><span class="line"><span class="cl"><span class="cs">#+LATEX_CLASS</span><span class="c">: elegantpaper</span>
</span></span><span class="line"><span class="cl"><span class="cs">#+OPTIONS</span><span class="c">: prop:t</span>
</span></span></code></pre></div><div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p><a href="https://ox-hugo.scripter.co/doc/org-special-blocks/">Org Special Blocks</a>&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a>&#160;<a href="#fnref1:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</div>

                                                                                                                                                                    
<div class="bl-section">
  <h4>Links to this note</h4>
  <div class="backlinks">
    <ul>
      
      <li><a href="/posts/main/20220508195206-toolbox/">Toolbox</a></li>
      
    </ul>
  </div>
</div>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="prev" href="https://sheerwill.xyz/posts/main/20230211001746-covering_index/">
    <span class="title">« Prev</span>
    <br>
    <span>covering index</span>
  </a>
  <a class="next" href="https://sheerwill.xyz/posts/main/clm-the_left_prefix_index_rule_is_determined_by_the_b&#43;tree_structure/">
    <span class="title">Next »</span>
    <br>
    <span>The Left-Prefix Index Rule is determined by the B&#43;tree structure</span>
  </a>
</nav>


<ul class="share-buttons">
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Vanilla Emacs with Purcell on x"
            href="https://x.com/intent/tweet/?text=Vanilla%20Emacs%20with%20Purcell&amp;url=https%3a%2f%2fsheerwill.xyz%2fposts%2fmain%2f20220723211325-vanilla_emacs_with_purcell%2f&amp;hashtags=">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M512 62.554 L 512 449.446 C 512 483.97 483.97 512 449.446 512 L 62.554 512 C 28.03 512 0 483.97 0 449.446 L 0 62.554 C 0 28.03 28.029 0 62.554 0 L 449.446 0 C 483.971 0 512 28.03 512 62.554 Z M 269.951 190.75 L 182.567 75.216 L 56 75.216 L 207.216 272.95 L 63.9 436.783 L 125.266 436.783 L 235.9 310.383 L 332.567 436.783 L 456 436.783 L 298.367 228.367 L 432.367 75.216 L 371.033 75.216 Z M 127.633 110 L 164.101 110 L 383.481 400.065 L 349.5 400.065 Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Vanilla Emacs with Purcell on linkedin"
            href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fsheerwill.xyz%2fposts%2fmain%2f20220723211325-vanilla_emacs_with_purcell%2f&amp;title=Vanilla%20Emacs%20with%20Purcell&amp;summary=Vanilla%20Emacs%20with%20Purcell&amp;source=https%3a%2f%2fsheerwill.xyz%2fposts%2fmain%2f20220723211325-vanilla_emacs_with_purcell%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Vanilla Emacs with Purcell on reddit"
            href="https://reddit.com/submit?url=https%3a%2f%2fsheerwill.xyz%2fposts%2fmain%2f20220723211325-vanilla_emacs_with_purcell%2f&title=Vanilla%20Emacs%20with%20Purcell">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Vanilla Emacs with Purcell on facebook"
            href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fsheerwill.xyz%2fposts%2fmain%2f20220723211325-vanilla_emacs_with_purcell%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Vanilla Emacs with Purcell on whatsapp"
            href="https://api.whatsapp.com/send?text=Vanilla%20Emacs%20with%20Purcell%20-%20https%3a%2f%2fsheerwill.xyz%2fposts%2fmain%2f20220723211325-vanilla_emacs_with_purcell%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Vanilla Emacs with Purcell on telegram"
            href="https://telegram.me/share/url?text=Vanilla%20Emacs%20with%20Purcell&amp;url=https%3a%2f%2fsheerwill.xyz%2fposts%2fmain%2f20220723211325-vanilla_emacs_with_purcell%2f">
            <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28" height="30px" width="30px" fill="currentColor">
                <path
                    d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Vanilla Emacs with Purcell on ycombinator"
            href="https://news.ycombinator.com/submitlink?t=Vanilla%20Emacs%20with%20Purcell&u=https%3a%2f%2fsheerwill.xyz%2fposts%2fmain%2f20220723211325-vanilla_emacs_with_purcell%2f">
            <svg version="1.1" xml:space="preserve" width="30px" height="30px" viewBox="0 0 512 512" fill="currentColor"
                xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape">
                <path
                    d="M449.446 0C483.971 0 512 28.03 512 62.554L512 449.446C512 483.97 483.97 512 449.446 512L62.554 512C28.03 512 0 483.97 0 449.446L0 62.554C0 28.03 28.029 0 62.554 0L449.446 0ZM183.8767 87.9921H121.8427L230.6673 292.4508V424.0079H281.3328V292.4508L390.1575 87.9921H328.1233L256 238.2489z" />
            </svg>
        </a>
    </li>
</ul>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2024 <a href="https://sheerwill.xyz/">Lucius | Braindump</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
